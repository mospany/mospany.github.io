<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>å¢¨æ–¯æ½˜åœ’ on å¢¨æ–¯æ½˜åœ’</title>
        <link>http://mospany.github.io/</link>
        <language>zh-CN</language>
        <author>Mospan</author>
        <rights>Copyright (c) 2016, mospan; all rights reserved.</rights>
        <updated>Mon, 02 Jun 2025 16:29:28 CST</updated>
        
        <item>
            <title>huggingfaceå¤§æ¨¡å‹æ–‡ä»¶æ„æˆ</title>
            <link>http://mospany.github.io/2025/06/02/huggingface-llm/</link>
            <pubDate>Mon, 02 Jun 2025 16:29:28 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2025/06/02/huggingface-llm/</guid>
            <description>

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;Hugging Face æ˜¯ä¸€ä¸ªæœºå™¨å­¦ä¹ ç¤¾åŒºå¹³å°ï¼Œæä¾›æ•°ä¸‡ä¸ªé¢„è®­ç»ƒæ¨¡å‹ã€æ•°æ®é›†ã€API ä¸å·¥å…·åº“ï¼Œå¹¿æ³›åº”ç”¨äº NLPã€CVã€è¯­éŸ³ã€å¼ºåŒ–å­¦ä¹ ã€å¤šæ¨¡æ€ç­‰ä»»åŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;å®˜æ–¹å¹³å°ï¼šğŸ”— &lt;a href=&#34;https://huggingface.co/&#34;&gt;https://huggingface.co/&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æ ¸å¿ƒç»„ä»¶&#34;&gt;æ ¸å¿ƒç»„ä»¶&lt;/h1&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç»„ä»¶å&lt;/th&gt;
&lt;th&gt;ç®€ä»‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;transformers&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ä¸»åŠ›åº“ï¼Œæä¾› NLP é¢„è®­ç»ƒæ¨¡å‹çš„åŠ è½½ä¸ä½¿ç”¨&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;code&gt;datasets&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;é«˜è´¨é‡æ•°æ®é›†ç®¡ç†ã€åŠ è½½ã€é¢„å¤„ç†åº“&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;code&gt;accelerate&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ç®€åŒ–å¤š GPUã€TPU çš„è®­ç»ƒéƒ¨ç½²&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;code&gt;diffusers&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ–‡ç”Ÿå›¾ã€æ‰©æ•£æ¨¡å‹çš„ä¸»è¦æ”¯æŒåº“&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;code&gt;peft&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;è½»é‡å¾®è°ƒï¼ˆLoRAã€QLoRA ç­‰ï¼‰æ”¯æŒåº“&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;code&gt;huggingface_hub&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ä¸ Hugging Face Hub äº¤äº’çš„ Python å·¥å…·åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
</description>
        </item>
        
        <item>
            <title>vGPUæ–¹æ¡ˆHAMi(01): å®ç°ç»†ç²’åº¦ GPU åˆ‡åˆ†</title>
            <link>http://mospany.github.io/2024/02/05/hami-vgpu-split/</link>
            <pubDate>Mon, 05 Feb 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/02/05/hami-vgpu-split/</guid>
            <description>

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº«ä¸€ä¸ªå¼€æºçš„ GPU è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼šHAMiï¼ŒåŒ…æ‹¬å¦‚ä½•å®‰è£…ã€é…ç½®ä»¥åŠä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;ç›¸æ¯”äºä¸Šä¸€ç¯‡åˆ†äº«çš„ TimeSlicing æ–¹æ¡ˆï¼ŒHAMi é™¤äº† GPU å…±äº«ä¹‹å¤–è¿˜å¯ä»¥å®ç° GPU coreã€memory çš„é™åˆ¶ï¼Œä¿è¯å…±äº«åŒä¸€ GPU çš„å„ä¸ª Pod éƒ½èƒ½æ‹¿åˆ°è¶³å¤Ÿçš„èµ„æºã€‚&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦å¯¹å¼€æºçš„ vGPU æ–¹æ¡ˆ HAMi çš„ GPU Core&amp;amp;Memory éš”ç¦»åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä¸ºä»€ä¹ˆéœ€è¦-gpu-å…±äº«-åˆ‡åˆ†ç­‰æ–¹æ¡ˆ&#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆï¼Ÿ&lt;/h1&gt;

&lt;p&gt;å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œ&lt;em&gt;ä¸ºä»€ä¹ˆéœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆï¼Ÿ&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;æˆ–è€…è¯´æ˜¯å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼š&lt;em&gt;æ˜æ˜ç›´æ¥åœ¨è£¸æœºç¯å¢ƒä½¿ç”¨ï¼Œéƒ½å¯ä»¥å¤šä¸ªè¿›ç¨‹å…±äº« GPUï¼Œæ€ä¹ˆåˆ° k8s ç¯å¢ƒå°±ä¸è¡Œäº†ã€‚&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;æ¨èé˜…è¯»å‰é¢å‡ ç¯‡æ–‡ç« ï¼šè¿™ä¸¤ç¯‡åˆ†äº«äº†å¦‚ä½•åœ¨å„ä¸ªç¯å¢ƒä¸­ä½¿ç”¨ GPUï¼Œåœ¨ k8s ç¯å¢ƒåˆ™æ¨èä½¿ç”¨ NVIDIA æä¾›çš„ gpu-operator å¿«é€Ÿéƒ¨ç½²ç¯å¢ƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.mospan.cn/2024/01/16/gpu-on-k8s/&#34;&gt;K8Sé¡¹ç›®å®è·µ(08): åœ¨ECSã€Dockerã€K8s ç­‰ç¯å¢ƒä¸­ä½¿ç”¨ GPU&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.mospan.cn/2024/01/17/gpu-operator/&#34;&gt;K8Sé¡¹ç›®å®è·µ(09): ä½¿ç”¨ GPU Operatoræ­å»ºAIç®—åŠ›ç¯å¢ƒ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿™ä¸¤ç¯‡åˆ™åˆ†æäº† device-plugin åŸç†ä»¥åŠåœ¨ K8s ä¸­åˆ›å»ºä¸€ä¸ªç”³è¯· GPU çš„ Pod åçš„ä¸€äº›åˆ—åŠ¨ä½œï¼Œæœ€ç»ˆè¯¥ Pod æ˜¯å¦‚ä½•ä½¿ç”¨åˆ° GPU çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.mospan.cn/2024/01/24/device-plugin/&#34;&gt;K8Sé¡¹ç›®å®è·µ(10): device-pluginåŸç†åˆ°å®ç°&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.mospan.cn/2024/01/27/pod-use-gpu/&#34;&gt;K8Sé¡¹ç›®å®è·µ(11): Pod æ˜¯å¦‚ä½•ä½¿ç”¨åˆ° GPU çš„åŠæºç åˆ†æ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;çœ‹å®Œä¹‹åï¼Œå¤§å®¶åº”è¯¥å°±å¤§è‡´æ˜ç™½äº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;èµ„æºæ„ŸçŸ¥&#34;&gt;èµ„æºæ„ŸçŸ¥&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆåœ¨ k8s ä¸­èµ„æºæ˜¯å’ŒèŠ‚ç‚¹ç»‘å®šçš„ï¼Œå¯¹äº GPU èµ„æºï¼Œæˆ‘ä»¬ä½¿ç”¨ NVIDIA æä¾›çš„ device-plugin è¿›è¡Œæ„ŸçŸ¥ï¼Œå¹¶ä¸ŠæŠ¥åˆ° kube-apiserver,è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ Node å¯¹è±¡ä¸Šçœ‹åˆ°å¯¹åº”çš„èµ„æºäº†ã€‚&lt;/p&gt;

&lt;p&gt;å°±åƒè¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# kubectl  describe node k8s-worker1 | grep Capacity: -A8
Capacity:
  cpu:                   4
  ephemeral-storage:     123460788Ki
  hugepages-1Gi:         0
  hugepages-2Mi:         0
  lixueduan.com/gopher:  2
  memory:                9922140Ki
  nvidia.com/gpu:        1
  pods:                  110
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¯¥èŠ‚ç‚¹é™¤äº†åŸºç¡€çš„ cpuã€memory ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªnvidia.com/gpu: 1 ä¿¡æ¯ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä¸Šæœ‰ 1 ä¸ª GPUã€‚&lt;/p&gt;

&lt;h2 id=&#34;èµ„æºç”³è¯·&#34;&gt;èµ„æºç”³è¯·&lt;/h2&gt;

&lt;p&gt;ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨åˆ›å»º Pod æ—¶ç”³è¯·å¯¹åº”çš„èµ„æºäº†ï¼Œæ¯”å¦‚ç”³è¯·ä¸€ä¸ª GPUï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: cuda-vectoradd
spec:
  restartPolicy: OnFailure
  containers:
  - name: cuda-vectoradd
    image: &amp;quot;nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2&amp;quot;
    resources:
      limits:
        nvidia.com/gpu: 1
    command: [&amp;quot;nvidia-smi&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;apply è¯¥ yaml ä¹‹åï¼Œkube-scheduler åœ¨è°ƒåº¦è¯¥ Pod æ—¶å°±ä¼šå°†å…¶è°ƒåº¦åˆ°ä¸€ä¸ªæ‹¥æœ‰è¶³å¤Ÿ GPU èµ„æºçš„ Node ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;åŒæ—¶è¯¥ Pod ç”³è¯·çš„éƒ¨åˆ†èµ„æºä¹Ÿä¼šæ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œä¸ä¼šå†åˆ†é…ç»™å…¶ä»– Podã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/20224/images/2024-02-05-hami-vgpu-split/IMG_20250205-100211174.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åˆ°è¿™é‡Œï¼Œé—®é¢˜çš„ç­”æ¡ˆå°±å·²ç»å¾ˆæ˜æ˜¾çš„ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰device-plugin æ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ç‰©ç† GPU æ•°é‡ï¼Œä¸ŠæŠ¥åˆ° kube-apiserver&lt;/li&gt;
&lt;li&gt;2ï¼‰kube-scheduler è°ƒåº¦ Pod æ—¶ä¼šæ ¹æ® pod ä¸­çš„ Request æ¶ˆè€—å¯¹åº”èµ„æº
å³ï¼š&lt;em&gt;Node ä¸Šçš„ GPU èµ„æºè¢« Pod ç”³è¯·ä¹‹åï¼Œåœ¨ k8s ä¸­å°±è¢«æ ‡è®°ä¸ºå·²æ¶ˆè€—äº†ï¼Œåç»­åˆ›å»ºçš„ Pod ä¼šå› ä¸ºèµ„æºä¸å¤Ÿå¯¼è‡´æ— æ³•è°ƒåº¦ã€‚&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®é™…ä¸Šï¼šå¯èƒ½ GPU æ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå¯ä»¥æ”¯æŒå¤šä¸ª Pod å…±åŒä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸º k8s ä¸­çš„è°ƒåº¦é™åˆ¶å¯¼è‡´å¤šä¸ª Pod æ— æ³•æ­£å¸¸å…±äº«ã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤ï¼Œæˆ‘ä»¬æ‰éœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;p&gt;ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href=&#34;http://blog.mospan.cn/2024/01/31/gpu-time-slicing/&#34;&gt;K8Sé¡¹ç›®å®è·µ(12): GPUå…±äº«æ–¹æ¡ˆTime Slicing&lt;/a&gt;ä¸­ç»™å¤§å®¶åˆ†äº«äº†ä¸€ä¸ª GPU å…±äº«æ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥å®ç°å¤šä¸ª Pod å…±äº«åŒä¸€ä¸ª GPUï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šPod ä¹‹é—´å¹¶æœªåšä»»ä½•éš”ç¦»ï¼Œæ¯ä¸ª Pod èƒ½ç”¨åˆ°å¤šå°‘ GPU coreã€memory éƒ½é ç«äº‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ† Pod å ç”¨å¤§éƒ¨åˆ†èµ„æºå¯¼è‡´å…¶ä»– Pod æ— æ³•æ­£å¸¸ä½¿ç”¨çš„æƒ…å†µã€‚&lt;/p&gt;

&lt;p&gt;ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªå¼€æºçš„ vGPU æ–¹æ¡ˆ &lt;a href=&#34;https://github.com/Project-HAMi/HAMi&#34;&gt;HAMi&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼šNVIDIA ä¹Ÿæœ‰è‡ªå·±çš„ vGPU æ–¹æ¡ˆï¼Œä½†æ˜¯éœ€è¦ license&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;ä»€ä¹ˆæ˜¯-hami&#34;&gt;ä»€ä¹ˆæ˜¯ HAMiï¼Ÿ&lt;/h1&gt;

&lt;p&gt;HAMi å…¨ç§°æ˜¯ï¼šHeterogeneous AI Computing Virtualization Middlewareï¼ŒHAMi ç»™è‡ªå·±çš„å®šä½æˆ–è€…å¸Œæœ›æ˜¯åšä¸€ä¸ªå¼‚æ„ç®—åŠ›è™šæ‹ŸåŒ–å¹³å°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åŸ ç¬¬å››èŒƒå¼ k8s-vgpu-scheduler, è¿™æ¬¡æ”¹å HAMi åŒæ—¶ä¹Ÿå°†æ ¸å¿ƒçš„ vCUDA åº“ libvgpu.so ä¹Ÿå¼€æºäº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä½†æ˜¯ç°åœ¨æ¯”è¾ƒå®Œå–„çš„æ˜¯å¯¹ NVIDIA GPU çš„ vGPU æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç®€å•è®¤ä¸ºä»–å°±æ˜¯ä¸€ä¸ª vGPU æ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;p&gt;æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-02-05-hami-vgpu-split/IMG_20250205-101305158.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ç»„ä»¶è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæ¶‰åŠåˆ° Webhookã€Schedulerã€Device Pluginã€HAMi-Core ç­‰ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ç¯‡æ–‡ç« åªè®²ä½¿ç”¨ï¼Œå› æ­¤æ¶æ„ã€åŸç†å°±ä¸€ç¬”å¸¦è¿‡ï¼Œåç»­ä¹Ÿä¼šæœ‰ç›¸å…³æ–‡ç« ,æ¬¢è¿å…³æ³¨~ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç‰¹æ€§&#34;&gt;ç‰¹æ€§&lt;/h2&gt;

&lt;p&gt;ä½¿ç”¨ HAMi æœ€å¤§çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹å°±æ˜¯å¯ä»¥å®ç° GPU çš„ç»†ç²’åº¦çš„éš”ç¦»ï¼Œå¯ä»¥å¯¹ core å’Œ memory ä½¿ç”¨ 1% çº§åˆ«çš„éš”ç¦»ã€‚&lt;/p&gt;

&lt;p&gt;å…·ä½“å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
spec:
  containers:
    - name: ubuntu-container
      image: ubuntu:18.04
      command: [&amp;quot;bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;sleep 86400&amp;quot;]
      resources:
        limits:
          nvidia.com/gpu: 1 # è¯·æ±‚1ä¸ªvGPUs
          nvidia.com/gpumem: 3000 # æ¯ä¸ªvGPUç”³è¯·3000mæ˜¾å­˜ ï¼ˆå¯é€‰ï¼Œæ•´æ•°ç±»å‹ï¼‰
          nvidia.com/gpucores: 30 # æ¯ä¸ªvGPUçš„ç®—åŠ›ä¸º30%å®é™…æ˜¾å¡çš„ç®—åŠ› ï¼ˆå¯é€‰ï¼Œæ•´æ•°ç±»å‹ï¼‰
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;nvidia.com/gpuï¼šè¯·æ±‚ä¸€ä¸ª GPU&lt;/li&gt;
&lt;li&gt;nvidia.com/gpumemï¼šåªç”³è¯·ä½¿ç”¨ 3000M GPU Memory&lt;/li&gt;
&lt;li&gt;nvidia.com/gpucoresï¼šç”³è¯·ä½¿ç”¨ 30% çš„ GPU coreï¼Œä¹Ÿå°±æ˜¯è¯¥ Pod åªèƒ½ä½¿ç”¨åˆ° 30% çš„ç®—åŠ›
ç›¸æ¯”äºä¸Šæ–‡åˆ†äº«äº† TimeSlicing æ–¹æ¡ˆï¼ŒHAMi åˆ™æ˜¯å®ç°äº† GPU core å’Œ memory çš„éš”ç¦»ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨å¼€æºæ–¹æ¡ˆé‡Œé¢å·²ç»ç®—æ˜¯æ¯”è¾ƒä¼˜ç§€çš„äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ç‰¹æ€§-1&#34;&gt;ç‰¹æ€§&lt;/h2&gt;

&lt;p&gt;HAMi å®ç°GPU core å’Œ memory éš”ç¦»ã€é™åˆ¶æ˜¯ä½¿ç”¨çš„ vCUDA æ–¹æ¡ˆï¼Œå…·ä½“è®¾è®¡å¦‚ä¸‹ï¼š
&lt;img src=&#34;post/2024/images/2024-02-05-hami-vgpu-split/IMG_20250205-102943833.png&#34; alt=&#34;picture 2&#34; /&gt;&lt;/p&gt;

&lt;p&gt;HAMi ä½¿ç”¨çš„æ˜¯è½¯ä»¶å±‚é¢çš„ vCUDA æ–¹æ¡ˆï¼Œå¯¹ NVIDIA åŸç”Ÿçš„ CUDA é©±åŠ¨è¿›è¡Œé‡å†™(libvgpu.so)ï¼Œç„¶åæŒ‚è½½åˆ° Pod ä¸­è¿›è¡Œæ›¿æ¢ï¼Œç„¶ååœ¨è‡ªå·±çš„å®ç°çš„ CUDA é©±åŠ¨ä¸­å¯¹ API è¿›è¡Œæ‹¦æˆªï¼Œå®ç°èµ„æºéš”ç¦»ä»¥åŠé™åˆ¶çš„æ•ˆæœã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å¦‚ï¼šåŸç”Ÿ libvgpu.so åœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œåªæœ‰åœ¨ GPU å†…å­˜çœŸçš„ç”¨å®Œçš„æ—¶å€™æ‰ä¼šæç¤º CUDA OOMï¼Œä½†æ˜¯å¯¹äº HAMi å®ç°çš„ libvgpu.so æ¥è¯´ï¼Œæ£€æµ‹åˆ° Pod ä¸­ä½¿ç”¨çš„å†…å­˜è¶…è¿‡äº† Resource ä¸­çš„ç”³è¯·é‡å°±ç›´æ¥è¿”å› OOMï¼Œä»è€Œå®ç°èµ„æºçš„ä¸€ä¸ªé™åˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶ååœ¨æ‰§è¡Œ nvidia-smi å‘½ä»¤æŸ¥çœ‹ GPU ä¿¡æ¯æ—¶ï¼Œä¹Ÿåªè¿”å› Pod Resource ä¸­ç”³è¯·çš„èµ„æºï¼Œè¿™æ ·åœ¨æŸ¥çœ‹æ—¶ä¹Ÿè¿›è¡Œéš”ç¦»ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼šéœ€è¦å¯¹ CUDA å’Œ NVML çš„éƒ¨åˆ† API æ‹¦æˆªã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;hami-éƒ¨ç½²&#34;&gt;HAMi éƒ¨ç½²&lt;/h1&gt;

&lt;p&gt;HAMi æä¾›äº† Helm Chart å®‰è£…ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²-gpu-operator&#34;&gt;éƒ¨ç½² GPU Operator&lt;/h2&gt;

&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ HAMi ä¼šä¾èµ– NVIDIA çš„é‚£ä¸€å¥—ï¼Œå› æ­¤æ¨èå…ˆéƒ¨ç½² GPU-Operatorã€‚&lt;/p&gt;

&lt;p&gt;å‚è€ƒè¿™ç¯‡æ–‡ç«  â€“&amp;gt; &lt;a href=&#34;http://blog.mospan.cn/2024/01/17/gpu-operator/&#34;&gt;K8Sé¡¹ç›®å®è·µ(09): ä½¿ç”¨ GPU Operatoræ­å»ºAIç®—åŠ›ç¯å¢ƒ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;éƒ¨ç½²å¥½ GPU Operator ä¹‹ååœ¨éƒ¨ç½² HAMiã€‚&lt;/p&gt;

&lt;h2 id=&#34;å‡†å¤‡é•œåƒ&#34;&gt;å‡†å¤‡é•œåƒ&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;crictl pull ghcr.io/stackhpc/kube-webhook-certgen:v1.1.1

ctr -n k8s.io image tag  ghcr.io/stackhpc/kube-webhook-certgen:v1.1.1  liangjw/kube-webhook-certgen:v1.1.1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;éƒ¨ç½²-hami&#34;&gt;éƒ¨ç½² HAMi&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆä½¿ç”¨ helm æ·»åŠ æˆ‘ä»¬çš„ repo&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;helm repo add hami-charts https://project-hami.github.io/HAMi/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éšåï¼Œä½¿ç”¨ä¸‹åˆ—æŒ‡ä»¤è·å–é›†ç¾¤æœåŠ¡ç«¯ç‰ˆæœ¬
&amp;gt; è¿™é‡Œä½¿ç”¨çš„æ˜¯ v1.28.15ç‰ˆæœ¬&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl version
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨å®‰è£…è¿‡ç¨‹ä¸­é¡»æ ¹æ®é›†ç¾¤æœåŠ¡ç«¯ç‰ˆæœ¬ï¼ˆä¸Šä¸€æ¡æŒ‡ä»¤çš„ç»“æœï¼‰æŒ‡å®šè°ƒåº¦å™¨é•œåƒç‰ˆæœ¬ï¼Œä¾‹å¦‚é›†ç¾¤æœåŠ¡ç«¯ç‰ˆæœ¬ä¸º v1.28.5ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œå®‰è£…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;helm install hami hami-charts/hami --set scheduler.kubeScheduler.imageTag=v1.28.5 -n kube-system
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡kubectl get podsæŒ‡ä»¤çœ‹åˆ° vgpu-device-plugin ä¸ vgpu-scheduler ä¸¤ä¸ªpod çŠ¶æ€ä¸ºRunning å³ä¸ºå®‰è£…æˆåŠŸ&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(12): GPUå…±äº«æ–¹æ¡ˆTime Slicing</title>
            <link>http://mospany.github.io/2024/01/31/gpu-time-slicing/</link>
            <pubDate>Wed, 31 Jan 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/31/gpu-time-slicing/</guid>
            <description>

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº« GPU å…±äº«æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å¦‚ä½•å®‰è£…ã€é…ç½®ä»¥åŠä½¿ç”¨ï¼Œæœ€åé€šè¿‡åˆ†ææºç äº† TimeSlicing çš„å…·ä½“å®ç°ã€‚é€šè¿‡é…ç½® TimeSlicing å¯ä»¥å®ç° Pod å…±äº«ä¸€å—ç‰©ç† GPU(ä½¿ç”¨GRID GPUä»£æ›¿)ï¼Œä»¥æå‡èµ„æºåˆ©ç”¨ç‡ã€‚&lt;/p&gt;

&lt;h1 id=&#34;1-ä¸ºä»€ä¹ˆéœ€è¦-gpu-å…±äº«-åˆ‡åˆ†ç­‰æ–¹æ¡ˆ&#34;&gt;1. ä¸ºä»€ä¹ˆéœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆï¼Ÿ&lt;/h1&gt;

&lt;p&gt;å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œ&lt;em&gt;ä¸ºä»€ä¹ˆéœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆ?&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;æˆ–è€…è¯´æ˜¯å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼š&lt;em&gt;æ˜æ˜ç›´æ¥åœ¨è£¸æœºç¯å¢ƒä½¿ç”¨ï¼Œéƒ½å¯ä»¥å¤šä¸ªè¿›ç¨‹å…±äº« GPUï¼Œæ€ä¹ˆåˆ° k8s ç¯å¢ƒå°±ä¸è¡Œäº†ã€‚&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;1-1-èµ„æºæ„ŸçŸ¥&#34;&gt;1.1. èµ„æºæ„ŸçŸ¥&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆåœ¨ k8s ä¸­èµ„æºæ˜¯å’ŒèŠ‚ç‚¹ç»‘å®šçš„ï¼Œå¯¹äº GPU èµ„æºï¼Œæˆ‘ä»¬ä½¿ç”¨ NVIDIA æä¾›çš„ device-plugin è¿›è¡Œæ„ŸçŸ¥ï¼Œå¹¶ä¸ŠæŠ¥åˆ° kube-apiserver,è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ Node å¯¹è±¡ä¸Šçœ‹åˆ°å¯¹åº”çš„èµ„æºäº†ã€‚&lt;/p&gt;

&lt;p&gt;å°±åƒè¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     8
  pods:               110
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¯¥èŠ‚ç‚¹é™¤äº†åŸºç¡€çš„ cpuã€memory ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªnvidia.com/gpu: 8 ä¿¡æ¯ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä¸Šæœ‰ 8 ä¸ª GPUã€‚&lt;/p&gt;

&lt;h2 id=&#34;1-2-èµ„æºç”³è¯·&#34;&gt;1.2. èµ„æºç”³è¯·&lt;/h2&gt;

&lt;p&gt;ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨åˆ›å»º Pod æ—¶ç”³è¯·å¯¹åº”çš„èµ„æºäº†ï¼Œæ¯”å¦‚ç”³è¯·ä¸€ä¸ª GPUï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
spec:
  containers:
  - name: gpu-container
    image: nvidia/cuda:11.0-base   # ä¸€ä¸ªæ”¯æŒ GPU çš„é•œåƒ
    resources:
      limits:
        nvidia.com/gpu: 1          # ç”³è¯· 1 ä¸ª GPU
    command: [&amp;quot;nvidia-smi&amp;quot;]         # ç¤ºä¾‹å‘½ä»¤ï¼Œæ˜¾ç¤º GPU çš„ä¿¡æ¯
  restartPolicy: OnFailure
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;apply è¯¥ yaml ä¹‹åï¼Œkube-scheduler åœ¨è°ƒåº¦è¯¥ Pod æ—¶å°±ä¼šå°†å…¶è°ƒåº¦åˆ°ä¸€ä¸ªæ‹¥æœ‰è¶³å¤Ÿ GPU èµ„æºçš„ Node ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;åŒæ—¶è¯¥ Pod ç”³è¯·çš„éƒ¨åˆ†èµ„æºä¹Ÿä¼šæ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œä¸ä¼šåœ¨åˆ†é…ç»™å…¶ä»– Podã€‚&lt;/p&gt;

&lt;p&gt;åˆ°è¿™é‡Œï¼Œé—®é¢˜çš„ç­”æ¡ˆå°±å·²ç»å¾ˆæ˜æ˜¾çš„ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰device-plugin æ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ç‰©ç† GPU æ•°é‡ï¼Œä¸ŠæŠ¥åˆ° kube-apiserver&lt;/li&gt;
&lt;li&gt;2ï¼‰kube-scheduler è°ƒåº¦ Pod æ—¶ä¼šæ ¹æ® pod ä¸­çš„ Request æ¶ˆè€—å¯¹åº”èµ„æº&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å³ï¼š&lt;em&gt;Node ä¸Šçš„ GPU èµ„æºè¢« Pod ç”³è¯·ä¹‹åï¼Œåœ¨ k8s ä¸­å°±è¢«æ ‡è®°ä¸ºå·²æ¶ˆè€—äº†ï¼Œåç»­åˆ›å»ºçš„ Pod ä¼šå› ä¸ºèµ„æºä¸å¤Ÿå¯¼è‡´æ— æ³•è°ƒåº¦ã€‚&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;å®é™…ä¸Šï¼šå¯èƒ½ GPU æ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå¯ä»¥æ”¯æŒå¤šä¸ª Pod å…±åŒä½¿ç”¨ï¼Œä½†æ˜¯å› ä¸º k8s ä¸­çš„è°ƒåº¦é™åˆ¶å¯¼è‡´å¤šä¸ª Pod æ— æ³•æ­£å¸¸å…±äº«ã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤ï¼Œæˆ‘ä»¬æ‰éœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;h1 id=&#34;2-ä»€ä¹ˆæ˜¯-time-slicing-æ–¹æ¡ˆ&#34;&gt;2. ä»€ä¹ˆæ˜¯ Time Slicing æ–¹æ¡ˆ&lt;/h1&gt;

&lt;p&gt;NVIDIA æä¾›çš„ &lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html&#34;&gt;Time-Slicing GPUs in Kubernetes&lt;/a&gt; æ˜¯ä¸€ç§é€šè¿‡ oversubscription(è¶…é¢è®¢é˜…) æ¥å®ç° GPU å…±äº«çš„ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥èƒ½è®©å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ª GPU ä¸Šè¿›è¡Œï¼Œè€Œä¸æ˜¯æ¯ä¸ªä»»åŠ¡éƒ½ç‹¬å ä¸€ä¸ª GPUã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;è™½ç„¶æ–¹æ¡ˆåç§°å«åš Time Slicingï¼Œä½†æ˜¯device-plugin çš„å®ç°ä¸Šå’Œæ—¶é—´åˆ‡ç‰‡æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ª GPU è¶…å–æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;2-1-ä¸ºä»€ä¹ˆè¦å«time-slicing-æ—¶é—´ç‰‡&#34;&gt;2.1. ä¸ºä»€ä¹ˆè¦å«Time Slicing(æ—¶é—´ç‰‡)ï¼Ÿ&lt;/h2&gt;

&lt;p&gt;è™½ç„¶å®ç°ä¸Šåªæ˜¯ *oversubscription(è¶…é¢è®¢é˜…)*ï¼Œä½†æ˜¯åç§°ä¸­çš„ Time Slicing(æ—¶é—´ç‰‡)æŒ‡çš„æ˜¯ GPU æœ¬èº«çš„æ—¶é—´ç‰‡è°ƒåº¦ã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å¦‚ï¼šAã€Bã€C ä¸‰ä¸ªè¿›ç¨‹å…±äº« GPUï¼Œä¸‰ä¸ªè¿›ç¨‹åŒæ—¶æŠŠ CUDA ä»»åŠ¡å‘å°„åˆ° GPU ä¸Šå»ï¼ŒGPU å¹¶ä¸ä¼šåŒæ—¶æ‰§è¡Œï¼Œè€Œæ˜¯é‡‡ç”¨æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦çš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆç¬¬ä¸€ä¸ªæ—¶é—´ç‰‡ï¼ŒA ä»»åŠ¡è¢«æ‰§è¡Œï¼Œæ¥ç€ç¬¬äºŒä¸ªæ—¶é—´ç‰‡ï¼Œæ‰§è¡Œ B ä»»åŠ¡ï¼Œç¬¬ä¸‰ä¸ªæ—¶é—´ç‰‡ï¼Œ C ä»»åŠ¡å°†è¢«æ‰§è¡Œã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æ—¶é—´ç‰‡æ˜¯ä¾æ¬¡è¿›è¡Œè½®è½¬è°ƒåº¦çš„ï¼Œåˆ†åˆ«æ‰§è¡ŒAã€Bã€Cä¸­çš„ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;2-2-æ•ˆæœ&#34;&gt;2.2. æ•ˆæœ&lt;/h2&gt;

&lt;p&gt;æ¯”å¦‚èŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªç‰©ç† GPUï¼Œæ­£å¸¸å®‰è£… GPU Operator ä¹‹åï¼Œdevice plugin æ£€æµ‹åˆ°è¯¥èŠ‚ç‚¹ä¸Šæœ‰ 1 ä¸ª GPUï¼Œä¸ŠæŠ¥ç»™ kubeletï¼Œç„¶å kubelet æ›´æ–°åˆ° kube-apiserverï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Node å¯¹è±¡ä¸Šçœ‹åˆ°äº†ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     1
  pods:               110
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ­¤æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª Pod ç”³è¯· 1 ä¸ª GPU ä¹‹åï¼Œç¬¬äºŒä¸ª Pod å°±æ— æ³•ä½¿ç”¨äº†ï¼Œå› ä¸º GPU èµ„æºä¸è¶³æ— æ³•è°ƒåº¦ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ä½†æ˜¯ Time Slicing å¯ä»¥è¿›è¡Œ oversubscription è®¾ç½®ï¼Œå°† device-plugin ä¸ŠæŠ¥çš„ GPU æ•°é‡è¿›è¡Œæ‰©å¤§ã€‚&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚å°†å…¶æ•°é‡æ”¾å¤§ 10 å€ï¼Œdevice plugin å°±ä¼šä¸ŠæŠ¥è¯¥èŠ‚ç‚¹æœ‰ 1*10 = 10 ä¸ª GPUï¼Œæœ€ç»ˆ kube-apiserver åˆ™ä¼šè®°å½•è¯¥èŠ‚ç‚¹æœ‰ 10 ä¸ª GPUï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     10
  pods:               110
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·ï¼Œå°±å¯ä»¥ä¾› 10 ä¸ª Pod ä½¿ç”¨äº†ã€‚&lt;/p&gt;

&lt;p&gt;å½“ç„¶äº†ï¼ŒTime Slicing æ–¹æ¡ˆä¹Ÿæœ‰ç¼ºç‚¹ï¼šå¤šä¸ª Pod ä¹‹é—´æ²¡æœ‰å†…å­˜æˆ–è€…æ•…éšœéš”ç¦»ï¼Œå®Œå…¨çš„å…±äº«ï¼Œèƒ½ä½¿ç”¨å¤šå°‘å†…å­˜å’Œç®—åŠ›å…¨é å¤šä¸ª Pod è‡ªè¡Œç«äº‰ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼šå°±å’Œç›´æ¥åœ¨å®¿ä¸»æœºä¸Šå¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ª GPU åŸºæœ¬ä¸€è‡´&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;3-time-slicing-demo&#34;&gt;3. Time Slicing Demo&lt;/h1&gt;

&lt;p&gt;Time Slicing ç”±äºæ˜¯ NVIDIA çš„æ–¹æ¡ˆï¼Œå› æ­¤ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨éƒ¨ç½²å®Œæˆ GPU Operator ä¹‹åè¿›è¡Œé…ç½®å³å¯ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒè¿™ç¯‡æ–‡ç« å®Œæˆ GPU Operator çš„éƒ¨ç½² â€“&amp;gt; GPU ç¯å¢ƒæ­å»ºæŒ‡å—ï¼š&lt;a href=&#34;http://blog.mospan.cn/2024/01/17/gpu-operator/&#34;&gt;ä½¿ç”¨ GPU Operatoræ­å»ºAIç®—åŠ›ç¯å¢ƒ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åå³å¯å¼€å§‹é…ç½® TimeSlicingã€‚&lt;/p&gt;

&lt;p&gt;æ•´ä½“é…ç½®åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰åˆ›å»º TimeSlicing é…ç½®

&lt;ul&gt;
&lt;li&gt;æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°ï¼Œä¿®æ”¹äº† TimeSlicing é…ç½®ä¹‹åï¼Œdevice plugin Pod ä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œå› æ­¤æ–°çš„é…ç½®ä¸ä¼šç”Ÿæ•ˆ,éœ€è¦æ‰‹åŠ¨é‡å¯å¯¹åº” Podã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;2ï¼‰ä¿®æ”¹é›†ç¾¤ç­–ç•¥å¼€å¯ Time Slicingï¼Œå¹¶æŒ‡å®šè®© device-plugin ä½¿ç”¨ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„é…ç½®

&lt;ul&gt;
&lt;li&gt;è¿™é‡Œåˆ™æ˜¯é€šè¿‡ Configmap åç§°æ¥æŒ‡å®š&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;3ï¼‰ï¼ˆå¯é€‰ï¼‰ç»™è¦ä½¿ç”¨ GPU TimeSlicing çš„èŠ‚ç‚¹æ‰“ä¸Šå¯¹åº” labelï¼Œå®ç°ä¸åŒ Node ä½¿ç”¨ä¸åŒç­–ç•¥

&lt;ul&gt;
&lt;li&gt;æ¯”å¦‚ä¸åŒèŠ‚ç‚¹ä¸Šçš„ GPU ä¸åŒï¼Œé‚£ä¹ˆå¯ä»¥æ ¹æ® GPU çš„ç®—åŠ›æˆ–è€…å†…å­˜æƒ…å†µè®¾ç½®ä¸åŒçš„å‰¯æœ¬æ•°ä»¥åˆç†åˆ©ç”¨èµ„æº&lt;/li&gt;
&lt;li&gt;å¦‚æœéƒ½æ˜¯ç»Ÿä¸€ GPUï¼Œåˆ™ä½¿ç”¨é›†ç¾¤çº§åˆ«çš„ç»Ÿä¸€é…ç½®å³å¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;3-1-é…ç½®å¼€å¯-timeslicing&#34;&gt;3.1. é…ç½®å¼€å¯ TimeSlicing&lt;/h2&gt;

&lt;h3 id=&#34;3-1-1-åˆ›å»º-timeslicing-é…ç½®&#34;&gt;3.1.1. åˆ›å»º TimeSlicing é…ç½®&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ Configmap æ¥å­˜æ”¾ TimeSlicing çš„é…ç½®ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œä½¿ç”¨é›†ç¾¤çº§åˆ«çš„ç»Ÿä¸€é…ç½®ï¼Œé…ç½®æ–‡ä»¶ time-slicing-config-all.yaml å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-all
data:
  any: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        renameByDefault: false
        failRequestsGreaterThanOne: false
        resources:
          - name: nvidia.com/gpu
            replicas: 4    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…·ä½“é…ç½®å«ä¹‰å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html#about-configuring-gpu-time-slicing&#34;&gt;about-configuring-gpu-time-slicing&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;data.&lt;key&gt;ï¼š é…ç½®çš„åå­—ï¼Œå¯ä»¥ä¸ºä¸åŒ Node è®¾ç½®å•ç‹¬é…ç½®ï¼Œåç»­é€šè¿‡åç§°å¼•ç”¨å¯¹åº”é…ç½®ã€‚

&lt;ul&gt;
&lt;li&gt;åç»­å¼€å¯ TimeSlicing æ—¶åˆ™æ ¹æ® key æŒ‡å®šä½¿ç”¨ä¸åŒé…ç½®&lt;/li&gt;
&lt;li&gt;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é›†ç¾¤ç»Ÿä¸€é…ç½®ï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ª key å³å¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;flags.migStrategyï¼šé…ç½®å¼€å¯æ—¶é—´ç‰‡ä¹‹åå¦‚ä½•å¤„ç† MIG è®¾å¤‡ï¼Œé»˜è®¤ä¸º none&lt;/li&gt;
&lt;li&gt;renameByDefaultï¼šæ˜¯å¦å¯¹ GPU èµ„æºæ”¹åã€‚

&lt;ul&gt;
&lt;li&gt;è®¾ç½®ä¸º true ä¹‹åï¼Œä¼šä½¿ç”¨&lt;resource-name&gt;.shared æ›¿ä»£åŸæœ¬çš„ &lt;resource-name&gt;ã€‚ä¾‹å¦‚ nvidia.com/gpu ä¼šå˜æˆ nvidia.com/gpu.shared ï¼Œæ˜¾å¼å‘ŠçŸ¥ä½¿ç”¨è€…è¿™æ˜¯å…±äº« GPUã€‚&lt;/li&gt;
&lt;li&gt;é»˜è®¤ä¸º falseï¼Œå³ä¸æ”¹èµ„æºç±»å‹åï¼Œä¸è¿‡ Node ä¸Šçš„ label ä¹Ÿä¼šæ”¹ï¼Œæ¯”å¦‚ä½¿ç”¨æ—¶é—´ç‰‡ä¹‹å‰æ˜¯nvidia.com/gpu.product=Tesla-T4, ä½¿ç”¨åå°±ä¼šå˜æˆnvidia.com/gpu.product=Tesla-T4-SHARED è¿™æ ·ä¾æ—§å¯ä»¥é€šè¿‡ nodeSelector æ¥é™åˆ¶ Pod è°ƒåº¦èŠ‚ç‚¹ï¼Œæ¥æ§åˆ¶æ˜¯å¦ä½¿ç”¨å…±äº«çš„ GPU&lt;/li&gt;
&lt;li&gt;æ¨èä½¿ç”¨ fasle å³å¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;failRequestsGreaterThanOneï¼šå¼€å¯åï¼Œå½“ Pod è¯·æ±‚ 1 ä¸ªä»¥ä¸Šçš„ shared GPU æ—¶ç›´æ¥æŠ¥é”™ UnexpectedAdmissionErrorã€‚è¿™ä¸ªå­—æ®µæ˜¯é€šè¿‡æŠ¥é”™çš„æ–¹å¼å‘Šè¯‰ä½¿ç”¨è€…ï¼Œè¯·æ±‚å¤šä¸ª shared GPU å¹¶ä¸ä¼šå¢åŠ  Pod å¯¹è¯¥å…±äº« GPU çš„å ç”¨æ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;resources.nameï¼šè¦é€šè¿‡æ—¶é—´åˆ†ç‰‡æä¾›è®¿é—®çš„èµ„æºç±»ä¼¼ï¼Œæ¯”å¦‚nvidia.com/gpu&lt;/li&gt;
&lt;li&gt;resources.replicasï¼šå¯å…±äº«è®¿é—®çš„èµ„æºæ•°é‡ï¼Œæ¯”å¦‚è¿™é‡ŒæŒ‡å®šçš„ 4 ä¹Ÿå°±æ˜¯ 1 ä¸ªè¯¥ç±»å‹çš„ GPU å¯ä»¥ä¾› 4 ä¸ª Pod å…±äº«è®¿é—®ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆ Pod ä¸Šçœ‹åˆ°çš„ GPU æ•°é‡æ˜¯ç‰©ç† GPU æ•°é‡çš„ 4 å€ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å°†é…ç½® Apply åˆ° gpu-operator æ‰€åœ¨çš„ namespace&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl create -n gpu-operator -f time-slicing-config-all.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-1-2-ä¿®æ”¹é›†ç¾¤ç­–ç•¥&#34;&gt;3.1.2. ä¿®æ”¹é›†ç¾¤ç­–ç•¥&lt;/h3&gt;

&lt;p&gt;ä¿®æ”¹clusterpolicies.nvidia.com/cluster-policy å¯¹è±¡ï¼Œè®© device plugin ä½¿ç”¨ä¸Šä¸€æ­¥åˆ›å»ºçš„é…ç½®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl patch clusterpolicies.nvidia.com/cluster-policy \
    -n gpu-operator --type merge \
    -p &#39;{&amp;quot;spec&amp;quot;: {&amp;quot;devicePlugin&amp;quot;: {&amp;quot;config&amp;quot;: {&amp;quot;name&amp;quot;: &amp;quot;time-slicing-config-all&amp;quot;, &amp;quot;default&amp;quot;: &amp;quot;any&amp;quot;}}}}&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;nameï¼štime-slicing-config-all æŒ‡å®šäº†é…ç½®æ–‡ä»¶å¯¹åº”çš„ Configmap åç§°&lt;/li&gt;
&lt;li&gt;defaultï¼šanyï¼šè¡¨ç¤ºé»˜è®¤é…ç½®ä¸ºè¿™ä¸ª Configmap ä¸­çš„ key ä¸º any çš„é…ç½®
ä¿®æ”¹å gpu-feature-discovery å’Œ nvidia-device-plugin-daemonset pod ä¼šé‡å¯ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹é‡å¯è¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl get events -n gpu-operator --sort-by=&#39;.lastTimestamp&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-215925170.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;3-2-éªŒè¯-timeslicing-æ˜¯å¦ç”Ÿæ•ˆ&#34;&gt;3.2. éªŒè¯ TimeSlicing æ˜¯å¦ç”Ÿæ•ˆ&lt;/h2&gt;

&lt;h3 id=&#34;3-2-1-æŸ¥çœ‹-node-ä¸Šçš„-gpu-ä¿¡æ¯&#34;&gt;3.2.1. æŸ¥çœ‹ Node ä¸Šçš„ GPU ä¿¡æ¯&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹ Node ä¿¡æ¯ï¼Œç¡®è®¤ TimeSlicing ç”Ÿæ•ˆäº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl  describe node k8s-worker1 | grep Capacity -A20
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-221241899.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;br /&gt;
gpuä¸º1*4=4æ˜¾ç¤ºæˆåŠŸã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;...
Labels:
                  nvidia.com/gpu.count=1
                  nvidia.com/gpu.product=GRID-T4-2Q-SHARED
                  nvidia.com/gpu.replicas=4
Capacity:
  nvidia.com/gpu: 4
  ...
Allocatable:
  nvidia.com/gpu: 4
  ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¢åŠ äº†å‡ ä¸ª labelï¼Œ&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;nvidia.com/gpu.product=GRID-T4-2Q-SHARED&lt;/li&gt;
&lt;li&gt;nvidia.com/gpu.replicas=4&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ ¹æ®nvidia.com/gpu.count=1 å¯çŸ¥ï¼ŒèŠ‚ç‚¹ä¸Šæœ‰ 1 å¼  GPUï¼Œç„¶åç”±äºä½¿ç”¨äº†æ—¶é—´ç‰‡ï¼Œä¸”é…ç½®çš„nvidia.com/gpu.replicas=4 å‰¯æœ¬æ•°ä¸º 4ï¼Œå› æ­¤æœ€ç»ˆèŠ‚ç‚¹ä¸Š device plugin ä¸ŠæŠ¥çš„ GPU æ•°é‡å°±æ˜¯ 1*4 = 4 ä¸ªã€‚&lt;/p&gt;

&lt;h2 id=&#34;3-3-éªŒè¯-gpu-èƒ½å¦æ­£å¸¸ä½¿ç”¨&#34;&gt;3.3. éªŒè¯ GPU èƒ½å¦æ­£å¸¸ä½¿ç”¨&lt;/h2&gt;

&lt;p&gt;åˆ›å»ºä¸€ä¸ª Deployment æ¥éªŒè¯ï¼ŒGPU èƒ½å¦æ­£å¸¸ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œå‰¯æœ¬æ•°æŒ‡å®šä¸º 2ï¼Œå› ä¸ºé›†ç¾¤é‡Œåªæœ‰ 1 å¼  GPUï¼Œå¦‚æœ TimeSlicing æœªç”Ÿæ•ˆï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ª Pod è‚¯å®šä¼šåº”ä¸ºæ‹¿ä¸åˆ° GPU èµ„æºè€Œ pendingã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: time-slicing-verification
  labels:
    app: time-slicing-verification
spec:
  replicas: 2
  selector:
    matchLabels:
      app: time-slicing-verification
  template:
    metadata:
      labels:
        app: time-slicing-verification
    spec:
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      hostPID: true
      containers:
        - name: cuda-sample-vector-add
          image: &amp;quot;nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2&amp;quot;
          command: [&amp;quot;/bin/bash&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;--&amp;quot;]
          args:
            - while true; do /tmp/vectorAdd; done
          resources:
           limits:
             nvidia.com/gpu: 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¼šå¯åŠ¨ 2ä¸ª Podï¼Œ&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹æƒ…å†µ
&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-224915379.png&#34; alt=&#34;picture 2&#34; /&gt;&lt;/p&gt;

&lt;p&gt;2 ä¸ª Pod éƒ½å¯åŠ¨äº†ï¼Œè¯´æ˜æ—¶é—´ç‰‡æ—¶æˆåŠŸçš„ã€‚&lt;/p&gt;

&lt;p&gt;éšä¾¿æŸ¥çœ‹ä¸€ä¸ª Pod çš„æ—¥å¿—&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 timeSlicing]# kubectl logs time-slicing-verification-56487b549d-nqn6s 
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ‰ Test PASSED åˆ™è¯´æ˜æˆåŠŸäº†ã€‚&lt;/p&gt;

&lt;p&gt;è¯´æ˜ TimeSlicing é…ç½®ç”Ÿæ•ˆäº†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;4-ä½¿ç”¨-node-çº§åˆ«çš„å•ç‹¬é…ç½®&#34;&gt;4. ä½¿ç”¨ Node çº§åˆ«çš„å•ç‹¬é…ç½®&lt;/h1&gt;

&lt;p&gt;å‰é¢åªåˆ›å»ºäº†ä¸€ä¸ªåç§°ä¸º any çš„é…ç½®ï¼Œå¹¶åœ¨ clusterpolicy ä¸­æŒ‡æ˜äº†ä½¿ç”¨è¯¥é…ç½®ä¸ºé»˜è®¤é…ç½®ï¼Œå› æ­¤é›†ç¾¤ä¸­çš„å…¨éƒ¨èŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨è¯¥é…ç½®æ¥åšæ—¶é—´ç‰‡ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯å¯èƒ½*é›†ç¾¤ä¸­ä¸åŒèŠ‚ç‚¹ä¸Šçš„ GPU å‹å·ä¸åŒ*ï¼Œå› æ­¤éœ€è¦å…±äº«åˆ†å‰¯æœ¬æ•°å¯ä»¥è°ƒæ•´ï¼Œæ€§èƒ½å¥½çš„å‰¯æœ¬æ•°å°±è°ƒå¤§ä¸€ç‚¹ï¼Œæ€§èƒ½å·®çš„å°±å°ä¸€ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;æœ¬ç« ä¸»è¦è®°å½•æ€ä¹ˆä¸ºä¸åŒçš„èŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„é…ç½®ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®é™…ä¸Šæ˜¯ä¸ºä¸åŒçš„ GPU å‡†å¤‡ä¸åŒçš„é…ç½®ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;4-1-åˆ›å»ºæ—¶é—´ç‰‡é…ç½®&#34;&gt;4.1. åˆ›å»ºæ—¶é—´ç‰‡é…ç½®&lt;/h2&gt;

&lt;p&gt;åŒæ ·çš„åˆ›å»º TimeSlicing é…ç½®ï¼Œä¸è¿‡è¿™æ¬¡ Configmap ä¸­å†™äº†ä¸¤ä¸ªé…ç½®ï¼Œè€Œä¸”æ˜¯ä»¥ GPU å‹å·å‘½åçš„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-fine
data:
  a100-40gb: |-
    version: v1
    flags:
      migStrategy: mixed
    sharing:
      timeSlicing:
        resources:
        - name: nvidia.com/gpu
          replicas: 8
        - name: nvidia.com/mig-1g.5gb
          replicas: 2
        - name: nvidia.com/mig-2g.10gb
          replicas: 2
        - name: nvidia.com/mig-3g.20gb
          replicas: 3
        - name: nvidia.com/mig-7g.40gb
          replicas: 7    
  tesla-t4: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        resources:
        - name: nvidia.com/gpu
          replicas: 5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œåˆ†åˆ«å¯¹ A100 å’Œ Tesla T4 è¿™ä¸¤ç§ GPU åšäº†é…ç½®ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;a100-40gbï¼šA100 æ”¯æŒ MIGï¼Œå› æ­¤å¢åŠ äº† MIG éƒ¨åˆ†çš„é…ç½®ï¼Œè‹¥æ²¡æœ‰åˆ™æŒ‡å®šä¸º none å³å¯

&lt;ul&gt;
&lt;li&gt;ç„¶åæ ¹æ® MIG å®ä¾‹åˆ†åˆ«æŒ‡å®šä¸åŒçš„ replicas æ•°&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;tesla-t4ï¼šTesla T4 GPU æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå› æ­¤ replicas æŒ‡å®šä¸º 4 å³å¯
å°†é…ç½® Apply åˆ° gpu-operator æ‰€åœ¨çš„ namespace&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl  create -n gpu-operator -f time-slicing-config-fine.yaml 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-201203558.png&#34; alt=&#34;picture 3&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;4-2-ä¿®æ”¹é›†ç¾¤ç­–ç•¥&#34;&gt;4.2. ä¿®æ”¹é›†ç¾¤ç­–ç•¥&lt;/h2&gt;

&lt;p&gt;åŒæ ·çš„ï¼Œä¿®æ”¹ä¸€ä¸‹ cluster-policy æŒ‡å®š device plugin ä½¿ç”¨çš„ Configmapï¼Œè¿™æ¬¡ä¸ä¹‹å‰çš„åŒºåˆ«åœ¨äºï¼Œ*è¿™é‡Œæ²¡æœ‰æŒ‡å®š default é…ç½®*ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl patch clusterpolicies.nvidia.com/cluster-policy \
-n gpu-operator --type merge \
-p &#39;{&amp;quot;spec&amp;quot;: {&amp;quot;devicePlugin&amp;quot;: {&amp;quot;config&amp;quot;: {&amp;quot;name&amp;quot;: &amp;quot;time-slicing-config-fine&amp;quot;}}}}&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ²¡æœ‰æŒ‡å®š default æ—¶ï¼Œdevice-plugin åˆ™ä¼šæ ¹æ® node ä¸Šçš„ label (nvidia.com/device-plugin.config)æ¥è·å–è¦ä½¿ç”¨çš„é…ç½®ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-3-ä¸ºèŠ‚ç‚¹æ‰“-label&#34;&gt;4.3. ä¸ºèŠ‚ç‚¹æ‰“ label&lt;/h2&gt;

&lt;p&gt;åœ¨èŠ‚ç‚¹ä¸Šæ‰“ä¸Šä¸‹é¢çš„ labelï¼Œè¿™æ ·è¯¥èŠ‚ç‚¹ä¸Šçš„ device plugin å°±ä¼šæ ¹æ®è¯¥ label çš„ value æ¥ä½¿ç”¨å¯¹åº”åå­—çš„é…ç½®äº†ã€‚&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚è¿™é‡Œï¼Œå°±æ˜¯æœ‰è¿™ä¸ª label çš„èŠ‚ç‚¹å°±ä½¿ç”¨åå« tesla-t4 çš„é…ç½®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl label node k8s-worker1 nvidia.com/device-plugin.config=tesla-t4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸€èˆ¬éƒ½æ˜¯ä»¥ GPU å‹å·å‘½åï¼Œç„¶åç»™ä½¿ç”¨è¯¥ GPU çš„èŠ‚ç‚¹éƒ½æ‰“ä¸Šå¯¹åº” label,è¿™æ ·ä¾¿äºæŸ¥çœ‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-4-éªŒè¯&#34;&gt;4.4. éªŒè¯&lt;/h2&gt;

&lt;p&gt;æŸ¥çœ‹nodeèŠ‚ç‚¹gpuå¡æ•°æ˜¯å¦å·²ä¸º5.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl  describe node k8s-worker1 | grep Capacity -A20
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-203630774.png&#34; alt=&#34;picture 4&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;5-å…³é—­-timeslicing&#34;&gt;5. å…³é—­ TimeSlicing&lt;/h1&gt;

&lt;p&gt;æƒ³å…³é—­ TimeSlicing é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥æ›´æ–° é›†ç¾¤ç­–ç•¥ æŠŠ device plugin ä¸‹çš„ config è¿™ä¸€æ®µå»æ‰å³å¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  devicePlugin:
    config:
      default: any
      name: time-slicing-config-fine
    enabled: true
    env:
    - name: PASS_DEVICE_SPECS
      value: &amp;quot;true&amp;quot;
    - name: FAIL_ON_INIT_ERROR
      value: &amp;quot;true&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl patch clusterpolicies.nvidia.com/cluster-policy -n gpu-operator --type json -p &#39;[{&amp;quot;op&amp;quot;: &amp;quot;remove&amp;quot;, &amp;quot;path&amp;quot;: &amp;quot;/spec/devicePlugin/config&amp;quot;}]&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åé‡å¯ä¸€ä¸‹ device-plugin pod&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl rollout restart -n gpu-operator daemonset/nvidia-device-plugin-daemonset
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸å‡ºæ„å¤–çš„è¯å°±å…³æ‰äº†ï¼Œå†æ¬¡æŸ¥çœ‹ Pod ä¿¡æ¯ï¼ŒGPU å°±å˜æˆäº†ç‰©ç† GPU æ•°é‡ï¼Œè¯´æ˜å…³é—­æˆåŠŸã€‚
&lt;img src=&#34;post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-204613867.png&#34; alt=&#34;picture 5&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;6-æºç åˆ†æ&#34;&gt;6. æºç åˆ†æ&lt;/h1&gt;

&lt;p&gt;ç®€å•çœ‹ä¸‹æºç ï¼Œåˆ†æ TimeSlicing æ˜¯æ€ä¹ˆå®ç°çš„ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæ˜¯ device-plugin å¯ä»¥æ¥æ”¶çš„é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// api/config/v1/config.go#L32
// Config is a versioned struct used to hold configuration information.
type Config struct {
	Version   string    `json:&amp;quot;version&amp;quot;             yaml:&amp;quot;version&amp;quot;`
	Flags     Flags     `json:&amp;quot;flags,omitempty&amp;quot;     yaml:&amp;quot;flags,omitempty&amp;quot;`
	Resources Resources `json:&amp;quot;resources,omitempty&amp;quot; yaml:&amp;quot;resources,omitempty&amp;quot;`
	Sharing   Sharing   `json:&amp;quot;sharing,omitempty&amp;quot;   yaml:&amp;quot;sharing,omitempty&amp;quot;`
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ clusterPolicy ä¸­é…ç½®çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-all
data:
  any: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        renameByDefault: false
        failRequestsGreaterThanOne: false
        resources:
          - name: nvidia.com/gpu
            replicas: 4    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å…³æ³¨ resources ä¸­çš„ replicas å‚æ•°ï¼Œæ­£æ˜¯è¿™ä¸ªå‚æ•°å®šä¹‰äº† oversubscription(è¶…é¢è®¢é˜…) çš„é¢åº¦ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;        resources:
          - name: nvidia.com/gpu
            replicas: 4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;çœ‹ä¸‹ä»£ç ä¸­æ˜¯ä»€ä¹ˆç”Ÿæ•ˆçš„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// internal/rm/device_map.go#L282

// updateDeviceMapWithReplicas returns an updated map of resource names to devices with replica
// information from the active replicated resources config.
func updateDeviceMapWithReplicas(replicatedResources *spec.ReplicatedResources, oDevices DeviceMap) (DeviceMap, error) {
	devices := make(DeviceMap)

	// Begin by walking replicatedResources.Resources and building a map of just the resource names.
	names := make(map[spec.ResourceName]bool)
	for _, r := range replicatedResources.Resources {
		names[r.Name] = true
	}

	// Copy over all devices from oDevices without a resource reference in TimeSlicing.Resources.
	for r, ds := range oDevices {
		if !names[r] {
			devices[r] = ds
		}
	}

	// Walk shared Resources and update devices in the device map as appropriate.
	for _, resource := range replicatedResources.Resources {
		r := resource
		// Get the IDs of the devices we want to replicate from oDevices
		ids, err := oDevices.getIDsOfDevicesToReplicate(&amp;amp;r)
		if err != nil {
			return nil, fmt.Errorf(&amp;quot;unable to get IDs of devices to replicate for &#39;%v&#39; resource: %v&amp;quot;, r.Name, err)
		}
		// Skip any resources not matched in oDevices
		if len(ids) == 0 {
			continue
		}

		// Add any devices we don&#39;t want replicated directly into the device map.
		for _, d := range oDevices[r.Name].Difference(oDevices[r.Name].Subset(ids)) {
			devices.insert(r.Name, d)
		}

		// Create replicated devices add them to the device map.
		// Rename the resource for replicated devices as requested.
		name := r.Name
		if r.Rename != &amp;quot;&amp;quot; {
			name = r.Rename
		}
		for _, id := range ids {
			for i := 0; i &amp;lt; r.Replicas; i++ {
				annotatedID := string(NewAnnotatedID(id, i))
				replicatedDevice := *(oDevices[r.Name][id])
				replicatedDevice.ID = annotatedID
				replicatedDevice.Replicas = r.Replicas
				devices.insert(name, &amp;amp;replicatedDevice)
			}
		}
	}

	return devices, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒéƒ¨åˆ†å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;for _, id := range ids {
  for i := 0; i &amp;lt; r.Replicas; i++ {
    annotatedID := string(NewAnnotatedID(id, i))
    replicatedDevice := *(oDevices[r.Name][id])
    replicatedDevice.ID = annotatedID
    replicatedDevice.Replicas = r.Replicas
    devices.insert(name, &amp;amp;replicatedDevice)
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜¯åŒå±‚ for å¾ªç¯ï¼Œå¯¹ device æ•°é‡è¿›è¡Œäº†ä¸€ä¸ªå¤åˆ¶çš„æ“ä½œï¼Œè¿™æ ·æ¯å¼  GPU éƒ½å¯ä»¥è¢«ä½¿ç”¨ Replicas æ¬¡äº†ã€‚&lt;/p&gt;

&lt;p&gt;å…¶ä»–å±æ€§éƒ½æ²¡å˜ï¼Œåªæ˜¯æŠŠ deviceID è¿›è¡Œäº†å¤„ç†ï¼Œä¾¿äºåŒºåˆ†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// NewAnnotatedID creates a new AnnotatedID from an ID and a replica number.
func NewAnnotatedID(id string, replica int) AnnotatedID {
	return AnnotatedID(fmt.Sprintf(&amp;quot;%s::%d&amp;quot;, id, replica))
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶ååœ¨çœŸæ­£æŒ‚è½½æ—¶åˆ™è¿›è¡Œ split æ‹¿åˆ° id å’Œ replicas ä¿¡æ¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Split splits a AnnotatedID into its ID and replica number parts.
func (r AnnotatedID) Split() (string, int) {
	split := strings.SplitN(string(r), &amp;quot;::&amp;quot;, 2)
	if len(split) != 2 {
		return string(r), 0
	}
	replica, _ := strconv.ParseInt(split[1], 10, 0)
	return split[0], int(replica)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æå®Œäº† TimeSlicing çš„å…·ä½“å®ç°ï¼Œå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®é…ç½®çš„ replicas å‚æ•°å¯¹ device plugin æ„ŸçŸ¥åˆ°çš„è®¾å¤‡è¿›è¡Œå¤åˆ¶ï¼Œå¹¶åœ¨ DeviceID ä½¿ç”¨ç‰¹å®šæ ¼å¼è¿›è¡Œæ ‡è®°ä¾¿äºåŒºåˆ†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;7-å°ç»“&#34;&gt;7. å°ç»“&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº«äº† NVIDIA Time Slicing è¿™ä¸ª GPU å…±äº«æ–¹æ¡ˆ,åŒ…æ‹¬å³å®ç°åŸç†ï¼Œä»¥åŠé…ç½®å’Œä½¿ç”¨æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åé€šè¿‡åˆ†ææºç çš„æ–¹å¼æ¢ç´¢äº† TimeSlicing çš„ä»£ç å®ç°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;7-1-ä¸ºä»€ä¹ˆéœ€è¦-gpu-å…±äº«-åˆ‡åˆ†&#34;&gt;7.1. ä¸ºä»€ä¹ˆéœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ï¼Ÿ&lt;/h2&gt;

&lt;p&gt;åœ¨ k8s ä¸­ä½¿ç”¨é»˜è®¤ device plugin æ—¶ï¼ŒGPU èµ„æºå’Œç‰©ç† GPU æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¯¼è‡´ä¸€ä¸ªç‰©ç† GPU è¢«ä¸€ä¸ª Pod ç”³è¯·åï¼Œå…¶ä»– Pod å°±æ— æ³•ä½¿ç”¨äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ GPU å…±äº«ã€åˆ‡åˆ†ç­‰æ–¹æ¡ˆã€‚&lt;/p&gt;

&lt;h2 id=&#34;7-2-ä»€ä¹ˆæ˜¯-timeslicing&#34;&gt;7.2. ä»€ä¹ˆæ˜¯ TimeSlicingï¼Ÿ&lt;/h2&gt;

&lt;p&gt;TimeSlicing æ˜¯ä¸€ç§é€šè¿‡ oversubscription(è¶…é¢è®¢é˜…) æ¥å®ç° GPU å…±äº«çš„ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥èƒ½è®©å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ª GPU ä¸Šè¿›è¡Œï¼Œè€Œä¸æ˜¯æ¯ä¸ªä»»åŠ¡éƒ½ç‹¬å ä¸€ä¸ª GPUã€‚&lt;/p&gt;

&lt;h2 id=&#34;7-3-å¦‚ä½•å¼€å¯-timeslicing&#34;&gt;7.3. å¦‚ä½•å¼€å¯ TimeSlicing&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1ï¼‰åˆ›å»º TimeSlicing é…ç½®&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯ä»¥æ˜¯é›†ç¾¤ç»Ÿä¸€é…ç½®ï¼Œä¹Ÿå¯ä»¥æ˜¯ Node çº§åˆ«çš„é…ç½®ï¼Œä¸»è¦æ ¹æ®ä¸åŒèŠ‚ç‚¹ä¸Šçš„ GPU è¿›è¡Œé…ç½®&lt;/li&gt;
&lt;li&gt;å¦‚æœé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ GPU å‹å·éƒ½ä¸€è‡´ï¼Œåˆ™ä½¿ç”¨é›†ç¾¤ç»Ÿä¸€é…ç½®å³å¯ï¼Œè‹¥ä¸ä¸€è‡´åˆ™æ ¹æ® èŠ‚ç‚¹ä¸Šçš„ GPU æ€§èƒ½ä¿®æ”¹é…ç½®&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;2ï¼‰ä¿®æ”¹ cluster-policyï¼Œå¢åŠ  TimeSlicing ç›¸å…³é…ç½®&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä½œä¸ºè¿™ä¸¤ä¸ªæ­¥éª¤ä¹‹åï¼ŒTimeSlicing å°±å¼€å¯äº†ï¼Œå†æ¬¡æŸ¥çœ‹ Node ä¿¡æ¯æ—¶ä¼šå‘ç° GPU æ•°é‡å˜å¤šäº†ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;7-4-timeslicing-å®ç°åŸç†&#34;&gt;7.4. TimeSlicing å®ç°åŸç†&lt;/h2&gt;

&lt;p&gt;æ ¹æ®é…ç½®çš„ replicas å‚æ•°å¯¹ device plugin æ„ŸçŸ¥åˆ°çš„è®¾å¤‡è¿›è¡Œå¤åˆ¶ï¼Œå¹¶åœ¨ DeviceID ä½¿ç”¨ç‰¹å®šæ ¼å¼è¿›è¡Œæ ‡è®°ä¾¿äºåŒºåˆ†ã€‚&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(11): Pod æ˜¯å¦‚ä½•ä½¿ç”¨åˆ° GPU çš„åŠæºç åˆ†æ</title>
            <link>http://mospany.github.io/2024/01/27/pod-use-gpu/</link>
            <pubDate>Sat, 27 Jan 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/27/pod-use-gpu/</guid>
            <description>

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†æäº†åœ¨ K8s ä¸­åˆ›å»ºä¸€ä¸ª Pod å¹¶ç”³è¯· GPU èµ„æºï¼Œæœ€ç»ˆè¯¥ Pod æ—¶æ€ä¹ˆèƒ½å¤Ÿä½¿ç”¨ GPU çš„ï¼Œå…·ä½“çš„å®ç°åŸç†ï¼Œä»¥åŠ device pluginã€nvidia-container-toolkit ç›¸å…³æºç åˆ†æã€‚&lt;/p&gt;

&lt;h1 id=&#34;1-æ¦‚è¿°&#34;&gt;1. æ¦‚è¿°&lt;/h1&gt;

&lt;p&gt;è¿™ç¯‡æ–‡ç« åˆ™æ˜¯å°†æ•´ä¸ªæµç¨‹è¿èµ·æ¥åšä¸€ä¸ªç®€å•åˆ†æï¼Œå³ï¼šå®¿ä¸»æœºä¸Šçš„ GPU æ˜¯æ€ä¹ˆèƒ½å¤Ÿè¢« K8s ä¸­çš„ Pod ä½¿ç”¨çš„ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;k8s æ˜¯å¦‚ä½•æ„ŸçŸ¥åˆ° GPU çš„&lt;/li&gt;
&lt;li&gt;GPU æ˜¯å¦‚ä½•åˆ†é…ç»™ Pod çš„&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&#34;2-å·¥ä½œæµç¨‹&#34;&gt;2. å·¥ä½œæµç¨‹&lt;/h1&gt;

&lt;p&gt;è¿™éƒ¨åˆ†ä¸»è¦åˆ†äº«ä¸€ä¸‹ NVIDIA çš„ device-plugin ä»¥åŠ nvidia-container-toolkit çš„å·¥ä½œæµç¨‹ï¼Œä»¥åŠäºŒè€…æ˜¯æ€ä¹ˆé…åˆçš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;2-1-k8s-æ˜¯å¦‚ä½•æ„ŸçŸ¥åˆ°-gpu-çš„&#34;&gt;2.1. k8s æ˜¯å¦‚ä½•æ„ŸçŸ¥åˆ° GPU çš„&lt;/h2&gt;

&lt;p&gt;NVIDIA å®ç°äº†&lt;a href=&#34;https://github.com/NVIDIA/k8s-device-plugin&#34;&gt;NVIDIA/k8s-device-plugin&lt;/a&gt; æ¥ä½¿å¾—èŠ‚ç‚¹ä¸Šçš„ GPU èƒ½å¤Ÿè¢« k8s æ„ŸçŸ¥åˆ°ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ª device plugin ä¸»è¦åšä¸¤ä»¶äº‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰æ£€æµ‹èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡å¹¶ä¸ŠæŠ¥ç»™ Kubeletï¼Œå†ç”± Kubelet æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯æ—¶æäº¤åˆ° kube-apiserverã€‚

&lt;ul&gt;
&lt;li&gt;è¿™æ · k8s å°±çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤šå°‘ GPU äº†ï¼Œåç»­ Pod ç”³è¯· GPU æ—¶å°±ä¼šå¾€æœ‰ GPU èµ„æºçš„èŠ‚ç‚¹ä¸Šè°ƒåº¦ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;2ï¼‰Pod ç”³è¯· GPU æ—¶ï¼Œä¸ºå¯¹åº”å®¹å™¨æ·»åŠ ä¸€ä¸ªNVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡ï¼Œåç»­åº•å±‚ Runtime åœ¨çœŸæ­£åˆ›å»ºå®¹å™¨æ—¶å°±èƒ½æ ¹æ®è¿™äº›ä¿¡æ¯æŠŠ GPU æŒ‚è½½åˆ°å®¹å™¨ä¸­

&lt;ul&gt;
&lt;li&gt;ä¾‹å¦‚æ·»åŠ ç¯å¢ƒå˜é‡ï¼šNVIDIA_VISIBLE_DEVICES=GPU-03f69c50-207a-2038-9b45-23cac89cb67d
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;NVIDIA è¿™ä¸ª device plugin æ¯”è¾ƒå¤æ‚ï¼Œæ”¯æŒå¤šç§ç­–ç•¥ï¼Œdevice plugin æä¾›çš„ envã€mountsã€device ä»¥åŠ annotations ç­‰æ–¹å¼å®ƒéƒ½åšäº†æ”¯æŒï¼Œåœ¨éƒ¨ç½²æ—¶å¯ä»¥é€šè¿‡ DEVICE_LIST_STRATEGY ç¯å¢ƒå˜é‡è¿›è¡ŒæŒ‡å®šï¼Œä¸è¿‡é»˜è®¤è¿˜æ˜¯ç”¨çš„ envã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–DEVICE_ID_STRATEGY é»˜è®¤ä¹Ÿæ˜¯ uuidï¼Œå› æ­¤åœ¨ Pod ä¸­çœ‹åˆ°çš„ NVIDIA_VISIBLE_DEVICES å°±ä¸æ˜¯ Docker ç¯å¢ƒä¸­å¸¸è§çš„ 0,1,2 è¿™ç§ç¼–å·äº†ï¼Œè€Œæ˜¯ GPU è®¾å¤‡å¯¹åº”çš„ UUIDã€‚&lt;/p&gt;

&lt;h2 id=&#34;2-2-gpu-æ˜¯å¦‚ä½•åˆ†é…ç»™-pod-çš„&#34;&gt;2.2. GPU æ˜¯å¦‚ä½•åˆ†é…ç»™ Pod çš„&lt;/h2&gt;

&lt;p&gt;NVIDIA æä¾›äº† nvidia-container-toolkit æ¥å¤„ç†å¦‚ä½•å°† GPU åˆ†é…ç»™å®¹å™¨çš„é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;æ ¸å¿ƒç»„ä»¶æœ‰ä»¥ä¸‹ä¸‰ä¸ªï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;nvidia-container-runtime&lt;/li&gt;
&lt;li&gt;nvidia-container-runtime-hook&lt;/li&gt;
&lt;li&gt;nvidia-container-cli&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é¦–å…ˆéœ€è¦å°† docker/containerd çš„ runtime è®¾ç½®ä¸ºnvidia-container-runtimeï¼Œæ­¤åæ•´ä¸ªè°ƒç”¨é“¾å°±å˜æˆè¿™æ ·äº†ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-27-pod-use-gpu/IMG_20250127-192425835.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ¥ä¸‹æ¥å°±å…·ä½“åˆ†ææ¯ä¸ªç»„ä»¶çš„ä½œç”¨ã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-2-1-nvidia-container-runtime&#34;&gt;2.2.1. nvidia-container-runtime&lt;/h3&gt;

&lt;p&gt;nvidia-container-runtime çš„ä½œç”¨å°±æ˜¯è´Ÿè´£åœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œå°† nvidia-container-runtime-hook æ³¨å…¥åˆ° prestart hookã€‚
&amp;gt; å°çŸ¥è¯†ï¼šdocker/containerd éƒ½æ˜¯é«˜çº§ Runtimeï¼ŒrunC åˆ™æ˜¯ä½çº§ Runtimeã€‚ä¸åŒå±‚çº§ Runtime é€šè¿‡ OCI Spec è¿›è¡Œäº¤äº’ã€‚&lt;/p&gt;

&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ docker è°ƒç”¨ runC åˆ›å»ºå®¹å™¨æ—¶ï¼Œä¼šæŠŠ docker æ”¶åˆ°çš„ä¿¡æ¯è§£æï¼Œç»„è£…æˆ OCI Specï¼Œç„¶ååœ¨å¾€ä¸‹ä¼ é€’ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è€Œ nvidia-container-runtime çš„ä½œç”¨å°±æ˜¯ä¿®æ”¹å®¹å™¨ Specï¼Œå¾€é‡Œé¢æ·»åŠ ä¸€ä¸ª prestart hookï¼Œè¿™ä¸ª hook å°±æ˜¯ nvidia-container-runtime-hook ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;è¿™æ · runC æ ¹æ® Spec å¯åŠ¨å®¹å™¨æ—¶å°±ä¼šæ‰§è¡Œè¯¥ hookï¼Œå³æ‰§è¡Œ nvidia-container-runtime-hookã€‚&lt;/p&gt;

&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ nvidia-container-runtime å…¶å®æ²¡æœ‰ä»»ä½•é€»è¾‘ï¼ŒçœŸæ­£çš„é€»è¾‘éƒ½åœ¨ nvidia-container-runtime-hook ä¸­ã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-2-2-nvidia-container-runtime-hook&#34;&gt;2.2.2. nvidia-container-runtime-hook&lt;/h3&gt;

&lt;p&gt;nvidia-container-runtime-hook åŒ…å«äº†ç»™å®¹å™¨åˆ†é… GPU çš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰ä»å®¹å™¨ Spec çš„ mounts å’Œ env ä¸­è§£æ GPU ä¿¡æ¯

&lt;ul&gt;
&lt;li&gt;mounts å¯¹åº”å‰é¢ device plugin ä¸­è®¾ç½®çš„ Mount å’Œ Deviceï¼Œenv åˆ™å¯¹åº” Env&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;2ï¼‰è°ƒç”¨ nvidia-container-cli configure å‘½ä»¤ï¼Œä¿è¯å®¹å™¨å†…å¯ä»¥ä½¿ç”¨è¢«æŒ‡å®šçš„ GPU ä»¥åŠå¯¹åº”èƒ½åŠ›

&lt;ul&gt;
&lt;li&gt;ä¹Ÿå°±æ˜¯è¯´nvidia-container-runtime-hook æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ nvidia-container-cli æ¥å®ç°çš„ç»™å®¹å™¨åˆ†é… GPU èƒ½åŠ›çš„ã€‚
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;2-2-3-nvidia-container-cli&#34;&gt;2.2.3. nvidia-container-cli&lt;/h3&gt;

&lt;p&gt;nvidia-container-cli æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºé…ç½® Linux å®¹å™¨å¯¹ GPU ç¡¬ä»¶çš„ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;æä¾›äº†ä¸‰ä¸ªå‘½ä»¤&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;list: æ‰“å° nvidia é©±åŠ¨åº“åŠè·¯å¾„&lt;/li&gt;
&lt;li&gt;info: æ‰“å°æ‰€æœ‰Nvidia GPUè®¾å¤‡&lt;/li&gt;
&lt;li&gt;configureï¼š è¿›å…¥ç»™å®šè¿›ç¨‹çš„å‘½åç©ºé—´ï¼Œæ‰§è¡Œå¿…è¦æ“ä½œä¿è¯å®¹å™¨å†…å¯ä»¥ä½¿ç”¨è¢«æŒ‡å®šçš„ GPU ä»¥åŠå¯¹åº”èƒ½åŠ›ï¼ˆæŒ‡å®š NVIDIA é©±åŠ¨åº“ï¼‰
&lt;img src=&#34;post/2024/images/2024-01-27-pod-use-gpu/IMG_20250130-215950804.png&#34; alt=&#34;picture 3&#34; /&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸€èˆ¬ä¸»è¦ä½¿ç”¨ configure å‘½ä»¤ï¼Œå®ƒå°† NVIDIA GPU Driverã€CUDA Driver ç­‰ é©±åŠ¨åº“çš„ so æ–‡ä»¶ å’Œ GPU è®¾å¤‡ä¿¡æ¯ï¼Œ é€šè¿‡æ–‡ä»¶æŒ‚è½½çš„æ–¹å¼æ˜ å°„åˆ°å®¹å™¨ä¸­ã€‚&lt;/p&gt;

&lt;h2 id=&#34;2-3-å°ç»“&#34;&gt;2.3. å°ç»“&lt;/h2&gt;

&lt;p&gt;æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰device plugin ä¸ŠæŠ¥èŠ‚ç‚¹ä¸Šçš„ GPU ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;2ï¼‰ç”¨æˆ·åˆ›å»º Podï¼Œåœ¨ resources.rquest ä¸­ç”³è¯· GPUï¼ŒScheduler æ ¹æ®å„èŠ‚ç‚¹ GPU èµ„æºæƒ…å†µï¼Œå°† Pod è°ƒåº¦åˆ°ä¸€ä¸ªæœ‰è¶³å¤Ÿ GPU çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;3ï¼‰DevicePlugin æ ¹æ® Pod ä¸­ç”³è¯·çš„ GPU èµ„æºï¼Œä¸ºå®¹å™¨æ·»åŠ  Env å’Œ Devices é…ç½®

&lt;ul&gt;
&lt;li&gt;ä¾‹å¦‚æ·»åŠ ç¯å¢ƒå˜é‡ï¼šNVIDIA_VISIBLE_DEVICES=GPU-03f69c50-207a-2038-9b45-23cac89cb67d&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;4ï¼‰docker / containerd å¯åŠ¨å®¹å™¨&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç”±äºé…ç½®äº† nvidia-container-runtime,å› æ­¤ä¼šä½¿ç”¨ nvidia-container-runtime æ¥åˆ›å»ºå®¹å™¨&lt;/li&gt;
&lt;li&gt;nvidia-container-runtime é¢å¤–åšäº†ä¸€ä»¶äº‹ï¼šå°† nvidia-container-runtime-hook ä½œä¸º prestart hook æ·»åŠ åˆ°å®¹å™¨ spec ä¸­ï¼Œç„¶åå°±å°†å®¹å™¨ spec ä¿¡æ¯å¾€åä¼ ç»™ runC äº†ã€‚&lt;/li&gt;
&lt;li&gt;runC åˆ›å»ºå®¹å™¨å‰ä¼šè°ƒç”¨ prestart hookï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†ä¸Šä¸€æ­¥æ·»åŠ çš„ nvidia-container-runtime-hookï¼Œè¯¥ hook ä¸»è¦åšä¸¤ä»¶äº‹ï¼š

&lt;ul&gt;
&lt;li&gt;ä»å®¹å™¨ Spec çš„ mounts æˆ–è€… env ä¸­è§£æ GPU ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;è°ƒç”¨ nvidia-container-cli configure å‘½ä»¤ï¼Œå°† NVIDIA çš„ GPU Driverã€CUDA Driver ç­‰åº“æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨ï¼Œä¿è¯å®¹å™¨å†…å¯ä»¥ä½¿ç”¨è¢«æŒ‡å®šçš„ GPUä»¥åŠå¯¹åº”èƒ½åŠ›
ä»¥ä¸Šå°±æ˜¯åœ¨ k8s ä¸­ä½¿ç”¨ NVIDIA GPU çš„æµç¨‹ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼š&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;1ï¼‰device plugin ä¸­æ ¹æ® pod ç”³è¯·çš„ GPU èµ„æºåˆ†é… GPUï¼Œå¹¶ä»¥ ENV ç¯å¢ƒå˜é‡æ–¹å¼æ·»åŠ åˆ°å®¹å™¨ä¸Šã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;2ï¼‰nvidia-container-toolkit åˆ™æ ¹æ®è¯¥ Env æ‹¿åˆ°è¦åˆ†é…ç»™è¯¥å®¹å™¨çš„ GPU æœ€ç»ˆæŠŠç›¸å…³æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œ
å½“ç„¶å¹¶ä¸æ˜¯åªæœ‰è¿™ä¸€ç§å®ç°æ–¹æ³•ï¼Œæ¯”å¦‚å¤©æ•°çš„ ix-device-plugin å®ç°ä¸­å°±æ²¡æœ‰æä¾›è‡ªå·±çš„ container-toolkitï¼Œåªåœ¨ device plugin ä¸­é€šè¿‡ Device æŒ‡å®šè¦æŒ‚è½½å“ªäº›è®¾å¤‡,è¿™æ ·å®¹å™¨å¯åŠ¨æ—¶ä¹Ÿä¼šæŠŠè¿™äº›è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼š&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (p *iluvatarDevicePlugin) allocateDevicesByDeviceID(hostminor uint, num int) *pluginapi.DeviceSpec {
	var device pluginapi.DeviceSpec

	hostPathPrefix := &amp;quot;/dev/&amp;quot;
	containerPathPrefix := &amp;quot;/dev/&amp;quot;

	// Expose the device node for iluvatar pod.
	device.HostPath = hostPathPrefix + deviceName + strconv.Itoa(int(hostminor))
	device.ContainerPath = containerPathPrefix + deviceName + strconv.Itoa(num)
	device.Permissions = &amp;quot;rw&amp;quot;

	return &amp;amp;device
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸è¿‡ç”±äºæ²¡æœ‰æŒ‚è½½é©±åŠ¨è¿›å»ï¼Œå› æ­¤éœ€è¦å®¹å™¨å†…è‡ªå¸¦é©±åŠ¨æ‰è¡Œã€‚&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼Œå·²ç»åˆ†æäº† k8s åˆ›å»º Pod ä½¿ç”¨ GPU çš„æ•´ä¸ªæµç¨‹åŠå¤§è‡´åŸç†ï¼Œæ¥ä¸‹æ¥ç®€å•åˆ†æä¸‹ç›¸å…³ç»„ä»¶æºç ã€‚&lt;/p&gt;

&lt;h1 id=&#34;3-device-plugin-æºç åˆ†æ&#34;&gt;3. device plugin æºç åˆ†æ&lt;/h1&gt;

&lt;p&gt;NVIDIA GPU å¯¹åº”çš„ device plugin å«åšï¼š&lt;a href=&#34;https://github.com/NVIDIA/k8s-device-plugin&#34;&gt;NVIDIA/k8s-device-plugin&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;3-1-allocate-æ–¹æ³•&#34;&gt;3.1. Allocate æ–¹æ³•&lt;/h2&gt;

&lt;p&gt;ä¸»è¦çœ‹ä¸ºå®¹å™¨åˆ†é…èµ„æºçš„ Allocate æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// https://github.com/NVIDIA/k8s-device-plugin/blob/main/internal/plugin/server.go#L319-L332

// Allocate which return list of devices.
func (plugin *NvidiaDevicePlugin) Allocate(ctx context.Context, reqs *pluginapi.AllocateRequest) (*pluginapi.AllocateResponse, error) {
        responses := pluginapi.AllocateResponse{}
        for _, req := range reqs.ContainerRequests {
                if err := plugin.rm.ValidateRequest(req.DevicesIDs); err != nil {
                        return nil, fmt.Errorf(&amp;quot;invalid allocation request for %q: %w&amp;quot;, plugin.rm.Resource(), err)
                }
                response, err := plugin.getAllocateResponse(req.DevicesIDs)
                if err != nil {
                        return nil, fmt.Errorf(&amp;quot;failed to get allocate response: %v&amp;quot;, err)
                }
                responses.ContainerResponses = append(responses.ContainerResponses, response)
        }

        return &amp;amp;responses, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒé€»è¾‘åœ¨ getAllocateResponse ä¸­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (plugin *NvidiaDevicePlugin) getAllocateResponse(requestIds []string) (*pluginapi.ContainerAllocateResponse, error) {
	deviceIDs := plugin.deviceIDsFromAnnotatedDeviceIDs(requestIds)

	// Create an empty response that will be updated as required below.
	response := &amp;amp;pluginapi.ContainerAllocateResponse{
		Envs: make(map[string]string),
	}
	if plugin.deviceListStrategies.AnyCDIEnabled() {
		responseID := uuid.New().String()
		if err := plugin.updateResponseForCDI(response, responseID, deviceIDs...); err != nil {
			return nil, fmt.Errorf(&amp;quot;failed to get allocate response for CDI: %v&amp;quot;, err)
		}
	}
	if plugin.config.Sharing.SharingStrategy() == spec.SharingStrategyMPS {
		plugin.updateResponseForMPS(response)
	}

	// The following modifications are only made if at least one non-CDI device
	// list strategy is selected.
	if plugin.deviceListStrategies.AllCDIEnabled() {
		return response, nil
	}

	if plugin.deviceListStrategies.Includes(spec.DeviceListStrategyEnvvar) {
		plugin.updateResponseForDeviceListEnvvar(response, deviceIDs...)
	}
	if plugin.deviceListStrategies.Includes(spec.DeviceListStrategyVolumeMounts) {
		plugin.updateResponseForDeviceMounts(response, deviceIDs...)
	}
	if *plugin.config.Flags.Plugin.PassDeviceSpecs {
		response.Devices = append(response.Devices, plugin.apiDeviceSpecs(*plugin.config.Flags.NvidiaDevRoot, requestIds)...)
	}
	if *plugin.config.Flags.GDSEnabled {
		response.Envs[&amp;quot;NVIDIA_GDS&amp;quot;] = &amp;quot;enabled&amp;quot;
	}
	if *plugin.config.Flags.MOFEDEnabled {
		response.Envs[&amp;quot;NVIDIA_MOFED&amp;quot;] = &amp;quot;enabled&amp;quot;
	}
	return response, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®ä¸åŒ flag ä»¥åŠç­–ç•¥åˆ†ä¸ºä¸åŒçš„è®¾ç½®æ–¹å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Constants to represent the various device list strategies
const (
	DeviceListStrategyEnvvar         = &amp;quot;envvar&amp;quot;
	DeviceListStrategyVolumeMounts   = &amp;quot;volume-mounts&amp;quot;
	DeviceListStrategyCDIAnnotations = &amp;quot;cdi-annotations&amp;quot;
	DeviceListStrategyCDICRI         = &amp;quot;cdi-cri&amp;quot;
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸»è¦çœ‹è®¾ç½® Env çš„ç­–ç•¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;if plugin.deviceListStrategies.Includes(spec.DeviceListStrategyEnvvar) {
    plugin.updateResponseForDeviceListEnvvar(response, deviceIDs...)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// updateResponseForDeviceListEnvvar sets the environment variable for the requested devices.
func (plugin *NvidiaDevicePlugin) updateResponseForDeviceListEnvvar(response *pluginapi.ContainerAllocateResponse, deviceIDs ...string) {
        response.Envs[plugin.deviceListEnvvar] = strings.Join(deviceIDs, &amp;quot;,&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ç»™å®¹å™¨æ·»åŠ äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œvalue ä¸ºè®¾å¤‡ idï¼Œå…·ä½“ deviceID æä¾›äº†ä¸¤ç§ç­–ç•¥ï¼Œå¯ä»¥æ˜¯ç¼–å·æˆ–è€… uuid&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;const (
        DeviceIDStrategyUUID  = &amp;quot;uuid&amp;quot;
        DeviceIDStrategyIndex = &amp;quot;index&amp;quot;
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;key æ˜¯ä¸€ä¸ªå˜é‡ plugin.deviceListEnvvarï¼Œåˆå§‹åŒ–å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;        plugin := NvidiaDevicePlugin{
                deviceListEnvvar:     &amp;quot;NVIDIA_VISIBLE_DEVICES&amp;quot;,
                socket:               pluginPath + &amp;quot;.sock&amp;quot;,
          // ...
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ NVIDIA è¿™ä¸ª device plugin å®ç° Allocate ä¸»è¦å°±æ˜¯ç»™å®¹å™¨å¢åŠ äº†ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;NVIDIA_VISIBLE_DEVICES=GPU-03f69c50-207a-2038-9b45-23cac89cb67d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ–è€…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;NVIDIA_VISIBLE_DEVICES=1,2
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-2-å°ç»“&#34;&gt;3.2. å°ç»“&lt;/h2&gt;

&lt;p&gt;NVIDIA device plugin æ ¸å¿ƒé€»è¾‘å°±æ˜¯ç»™å®¹å™¨æ·»åŠ NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡ï¼Œå‘ŠçŸ¥åç»­ç»„ä»¶ï¼Œéœ€è¦ç»™è¯¥ç»„ä»¶åˆ†é… GPUã€‚&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚å½“æˆ‘ä»¬ä»…ä½¿ç”¨ Docker æ—¶å°±å¯ä»¥åœ¨å¯åŠ¨å®¹å™¨æ—¶æŒ‡å®š GPUï¼Œ&amp;ndash;gpus flag å’Œ NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡æ•ˆæœä¸€è‡´ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# --gpus
docker run --gpus device=0 -it tensorflow/tensorflow:latest-gpu bash
# æˆ–è€…ç¯å¢ƒå˜é‡ NVIDIA_VISIBLE_DEVICES
docker run -e NVIDIA_VISIBLE_DEVICES=0 -it tensorflow/tensorflow:latest-gpu bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è‡³äºä¸ºä»€ä¹ˆæ·»åŠ äº†NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡å°±ä¼šç»™è¯¥å®¹å™¨åˆ†é… GPUï¼Œå°±æ˜¯æ¥ä¸‹æ¥çš„ nvidi-container-toolkit ç»„ä»¶å®ç°çš„ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;nvidia åœ¨ device plugin ä¸­ä¹Ÿä½¿ç”¨NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡æ­£å¥½èƒ½å¤Ÿå…¼å®¹ nvidia-container-toolkitã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;4-nvidia-container-toolkit-æºç åˆ†æ&#34;&gt;4. nvidia-container-toolkit æºç åˆ†æ&lt;/h1&gt;

&lt;p&gt;è¿™éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦åˆ†æï¼Œä¸ºä»€ä¹ˆæ·»åŠ äº†NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡å°±ä¼šç»™è¯¥å®¹å™¨åˆ†é… GPUï¼Œnvidia-container-toolkit ä¸­åšäº†å“ªäº›å¤„ç†ã€‚&lt;/p&gt;

&lt;p&gt;nvidia-container-toolkit åŒ…å«ä»¥ä¸‹ 3 ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰&lt;a href=&#34;https://github.com/NVIDIA/nvidia-container-toolkit/tree/main/cmd/nvidia-container-runtime&#34;&gt;nvidia-container-runtime&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2ï¼‰&lt;a href=&#34;https://github.com/NVIDIA/nvidia-container-toolkit/tree/main/cmd/nvidia-container-runtime-hook&#34;&gt;nvidia-container-runtime-hook&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;3ï¼‰&lt;a href=&#34;https://github.com/NVIDIA/libnvidia-container/tree/master/src/cli&#34;&gt;nvidia-container-cli&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;4-1-nvidia-container-runtime&#34;&gt;4.1. nvidia-container-runtime&lt;/h2&gt;

&lt;p&gt;nvidia-container-runtime å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª docker/containerd çš„åº•å±‚ runtimeï¼ˆç±»ä¼¼ runCï¼‰ï¼Œåœ¨æ¨¡å—åœ¨åˆ›å»ºå®¹å™¨çš„æ•´ä¸ªè°ƒç”¨é“¾ä¸­å¤„åœ¨å¦‚ä¸‹ä½ç½®ï¼š
&lt;img src=&#34;post/2024/images/2024-01-27-pod-use-gpu/IMG_20250128-155337940.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å®ƒåªåšä¸€ä»¶äº‹ï¼Œå°±æ˜¯åœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œå°† nvidia-container-runtime-hook æ³¨å…¥åˆ° prestart hookã€‚
&amp;gt; ä»¥ä¿®æ”¹å®¹å™¨ Spec çš„æ–¹å¼æ·»åŠ ä¸€ä¸ª prestart hook è¿›å»&lt;/p&gt;

&lt;p&gt;è¿™æ ·ï¼Œåç»­ runC ä½¿ç”¨å®¹å™¨ Spec åˆ›å»ºå®¹å™¨æ—¶å°±ä¼šæ‰§è¡Œè¯¥ prestart hookã€‚&lt;/p&gt;

&lt;p&gt;ç®€å•åˆ†æä¸‹æºç ï¼Œé¦–å…ˆæ˜¯å¯åŠ¨å‘½ä»¤ï¼š&lt;a href=&#34;https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/cmd/nvidia-container-runtime/main.go&#34;&gt;nvidia-container-runtime/main.go&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å°±æ˜¯ New äº†ä¸€ä¸ª nvidia runtime å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå…¶ Run æ–¹æ³•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/cmd/nvidia-container-runtime/main.go#L9-L15

import (
    &amp;quot;os&amp;quot;

    &amp;quot;github.com/NVIDIA/nvidia-container-toolkit/internal/runtime&amp;quot;
)

func main() {
    r := runtime.New()
    err := r.Run(os.Args)
    if err != nil {
       os.Exit(1)
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…·ä½“çš„ New æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåä¸º Interface çš„ Interfaceï¼ŒåŒ…å«ä¸€ä¸ª Run æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// https://github.com/NVIDIA/nvidia-containertoolkit/blob/main/internal/runtime/api.go#L17-L26

type rt struct {
    logger       *Logger
    modeOverride string
}

// Interface is the interface for the runtime library.
type Interface interface {
    Run([]string) error
}
func New(opts ...Option) Interface {
    r := rt{}
    for _, opt := range opts {
       opt(&amp;amp;r)
    }
    if r.logger == nil {
       r.logger = NewLogger()
    }
    return &amp;amp;r
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Run æ–¹æ³•å…·ä½“å®ç°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/internal/runtime/runtime.go#L34-L91

// Run is an entry point that allows for idiomatic handling of errors
// when calling from the main function.
func (r rt) Run(argv []string) (rerr error) {
    defer func() {
       if rerr != nil {
          r.logger.Errorf(&amp;quot;%v&amp;quot;, rerr)
       }
    }()

    printVersion := hasVersionFlag(argv)
    if printVersion {
       fmt.Printf(&amp;quot;%v version %v\n&amp;quot;, &amp;quot;NVIDIA Container Runtime&amp;quot;, info.GetVersionString(fmt.Sprintf(&amp;quot;spec: %v&amp;quot;, specs.Version)))
    }

    cfg, err := config.GetConfig()
    if err != nil {
       return fmt.Errorf(&amp;quot;error loading config: %v&amp;quot;, err)
    }
    r.logger.Update(
       cfg.NVIDIAContainerRuntimeConfig.DebugFilePath,
       cfg.NVIDIAContainerRuntimeConfig.LogLevel,
       argv,
    )
    defer func() {
       if rerr != nil {
          r.logger.Errorf(&amp;quot;%v&amp;quot;, rerr)
       }
       if err := r.logger.Reset(); err != nil {
          rerr = errors.Join(rerr, fmt.Errorf(&amp;quot;failed to reset logger: %v&amp;quot;, err))
       }
    }()

    // We apply some config updates here to ensure that the config is valid in
    // all cases.
    if r.modeOverride != &amp;quot;&amp;quot; {
       cfg.NVIDIAContainerRuntimeConfig.Mode = r.modeOverride
    }
    //nolint:staticcheck  // TODO(elezar): We should swith the nvidia-container-runtime from using nvidia-ctk to using nvidia-cdi-hook.
    cfg.NVIDIACTKConfig.Path = config.ResolveNVIDIACTKPath(&amp;amp;logger.NullLogger{}, cfg.NVIDIACTKConfig.Path)
    cfg.NVIDIAContainerRuntimeHookConfig.Path = config.ResolveNVIDIAContainerRuntimeHookPath(&amp;amp;logger.NullLogger{}, cfg.NVIDIAContainerRuntimeHookConfig.Path)

    // Log the config at Trace to allow for debugging if required.
    r.logger.Tracef(&amp;quot;Running with config: %+v&amp;quot;, cfg)

    driver := root.New(
       root.WithLogger(r.logger),
       root.WithDriverRoot(cfg.NVIDIAContainerCLIConfig.Root),
    )

    r.logger.Tracef(&amp;quot;Command line arguments: %v&amp;quot;, argv)
    runtime, err := newNVIDIAContainerRuntime(r.logger, cfg, argv, driver)
    if err != nil {
       return fmt.Errorf(&amp;quot;failed to create NVIDIA Container Runtime: %v&amp;quot;, err)
    }

    if printVersion {
       fmt.Print(&amp;quot;\n&amp;quot;)
    }
    return runtime.Exec(argv)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒéƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;runtime, err := newNVIDIAContainerRuntime(r.logger, cfg, argv, driver)
if err != nil {
   return fmt.Errorf(&amp;quot;failed to create NVIDIA Container Runtime: %v&amp;quot;, err)
}

if printVersion {
   fmt.Print(&amp;quot;\n&amp;quot;)
}
return runtime.Exec(argv)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»§ç»­æŸ¥çœ‹ newNVIDIAContainerRuntime å®ç°&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/internal/runtime/runtime_factory.go#L32-L62

// newNVIDIAContainerRuntime is a factory method that constructs a runtime based on the selected configuration and specified logger
func newNVIDIAContainerRuntime(logger logger.Interface, cfg *config.Config, argv []string, driver *root.Driver) (oci.Runtime, error) {
    lowLevelRuntime, err := oci.NewLowLevelRuntime(logger, cfg.NVIDIAContainerRuntimeConfig.Runtimes)
    if err != nil {
       return nil, fmt.Errorf(&amp;quot;error constructing low-level runtime: %v&amp;quot;, err)
    }

    logger.Tracef(&amp;quot;Using low-level runtime %v&amp;quot;, lowLevelRuntime.String())
    if !oci.HasCreateSubcommand(argv) {
       logger.Tracef(&amp;quot;Skipping modifier for non-create subcommand&amp;quot;)
       return lowLevelRuntime, nil
    }

    ociSpec, err := oci.NewSpec(logger, argv)
    if err != nil {
       return nil, fmt.Errorf(&amp;quot;error constructing OCI specification: %v&amp;quot;, err)
    }

    specModifier, err := newSpecModifier(logger, cfg, ociSpec, driver)
    if err != nil {
       return nil, fmt.Errorf(&amp;quot;failed to construct OCI spec modifier: %v&amp;quot;, err)
    }

    // Create the wrapping runtime with the specified modifier.
    r := oci.NewModifyingRuntimeWrapper(
       logger,
       lowLevelRuntime,
       ociSpec,
       specModifier,
    )

    return r, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æš‚æ—¶åªéœ€è¦å…³æ³¨ specModifier è¿™ä¸ªå¯¹è±¡,å°±æ˜¯å®ƒåœ¨ä¿®æ”¹å®¹å™¨çš„ spec ä»¥æ·»åŠ  hook&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// newSpecModifier is a factory method that creates constructs an OCI spec modifer based on the provided config.
func newSpecModifier(logger logger.Interface, cfg *config.Config, ociSpec oci.Spec, driver *root.Driver) (oci.SpecModifier, error) {
    rawSpec, err := ociSpec.Load()
    if err != nil {
       return nil, fmt.Errorf(&amp;quot;failed to load OCI spec: %v&amp;quot;, err)
    }

    image, err := image.NewCUDAImageFromSpec(rawSpec)
    if err != nil {
       return nil, err
    }

    mode := info.ResolveAutoMode(logger, cfg.NVIDIAContainerRuntimeConfig.Mode, image)
    modeModifier, err := newModeModifier(logger, mode, cfg, ociSpec, image)
    if err != nil {
       return nil, err
    }
    // For CDI mode we make no additional modifications.
    if mode == &amp;quot;cdi&amp;quot; {
       return modeModifier, nil
    }

    graphicsModifier, err := modifier.NewGraphicsModifier(logger, cfg, image, driver)
    if err != nil {
       return nil, err
    }

    featureModifier, err := modifier.NewFeatureGatedModifier(logger, cfg, image)
    if err != nil {
       return nil, err
    }

    modifiers := modifier.Merge(
       modeModifier,
       graphicsModifier,
       featureModifier,
    )
    return modifiers, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿®æ”¹ hook çš„ modifier åœ¨ newModeModifier é‡Œé¢&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func newModeModifier(logger logger.Interface, mode string, cfg *config.Config, ociSpec oci.Spec, image image.CUDA) (oci.SpecModifier, error) {
    switch mode {
    case &amp;quot;legacy&amp;quot;:
       return modifier.NewStableRuntimeModifier(logger, cfg.NVIDIAContainerRuntimeHookConfig.Path), nil
    case &amp;quot;csv&amp;quot;:
       return modifier.NewCSVModifier(logger, cfg, image)
    case &amp;quot;cdi&amp;quot;:
       return modifier.NewCDIModifier(logger, cfg, ociSpec)
    }

    return nil, fmt.Errorf(&amp;quot;invalid runtime mode: %v&amp;quot;, cfg.NVIDIAContainerRuntimeConfig.Mode)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…·ä½“ä¸º stableRuntimeModifierï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (m stableRuntimeModifier) Modify(spec *specs.Spec) error {
    // If an NVIDIA Container Runtime Hook already exists, we don&#39;t make any modifications to the spec.
    if spec.Hooks != nil {
       for _, hook := range spec.Hooks.Prestart {
          hook := hook
          if isNVIDIAContainerRuntimeHook(&amp;amp;hook) {
             m.logger.Infof(&amp;quot;Existing nvidia prestart hook (%v) found in OCI spec&amp;quot;, hook.Path)
             return nil
          }
       }
    }

    path := m.nvidiaContainerRuntimeHookPath
    m.logger.Infof(&amp;quot;Using prestart hook path: %v&amp;quot;, path)
    args := []string{filepath.Base(path)}
    if spec.Hooks == nil {
       spec.Hooks = &amp;amp;specs.Hooks{}
    }
    spec.Hooks.Prestart = append(spec.Hooks.Prestart, specs.Hook{
       Path: path,
       Args: append(args, &amp;quot;prestart&amp;quot;),
    })

    return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒéƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;path := m.nvidiaContainerRuntimeHookPath
spec.Hooks.Prestart = append(spec.Hooks.Prestart, specs.Hook{
   Path: path,
   Args: append(args, &amp;quot;prestart&amp;quot;),
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆå°±æ˜¯æ·»åŠ äº†ä¸€ä¸ª prestart hookï¼Œhook çš„ path å°±æ˜¯ nvidia-container-runtime-hook è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ã€‚&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼Œnvidia-container-runtime çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œå®¹å™¨çœŸæ­£å¯åŠ¨æ—¶ï¼Œåº•å±‚ runtimeï¼ˆæ¯”å¦‚ runCï¼‰æ£€æµ‹åˆ°å®¹å™¨çš„ Spec ä¸­æœ‰è¿™ä¸ª hook å°±ä¼šå»æ‰§è¡Œäº†ï¼Œæœ€ç»ˆ nvidia-container-runtime-hook å°±ä¼šè¢«è¿è¡Œäº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-2-nvidia-container-runtime-hook&#34;&gt;4.2. nvidia-container-runtime-hook&lt;/h2&gt;

&lt;p&gt;è¯¥ç»„ä»¶åˆ™æ˜¯ nvidia-container-toolkit ä¸­çš„æ ¸å¿ƒï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½åœ¨è¿™é‡Œé¢å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;ä¸»è¦åšä¸¤ä»¶äº‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰ä»å®¹å™¨çš„ env ä¸­è§£æ GPU ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;2ï¼‰è°ƒç”¨ nvidia-container-cli configure å‘½ä»¤ï¼ŒæŒ‚è½½ç›¸å…³æ–‡ä»¶ï¼Œä¿è¯å®¹å™¨å†…å¯ä»¥ä½¿ç”¨è¢«æŒ‡å®šçš„GPUä»¥åŠå¯¹åº”èƒ½åŠ›
ä¹Ÿæ˜¯å…ˆä»å¯åŠ¨å‘½ä»¤çœ‹èµ·ï¼š&lt;a href=&#34;https://github.com/NVIDIA/nvidia-container-toolkit/blob/main/cmd/nvidia-container-runtime-hook/main.go&#34;&gt;nvidia-container-runtime-hook/main.go&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;switch args[0] {
case &amp;quot;prestart&amp;quot;:
    doPrestart()
    os.Exit(0)
case &amp;quot;poststart&amp;quot;:
    fallthrough
case &amp;quot;poststop&amp;quot;:
    os.Exit(0)
default:
    flag.Usage()
    os.Exit(2)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬æ˜¯æ·»åŠ çš„ prestart hookï¼Œå› æ­¤ä¼šèµ° prestart åˆ†æ”¯ æ‰§è¡ŒdoPrestart()æ–¹æ³•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func doPrestart() {
    var err error

    defer exit()
    log.SetFlags(0)

    hook, err := getHookConfig()
    if err != nil || hook == nil {
       log.Panicln(&amp;quot;error getting hook config:&amp;quot;, err)
    }
    cli := hook.NVIDIAContainerCLIConfig

    container := getContainerConfig(*hook)
    nvidia := container.Nvidia
    if nvidia == nil {
       // Not a GPU container, nothing to do.
       return
    }

    if !hook.NVIDIAContainerRuntimeHookConfig.SkipModeDetection &amp;amp;&amp;amp; info.ResolveAutoMode(&amp;amp;logInterceptor{}, hook.NVIDIAContainerRuntimeConfig.Mode, container.Image) != &amp;quot;legacy&amp;quot; {
       log.Panicln(&amp;quot;invoking the NVIDIA Container Runtime Hook directly (e.g. specifying the docker --gpus flag) is not supported. Please use the NVIDIA Container Runtime (e.g. specify the --runtime=nvidia flag) instead.&amp;quot;)
    }

    rootfs := getRootfsPath(container)

    args := []string{getCLIPath(cli)}
    if cli.Root != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--root=%s&amp;quot;, cli.Root))
    }
    if cli.LoadKmods {
       args = append(args, &amp;quot;--load-kmods&amp;quot;)
    }
    if cli.NoPivot {
       args = append(args, &amp;quot;--no-pivot&amp;quot;)
    }
    if *debugflag {
       args = append(args, &amp;quot;--debug=/dev/stderr&amp;quot;)
    } else if cli.Debug != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--debug=%s&amp;quot;, cli.Debug))
    }
    if cli.Ldcache != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--ldcache=%s&amp;quot;, cli.Ldcache))
    }
    if cli.User != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--user=%s&amp;quot;, cli.User))
    }
    args = append(args, &amp;quot;configure&amp;quot;)

    if ldconfigPath := cli.NormalizeLDConfigPath(); ldconfigPath != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--ldconfig=%s&amp;quot;, ldconfigPath))
    }
    if cli.NoCgroups {
       args = append(args, &amp;quot;--no-cgroups&amp;quot;)
    }
    if len(nvidia.Devices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--device=%s&amp;quot;, nvidia.Devices))
    }
    if len(nvidia.MigConfigDevices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--mig-config=%s&amp;quot;, nvidia.MigConfigDevices))
    }
    if len(nvidia.MigMonitorDevices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--mig-monitor=%s&amp;quot;, nvidia.MigMonitorDevices))
    }
    if len(nvidia.ImexChannels) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--imex-channel=%s&amp;quot;, nvidia.ImexChannels))
    }

    for _, cap := range strings.Split(nvidia.DriverCapabilities, &amp;quot;,&amp;quot;) {
       if len(cap) == 0 {
          break
       }
       args = append(args, capabilityToCLI(cap))
    }

    for _, req := range nvidia.Requirements {
       args = append(args, fmt.Sprintf(&amp;quot;--require=%s&amp;quot;, req))
    }

    args = append(args, fmt.Sprintf(&amp;quot;--pid=%s&amp;quot;, strconv.FormatUint(uint64(container.Pid), 10)))
    args = append(args, rootfs)

    env := append(os.Environ(), cli.Environment...)
    //nolint:gosec // TODO: Can we harden this so that there is less risk of command injection?
    err = syscall.Exec(args[0], args, env)
    log.Panicln(&amp;quot;exec failed:&amp;quot;, err)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸‹é¢è¿™ä¸ªå°±è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;args := []string{getCLIPath(cli)}
container := getContainerConfig(*hook)
err = syscall.Exec(args[0], args, env)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸€ä¸ªæ˜¯ getContainerConfig è§£æå®¹å™¨é…ç½® ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ exec çœŸæ­£å¼€å§‹æ‰§è¡Œå‘½ä»¤ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;è¿™é‡Œæ‰§è¡Œçš„å‘½ä»¤å…¶å®å°±æ˜¯ nvidia-container-cli&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;4-2-1-getcontainerconfig&#34;&gt;4.2.1. getContainerConfig&lt;/h3&gt;

&lt;p&gt;è¿™éƒ¨åˆ†å°±æ˜¯è§£æ Env æ‹¿åˆ°è¦åˆ†é…ç»™è¯¥å®¹å™¨çš„ GPUï¼Œå¦‚æœæ²¡æœ‰ NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡å°±ä¸ä¼šåšä»»ä½•äº‹æƒ…ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func getContainerConfig(hook HookConfig) (config containerConfig) {
    var h HookState
    d := json.NewDecoder(os.Stdin)
    if err := d.Decode(&amp;amp;h); err != nil {
       log.Panicln(&amp;quot;could not decode container state:&amp;quot;, err)
    }

    b := h.Bundle
    if len(b) == 0 {
       b = h.BundlePath
    }

    s := loadSpec(path.Join(b, &amp;quot;config.json&amp;quot;))

    image, err := image.New(
       image.WithEnv(s.Process.Env),
       image.WithDisableRequire(hook.DisableRequire),
    )
    if err != nil {
       log.Panicln(err)
    }

    privileged := isPrivileged(s)
    return containerConfig{
       Pid:    h.Pid,
       Rootfs: s.Root.Path,
       Image:  image,
       Nvidia: getNvidiaConfig(&amp;amp;hook, image, s.Mounts, privileged),
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ„å»ºäº†ä¸€ä¸ª image å¯¹è±¡ï¼Œæ³¨æ„è¿™é‡ŒæŠŠ ENV ä¹Ÿä¼ è¿›å»äº†&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¹‹å‰è¯´äº†éœ€è¦ç»™å®¹å™¨åˆ†é…ä»€ä¹ˆ GPU æ˜¯é€šè¿‡ NVIDIA_VISIBLE_DEVICES ç¯å¢ƒå˜é‡æŒ‡å®šçš„&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;image, err := image.New(
    image.WithEnv(s.Process.Env),
    image.WithDisableRequire(hook.DisableRequire),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åè§£æé…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func getNvidiaConfig(hookConfig *HookConfig, image image.CUDA, mounts []Mount, privileged bool) *nvidiaConfig {
    legacyImage := image.IsLegacy()

    var devices string
    if d := getDevices(hookConfig, image, mounts, privileged); d != nil {
       devices = *d
    } else {
       // &#39;nil&#39; devices means this is not a GPU container.
       return nil
    }

    var migConfigDevices string
    if d := getMigConfigDevices(image); d != nil {
       migConfigDevices = *d
    }
    if !privileged &amp;amp;&amp;amp; migConfigDevices != &amp;quot;&amp;quot; {
       log.Panicln(&amp;quot;cannot set MIG_CONFIG_DEVICES in non privileged container&amp;quot;)
    }

    var migMonitorDevices string
    if d := getMigMonitorDevices(image); d != nil {
       migMonitorDevices = *d
    }
    if !privileged &amp;amp;&amp;amp; migMonitorDevices != &amp;quot;&amp;quot; {
       log.Panicln(&amp;quot;cannot set MIG_MONITOR_DEVICES in non privileged container&amp;quot;)
    }

    var imexChannels string
    if c := getImexChannels(image); c != nil {
       imexChannels = *c
    }

    driverCapabilities := hookConfig.getDriverCapabilities(image, legacyImage).String()

    requirements, err := image.GetRequirements()
    if err != nil {
       log.Panicln(&amp;quot;failed to get requirements&amp;quot;, err)
    }

    return &amp;amp;nvidiaConfig{
       Devices:            devices,
       MigConfigDevices:   migConfigDevices,
       MigMonitorDevices:  migMonitorDevices,
       ImexChannels:       imexChannels,
       DriverCapabilities: driverCapabilities,
       Requirements:       requirements,
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒæ˜¯ getDeviceï¼Œå°±æ˜¯æ ¹æ® Mounts ä¿¡æ¯æˆ–è€… Env è§£æè¦åˆ†é…ç»™è¯¥å®¹å™¨çš„ GPU&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func getDevices(hookConfig *HookConfig, image image.CUDA, mounts []Mount, privileged bool) *string {
    // If enabled, try and get the device list from volume mounts first
    if hookConfig.AcceptDeviceListAsVolumeMounts {
       devices := getDevicesFromMounts(mounts)
       if devices != nil {
          return devices
       }
    }

    // Fallback to reading from the environment variable if privileges are correct
    devices := getDevicesFromEnvvar(image, hookConfig.getSwarmResourceEnvvars())
    if devices == nil {
       return nil
    }
    if privileged || hookConfig.AcceptEnvvarUnprivileged {
       return devices
    }

    configName := hookConfig.getConfigOption(&amp;quot;AcceptEnvvarUnprivileged&amp;quot;)
    log.Printf(&amp;quot;Ignoring devices specified in NVIDIA_VISIBLE_DEVICES (privileged=%v, %v=%v) &amp;quot;, privileged, configName, hookConfig.AcceptEnvvarUnprivileged)

    return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ®é…ç½®ä¸åŒï¼Œæä¾›äº†ä¸¤ç§è§£æ devices çš„æ–¹æ³•ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;getDevicesFromMounts&lt;/li&gt;
&lt;li&gt;getDevicesFromEnvvar
è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ nvidia device plugin é™¤äº†å®ç° Env ä¹‹å¤–è¿˜å®ç°äº†å¦å¤–çš„æ–¹å¼ï¼ŒäºŒè€…é…ç½®åº”è¯¥è¦å¯¹åº”æ‰è¡Œã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ getDevicesFromEnvvarï¼Œä»ç¯å¢ƒå˜é‡é‡Œè§£æ Deviceï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;envNVVisibleDevices     = &amp;quot;NVIDIA_VISIBLE_DEVICES&amp;quot;

func getDevicesFromEnvvar(image image.CUDA, swarmResourceEnvvars []string) *string {
	// We check if the image has at least one of the Swarm resource envvars defined and use this
	// if specified.
	var hasSwarmEnvvar bool
	for _, envvar := range swarmResourceEnvvars {
		if image.HasEnvvar(envvar) {
			hasSwarmEnvvar = true
			break
		}
	}

	var devices []string
	if hasSwarmEnvvar {
		devices = image.DevicesFromEnvvars(swarmResourceEnvvars...).List()
	} else {
		devices = image.DevicesFromEnvvars(envNVVisibleDevices).List()
	}

	if len(devices) == 0 {
		return nil
	}

	devicesString := strings.Join(devices, &amp;quot;,&amp;quot;)

	return &amp;amp;devicesString
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;devices = image.DevicesFromEnvvars(envNVVisibleDevices).List()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä» image é‡Œé¢æå–NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡ï¼Œè‡³äºè¿™ä¸ª Env æ˜¯å“ªé‡Œæ¥çš„ï¼Œä¹Ÿæ˜¯å®¹å™¨ Spec ä¸­å®šä¹‰çš„ï¼Œä¹‹å‰ image æ˜¯è¿™æ ·åˆå§‹åŒ–çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;s := loadSpec(path.Join(b, &amp;quot;config.json&amp;quot;))

	image, err := image.New(
		image.WithEnv(s.Process.Env), // è¿™é‡ŒæŠŠå®¹å™¨ env ä¼ ç»™äº† image å¯¹è±¡
		image.WithDisableRequire(hook.DisableRequire),
	)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®é™…è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šé€»è¾‘ï¼š&lt;em&gt;å¦‚æœæ²¡æœ‰è®¾ç½® NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡ï¼Œä¹Ÿæ²¡é€šè¿‡å…¶ä»–æ–¹å¼è§£æåˆ° device å¹¶ä¸”è¿˜æ˜¯æ˜¯ä¸€ä¸ª legacy imageï¼Œé‚£ä¹ˆé»˜è®¤ä½¿ç”¨å…¨éƒ¨ GPUã€‚&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Environment variable unset with legacy image: default to &amp;quot;all&amp;quot;.
if !isSet &amp;amp;&amp;amp; len(devices) == 0 &amp;amp;&amp;amp; i.IsLegacy() {
  return NewVisibleDevices(&amp;quot;all&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‚£ä¹ˆä»€ä¹ˆç®—æ˜¯ legacy image å‘¢ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// IsLegacy returns whether the associated CUDA image is a &amp;quot;legacy&amp;quot; image. An
// image is considered legacy if it has a CUDA_VERSION environment variable defined
// and no NVIDIA_REQUIRE_CUDA environment variable defined.
func (i CUDA) IsLegacy() bool {
	legacyCudaVersion := i.env[envCUDAVersion]
	cudaRequire := i.env[envNVRequireCUDA]
	return len(legacyCudaVersion) &amp;gt; 0 &amp;amp;&amp;amp; len(cudaRequire) == 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆï¼Œæœ‰æ—¶å€™å¯åŠ¨ Pod å¹¶æ²¡æœ‰ç”³è¯· GPUï¼Œä½†æ˜¯ Pod é‡Œé¢ä¾æ—§å¯ä»¥çœ‹åˆ°æ‰€æœ‰ GPUï¼Œå°±æ˜¯èµ°äº†è¿™ä¸ª legacy image çš„åˆ†æ”¯é€»è¾‘ã€‚&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“äº†è¿™è¾¹ runtime æ˜¯æ€ä¹ˆæŒ‡å®šè¦æŠŠå“ªäº› GPU åˆ†é…ç»™å®¹å™¨äº†ï¼Œæ¥ä¸‹æ¥è¿›å…¥ Exec é€»è¾‘ã€‚&lt;/p&gt;

&lt;h3 id=&#34;4-2-2-exec&#34;&gt;4.2.2. Exec&lt;/h3&gt;

&lt;p&gt;Exec éƒ¨åˆ†æ¯”è¾ƒçŸ­ï¼Œå°±æ˜¯è¿™ä¸¤è¡Œä»£ç ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;args := []string{getCLIPath(cli)}
err = syscall.Exec(args[0], args, env)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é¦–å…ˆæ˜¯ getCLIPathï¼Œç”¨äºå¯»æ‰¾ nvidia-container-cli å·¥å…·çš„ä½ç½®å¹¶ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func getCLIPath(config config.ContainerCLIConfig) string {
    if config.Path != &amp;quot;&amp;quot; {
       return config.Path
    }

    if err := os.Setenv(&amp;quot;PATH&amp;quot;, lookup.GetPath(config.Root)); err != nil {
       log.Panicln(&amp;quot;couldn&#39;t set PATH variable:&amp;quot;, err)
    }

    path, err := exec.LookPath(&amp;quot;nvidia-container-cli&amp;quot;)
    if err != nil {
       log.Panicln(&amp;quot;couldn&#39;t find binary nvidia-container-cli in&amp;quot;, os.Getenv(&amp;quot;PATH&amp;quot;), &amp;quot;:&amp;quot;, err)
    }
    return path
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå•ç‹¬é…ç½®äº† cli çš„ä½ç½®å‚æ•°å°±ä½¿ç”¨é…ç½®çš„ä½ç½®ï¼Œå¦åˆ™ä½¿ç”¨ LookPath æ ¹æ®åå­—å¯»æ‰¾ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶åæ˜¯ç›¸å…³çš„å‚æ•°&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;    args := []string{getCLIPath(cli)}
    if cli.Root != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--root=%s&amp;quot;, cli.Root))
    }
    if cli.LoadKmods {
       args = append(args, &amp;quot;--load-kmods&amp;quot;)
    }
    if cli.NoPivot {
       args = append(args, &amp;quot;--no-pivot&amp;quot;)
    }
    if *debugflag {
       args = append(args, &amp;quot;--debug=/dev/stderr&amp;quot;)
    } else if cli.Debug != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--debug=%s&amp;quot;, cli.Debug))
    }
    if cli.Ldcache != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--ldcache=%s&amp;quot;, cli.Ldcache))
    }
    if cli.User != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--user=%s&amp;quot;, cli.User))
    }
    args = append(args, &amp;quot;configure&amp;quot;)

    if ldconfigPath := cli.NormalizeLDConfigPath(); ldconfigPath != &amp;quot;&amp;quot; {
       args = append(args, fmt.Sprintf(&amp;quot;--ldconfig=%s&amp;quot;, ldconfigPath))
    }
    if cli.NoCgroups {
       args = append(args, &amp;quot;--no-cgroups&amp;quot;)
    }
    if len(nvidia.Devices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--device=%s&amp;quot;, nvidia.Devices))
    }
    if len(nvidia.MigConfigDevices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--mig-config=%s&amp;quot;, nvidia.MigConfigDevices))
    }
    if len(nvidia.MigMonitorDevices) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--mig-monitor=%s&amp;quot;, nvidia.MigMonitorDevices))
    }
    if len(nvidia.ImexChannels) &amp;gt; 0 {
       args = append(args, fmt.Sprintf(&amp;quot;--imex-channel=%s&amp;quot;, nvidia.ImexChannels))
    }

    for _, cap := range strings.Split(nvidia.DriverCapabilities, &amp;quot;,&amp;quot;) {
       if len(cap) == 0 {
          break
       }
       args = append(args, capabilityToCLI(cap))
    }

    for _, req := range nvidia.Requirements {
       args = append(args, fmt.Sprintf(&amp;quot;--require=%s&amp;quot;, req))
    }

    args = append(args, fmt.Sprintf(&amp;quot;--pid=%s&amp;quot;, strconv.FormatUint(uint64(container.Pid), 10)))
    args = append(args, rootfs)

    env := append(os.Environ(), cli.Environment...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;args = append(args, &amp;quot;configure&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¡¨ç¤ºæ‰§è¡Œçš„æ˜¯nvidia-container-cli configure å‘½ä»¤ã€‚&lt;/p&gt;

&lt;p&gt;æœ€ååˆ™æ˜¯è°ƒç”¨ syscall.Exec çœŸæ­£å¼€å§‹æ‰§è¡Œå‘½ä»¤&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;err = syscall.Exec(args[0], args, env)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥å‘½ä»¤å…·ä½“åœ¨åšä»€ä¹ˆå‘¢ï¼Œæ¥ç€åˆ†æ nvidia-container-cli å®ç°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-3-nvidia-container-cli&#34;&gt;4.3. nvidia-container-cli&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/NVIDIA/libnvidia-container/tree/master/src/cli&#34;&gt;nvidia-container-cli&lt;/a&gt; æ˜¯ä¸€ä¸ª C å†™çš„å°å·¥å…·ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ä¸Šæ‰§è¡Œå‘½ä»¤æ—¶ä¼ é€’çš„å‚æ•°ï¼ŒæŠŠGPU è®¾å¤‡åŠå…¶ç›¸å…³ä¾èµ–åº“æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œä½¿å¾—å®¹å™¨èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ GPU èƒ½åŠ›ã€‚&lt;/p&gt;

&lt;p&gt;ç®€å•çœ‹ä¸‹éƒ¨åˆ†ä»£ç ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæ˜¯é©±åŠ¨ä¿¡æ¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// https://github.com/NVIDIA/libnvidia-container/blob/master/src/cli/configure.c#L279-L288

/* Query the driver and device information. */
if (perm_set_capabilities(&amp;amp;err, CAP_EFFECTIVE, ecaps[NVC_INFO], ecaps_size(NVC_INFO)) &amp;lt; 0) {
        warnx(&amp;quot;permission error: %s&amp;quot;, err.msg);
        goto fail;
}
if ((drv = libnvc.driver_info_new(nvc, NULL)) == NULL ||
    (dev = libnvc.device_info_new(nvc, NULL)) == NULL) {
        warnx(&amp;quot;detection error: %s&amp;quot;, libnvc.error(nvc));
        goto fail;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;nvc_driver_info_new()ï¼šè·å– CUDA Driver ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;nvc_device_info_new()ï¼šè·å– GPU Drvier ä¿¡æ¯
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç„¶åè·å–å®¹å™¨ä¸­å¯è§çš„ GPU åˆ—è¡¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// https://github.com/NVIDIA/libnvidia-container/blob/master/src/cli/configure.c#L308-L314

        /* Select the visible GPU devices. */
        if (dev-&amp;gt;ngpus &amp;gt; 0) {
                if (select_devices(&amp;amp;err, ctx-&amp;gt;devices, dev, &amp;amp;devices) &amp;lt; 0) {
                        warnx(&amp;quot;device error: %s&amp;quot;, err.msg);
                        goto fail;
                }
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€ååˆ™æ˜¯å°†ç›¸å…³é©±åŠ¨æŒ‚è½½åˆ°å®¹å™¨é‡Œå»ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// https://github.com/NVIDIA/libnvidia-container/blob/master/src/cli/configure.c#L362-L408

/* Mount the driver, visible devices, mig-configs and mig-monitors. */
if (perm_set_capabilities(&amp;amp;err, CAP_EFFECTIVE, ecaps[NVC_MOUNT], ecaps_size(NVC_MOUNT)) &amp;lt; 0) {
        warnx(&amp;quot;permission error: %s&amp;quot;, err.msg);
        goto fail;
}
if (libnvc.driver_mount(nvc, cnt, drv) &amp;lt; 0) {
        warnx(&amp;quot;mount error: %s&amp;quot;, libnvc.error(nvc));
        goto fail;
}
for (size_t i = 0; i &amp;lt; devices.ngpus; ++i) {
        if (libnvc.device_mount(nvc, cnt, devices.gpus[i]) &amp;lt; 0) {
                warnx(&amp;quot;mount error: %s&amp;quot;, libnvc.error(nvc));
                goto fail;
        }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;libnvidia-containeræ˜¯é‡‡ç”¨ linux c mount &amp;ndash;bindåŠŸèƒ½å°† CUDA Driver Libraries/Binariesä¸€ä¸ªä¸ªæŒ‚è½½åˆ°å®¹å™¨é‡Œï¼Œè€Œä¸æ˜¯å°†æ•´ä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;å¯é€šè¿‡NVIDIA_DRIVER_CAPABILITIESç¯å¢ƒå˜é‡æŒ‡å®šè¦æŒ‚è½½çš„ driver libraries/binariesã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;docker run -e NVIDIA_VISIBLE_DEVICES=0,1 -e NVIDIA_DRIVER_CAPABILITIES=compute,utility -it tensorflow/tensorflow:latest-gpu bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‡å®šNVIDIA_DRIVER_CAPABILITIES=compute,utility å°±ä¼šæŠŠ compute å’Œ utility ç›¸å…³çš„åº“æŒ‚è½½è¿›å»ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ ·å®¹å™¨é‡Œå°±å¯ä»¥ä½¿ç”¨ GPU äº†ã€‚&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼Œç›¸å…³æºç å°±åˆ†æå®Œæˆäº†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;5-å°ç»“&#34;&gt;5. å°ç»“&lt;/h1&gt;

&lt;p&gt;æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;1ï¼‰device plugin ä¸ŠæŠ¥èŠ‚ç‚¹ä¸Šçš„ GPU ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;2ï¼‰ç”¨æˆ·åˆ›å»º Podï¼Œåœ¨ resources.rquest ä¸­ç”³è¯· GPUï¼ŒScheduler æ ¹æ®å„èŠ‚ç‚¹ GPU èµ„æºæƒ…å†µï¼Œå°† Pod è°ƒåº¦åˆ°ä¸€ä¸ªæœ‰è¶³å¤Ÿ GPU çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;3ï¼‰DevicePlugin æ ¹æ® Pod ä¸­ç”³è¯·çš„ GPU èµ„æºï¼Œä¸ºå®¹å™¨æ·»åŠ NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡
 &amp;gt; ä¾‹å¦‚ï¼šNVIDIA_VISIBLE_DEVICES=GPU-03f69c50-207a-2038-9b45-23cac89cb67d&lt;/li&gt;

&lt;li&gt;&lt;p&gt;4ï¼‰docker / containerd å¯åŠ¨å®¹å™¨&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç”±äºé…ç½®äº† nvidia-container-runtime,å› æ­¤ä¼šä½¿ç”¨ nvidia-container-runtime æ¥åˆ›å»ºå®¹å™¨&lt;/li&gt;
&lt;li&gt;nvidia-container-runtime é¢å¤–åšäº†ä¸€ä»¶äº‹ï¼šå°† nvidia-container-runtime-hook ä½œä¸º prestart hook æ·»åŠ åˆ°å®¹å™¨ spec ä¸­ï¼Œç„¶åå°±å°†å®¹å™¨ spec ä¿¡æ¯å¾€åä¼ ç»™ runC äº†ã€‚&lt;/li&gt;
&lt;li&gt;runC åˆ›å»ºå®¹å™¨å‰ä¼šè°ƒç”¨ prestart hookï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†ä¸Šä¸€æ­¥æ·»åŠ çš„ nvidia-container-runtime-hookï¼Œè¯¥ hook ä¸»è¦åšä¸¤ä»¶äº‹ï¼š

&lt;ul&gt;
&lt;li&gt;ä»å®¹å™¨ Spec çš„ mounts æˆ–è€… env ä¸­è§£æ GPU ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;è°ƒç”¨ nvidia-container-cli å‘½ä»¤ï¼Œå°† NVIDIA çš„ GPU Driverã€CUDA Driver ç­‰åº“æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨ï¼Œä¿è¯å®¹å™¨å†…å¯ä»¥ä½¿ç”¨è¢«æŒ‡å®šçš„ GPUä»¥åŠå¯¹åº”èƒ½åŠ›
æ ¸å¿ƒå°±æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼š&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;device plugin æ ¹æ® GPU èµ„æºç”³è¯·ä¸ºå®¹å™¨æ·»åŠ  NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;nvidia-container-toolkit åˆ™æ˜¯æ ¹æ® NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡å°† GPUã€é©±åŠ¨ç­‰ç›¸å…³æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œã€‚
çœ‹æºç åŒæ—¶é¡ºå¸¦è§£å†³äº†ä¸€ä¸ªï¼Œä¹‹å‰é‡åˆ°è¿‡çš„é—®é¢˜ï¼š&lt;em&gt;ä¸ºä»€ä¹ˆ Pod æ˜æ˜æ²¡æœ‰ç”³è¯· GPUï¼Œå¯åŠ¨åä¹Ÿèƒ½çœ‹åˆ°æ‰€æœ‰ GPUï¼Ÿ&lt;/em&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™æ˜¯å› ä¸º nvidia-container-toolkit ä¸­å­˜åœ¨ç‰¹æ®Šé€»è¾‘ï¼Œæ²¡æœ‰è®¾ç½® NVIDIA_VISIBLE_DEVICESç¯å¢ƒå˜é‡ï¼Œä¹Ÿæ²¡é€šè¿‡å…¶ä»–æ–¹å¼è§£æåˆ° device å¹¶ä¸”è¿˜æ˜¯ä¸€ä¸ª legacy imageï¼Œé‚£ä¹ˆé»˜è®¤ä¼šè¿”å›allï¼Œå³ï¼šNVIDIA_VISIBLE_DEVICES=all ï¼Œå› æ­¤è¯¥ Pod èƒ½çœ‹åˆ°å…¨éƒ¨ GPUã€‚&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(10): device-pluginåŸç†åˆ°å®ç°</title>
            <link>http://mospany.github.io/2024/01/24/device-plugin/</link>
            <pubDate>Wed, 24 Jan 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/24/device-plugin/</guid>
            <description>

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†æ k8s ä¸­çš„ device-plugin æœºåˆ¶å·¥ä½œåŸç†ï¼Œå¹¶é€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„ device-plugin æ¥åŠ æ·±ç†è§£ã€‚&lt;/p&gt;

&lt;h1 id=&#34;1-èƒŒæ™¯&#34;&gt;1. èƒŒæ™¯&lt;/h1&gt;

&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ï¼Œk8s ä¸­çš„ Pod åªèƒ½ç”³è¯· CPU å’Œ Memory è¿™ä¸¤ç§èµ„æºï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;resources:
  requests:
    memory: &amp;quot;1024Mi&amp;quot;
    cpu: &amp;quot;100m&amp;quot;
  limits:
    memory: &amp;quot;2048Mi&amp;quot;
    cpu: &amp;quot;200m&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éšç€ AI çƒ­åº¦è¶Šæ¥è¶Šé«˜ï¼Œæ›´å¤šçš„ä¸šåŠ¡ Pod éœ€è¦ç”³è¯· GPU èµ„æºï¼Œ&lt;a href=&#34;http://127.0.0.1:1313/2024/01/16/gpu-on-k8s/&#34;&gt;åœ¨ECSã€Dockerã€K8s ç­‰ç¯å¢ƒä¸­ä½¿ç”¨ GPU&lt;/a&gt;ä¸­æˆ‘ä»¬åˆ†æäº†å¦‚ä½•åœ¨ k8s ç¯å¢ƒä¸­ä½¿ç”¨ GPUï¼Œå°±æ˜¯é  Device Plugin æœºåˆ¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶ä½¿å¾— k8s èƒ½æ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ GPU èµ„æºï¼Œå°±åƒåŸç”Ÿçš„ CPU å’Œ Memory èµ„æºä¸€æ ·ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;å®é™…ä¸Šåœ¨æ—©æœŸï¼ŒK8s ä¹Ÿæä¾›äº†ä¸€ç§åä¸º alpha.kubernetes.io/nvidia-gpu çš„èµ„æºæ¥æ”¯æŒ NVIDIA GPUï¼Œä¸è¿‡åé¢ä¹Ÿå‘ç°äº†å¾ˆå¤šé—®é¢˜ï¼Œæ¯å¢åŠ ä¸€ç§èµ„æºéƒ½è¦ä¿®æ”¹ k8s æ ¸å¿ƒä»£ç ï¼Œk8s ç¤¾åŒºå‹åŠ›å±±å¤§ã€‚äºæ˜¯åœ¨ 1.8 ç‰ˆæœ¬å¼•å…¥äº† device plugin æœºåˆ¶ï¼Œé€šè¿‡æ’ä»¶å½¢å¼æ¥æ¥å…¥å…¶ä»–èµ„æºï¼Œè®¾å¤‡å‚å®¶åªéœ€è¦å¼€å‘å¯¹åº”çš„ xxx-device-plugin å°±å¯ä»¥å°†èµ„æºæ¥å…¥åˆ° k8s äº†ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼šç±»ä¼¼çš„è¿˜æœ‰å¼•å…¥ CSI è®©å­˜å‚¨æ’ä»¶ä» Kubernetes å†…éƒ¨ï¼ˆin-treeï¼‰ä»£ç åº“ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œæ”¹ä¸ºç‹¬ç«‹çš„ã€å¯æ’æ‹”çš„å¤–éƒ¨ç»„ä»¶ï¼ˆout-of-treeï¼‰ï¼Œè¿˜æœ‰ CRIã€CNI ç­‰ç­‰ï¼Œè¿™é‡Œçš„ Device Plugin ä¹Ÿèƒ½ç®—ä½œå…¶ä¸­çš„ä¸€ç§ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Device Plugin æœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸‹æ–‡ä¸­æ ¹æ®è¯­ä¹‰è‡ªè¡ŒåŒºåˆ†ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é¦–å…ˆå®ƒå¯ä»¥ä»£è¡¨ k8s ä¸­çš„ Device Plugin framework&lt;/li&gt;
&lt;li&gt;å…¶æ¬¡ä¹Ÿå¯ä»¥ä»£è¡¨å‚å®¶çš„å…·ä½“å®ç°ï¼Œæ¯”å¦‚ NVIDIA/k8s-device-pluginï¼Œå°±æ˜¯ç”¨äºæ¥å…¥ NVIDIA GPU èµ„æºçš„ Device Plugin å®ç°&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;2-åŸç†&#34;&gt;2. åŸç†&lt;/h1&gt;

&lt;p&gt;Device Plugin çš„å·¥ä½œåŸç†å…¶å®ä¸å¤æ‚ï¼Œå¯ä»¥åˆ†ä¸º æ’ä»¶æ³¨å†Œ å’Œ kubelet è°ƒç”¨æ’ä»¶ä¸¤éƒ¨åˆ†ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ’ä»¶æ³¨å†Œï¼šDevicePlugin å¯åŠ¨æ—¶ä¼šæƒ³èŠ‚ç‚¹ä¸Šçš„ Kubelet å‘èµ·æ³¨å†Œï¼Œè¿™æ · Kubeletå°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥æ’ä»¶çš„å­˜åœ¨äº†&lt;/li&gt;
&lt;li&gt;kubelet è°ƒç”¨æ’ä»¶ï¼šæ³¨å†Œå®Œæˆåï¼Œå½“æœ‰ Pod ç”³è¯·å¯¹äºèµ„æºæ—¶ï¼Œkubelet å°±ä¼šè°ƒç”¨è¯¥æ’ä»¶ API å®ç°å…·ä½“åŠŸèƒ½
å¦‚ k8s å®˜ç½‘ä¸Šçš„å›¾æ‰€ç¤ºï¼š
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250124-111704478.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;2-1-kubelet-éƒ¨åˆ†&#34;&gt;2.1. Kubelet éƒ¨åˆ†&lt;/h2&gt;

&lt;p&gt;ä¸ºäº†æä¾›è¯¥åŠŸèƒ½ï¼ŒKubelet æ–°å¢äº†ä¸€ä¸ª Registration gRPC service:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;service Registration {
	rpc Register(RegisterRequest) returns (Empty) {}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;device plugin å¯ä»¥è°ƒç”¨è¯¥æ¥å£å‘ Kubelet è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œæ¥å£éœ€è¦æä¾›ä¸‰ä¸ªå‚æ•°ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;device plugin å¯¹åº”çš„ unix socket åå­—ï¼šåç»­ kubelet æ ¹æ®åç§°æ‰¾åˆ°å¯¹åº”çš„ unix socketï¼Œå¹¶å‘æ’ä»¶å‘èµ·è°ƒç”¨&lt;/li&gt;
&lt;li&gt;device plugin è°ƒ API versionï¼šç”¨äºåŒºåˆ†ä¸åŒç‰ˆæœ¬çš„æ’ä»¶&lt;/li&gt;
&lt;li&gt;device plugin æä¾›çš„ ResourceNameï¼šé‡åˆ°ä¸èƒ½å¤„ç†çš„èµ„æºç”³è¯·æ—¶(CPUå’ŒMemoryä¹‹å¤–çš„èµ„æº)ï¼ŒKubelet å°±ä¼šæ ¹æ®ç”³è¯·çš„èµ„æºåç§°æ¥åŒ¹é…å¯¹åº”çš„æ’ä»¶&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;ResourceName éœ€è¦æŒ‰ç…§vendor-domain/resourcetype æ ¼å¼ï¼Œä¾‹å¦‚nvidia.com/gpuã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;2-2-device-plugin-éƒ¨åˆ†&#34;&gt;2.2. device plugin éƒ¨åˆ†&lt;/h2&gt;

&lt;p&gt;è¦è¿›è¡Œè®¾å¤‡ç®¡ç†ï¼Œdevice plugin æ’ä»¶éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GetDevicePluginOptionsï¼šè¿™ä¸ªæ¥å£ç”¨äºè·å–è®¾å¤‡æ’ä»¶çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨å…¶è¿”å›çš„å“åº”ä¸­æŒ‡å®šä¸€äº›è®¾å¤‡æ’ä»¶çš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥çœ‹åšæ˜¯æ’ä»¶çš„å…ƒæ•°æ®&lt;/li&gt;
&lt;li&gt;ListAndWatchï¼šè¯¥æ¥å£ç”¨äºåˆ—å‡ºå¯ç”¨çš„è®¾å¤‡å¹¶æŒç»­ç›‘è§†è¿™äº›è®¾å¤‡çš„çŠ¶æ€å˜åŒ–ã€‚&lt;/li&gt;
&lt;li&gt;GetPreferredAllocationï¼šå°†åˆ†é…åå¥½ä¿¡æ¯æä¾›ç»™ device plugin,ä»¥ä¾¿ device plugin åœ¨åˆ†é…æ—¶å¯ä»¥åšå‡ºæ›´å¥½çš„é€‰æ‹©&lt;/li&gt;
&lt;li&gt;Allocateï¼šè¯¥æ¥å£ç”¨äºå‘è®¾å¤‡æ’ä»¶è¯·æ±‚åˆ†é…æŒ‡å®šæ•°é‡çš„è®¾å¤‡èµ„æºã€‚&lt;/li&gt;
&lt;li&gt;PreStartContainerï¼š è¯¥æ¥å£åœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰è°ƒç”¨ï¼Œç”¨äºé…ç½®å®¹å™¨ä½¿ç”¨çš„è®¾å¤‡èµ„æºã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;åªæœ‰ ListAndWatch å’Œ Allocate ä¸¤ä¸ªæ¥å£æ˜¯å¿…é¡»çš„ï¼Œå…¶ä»–éƒ½æ˜¯å¯ä»¥é€‰çš„ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;2-3-å·¥ä½œæµç¨‹&#34;&gt;2.3. å·¥ä½œæµç¨‹&lt;/h2&gt;

&lt;p&gt;ä¸€èˆ¬æ‰€æœ‰çš„ Device Plugin å®ç°æœ€ç»ˆéƒ½ä¼šä»¥ Pod å½¢å¼è¿è¡Œåœ¨ k8s é›†ç¾¤ä¸­ï¼Œåˆå› ä¸ºéœ€è¦ç®¡ç†æ‰€æœ‰èŠ‚ç‚¹ï¼Œå› æ­¤éƒ½ä¼šä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ã€‚&lt;/p&gt;

&lt;p&gt;device plugin å¯åŠ¨ä¹‹åç¬¬ä¸€æ­¥å°±æ˜¯å‘ Kubelet æ³¨å†Œï¼Œè®© Kubelet çŸ¥é“æœ‰ä¸€ä¸ªæ–°çš„è®¾å¤‡æ¥å…¥äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†èƒ½å¤Ÿè°ƒç”¨ Kubelet çš„ Register æ¥å£ï¼ŒDevice Plugin Pod ä¼šå°†å®¿ä¸»æœºä¸Šçš„ kubelet.sock æ–‡ä»¶(unix socket)æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œé€šè¿‡ kubelet.sock æ–‡ä»¶å‘èµ·è°ƒç”¨ä»¥å®ç°æ³¨å†Œã€‚&lt;/p&gt;

&lt;p&gt;é›†ç¾¤éƒ¨ç½²åï¼ŒKubelet å°±ä¼šå¯åŠ¨ï¼Œ&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Kubelet å¯åŠ¨ Registration gRPC æœåŠ¡ï¼ˆkubelet.sockï¼‰ï¼Œæä¾› Register æ¥å£&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;device-plugin å¯åŠ¨åï¼Œé€šè¿‡ kubelet.sock è°ƒç”¨ Register æ¥å£ï¼Œå‘ Kubelet è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œä¿¡æ¯åŒ…æ‹¬ device plugin çš„ unix socketï¼ŒAPI Versionï¼ŒResourceName&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ³¨å†ŒæˆåŠŸåï¼ŒKubelet é€šè¿‡ device-plugin çš„ unix socket å‘ device plugin è°ƒç”¨ ListAndWatchï¼Œ è·å–å½“å‰èŠ‚ç‚¹ä¸Šçš„èµ„æº&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Kubelet å‘ api-server æ›´æ–°èŠ‚ç‚¹çŠ¶æ€æ¥è®°å½•ä¸Šä¸€æ­¥ä¸­å‘ç°çš„èµ„æº&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;blockquote&gt;
&lt;p&gt;æ­¤æ—¶ kubelet get node -oyaml å°±èƒ½æŸ¥çœ‹åˆ° Node å¯¹è±¡çš„ Capacity ä¸­å¤šäº†å¯¹åº”çš„èµ„æº&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ol&gt;
&lt;li&gt;ç”¨æˆ·åˆ›å»º Pod å¹¶ç”³è¯·è¯¥èµ„æºï¼Œè°ƒåº¦å®Œæˆåï¼Œå¯¹åº”èŠ‚ç‚¹ä¸Šçš„ kubelet è°ƒç”¨ device plugin çš„ Allocate æ¥å£è¿›è¡Œèµ„æºåˆ†é…
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;å¤§è‡´å¦‚ä¸‹ï¼š
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250124-141629596.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;3-å®ç°&#34;&gt;3. å®ç°&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;æºç ï¼š&lt;a href=&#34;https://github.com/mospany/i-device-plugin&#34;&gt;https://github.com/mospany/i-device-plugin&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;device plugin å®ç°å¤§è‡´åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰å¯åŠ¨æ—¶å‘ Kubelet å‘èµ·æ³¨å†Œ
   - æ³¨æ„ç›‘æ§ kubelet çš„é‡å¯ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨ fsnotify ç±»ä¼¼çš„åº“ç›‘æ§ kubelet.sock çš„é‡æ–°åˆ›å»ºäº‹ä»¶ã€‚å¦‚æœ kubelet.sock é‡æ–°åˆ›å»ºäº†ï¼Œåˆ™è®¤ä¸º kubelet æ˜¯é‡å¯äº†ï¼Œé‚£ä¹ˆéœ€è¦é‡æ–°æ³¨å†Œ
2ï¼‰gRPC Serverï¼šä¸»è¦æ˜¯å®ç° ListAndWatch å’Œ Allocateä¸¤ä¸ªæ–¹æ³•&lt;/p&gt;

&lt;h2 id=&#34;3-1-å®ç°-grpc-server&#34;&gt;3.1. å®ç° gRPC Server&lt;/h2&gt;

&lt;p&gt;ç®€å•èµ·è§ï¼Œè¿™é‡Œåªå®ç°äº†ListAndWatch å’Œ Allocate è¿™ä¸¤ä¸ªå¿…é¡»çš„æ–¹æ³•ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¯¹ gRPC ä¸ç†Ÿæ‚‰çš„ç«¥é‹å¯ä»¥çœ‹ä¸‹è¿™ä¸ª â€“&amp;gt; &lt;a href=&#34;https://www.lixueduan.com/tags/grpc/&#34;&gt;gRPC ç³»åˆ—æ•™ç¨‹&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;3-1-1-listandwatch&#34;&gt;3.1.1. ListAndWatch&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯ä¸€ä¸ª gRPC çš„ Stream æ–¹æ³•ï¼Œå»ºç«‹é•¿è¿æ¥ï¼Œå¯ä»¥æŒç»­å‘ Kubelet å‘é€è®¾å¤‡çš„ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// ListAndWatch returns a stream of List of Devices
// Whenever a Device state change or a Device disappears, ListAndWatch
// returns the new list
func (c *GopherDevicePlugin) ListAndWatch(_ *pluginapi.Empty, srv pluginapi.DevicePlugin_ListAndWatchServer) error {
	devs := c.dm.Devices()
	klog.Infof(&amp;quot;find devices [%s]&amp;quot;, String(devs))

	err := srv.Send(&amp;amp;pluginapi.ListAndWatchResponse{Devices: devs})
	if err != nil {
		return errors.WithMessage(err, &amp;quot;send device failed&amp;quot;)
	}

	klog.Infoln(&amp;quot;waiting for device update&amp;quot;)
	for range c.dm.notify {
		devs = c.dm.Devices()
		klog.Infof(&amp;quot;device update,new device list [%s]&amp;quot;, String(devs))
		_ = srv.Send(&amp;amp;pluginapi.ListAndWatchResponse{Devices: devs})
	}
	return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‘ç°è®¾å¤‡çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// List all device
func (d *DeviceMonitor) List() error {
	err := filepath.Walk(d.path, func(path string, info fs.FileInfo, err error) error {
		if info.IsDir() {
			klog.Infof(&amp;quot;%s is dir,skip&amp;quot;, path)
			return nil
		}

		d.devices[info.Name()] = &amp;amp;pluginapi.Device{
			ID:     info.Name(),
			Health: pluginapi.Healthy,
		}
		return nil
	})

	return errors.WithMessagef(err, &amp;quot;walk [%s] failed&amp;quot;, d.path)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¾ˆç®€å•ï¼Œå°±æ˜¯éå†æŸ¥çœ‹ /etc/gophers ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä¼šå½“åšä¸€ä¸ªè®¾å¤‡ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶åå†å¯åŠ¨ä¸€ä¸ª Goroutine ç›‘æ§è®¾å¤‡çš„å˜åŒ–,å³/etc/gophers ç›®å½•ä¸‹æ–‡ä»¶æœ‰å˜åŒ–æ—¶é€šè¿‡ chan å‘é€é€šçŸ¥,å°†æœ€æ–°çš„è®¾å¤‡ä¿¡æ¯å‘é€ç»™ Kubeletã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Watch device change
func (d *DeviceMonitor) Watch() error {
	klog.Infoln(&amp;quot;watching devices&amp;quot;)

	w, err := fsnotify.NewWatcher()
	if err != nil {
		return errors.WithMessage(err, &amp;quot;new watcher failed&amp;quot;)
	}
	defer w.Close()

	errChan := make(chan error)
	go func() {
		defer func() {
			if r := recover(); r != nil {
				errChan &amp;lt;- fmt.Errorf(&amp;quot;device watcher panic:%v&amp;quot;, r)
			}
		}()
		for {
			select {
			case event, ok := &amp;lt;-w.Events:
				if !ok {
					continue
				}
				klog.Infof(&amp;quot;fsnotify device event: %s %s&amp;quot;, event.Name, event.Op.String())

				if event.Op == fsnotify.Create {
					dev := path.Base(event.Name)
					d.devices[dev] = &amp;amp;pluginapi.Device{
						ID:     dev,
						Health: pluginapi.Healthy,
					}
					d.notify &amp;lt;- struct{}{}
					klog.Infof(&amp;quot;find new device [%s]&amp;quot;, dev)
				} else if event.Op&amp;amp;fsnotify.Remove == fsnotify.Remove {
					dev := path.Base(event.Name)
					delete(d.devices, dev)
					d.notify &amp;lt;- struct{}{}
					klog.Infof(&amp;quot;device [%s] removed&amp;quot;, dev)
				}

			case err, ok := &amp;lt;-w.Errors:
				if !ok {
					continue
				}
				klog.Errorf(&amp;quot;fsnotify watch device failed:%v&amp;quot;, err)
			}
		}
	}()

	err = w.Add(d.path)
	if err != nil {
		return fmt.Errorf(&amp;quot;watch device error:%v&amp;quot;, err)
	}

	return &amp;lt;-errChan
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-1-2-allocate&#34;&gt;3.1.2. Allocate&lt;/h3&gt;

&lt;p&gt;Allocate åˆ™æ˜¯éœ€è¦å‘ŠçŸ¥ kubelet æ€ä¹ˆå°†è®¾å¤‡åˆ†é…ç»™å®¹å™¨ï¼Œè¿™é‡Œå®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨å¯¹åº”å®¹å™¨ä¸­å¢åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒGopher=$deviceId&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Allocate is called during container creation so that the Device
// Plugin can run device specific operations and instruct Kubelet
// of the steps to make the Device available in the container
func (c *GopherDevicePlugin) Allocate(_ context.Context, reqs *pluginapi.AllocateRequest) (*pluginapi.AllocateResponse, error) {
	ret := &amp;amp;pluginapi.AllocateResponse{}
	for _, req := range reqs.ContainerRequests {
		klog.Infof(&amp;quot;[Allocate] received request: %v&amp;quot;, strings.Join(req.DevicesIDs, &amp;quot;,&amp;quot;))
		resp := pluginapi.ContainerAllocateResponse{
			Envs: map[string]string{
				&amp;quot;Gopher&amp;quot;: strings.Join(req.DevicesIDs, &amp;quot;,&amp;quot;),
			},
		}
		ret.ContainerResponses = append(ret.ContainerResponses, &amp;amp;resp)
	}
	return ret, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç®€å•çœ‹ä¸€ä¸‹ NVIDIA çš„ device plugin æ˜¯æ€ä¹ˆå®ç° Allocate çš„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Allocate which return list of devices.
func (plugin *NvidiaDevicePlugin) Allocate(ctx context.Context, reqs *pluginapi.AllocateRequest) (*pluginapi.AllocateResponse, error) {
	responses := pluginapi.AllocateResponse{}
	for _, req := range reqs.ContainerRequests {
		if err := plugin.rm.ValidateRequest(req.DevicesIDs); err != nil {
			return nil, fmt.Errorf(&amp;quot;invalid allocation request for %q: %w&amp;quot;, plugin.rm.Resource(), err)
		}
		response, err := plugin.getAllocateResponse(req.DevicesIDs)
		if err != nil {
			return nil, fmt.Errorf(&amp;quot;failed to get allocate response: %v&amp;quot;, err)
		}
		responses.ContainerResponses = append(responses.ContainerResponses, response)
	}

	return &amp;amp;responses, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒå…¶å®æ˜¯è¿™ä¸ªæ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// updateResponseForDeviceListEnvvar sets the environment variable for the requested devices.
func (plugin *NvidiaDevicePlugin) updateResponseForDeviceListEnvvar(response *pluginapi.ContainerAllocateResponse, deviceIDs ...string) {
	response.Envs[plugin.deviceListEnvvar] = strings.Join(deviceIDs, &amp;quot;,&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»™å®¹å™¨æ·»åŠ äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œvalue ä¸ºè®¾å¤‡ idï¼Œå…·ä½“ deviceID æä¾›äº†ä¸¤ç§æµ‹é‡ï¼Œå¯èƒ½æ˜¯ç¼–å·æˆ–è€… uuid&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;const (
	DeviceIDStrategyUUID  = &amp;quot;uuid&amp;quot;
	DeviceIDStrategyIndex = &amp;quot;index&amp;quot;
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;key æ˜¯ä¸€ä¸ªå˜é‡ plugin.deviceListEnvvarï¼Œåˆå§‹åŒ–å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;	plugin := NvidiaDevicePlugin{
		deviceListEnvvar:     &amp;quot;NVIDIA_VISIBLE_DEVICES&amp;quot;,
		socket:               pluginPath + &amp;quot;.sock&amp;quot;,
	  // ...
	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ NVIDIA è¿™ä¸ª device plugin å®ç° Allocate ä¸»è¦å°±æ˜¯ç»™å®¹å™¨å¢åŠ äº†ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;NVIDIA_VISIBLE_DEVICES=GPU-03f69c50-207a-2038-9b45-23cac89cb67d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ–è€…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;NVIDIA_VISIBLE_DEVICES=1,2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨æ–‡ç«  &lt;a href=&#34;http://blog.mospan.cn/2024/01/17/gpu-operator/&#34;&gt;ä½¿ç”¨ GPU Operatoræ­å»ºAIç®—åŠ›ç¯å¢ƒ&lt;/a&gt;, æåˆ° GPU Operator ä¼šä½¿ç”¨ NVIDIA Container Toolit Installer å®‰è£… NVIDIA Container Toolitã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ª NVIDIA Container Toolit çš„ä½œç”¨å°±æ˜¯æ·»åŠ å¯¹ GPU çš„æ”¯æŒï¼Œä¹ŸåŒ…æ‹¬äº†è¯†åˆ« NVIDIA_VISIBLE_DEVICES è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œç„¶åå°†å¯¹åº”è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨é‡Œã€‚&lt;/p&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–è¿˜ä¼šæŠŠè®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨é‡Œï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (plugin *NvidiaDevicePlugin) apiDeviceSpecs(devRoot string, ids []string) []*pluginapi.DeviceSpec {
	optional := map[string]bool{
		&amp;quot;/dev/nvidiactl&amp;quot;:        true,
		&amp;quot;/dev/nvidia-uvm&amp;quot;:       true,
		&amp;quot;/dev/nvidia-uvm-tools&amp;quot;: true,
		&amp;quot;/dev/nvidia-modeset&amp;quot;:   true,
	}

	paths := plugin.rm.GetDevicePaths(ids)

	var specs []*pluginapi.DeviceSpec
	for _, p := range paths {
		if optional[p] {
			if _, err := os.Stat(p); err != nil {
				continue
			}
		}
		spec := &amp;amp;pluginapi.DeviceSpec{
			ContainerPath: p,
			HostPath:      filepath.Join(devRoot, p),
			Permissions:   &amp;quot;rw&amp;quot;,
		}
		specs = append(specs, spec)
	}

	return specs
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;		spec := &amp;amp;pluginapi.DeviceSpec{
			ContainerPath: p,
			HostPath:      filepath.Join(devRoot, p),
			Permissions:   &amp;quot;rw&amp;quot;,
		}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡ŒæŒ‡å®šäº†è®¾å¤‡åœ¨å®¿ä¸»æœºä¸Šçš„ Path å’ŒæŒ‚è½½åˆ°å®¹å™¨ä¹‹åçš„ Pathï¼Œåç»­å°±å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿›è¡Œè®¾å¤‡æŒ‚è½½äº†ã€‚&lt;/p&gt;

&lt;p&gt;å®é™…ä¸Š device plugin æä¾›äº†å¤šç§æ–¹æ³•æ¥å®Œæˆè®¾å¤‡åˆ†é…ï¼Œå®ç°æ—¶åªéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©å…¶ä¸­ä¸€ç§å³å¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Env: è®¾å¤‡æ’ä»¶å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡å°†è®¾å¤‡çš„ç›¸å…³ä¿¡æ¯ä¼ é€’ç»™å®¹å™¨ã€‚è¿™ç§æ–¹å¼é€šå¸¸ç”¨äºå°†è®¾å¤‡çš„é…ç½®ä¿¡æ¯ã€è·¯å¾„æˆ–å…¶ä»–å‚æ•°ä¼ é€’ç»™å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºã€‚&lt;/li&gt;
&lt;li&gt;Mounts: è®¾å¤‡æ’ä»¶é€šè¿‡æŒ‚è½½è®¾å¤‡åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½¿å®¹å™¨èƒ½å¤Ÿç›´æ¥è®¿é—®è®¾å¤‡ã€‚è¿™ä¸ªæ–¹æ³•é€‚ç”¨äºéœ€è¦ç›´æ¥ä¸ç¡¬ä»¶è®¾å¤‡äº¤äº’çš„æƒ…å†µï¼Œä¾‹å¦‚ GPUã€ç½‘ç»œè®¾å¤‡ã€å—å­˜å‚¨ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;Devices: è®¾å¤‡æ’ä»¶å¯ä»¥é€šè¿‡ Devices å­—æ®µå°†è®¾å¤‡ç›´æ¥æ˜ å°„åˆ°å®¹å™¨ã€‚æ­¤æ–¹æ³•å…è®¸è®¾å¤‡è¢«æ˜¾å¼åœ°æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œç±»ä¼¼äº Linux ä¸­çš„ &amp;ndash;device é€‰é¡¹ã€‚&lt;/li&gt;
&lt;li&gt;Annotations: è®¾å¤‡æ’ä»¶è¿˜å¯ä»¥ä½¿ç”¨æ³¨è§£æ¥æä¾›é¢å¤–çš„ä¿¡æ¯ï¼Œä¾›è°ƒåº¦å™¨ä½¿ç”¨ã€‚æ³¨è§£é€šå¸¸ä¸ä¼šç›´æ¥å½±å“å®¹å™¨çš„è¡Œä¸ºï¼Œè€Œæ˜¯ä¸º Kubernetes è°ƒåº¦å™¨æä¾›ä¿¡æ¯ï¼Œå¸®åŠ©è°ƒåº¦å™¨åšå‡ºæ›´åˆé€‚çš„å†³ç­–ã€‚&lt;/li&gt;
&lt;li&gt;CDIDevices: CDIï¼ˆContainer Device Interfaceï¼‰æ˜¯ä¸€ç§ Kubernetes API æ‰©å±•ï¼Œå…è®¸è®¾å¤‡æ’ä»¶é€šè¿‡ CDI æ ‡å‡†è¿›è¡Œè®¾å¤‡åˆ†é…ã€‚é€šè¿‡ CDIï¼ŒKubernetes å¯ä»¥æ›´å®¹æ˜“åœ°ç®¡ç†å’Œè°ƒåº¦è®¾å¤‡ï¼Œå¦‚ GPUã€FPGAã€ç½‘ç»œå¡ç­‰ã€‚
æ¯”å¦‚ nvidia device plugin åœ¨å®ç°æ—¶å°±åŒæ—¶ä½¿ç”¨äº† Env å’Œ Devices æ–¹å¼ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åˆæ¯”å¦‚ &lt;a href=&#34;https://github.com/Deep-Spark/ix-device-plugin/blob/master/pkg/dpm/plugin.go#L144-L156&#34;&gt;ix-device-plugin&lt;/a&gt; å°±æ˜¯ç”¨çš„ Devices æ–¹å¼,ç›´æ¥æŒ‡å®šåˆ†é…ç»™å®¹å™¨çš„è®¾å¤‡åœ¨å®¿ä¸»æœºçš„ä½ç½®ï¼Œä»¥åŠè¦æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ä½ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (p *iluvatarDevicePlugin) allocateDevicesByDeviceID(hostminor uint, num int) *pluginapi.DeviceSpec {
	var device pluginapi.DeviceSpec

	hostPathPrefix := &amp;quot;/dev/&amp;quot;
	containerPathPrefix := &amp;quot;/dev/&amp;quot;

	// Expose the device node for iluvatar pod.
	device.HostPath = hostPathPrefix + deviceName + strconv.Itoa(int(hostminor))
	device.ContainerPath = containerPathPrefix + deviceName + strconv.Itoa(num)
	device.Permissions = &amp;quot;rw&amp;quot;

	return &amp;amp;device
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-1-3-å…¶ä»–æ–¹æ³•&#34;&gt;3.1.3. å…¶ä»–æ–¹æ³•&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// GetDevicePluginOptions returns options to be communicated with Device
// Manager
func (c *GopherDevicePlugin) GetDevicePluginOptions(_ context.Context, _ *pluginapi.Empty) (*pluginapi.DevicePluginOptions, error) {
	return &amp;amp;pluginapi.DevicePluginOptions{PreStartRequired: true}, nil
}

// GetPreferredAllocation returns a preferred set of devices to allocate
// from a list of available ones. The resulting preferred allocation is not
// guaranteed to be the allocation ultimately performed by the
// devicemanager. It is only designed to help the devicemanager make a more
// informed allocation decision when possible.
func (c *GopherDevicePlugin) GetPreferredAllocation(_ context.Context, _ *pluginapi.PreferredAllocationRequest) (*pluginapi.PreferredAllocationResponse, error) {
	return &amp;amp;pluginapi.PreferredAllocationResponse{}, nil
}

// PreStartContainer is called, if indicated by Device Plugin during registeration phase,
// before each container start. Device plugin can run device specific operations
// such as reseting the device before making devices available to the container
func (c *GopherDevicePlugin) PreStartContainer(_ context.Context, _ *pluginapi.PreStartContainerRequest) (*pluginapi.PreStartContainerResponse, error) {
	return &amp;amp;pluginapi.PreStartContainerResponse{}, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-2-å‘-kubelet-è¿›è¡Œæ³¨å†Œ&#34;&gt;3.2. å‘ Kubelet è¿›è¡Œæ³¨å†Œ&lt;/h2&gt;

&lt;p&gt;æ³¨å†Œä¹Ÿæ˜¯å¾ˆç®€å•ï¼Œè°ƒç”¨ deviceplugin æä¾›çš„ RegisterRequest æ–¹æ³•å³å¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Register registers the device plugin for the given resourceName with Kubelet.
func (c *GopherDevicePlugin) Register() error {
	conn, err := connect(pluginapi.KubeletSocket, common.ConnectTimeout)
	if err != nil {
		return errors.WithMessagef(err, &amp;quot;connect to %s failed&amp;quot;, pluginapi.KubeletSocket)
	}
	defer conn.Close()

	client := pluginapi.NewRegistrationClient(conn)
	reqt := &amp;amp;pluginapi.RegisterRequest{
		Version:      pluginapi.Version,
		Endpoint:     path.Base(common.DeviceSocket),
		ResourceName: common.ResourceName,
	}

	_, err = client.Register(context.Background(), reqt)
	if err != nil {
		return errors.WithMessage(err, &amp;quot;register to kubelet failed&amp;quot;)
	}
	return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-3-ç›‘æ§-kubelet-sock-çŠ¶æ€&#34;&gt;3.3. ç›‘æ§ kubelet.sock çŠ¶æ€&lt;/h2&gt;

&lt;p&gt;ä½¿ç”¨ fsnotify åº“ç›‘æ§ kubelet.sock æ–‡ä»¶çŠ¶æ€ï¼Œé€šè¿‡ kubelet.sock æ–‡ä»¶çš„å˜åŒ–æ¥åˆ¤æ–­ kubelet æ˜¯å¦é‡å¯ï¼Œå½“ kubelet é‡å¯å device plugin ä¹Ÿéœ€è¦é‡å¯ï¼Œç„¶åæ³¨å†Œåˆ°æ–°çš„ kubelet.sockã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// WatchKubelet restart device plugin when kubelet restarted
func WatchKubelet(stop chan&amp;lt;- struct{}) error {
	watcher, err := fsnotify.NewWatcher()
	if err != nil {
		return errors.WithMessage(err, &amp;quot;Unable to create fsnotify watcher&amp;quot;)
	}
	defer watcher.Close()

	go func() {
		// Start listening for events.
		for {
			select {
			case event, ok := &amp;lt;-watcher.Events:
				if !ok {
					continue
				}
				klog.Infof(&amp;quot;fsnotify events: %s %v&amp;quot;, event.Name, event.Op.String())
				if event.Name == pluginapi.KubeletSocket &amp;amp;&amp;amp; event.Op == fsnotify.Create {
					klog.Warning(&amp;quot;inotify: kubelet.sock created, restarting.&amp;quot;)
					stop &amp;lt;- struct{}{}
				}
			case err, ok := &amp;lt;-watcher.Errors:
				if !ok {
					continue
				}
				klog.Errorf(&amp;quot;fsnotify failed restarting,detail:%v&amp;quot;, err)
			}
		}
	}()

	// watch kubelet.sock
	err = watcher.Add(pluginapi.KubeletSocket)
	if err != nil {
		return errors.WithMessagef(err, &amp;quot;Unable to add path %s to watcher&amp;quot;, pluginapi.KubeletSocket)
	}
	return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ³¨å†Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å› ä¸ºKubelet ä¸­ä½¿ç”¨ä¸€ä¸ª map æ¥å­˜å‚¨æ³¨å†Œçš„æ’ä»¶ï¼Œå› æ­¤æ¯æ¬¡ Kubelet é‡å¯éƒ½ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ç° device plugin æ—¶å°±è¦ç›‘æ§ Kubelet é‡å¯çŠ¶æ€å¹¶é‡æ–°æ³¨å†Œã€‚&lt;/p&gt;

&lt;p&gt;Kubelet Register æ–¹æ³• å®ç°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// /pkg/kubelet/cm/devicemanager/plugin/v1beta1/server.go#L143-L165
func (s *server) Register(ctx context.Context, r *api.RegisterRequest) (*api.Empty, error) {
	klog.InfoS(&amp;quot;Got registration request from device plugin with resource&amp;quot;, &amp;quot;resourceName&amp;quot;, r.ResourceName)
	metrics.DevicePluginRegistrationCount.WithLabelValues(r.ResourceName).Inc()

	if !s.isVersionCompatibleWithPlugin(r.Version) {
		err := fmt.Errorf(errUnsupportedVersion, r.Version, api.SupportedVersions)
		klog.InfoS(&amp;quot;Bad registration request from device plugin with resource&amp;quot;, &amp;quot;resourceName&amp;quot;, r.ResourceName, &amp;quot;err&amp;quot;, err)
		return &amp;amp;api.Empty{}, err
	}

	if !v1helper.IsExtendedResourceName(core.ResourceName(r.ResourceName)) {
		err := fmt.Errorf(errInvalidResourceName, r.ResourceName)
		klog.InfoS(&amp;quot;Bad registration request from device plugin&amp;quot;, &amp;quot;err&amp;quot;, err)
		return &amp;amp;api.Empty{}, err
	}

	if err := s.connectClient(r.ResourceName, filepath.Join(s.socketDir, r.Endpoint)); err != nil {
		klog.InfoS(&amp;quot;Error connecting to device plugin client&amp;quot;, &amp;quot;err&amp;quot;, err)
		return &amp;amp;api.Empty{}, err
	}

	return &amp;amp;api.Empty{}, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¸å¿ƒåœ¨ connectClient æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (s *server) connectClient(name string, socketPath string) error {
	c := NewPluginClient(name, socketPath, s.chandler)

	s.registerClient(name, c)
	if err := c.Connect(); err != nil {
		s.deregisterClient(name)
		klog.ErrorS(err, &amp;quot;Failed to connect to new client&amp;quot;, &amp;quot;resource&amp;quot;, name)
		return err
	}

	go func() {
		s.runClient(name, c)
	}()

	return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ€ä¹ˆä¿å­˜è¿™ä¸ª client çš„å‘¢?&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (s *server) registerClient(name string, c Client) {
	s.mutex.Lock()
	defer s.mutex.Unlock()

	s.clients[name] = c
	klog.V(2).InfoS(&amp;quot;Registered client&amp;quot;, &amp;quot;name&amp;quot;, name)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type server struct {
	socketName string
	socketDir  string
	mutex      sync.Mutex
	wg         sync.WaitGroup
	grpc       *grpc.Server
	rhandler   RegistrationHandler
	chandler   ClientHandler
	clients    map[string]Client // ä½¿ç”¨ map å­˜å‚¨ï¼Œå¹¶ä¸ºæŒä¹…åŒ–
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-4-main-go&#34;&gt;3.4. main.go&lt;/h2&gt;

&lt;p&gt;main æ–¹æ³•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;p&gt;1) å¯åŠ¨ gRPC æœåŠ¡
2) å‘ Kubelet è¿›è¡Œæ³¨å†Œ
3) ç›‘æ§ kubelet.sock çŠ¶æ€&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func main() {
	klog.Infof(&amp;quot;device plugin starting&amp;quot;)
	dp := device_plugin.NewGopherDevicePlugin()
	go dp.Run()

	// register when device plugin start
	if err := dp.Register(); err != nil {
		klog.Fatalf(&amp;quot;register to kubelet failed: %v&amp;quot;, err)
	}

	// watch kubelet.sock,when kubelet restart,exit device plugin,then will restart by DaemonSet
	stop := make(chan struct{})
	err := utils.WatchKubelet(stop)
	if err != nil {
		klog.Fatalf(&amp;quot;start to kubelet failed: %v&amp;quot;, err)
	}

	&amp;lt;-stop
	klog.Infof(&amp;quot;kubelet restart,exiting&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;4-æµ‹è¯•&#34;&gt;4. æµ‹è¯•&lt;/h1&gt;

&lt;h2 id=&#34;4-1-ç¼–è¯‘&#34;&gt;4.1. ç¼–è¯‘&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;git clone git@github.com:mospany/i-device-plugin.git
cd i-device-plugin
make build-image
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-200208751.png&#34; alt=&#34;picture 2&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;4-2-æ‰“åŒ…é•œåƒ&#34;&gt;4.2. æ‰“åŒ…é•œåƒ&lt;/h2&gt;

&lt;p&gt;ç”±äºå›½å†…ä¸èƒ½ç›´æ¥è®¿é—®hub.docker.ioäº†ï¼Œéœ€æœ¬åœ°å¯¼å…¥ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;docker save mospany/i-device-plugin:latest -o i-device-plugin_latest.tar
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†åœ¨æœ¬åœ°ç›®å½•ä¸‹ç”Ÿæˆi-device-plugin_latest.tarã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-3-å¯¼å…¥é•œåƒ&#34;&gt;4.3. å¯¼å…¥é•œåƒ&lt;/h2&gt;

&lt;p&gt;å°†ç¼–è¯‘æœºä¸Šç”Ÿæˆçš„é•œåƒä¸Šä¼ åˆ°ç›®æ ‡workerä¸Šï¼Œå†å¯¼å…¥ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ctr -n k8s.io image import i-device-plugin_latest.tar 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-worker1 img]# crictl images | grep i-device
docker.io/mospany/i-device-plugin                                                     latest                             5954f214c8b06       23.5MB
[root@k8s-worker1 img]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;4-4-éƒ¨ç½²&#34;&gt;4.4. éƒ¨ç½²&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆæ˜¯éƒ¨ç½² i-device-pluginï¼Œä¸€èˆ¬ä½¿ç”¨ DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œå®Œæ•´ yaml å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: i-device-plugin
  namespace: kube-system
  labels:
    app: i-device-plugin
spec:
  selector:
    matchLabels:
      app: i-device-plugin
  template:
    metadata:
      labels:
        app: i-device-plugin
    spec:
      containers:
        - name: i-device-plugin
          image: mospany/i-device-plugin:latest
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: &amp;quot;1&amp;quot;
              memory: &amp;quot;512Mi&amp;quot;
            requests:
              cpu: &amp;quot;0.1&amp;quot;
              memory: &amp;quot;128Mi&amp;quot;
          volumeMounts:
            - name: device-plugin
              mountPath: /var/lib/kubelet/device-plugins
            - name: gophers
              mountPath: /etc/gophers
      volumes:
        - name: device-plugin
          hostPath:
            path: /var/lib/kubelet/device-plugins
        - name: gophers
          hostPath:
            path: /etc/gophers

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ hostPath æ–¹å¼å°†ç”¨åˆ°çš„ä¸¤ä¸ªç›®å½•æŒ‚è½½åˆ° Pod é‡Œï¼š
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-214446131.png&#34; alt=&#34;picture 3&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;/var/lib/kubelet/device-pluginsï¼šè¯·æ±‚ kubelet.sock å‘èµ·è°ƒç”¨ï¼ŒåŒæ—¶å°† device-plugin gRPC æœåŠ¡çš„ sock æ–‡ä»¶å†™å…¥è¯¥ç›®å½•ä¾› kubelet è°ƒç”¨&lt;/li&gt;
&lt;li&gt;/etc/gophersï¼šåœ¨è¯¥ Demo ä¸­ï¼ŒæŠŠ /etc/gophers ç›®å½•ä¸‹çš„æ–‡ä»¶ä½œä¸ºè®¾å¤‡ï¼Œå› æ­¤éœ€è¦å°†å…¶æŒ‚è½½åˆ° Pod é‡Œã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä½¿ç”¨kubectlè¿›è¡Œapplyä¸‹yamlæ–‡ä»¶ï¼Œç¡®ä¿ i-device-plugin å·²ç»å¯åŠ¨ã€‚
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-214524956.png&#34; alt=&#34;picture 4&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;4-5-åˆå§‹åŒ–&#34;&gt;4.5. åˆå§‹åŒ–&lt;/h2&gt;

&lt;p&gt;åœ¨è¯¥ Demo ä¸­ï¼ŒæŠŠ /etc/gophers ç›®å½•ä¸‹çš„æ–‡ä»¶ä½œä¸ºè®¾å¤‡ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åˆ° /etc/gophers ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œæ¨¡æ‹Ÿæœ‰æ–°çš„è®¾å¤‡æ¥å…¥å³å¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir /etc/gophers

touch /etc/gophers/g1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ device plugin æ—¥å¿—
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-214911049.png&#34; alt=&#34;picture 5&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æ„ŸçŸ¥åˆ°æ–°å¢çš„è®¾å¤‡äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸å‡ºæ„å¤–çš„è¯å¯ä»¥åœ¨ node ä¸Šçœ‹åˆ°æ–°èµ„æºäº†&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-215648627.png&#34; alt=&#34;picture 6&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æœç„¶ï¼Œnode capacity ä¸­æ–°å¢äº†lixueduan.com/gopher: &amp;ldquo;1&amp;rdquo;ï¼Œ ä»£è¡¨åˆ›å»ºäº†2ä¸ªè®¾å¤‡ï¼š/etc/gophers/g1å’Œ/etc/gophers/g2ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-6-åˆ›å»ºæµ‹è¯•-pod&#34;&gt;4.6. åˆ›å»ºæµ‹è¯• Pod&lt;/h2&gt;

&lt;p&gt;æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª Pod ç”³è¯·è¯¥èµ„æºè¯•è¯•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: gopher-pod
spec:
  containers:
  - name: gopher-container
    image: docker.m.daocloud.io/busybox
    command: [&amp;quot;sh&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;echo Hello, Kubernetes! &amp;amp;&amp;amp; sleep 3600&amp;quot;]
    resources:
      requests:
        lixueduan.com/gopher: &amp;quot;1&amp;quot;
      limits:
        lixueduan.com/gopher: &amp;quot;1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pod å¯åŠ¨æˆåŠŸ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 yaml]# kubectl  get pod -A | grep gopher
default        gopher-pod                                                        1/1     Running     0               4m18s
[root@k8s-master1 yaml]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹‹å‰åˆ†é…è®¾å¤‡æ˜¯æ·»åŠ  Gopher=xxx è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œç°åœ¨çœ‹ä¸‹æ˜¯å¦æ­£å¸¸åˆ†é…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 yaml]# kubectl  exec -ti gopher-pod -- env | grep -i goph
HOSTNAME=gopher-pod
Gopher=g2
[root@k8s-master1 yaml]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ok,ç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œå¯ä»¥çœ‹åˆ°åˆ†é…ç»™è¯¥ Pod çš„è®¾å¤‡æ˜¯ g2ã€‚&lt;/p&gt;

&lt;h1 id=&#34;5-å°ç»“&#34;&gt;5. å°ç»“&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†æäº† k8s ä¸­çš„ Device Plugin æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œå¹¶å®ç°äº†ä¸€ä¸ªç®€å•çš„ &lt;strong&gt;i-device-plugin&lt;/strong&gt;æ¥è¿›ä¸€æ­¥åŠ æ·±ç†è§£ã€‚&lt;/p&gt;

&lt;p&gt;Device Plugin çš„å·¥ä½œåŸç†å…¶å®ä¸å¤æ‚ï¼Œå¯ä»¥åˆ†ä¸º æ’ä»¶æ³¨å†Œ å’Œ kubelet è°ƒç”¨æ’ä»¶ä¸¤éƒ¨åˆ†ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ’ä»¶æ³¨å†Œï¼šDevicePlugin å¯åŠ¨æ—¶ä¼šæƒ³èŠ‚ç‚¹ä¸Šçš„ Kubelet å‘èµ·æ³¨å†Œï¼Œè¿™æ · Kubelet å°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥æ’ä»¶çš„å­˜åœ¨äº†&lt;/li&gt;
&lt;li&gt;kubelet è°ƒç”¨æ’ä»¶ï¼šæ³¨å†Œå®Œæˆåï¼Œå½“æœ‰ Pod ç”³è¯·å¯¹äºèµ„æºæ—¶ï¼Œkubelet å°±ä¼šè°ƒç”¨è¯¥æ’ä»¶ API å®ç°å…·ä½“åŠŸèƒ½&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-223139774.png&#34; alt=&#34;picture 7&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹æ˜¯æ€»ç»“çš„å‡ ä¸ªå¸¸è§é—®é¢˜ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰device plugin æ˜¯æ€ä¹ˆæ„ŸçŸ¥èŠ‚ç‚¹ä¸Šçš„è®¾å¤‡çš„ï¼Ÿ&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€èˆ¬è®¾å¤‡éƒ½ä¼šåœ¨ /dev/ ç›®å½•ä¸‹ï¼Œæ¯”å¦‚ NVIDIA GPU å°±æ˜¯ /dev/nvidia0ã€/dev/nvidia1 è¿™æ ·ï¼Œä¸è¿‡å…·ä½“é€»è¾‘è¿˜æ˜¯å¾—ç¡¬ä»¶å‚å•†è‡ªå·±å®ç°&lt;/li&gt;
&lt;li&gt;ç„¶å device plugin ä¼šä»¥ DaemonSet æ–¹å¼éƒ¨ç½²åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œå› æ­¤èƒ½å‘ç°æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„è®¾å¤‡
&lt;img src=&#34;post/2024/images/2024-01-24-device-plugin/IMG_20250125-223501456.png&#34; alt=&#34;picture 8&#34; /&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;2ï¼‰device plugin Allocate æ–¹æ³•æ€ä¹ˆå®ç°åˆ†é…è®¾å¤‡ç»™å®¹å™¨çš„ï¼Ÿ
&amp;gt; éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šAllocate æ–¹æ³•å¹¶æ²¡æœ‰çœŸæ­£å°†è®¾å¤‡åˆ†é…ç»™å®¹å™¨ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ç”šè‡³éƒ½è¿˜æ²¡åˆ›å»ºå®¹å™¨ï¼Œåªæ˜¯åœ¨è¯¥æ–¹æ³•ä¸­å¯ä»¥é€šè¿‡ Envã€Mountsã€Devicesã€Annotationsã€CDIDevices ç­‰ä¸åŒå½¢å¼æ¥ä¼ é€’ è¦å°†é‚£äº›è®¾å¤‡åˆ†é…ç»™è¯¥å®¹å™¨ è¿™ä¸ªä¿¡æ¯ç»™åç»­ç»„ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;è¿™äº›ä¿¡æ¯ä¼ ç»™ Kubeletï¼Œç„¶å Kubelet é€šè¿‡ CRI è°ƒç”¨ Runtimeï¼ˆDocker/Containerd ç­‰ç­‰ï¼‰çœŸæ­£å¼€å§‹åˆ›å»ºå®¹å™¨ã€‚&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚ NVIDIA åœ¨ Allocate ä¸­å°±ä¼ é€’äº† NVIDIA_VISIBLE_DEVICES è¿™ä¸ª Envï¼Œç„¶åè‡ªå·±å®ç°äº† nvidia-container-runtimeï¼Œè¯¥ runtime å°±å¯ä»¥æ ¹æ®è¯¥ Env çŸ¥é“è¦æŠŠå“ªä¸ª GPU åˆ†é…ç»™å®¹å™¨ï¼Œç„¶åä¿®æ”¹å®¹å™¨çš„ OCI Specï¼Œæœ€ç»ˆ runC(æˆ–è€…å…¶ä»–å®ç°)çœŸæ­£åˆ›å»ºå®¹å™¨æ—¶å°±ä¼šæŒ‰ç…§è¿™ä¸ªæè¿°å»å¤„ç†ã€‚&lt;/p&gt;

&lt;p&gt;åˆæ¯”å¦‚ ix-device-plugin å°±æ˜¯ç”¨çš„ Devices æ–¹å¼,ç›´æ¥æŒ‡å®šåˆ†é…ç»™å®¹å™¨çš„è®¾å¤‡åœ¨å®¿ä¸»æœºçš„ä½ç½®ï¼Œä»¥åŠè¦æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ä½ç½®ï¼Œè¿™æ ·å°±ä¸éœ€è¦å®ç°è‡ªå·±çš„ container-runtime äº†ï¼ŒrunC åˆ›å»ºå®¹å™¨æ—¶ä¹Ÿèƒ½æŠŠå¯¹åº”è®¾å¤‡åˆ†é…ç»™å®¹å™¨ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ ·åˆå¼•å‡ºä¸€ä¸ªå°é—®é¢˜ï¼Œæ—¢ç„¶å¤©æ•°(ix-device-plugin)è¿™ä¸ªå®ç°åªç”¨ Devices å°±èƒ½æ­£å¸¸è¿è¡Œï¼Œé‚£ä¸ºä»€ä¹ˆ NVIDIA å®ç°äº† Devices åˆå®ç°äº†ä¸€ä¸ª Envï¼Ÿ&lt;/p&gt;

&lt;p&gt;å…¶å®è¿™ä¸ª Env çš„å®ç°æ˜¯ä¸ºäº†å…¼å®¹é k8s ç¯å¢ƒï¼Œæ¯”å¦‚ Docker ç¯å¢ƒï¼š&lt;/p&gt;

&lt;p&gt;nvidia å¯ä»¥åœ¨å¯åŠ¨å®¹å™¨æ—¶æŒ‡å®š GPU&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# --gpus
docker run --gpus device=0 -it tensorflow/tensorflow:latest-gpu bash
# æˆ–è€…ç¯å¢ƒå˜é‡ NVIDIA_VISIBLE_DEVICES
docker run -e NVIDIA_VISIBLE_DEVICES=0 -it tensorflow/tensorflow:latest-gpu bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€Œå¤©æ•°åˆ™ä¸è¡Œï¼Œå°±åƒè¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo docker run --shm-size=&amp;quot;32g&amp;quot; -it -v /usr/src:/usr/src -v /lib/modules:/lib/modules -v /dev:/dev --privileged --cap-add=ALL --pid=host corex:4.0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œéœ€è¦è‡ªå·±ä½¿ç”¨ -v å°†ç›¸å…³æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨æ‰èƒ½ä½¿ç”¨ï¼Œnvidia-container-runtime å®åˆ™æ˜¯å°†è¿™éƒ¨åˆ†è¿›è¡Œäº†å°è£…ç®€åŒ–ï¼Œç”¨æˆ·åªéœ€è¦ä¼ ä¸€ä¸ªå‚æ•°å³å¯ã€‚&lt;/p&gt;

&lt;p&gt;3ï¼‰ä¸ºä»€ä¹ˆ device plugin è¦ Watch Kubelet çŠ¶æ€ï¼Œå½“ Kubelet é‡å¯å device plugin ä¹Ÿè¦è·Ÿç€é‡å¯ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªé—®é¢˜å®é™…ä¸Šå¯ä»¥ç¿»è¯‘ä¸ºï¼šä¸ºä»€ä¹ˆ Kubelet é‡å¯åï¼Œdevice plugin éœ€è¦é‡æ–°å‘ Kubelet æ³¨å†Œï¼Ÿ&lt;/p&gt;

&lt;p&gt;å› ä¸º device plugin çš„æ³¨å†Œä¿¡æ¯ Kubelet æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œä½¿ç”¨ Go ä¸­çš„ Map ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚é‡å¯åå°±ä¼šä¸¢å¤±ï¼Œå› æ­¤å„ä¸ª device plugin éƒ½éœ€è¦é‡æ–°æ³¨å†Œã€‚&lt;/p&gt;

&lt;p&gt;è‡³äºä¸ºä»€ä¹ˆ device plugin ä¸€èˆ¬ä¹Ÿä¼šè·Ÿç€é‡å¯ï¼Œæ˜¯å› ä¸º device plugin åœ¨å¯åŠ¨æ—¶ä¼šè°ƒç”¨å› æ­¤æ³¨å†Œæ¥å£ï¼Œå› æ­¤æ„ŸçŸ¥åˆ° Kubelet é‡å¯äº†ï¼Œç›´æ¥è®© device plugin é€€å‡ºå³å¯ï¼Œç„¶å DaemonSet ä¼šé‡æ–°æ‹‰èµ· Podï¼Œè¿™æ ·å¯åŠ¨åè‡ªåŠ¨è°ƒç”¨æ³¨å†Œæ¥å£ã€‚&lt;/p&gt;

&lt;h1 id=&#34;6-å‚è€ƒ&#34;&gt;6. å‚è€ƒ&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://www.lixueduan.com/posts/kubernetes/21-device-plugin/&#34;&gt;Kubernetesæ•™ç¨‹(äºŒä¸€)&amp;mdash;è‡ªå®šä¹‰èµ„æºæ”¯æŒï¼šK8s Device Plugin ä»åŸç†åˆ°å®ç°&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(09): ä½¿ç”¨ GPU Operatoræ­å»ºAIç®—åŠ›ç¯å¢ƒ</title>
            <link>http://mospany.github.io/2024/01/17/gpu-operator/</link>
            <pubDate>Wed, 17 Jan 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/17/gpu-operator/</guid>
            <description>

&lt;h1 id=&#34;1-å¼•è¨€&#34;&gt;1. å¼•è¨€&lt;/h1&gt;

&lt;p&gt;ä¸ºäº†å­¦ä¹ AIåº”ç”¨ã€ç®—æ³•ä¸ç®—åŠ›ç­‰æŠ€æœ¯ï¼Œåº”ç”¨éœ€è·‘åœ¨GPUå¡ä¸Šï¼Œéœ€è¦åœ¨èŠ‚ç‚¹ä¸Šå®‰è£… GPU Driverã€Container Toolkit ç­‰ç»„ä»¶ï¼Œå½“é›†ç¾¤è§„æ¨¡è¾ƒå¤§æ—¶è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNVIDIA æ¨å‡ºäº† GPU Operatorï¼ŒGPU Operator æ—¨åœ¨ç®€åŒ–åœ¨ Kubernetes ç¯å¢ƒä¸­ä½¿ç”¨ GPU çš„è¿‡ç¨‹ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹å¼å¤„ç† GPU é©±åŠ¨ç¨‹åºå®‰è£…ã€Controller Toolkitã€Device-Plugin ã€ç›‘æ§ç­‰ç»„ä»¶ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åŸºæœ¬ä¸ŠæŠŠéœ€è¦æ‰‹åŠ¨å®‰è£…ã€é…ç½®çš„åœ°æ–¹å…¨éƒ¨è‡ªåŠ¨åŒ–å¤„ç†äº†ï¼Œæå¤§ç®€åŒ–äº† k8s ç¯å¢ƒä¸­çš„ GPU ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;psï¼šåªæœ‰ NVIDIA GPU å¯ä»¥ä½¿ç”¨ï¼Œå…¶ä»–å‚å®¶ç°åœ¨åŸºæœ¬è¿˜æ˜¯æ‰‹åŠ¨å®‰è£…ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;2-è§„åˆ’&#34;&gt;2. è§„åˆ’&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº«å¦‚ä½•ä½¿ç”¨ GPU Operator å¿«é€Ÿæ­å»º Kubernetes GPU ç¯å¢ƒã€‚&lt;/p&gt;

&lt;p&gt;åŸºäºå¦‚ä¸‹ç¯å¢ƒæ­å»ºï¼š
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250117-194645644.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;br /&gt;
æŸ¥çœ‹workerèŠ‚ç‚¹GPUä¿¡æ¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-worker1 ~]# lspci | grep -i nvidia
00:07.0 VGA compatible controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
[root@k8s-worker1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯´æ˜è¯¥workerèŠ‚ç‚¹æœ‰1å¼ NVIDIA Tesla T4çš„GPUå¡ã€‚&lt;/p&gt;

&lt;h1 id=&#34;3-ç»„ä»¶ä»‹ç»&#34;&gt;3. ç»„ä»¶ä»‹ç»&lt;/h1&gt;

&lt;p&gt;è¿™éƒ¨åˆ†ä¸»è¦åˆ†æä¸‹ GPU Operator æ¶‰åŠåˆ°çš„å„ä¸ªç»„ä»¶åŠå…¶ä½œç”¨ã€‚&lt;/p&gt;

&lt;p&gt;NVIDIA GPU Operatoræ€»å…±åŒ…å«å¦‚ä¸‹çš„å‡ ä¸ªç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;NFD(Node Feature Discovery)ï¼šç”¨äºç»™èŠ‚ç‚¹æ‰“ä¸ŠæŸäº›æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾åŒ…æ‹¬ cpu idã€å†…æ ¸ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€æ˜¯ä¸æ˜¯ GPU èŠ‚ç‚¹ç­‰ï¼Œå…¶ä¸­éœ€è¦å…³æ³¨çš„æ ‡ç­¾æ˜¯nvidia.com/gpu.present=trueï¼Œå¦‚æœèŠ‚ç‚¹å­˜åœ¨è¯¥æ ‡ç­¾ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥èŠ‚ç‚¹æ˜¯ GPU èŠ‚ç‚¹ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;GFD(GPU Feature Discovery)ï¼šç”¨äºæ”¶é›†èŠ‚ç‚¹çš„ GPU è®¾å¤‡å±æ€§ï¼ˆGPU é©±åŠ¨ç‰ˆæœ¬ã€GPUå‹å·ç­‰ï¼‰ï¼Œå¹¶å°†è¿™äº›å±æ€§ä»¥èŠ‚ç‚¹æ ‡ç­¾çš„æ–¹å¼é€å‡ºã€‚åœ¨k8s é›†ç¾¤ä¸­ä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œåªæœ‰èŠ‚ç‚¹æ‹¥æœ‰æ ‡ç­¾nvidia.com/gpu.present=trueæ—¶ï¼ŒDaemonSet æ§åˆ¶çš„ Pod æ‰ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;æ–°ç‰ˆæœ¬ GFD è¿ç§»åˆ°äº† &lt;a href=&#34;https://github.com/NVIDIA/k8s-device-plugin/tree/main/docs/gpu-feature-discovery&#34;&gt;NVIDIA/k8s-device-plugin&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;NVIDIA Driver Installerï¼šåŸºäºå®¹å™¨çš„æ–¹å¼åœ¨èŠ‚ç‚¹ä¸Šå®‰è£… NVIDIA GPU é©±åŠ¨ï¼Œåœ¨ k8s é›†ç¾¤ä¸­ä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œåªæœ‰èŠ‚ç‚¹æ‹¥æœ‰æ ‡ç­¾nvidia.com/gpu.present=trueæ—¶ï¼ŒDaemonSet æ§åˆ¶çš„ Pod æ‰ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;NVIDIA Container Toolkit Installerï¼šèƒ½å¤Ÿå®ç°åœ¨å®¹å™¨ä¸­ä½¿ç”¨ GPU è®¾å¤‡ï¼Œåœ¨ k8s é›†ç¾¤ä¸­ä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ï¼ŒåŒæ ·çš„ï¼Œåªæœ‰èŠ‚ç‚¹æ‹¥æœ‰æ ‡ç­¾nvidia.com/gpu.present=trueæ—¶ï¼ŒDaemonSet æ§åˆ¶çš„ Pod æ‰ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;NVIDIA Device Pluginï¼šNVIDIA Device Plugin ç”¨äºå®ç°å°† GPU è®¾å¤‡ä»¥ Kubernetes æ‰©å±•èµ„æºçš„æ–¹å¼ä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œåœ¨ k8s é›†ç¾¤ä¸­ä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œåªæœ‰èŠ‚ç‚¹æ‹¥æœ‰æ ‡ç­¾nvidia.com/gpu.present=trueæ—¶ï¼ŒDaemonSet æ§åˆ¶çš„ Pod æ‰ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;DCGM Exporterï¼šå‘¨æœŸæ€§çš„æ”¶é›†èŠ‚ç‚¹ GPU è®¾å¤‡çš„çŠ¶æ€ï¼ˆå½“å‰æ¸©åº¦ã€æ€»çš„æ˜¾å­˜ã€å·²ä½¿ç”¨æ˜¾å­˜ã€ä½¿ç”¨ç‡ç­‰ï¼‰å¹¶æš´éœ² Metricsï¼Œç»“åˆ Prometheus å’Œ Grafana ä½¿ç”¨ã€‚åœ¨ k8s é›†ç¾¤ä¸­ä»¥DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œåªæœ‰èŠ‚ç‚¹æ‹¥æœ‰æ ‡ç­¾nvidia.com/gpu.present=trueæ—¶ï¼ŒDaemonSet æ§åˆ¶çš„ Pod æ‰ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é¦–å…ˆæ˜¯ GFDã€NFDï¼ŒäºŒè€…éƒ½æ˜¯ç”¨äºå‘ç° Node ä¸Šçš„ä¿¡æ¯ï¼Œå¹¶ä»¥ label å½¢å¼æ·»åŠ åˆ° k8s node å¯¹è±¡ä¸Šï¼Œç‰¹åˆ«æ˜¯ GFD ä¼šæ·»åŠ nvidia.com/gpu.present=true æ ‡ç­¾è¡¨ç¤ºè¯¥èŠ‚ç‚¹æœ‰ GPUï¼Œåªæœ‰æºå¸¦è¯¥æ ‡ç­¾çš„èŠ‚ç‚¹æ‰ä¼šå®‰è£…åç»­ç»„ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶ååˆ™æ˜¯ Driver Installerã€Container Toolkit Installer ç”¨äºå®‰è£… GPU é©±åŠ¨å’Œ container toolkitã€‚&lt;/p&gt;

&lt;p&gt;æ¥ä¸‹æ¥åˆ™æ˜¯ device-plugin è®© k8s èƒ½æ„ŸçŸ¥åˆ° GPU èµ„æºä¿¡æ¯ä¾¿äºè°ƒåº¦å’Œç®¡ç†ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åçš„ exporter åˆ™æ˜¯é‡‡é›† GPU ç›‘æ§å¹¶ä»¥ Prometheus Metrics æ ¼å¼æš´éœ²ï¼Œç”¨äºåš GPU ç›‘æ§ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;è¿™äº›ç»„ä»¶åŸºæœ¬å°±æŠŠéœ€è¦æ‰‹åŠ¨é…ç½®çš„ä¸œè¥¿éƒ½è‡ªåŠ¨åŒ–äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;NVIDIA GPU Operator ä¾å¦‚ä¸‹çš„é¡ºåºéƒ¨ç½²å„ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”å¦‚æœå‰ä¸€ä¸ªç»„ä»¶éƒ¨ç½²å¤±è´¥ï¼Œé‚£ä¹ˆå…¶åé¢çš„ç»„ä»¶å°†åœæ­¢éƒ¨ç½²ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;NVIDIA Driver Installer&lt;/li&gt;
&lt;li&gt;NVIDIA Container Toolkit Installer&lt;/li&gt;
&lt;li&gt;NVIDIA Device Plugin&lt;/li&gt;
&lt;li&gt;DCGM Exporter&lt;/li&gt;
&lt;li&gt;GFD&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä»¥ DaemonSet æ–¹å¼éƒ¨ç½²ï¼Œå¹¶ä¸”åªæœ‰å½“èŠ‚ç‚¹å­˜åœ¨æ ‡ç­¾ nvidia.com/gpu.present=true æ—¶ï¼Œå„ DaemonSetæ§åˆ¶çš„ Pod æ‰ä¼šåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;nvidia.com/gpu.deploy.driver=pre-installed
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-1-gfd-nfd&#34;&gt;3.1. GFD &amp;amp; NFD&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;GFDï¼šGPU Feature Discovery&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;NFDï¼šNode Feature Discovery&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ ¹æ®åç§°åŸºæœ¬èƒ½çŒœåˆ°è¿™ä¸¤ä¸ªç»„ä»¶çš„åŠŸèƒ½ï¼Œå‘ç°èŠ‚ç‚¹ä¿¡æ¯å’Œ GPU ä¿¡æ¯å¹¶ä»¥ Label å½¢å¼æ·»åŠ åˆ° k8s ä¸­çš„ node å¯¹è±¡ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;å…¶ä¸­ NFD æ·»åŠ çš„ label ä»¥   feature.node.kubernetes.io ä½œä¸ºå‰ç¼€ï¼Œæ¯”å¦‚:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;feature.node.kubernetes.io/cpu-cpuid.ADX=true
feature.node.kubernetes.io/system-os_release.ID=ubuntu
feature.node.kubernetes.io/system-os_release.VERSION_ID.major=22
feature.node.kubernetes.io/system-os_release.VERSION_ID.minor=04
feature.node.kubernetes.io/system-os_release.VERSION_ID=22.04
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äº GFD åˆ™ä¸»è¦è®°å½• GPU ä¿¡æ¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;nvidia.com/cuda.runtime.major=12
nvidia.com/cuda.runtime.minor=2
nvidia.com/cuda.driver.major=535
nvidia.com/cuda.driver.minor=161
nvidia.com/gpu.product=Tesla-T4
nvidia.com/gpu.memory=15360
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-2-driver-installer&#34;&gt;3.2. Driver Installer&lt;/h2&gt;

&lt;p&gt;NVIDIA å®˜æ–¹æä¾›äº†ä¸€ç§åŸºäºå®¹å™¨å®‰è£… NVIDIA é©±åŠ¨çš„æ–¹å¼ï¼ŒGPU Operator å®‰è£… nvidia é©±åŠ¨ä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;å½“ NVIDIA é©±åŠ¨åŸºäºå®¹å™¨åŒ–å®‰è£…åï¼Œæ•´ä¸ªæ¶æ„å°†æ¼”å˜æˆå›¾ä¸­æè¿°çš„æ ·å­ï¼š
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-152421553.png&#34; alt=&#34;picture 5&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Driver Installer ç»„ä»¶å¯¹åº”çš„ DaemonSet å°±æ˜¯nvidia-driver-daemonset-5.15.0-105-generic-ubuntu22.04ã€‚&lt;/p&gt;

&lt;p&gt;è¯¥ DaemonSet å¯¹åº”çš„é•œåƒä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@test:~# kgo get ds nvidia-driver-daemonset-5.15.0-105-generic-ubuntu22.04 -oyaml|grep image
        image: nvcr.io/nvidia/driver:535-5.15.0-105-generic-ubuntu22.04
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ DaemonSet åç§°/é•œåƒç”±å‡ éƒ¨åˆ†ç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;nvidia-driver-daemonset è¿™éƒ¨åˆ†ä¸ºå‰ç¼€&lt;/li&gt;
&lt;li&gt;5.15.0-105-generic ä¸ºå†…æ ¸ç‰ˆæœ¬ï¼Œä½¿ç”¨uname -r å‘½ä»¤æŸ¥çœ‹&lt;/li&gt;
&lt;li&gt;ubuntu22.04 æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼Œä½¿ç”¨cat /etc/os-release å‘½ä»¤æŸ¥çœ‹&lt;/li&gt;
&lt;li&gt;535ï¼šè¿™ä¸ªæ˜¯ GPU Driver çš„ç‰ˆæœ¬å·ï¼Œè¿™é‡Œè¡¨ç¤ºå®‰è£… 535 ç‰ˆæœ¬é©±åŠ¨ï¼Œåœ¨éƒ¨ç½²æ—¶å¯ä»¥æŒ‡å®šã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;GPU Operator ä¼šè‡ªåŠ¨æ ¹æ®èŠ‚ç‚¹ä¸Šçš„å†…æ ¸ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿç”Ÿæˆ DaemonSet é•œåƒï¼Œå› ä¸ºæ˜¯ä»¥ DaemonSet æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½æ˜¯è·‘çš„åŒä¸€ä¸ª Podï¼Œ&lt;strong&gt;å› æ­¤è¦é™åˆ¶é›†ç¾¤ä¸­çš„æ‰€æœ‰ GPU èŠ‚ç‚¹æ“ä½œç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬å¿…é¡»ä¸€è‡´ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼šå¦‚æœæå‰æ‰‹åŠ¨åœ¨èŠ‚ç‚¹ä¸Šå®‰è£… GPU é©±åŠ¨ï¼Œé‚£ä¹ˆ GPU Operator æ£€æµ‹åˆ°ä¹‹åå°±ä¸ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šå¯åŠ¨ Installer Podï¼Œè¿™æ ·è¯¥èŠ‚ç‚¹å°±å¯ä»¥ä¸éœ€è¦ç®¡æ“ä½œç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;3-3-nvidia-container-toolkit-installer&#34;&gt;3.3. NVIDIA Container Toolkit Installer&lt;/h2&gt;

&lt;p&gt;è¯¥ç»„ä»¶ç”¨äºå®‰è£… NVIDIA Container Toolkitã€‚&lt;/p&gt;

&lt;p&gt;æ‰‹åŠ¨å®‰è£…çš„æ—¶å€™æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰å®‰è£… NVIDIA Container Toolkit&lt;/p&gt;

&lt;p&gt;2ï¼‰ä¿®æ”¹ Runtime é…ç½®æŒ‡å®šä½¿ç”¨ nvidia-runtime&lt;/p&gt;

&lt;p&gt;åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­æ–°å¢ nvidia-container-runtimeï¼Œä»¥ä¾¿å¤„ç† GPU ç›¸å…³æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-153551818.png&#34; alt=&#34;picture 6&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™ä¸ª Installer åšçš„æ“ä½œä¹Ÿå°±æ˜¯è¿™ä¸¤æ­¥ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰å°†å®¹å™¨ä¸­NVIDIA Container Toolkitç»„ä»¶æ‰€æ¶‰åŠçš„å‘½ä»¤è¡Œå·¥å…·å’Œåº“æ–‡ä»¶ç§»åŠ¨åˆ°/usr/local/nvidia/toolkitç›®å½•ä¸‹&lt;/p&gt;

&lt;p&gt;2ï¼‰åœ¨ /usr/local/nvidia/toolkit/.config/nvidia-container-runtimeåˆ›å»ºnvidia-container-runtimeçš„é…ç½®æ–‡ä»¶config.tomlï¼Œå¹¶è®¾ç½®nvidia-container-cli.rootçš„å€¼ä¸º/run/nvidia/driverã€‚&lt;/p&gt;

&lt;h1 id=&#34;4-éƒ¨ç½²&#34;&gt;4. éƒ¨ç½²&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š &lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html#operator-install-guide&#34;&gt;operator-install-guide&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;4-1-å‡†å¤‡å·¥ä½œ&#34;&gt;4.1. å‡†å¤‡å·¥ä½œ&lt;/h2&gt;

&lt;p&gt;è¦æ±‚ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰GPU èŠ‚ç‚¹å¿…é¡»è¿è¡Œç›¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œ&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœæå‰æ‰‹åŠ¨åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…é©±åŠ¨çš„è¯ï¼Œè¯¥èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ“ä½œç³»ç»Ÿ&lt;/li&gt;
&lt;li&gt;CPU èŠ‚ç‚¹æ“ä½œç³»ç»Ÿæ²¡è¦æ±‚ï¼Œå› ä¸º gpu-operator åªä¼šåœ¨ GPU èŠ‚ç‚¹ä¸Šè¿è¡Œ
2ï¼‰GPU èŠ‚ç‚¹å¿…é¡»é…ç½®ç›¸åŒå®¹å™¨å¼•æ“ï¼Œä¾‹å¦‚éƒ½æ˜¯ containerd æˆ–è€…éƒ½æ˜¯ docker&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;3ï¼‰å¦‚æœä½¿ç”¨äº† Pod Security Admission (PSA) ï¼Œéœ€è¦ä¸º gpu-operator æ ‡è®°ç‰¹æƒæ¨¡å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# kubectl create ns gpu-operator
namespace/gpu-operator created
[root@k8s-master1 ~]# kubectl label --overwrite ns gpu-operator pod-security.kubernetes.io/enforce=privileged
namespace/gpu-operator labeled
[root@k8s-master1 ~]# kubectl get ns gpu-operator --show-labels
NAME           STATUS   AGE   LABELS
gpu-operator   Active   30s   kubernetes.io/metadata.name=gpu-operator,pod-security.kubernetes.io/enforce=privileged
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4ï¼‰é›†ç¾¤ä¸­ä¸è¦å®‰è£… NFDï¼Œå¦‚æœå·²ç»å®‰è£…äº†éœ€è¦å†å®‰è£… gpu-operator æ—¶ç¦ç”¨ NFD éƒ¨ç½²ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹é›†ç¾¤ä¸­æ˜¯å¦éƒ¨ç½² NFD&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl get nodes -o json | jq &#39;.items[].metadata.labels | keys | any(startswith(&amp;quot;feature.node.kubernetes.io&amp;quot;))&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœè¿”å› true åˆ™è¯´æ˜é›†ç¾¤ä¸­å®‰è£…äº† NFDã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-2-helméƒ¨ç½²&#34;&gt;4.2. helméƒ¨ç½²&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š &lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html#operator-install-guide&#34;&gt;operator-install-guide&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;4-2-1-å®‰è£…helmå‘½ä»¤&#34;&gt;4.2.1. å®‰è£…helmå‘½ä»¤&lt;/h3&gt;

&lt;p&gt;å¦‚æœmasterèŠ‚ç‚¹ä¸Šè¿˜æœªå®‰è£…helmå‘½ä»¤ï¼Œéœ€å®‰è£…&lt;/p&gt;

&lt;h4 id=&#34;4-2-1-1-ä¸‹è½½-helm-3-çš„æœ€æ–°ç‰ˆæœ¬&#34;&gt;4.2.1.1. ä¸‹è½½ Helm 3 çš„æœ€æ–°ç‰ˆæœ¬&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl https://get.helm.sh/helm-v3.11.1-linux-amd64.tar.gz -o helm-v3.11.1-linux-amd64.tar.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;4-2-1-2-è§£å‹å®‰è£…åŒ…&#34;&gt;4.2.1.2. è§£å‹å®‰è£…åŒ…&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 helm]# ls
helm-v3.11.1-linux-amd64.tar.gz
[root@k8s-master1 helm]# tar -zxvf helm-v3.11.1-linux-amd64.tar.gz 
linux-amd64/
linux-amd64/helm
linux-amd64/LICENSE
linux-amd64/README.md
[root@k8s-master1 helm]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;4-2-1-3-ç§»åŠ¨-helm-åˆ°ç³»ç»Ÿçš„å¯æ‰§è¡Œè·¯å¾„&#34;&gt;4.2.1.3. ç§»åŠ¨ helm åˆ°ç³»ç»Ÿçš„å¯æ‰§è¡Œè·¯å¾„&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo mv linux-amd64/helm /usr/local/bin/helm`
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;4-2-1-4-éªŒè¯å®‰è£…&#34;&gt;4.2.1.4. éªŒè¯å®‰è£…&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 helm]# helm version
version.BuildInfo{Version:&amp;quot;v3.11.1&amp;quot;, GitCommit:&amp;quot;293b50c65d4d56187cd4e2f390f0ada46b4c4737&amp;quot;, GitTreeState:&amp;quot;clean&amp;quot;, GoVersion:&amp;quot;go1.18.10&amp;quot;}
[root@k8s-master1 helm]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯´æ˜å®‰è£…æˆåŠŸã€‚&lt;/p&gt;

&lt;h3 id=&#34;4-2-2-chartéƒ¨ç½²&#34;&gt;4.2.2. chartéƒ¨ç½²&lt;/h3&gt;

&lt;h4 id=&#34;4-2-2-1-æ·»åŠ repoä»“åº“&#34;&gt;4.2.2.1. æ·»åŠ repoä»“åº“&lt;/h4&gt;

&lt;p&gt;æ·»åŠ  nvidia helm ä»“åº“å¹¶æ›´æ–°&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;helm repo add nvidia https://helm.ngc.nvidia.com/nvidia \
    &amp;amp;&amp;amp; helm repo update
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;4-2-2-2-æ‹‰å–chartåŒ…&#34;&gt;4.2.2.2. æ‹‰å–chartåŒ…&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;helm pull nvidia/gpu-operator --version v24.9.1 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†åœ¨æœ¬åœ°ç”Ÿæˆgpu-operator-v24.9.1.tgzæ–‡ä»¶ã€‚&lt;/p&gt;

&lt;h4 id=&#34;4-2-2-3-å‡†å¤‡é•œåƒ&#34;&gt;4.2.2.3. å‡†å¤‡é•œåƒ&lt;/h4&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç”±äºæœ‰äº›é•œåƒå›½å†…ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œéœ€ä»å›½å†…é•œåƒåœ°å€æ‹‰å–åå†ä¿®æ”¹tagã€‚
1ï¼‰æ‹‰å–å›½å†…ä»£ç†é•œåƒï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;crictl pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/nfd/node-feature-discovery:v0.16.6
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ï¼‰ä¿®æ”¹é•œåƒtagï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ctr -n k8s.io image tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/nfd/node-feature-discovery:v0.16.6 registry.k8s.io/nfd/node-feature-discovery:v0.16.6 
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;4-2-2-4-å®‰è£…chartåŒ…&#34;&gt;4.2.2.4. å®‰è£…chartåŒ…&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æ·»åŠ  nvidia helm ä»“åº“å¹¶æ›´æ–°
helm repo add nvidia https://helm.ngc.nvidia.com/nvidia \
    &amp;amp;&amp;amp; helm repo update
# ä»¥é»˜è®¤é…ç½®å®‰è£…
helm install --wait --generate-name \
    -n gpu-operator --create-namespace \
    nvidia/gpu-operator

# å¦‚æœæå‰æ‰‹åŠ¨å®‰è£…äº† gpu é©±åŠ¨ï¼Œoperator ä¸­è¦ç¦æ­¢ gpu å®‰è£…
helm install --wait --generate-name \
     -n gpu-operator --create-namespace \
     nvidia/gpu-operator \
     --set driver.enabled=false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®Œæˆå ä¼šå¯åŠ¨ Pod å®‰è£…é©±åŠ¨ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šå·²ç»å®‰è£…äº†é©±åŠ¨äº†ï¼Œé‚£ä¹ˆ gpu-operaotr å°±ä¸ä¼šå¯åŠ¨å®‰è£…é©±åŠ¨çš„ Pod,é€šè¿‡ label è¿›è¡Œç­›é€‰ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ²¡å®‰è£…é©±åŠ¨çš„èŠ‚ç‚¹ä¼šæ‰“ä¸Š nvidia.com/gpu.deploy.driver=true ,è¡¨ç¤ºéœ€è¦å®‰è£…é©±åŠ¨&lt;/li&gt;
&lt;li&gt;å·²ç»æ‰‹åŠ¨å®‰è£…è¿‡é©±åŠ¨çš„èŠ‚ç‚¹ä¼šæ‰“ä¸Šnvidia.com/gpu.deploy.driver=pre-install,Daemonset åˆ™ä¸ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-113127922.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;å½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªæ“ä½œç³»ç»Ÿ+å†…æ ¸ç‰ˆæœ¬çš„ç»„åˆï¼ŒNVIDIA éƒ½æä¾›äº†å¯¹åº”çš„é•œåƒï¼Œå¯ä»¥æå‰åœ¨ NVIDIA/driver tags æŸ¥çœ‹å½“å‰ NVIDIA æä¾›çš„é©±åŠ¨ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;5-æµ‹è¯•&#34;&gt;5. æµ‹è¯•&lt;/h1&gt;

&lt;p&gt;éƒ¨ç½²åï¼Œä¼šåœ¨gpu-operator namespace ä¸‹å¯åŠ¨ç›¸å…³ Podï¼ŒæŸ¥çœ‹ä¸€ä¸‹ Pod çš„è¿è¡Œæƒ…å†µï¼Œé™¤äº†ä¸€ä¸ª Completed ä¹‹å¤–å…¶ä»–åº”è¯¥éƒ½æ˜¯ Running çŠ¶æ€ã€‚
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-113933891.png&#34; alt=&#34;picture 2&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åè¿›å…¥nvidia-device-plugin-daemonset-xxx Podï¼Œåœ¨è¯¥ Pod ä¸­å¯ä»¥æ‰§è¡Œ nvidia-smiå‘½ä»¤,æ¯”å¦‚æŸ¥çœ‹ GPU ä¿¡æ¯ï¼š
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-115125616.png&#34; alt=&#34;picture 3&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æœ€åå†æŸ¥çœ‹ node ä¿¡æ¯
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-115436263.png&#34; alt=&#34;picture 4&#34; /&gt;&lt;br /&gt;
å¯ä»¥çœ‹å‡ºnvidia.com/gpu: &amp;ldquo;1&amp;rdquo;æ€»é‡ä¸º1ï¼Œ å¯åˆ†é…ä¹Ÿä¸º1ã€‚&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼Œè¯´æ˜æˆ‘ä»¬çš„ GPU Operator å·²ç»å®‰è£…æˆåŠŸï¼ŒK8s ä¹Ÿèƒ½æ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ GPUï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ Pod ä¸­ä½¿ç”¨ GPU äº†ã€‚&lt;/p&gt;

&lt;p&gt;åˆ›å»ºä¸€ä¸ªæµ‹è¯• Podï¼Œç”³è¯·ä¸€ä¸ª GPUï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Pod
metadata:
  name: cuda-vectoradd
spec:
  restartPolicy: OnFailure
  containers:
  - name: cuda-vectoradd
    image: &amp;quot;nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2&amp;quot;
    resources:
      limits:
        nvidia.com/gpu: 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ­£å¸¸çš„ Pod æ—¥å¿—å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 yaml]# kubectl logs cuda-vectoradd 
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åœ¨ k8s ä¸­ä½¿ç”¨ GPU äº†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;6-åŸç†&#34;&gt;6. åŸç†&lt;/h1&gt;

&lt;p&gt;è¿™éƒ¨åˆ†ä¸»è¦åˆ†æä¸€ä¸‹ Driver Installer å’Œ NVIDIA Container Toolkit Installer è¿™ä¸¤ä¸ªç»„ä»¶æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¤§è‡´åŸç†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;6-1-driver-installer&#34;&gt;6.1. Driver Installer&lt;/h2&gt;

&lt;p&gt;NVIDIA å®˜æ–¹æä¾›äº†ä¸€ç§åŸºäºå®¹å™¨å®‰è£… NVIDIA é©±åŠ¨çš„æ–¹å¼ï¼ŒGPU Operator å®‰è£… nvidia é©±åŠ¨ä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;å½“ NVIDIA é©±åŠ¨åŸºäºå®¹å™¨åŒ–å®‰è£…åï¼Œæ•´ä¸ªæ¶æ„å°†æ¼”å˜æˆå›¾ä¸­æè¿°çš„æ ·å­ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-184040318.png&#34; alt=&#34;picture 7&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;6-2-nvidia-container-toolkit-installer&#34;&gt;6.2. NVIDIA Container Toolkit Installer&lt;/h2&gt;

&lt;p&gt;è¯¥ç»„ä»¶ç”¨äºå®‰è£… NVIDIA Container Toolkitã€‚&lt;/p&gt;

&lt;p&gt;æ‰‹åŠ¨å®‰è£…çš„æ—¶å€™æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰å®‰è£… NVIDIA Container Toolkit&lt;/p&gt;

&lt;p&gt;2ï¼‰ä¿®æ”¹ Runtime é…ç½®æŒ‡å®šä½¿ç”¨ nvidia-runtime
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-190232787.png&#34; alt=&#34;picture 9&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­æ–°å¢ nvidia-container-runtimeï¼Œä»¥ä¾¿å¤„ç† GPU ç›¸å…³æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-185351436.png&#34; alt=&#34;picture 8&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™ä¸ª Installer åšçš„æ“ä½œä¹Ÿå°±æ˜¯è¿™ä¸¤æ­¥ï¼š&lt;/p&gt;

&lt;p&gt;1ï¼‰å°†å®¹å™¨ä¸­NVIDIA Container Toolkitç»„ä»¶æ‰€æ¶‰åŠçš„å‘½ä»¤è¡Œå·¥å…·å’Œåº“æ–‡ä»¶ç§»åŠ¨åˆ°/usr/local/nvidia/toolkitç›®å½•ä¸‹
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-211806300.png&#34; alt=&#34;picture 10&#34; /&gt;&lt;/p&gt;

&lt;p&gt;2ï¼‰åœ¨ /usr/local/nvidia/toolkit/.config/nvidia-container-runtimeåˆ›å»ºnvidia-container-runtimeçš„é…ç½®æ–‡ä»¶config.tomlï¼Œå¹¶è®¾ç½®nvidia-container-cli.rootçš„å€¼ä¸º/run/nvidia/driverã€‚
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250123-212557933.png&#34; alt=&#34;picture 11&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;7-å°ç»“&#34;&gt;7. å°ç»“&lt;/h1&gt;

&lt;p&gt;å°ç»“
æœ¬æ–‡ä¸»è¦åˆ†äº«å¦‚ä½•ä½¿ç”¨ GPU Operator è‡ªåŠ¨åŒ–å®Œæˆ GPU Driverã€NVIDIA Container Toolkitã€device-pluginã€exporter ç­‰ç»„ä»¶çš„éƒ¨ç½²ï¼Œå¿«é€Ÿå®ç°åœ¨ k8s ç¯å¢ƒä¸­ä½¿ç”¨ GPUã€‚&lt;/p&gt;

&lt;p&gt;æœ€åç®€å•åˆ†æäº† Driver Installer å’Œ NVIDIA Container Toolkit Installer è¿™ä¸¤ä¸ªç»„ä»¶çš„å·¥ä½œåŸç†ã€‚&lt;/p&gt;

&lt;p&gt;GPU Operator æå¤§ç®€åŒ–äº†åœ¨ k8s ä¸­ä½¿ç”¨ GPU çš„ç¹çè¿‡ç¨‹ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Driver Installer ä»¥ DaemonSet æ–¹å¼è¿è¡Œçš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod éƒ½ä¸€æ ·ï¼Œä½†æ˜¯é•œåƒç”± é©±åŠ¨ç‰ˆæœ¬+å†…æ ¸ç‰ˆæœ¬+æ“ä½œç³»ç»Ÿç‰ˆæœ¬æ‹¼æ¥è€Œæˆï¼Œå› æ­¤éœ€è¦é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹æ“ä½œç³»ç»Ÿä¸€è‡´ã€‚&lt;/li&gt;
&lt;li&gt;NVIDIA Container Toolkit Installer åŒæ ·æ˜¯ä»¥ DaemonSet æ–¹å¼è¿è¡Œçš„ï¼Œå¦å¤–å®‰è£…æ—¶éœ€è¦æŒ‡å®š Runtimeï¼Œè¿™ä¹Ÿé€ æˆäº†é›†ç¾¤çš„èŠ‚ç‚¹å¿…é¡»å®‰è£…ç›¸åŒçš„ Container Runtimeã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;8-å‚è€ƒèµ„æ–™&#34;&gt;8. å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://www.lixueduan.com/posts/ai/02-gpu-operator/#2-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D&#34;&gt;GPU ç¯å¢ƒæ­å»ºæŒ‡å—ï¼šä½¿ç”¨ GPU Operator åŠ é€Ÿ Kubernetes GPU ç¯å¢ƒæ­å»º&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(08): åœ¨ECSã€Dockerã€K8s ç­‰ç¯å¢ƒä¸­ä½¿ç”¨ GPU</title>
            <link>http://mospany.github.io/2024/01/16/gpu-on-k8s/</link>
            <pubDate>Tue, 16 Jan 2024 19:31:10 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/16/gpu-on-k8s/</guid>
            <description>

&lt;h1 id=&#34;1-å¼•è¨€&#34;&gt;1. å¼•è¨€&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº«åœ¨ä¸åŒç¯å¢ƒï¼Œä¾‹å¦‚ECSã€Docker å’Œ Kubernetes ç­‰ç¯å¢ƒä¸­å¦‚ä½•ä½¿ç”¨ GPUã€‚
&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼šç”±äºæ²¡æœ‰ç‰©ç†æœºè£¸æœºï¼Œåœ¨é˜¿é‡Œäº‘ä¸Šç”³è¯·ECSä¹Ÿå¯æ»¡è¶³å­¦ä¹ ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;h1 id=&#34;2-è§„åˆ’&#34;&gt;2. è§„åˆ’&lt;/h1&gt;

&lt;p&gt;åŸºäºå¦‚ä¸‹ç¯å¢ƒæ­å»ºï¼š
&lt;img src=&#34;post/2024/images/2024-01-17-gpu-operator/IMG_20250117-194645644.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;br /&gt;
æŸ¥çœ‹workerèŠ‚ç‚¹GPUä¿¡æ¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-worker1 ~]# lspci | grep -i nvidia
00:07.0 VGA compatible controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
[root@k8s-worker1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯´æ˜è¯¥workerèŠ‚ç‚¹æœ‰1å¼ NVIDIA Tesla T4çš„GPUå¡ã€‚&lt;/p&gt;

&lt;h1 id=&#34;3-æ¦‚è¿°&#34;&gt;3. æ¦‚è¿°&lt;/h1&gt;

&lt;p&gt;ä»…ä»¥æ¯”è¾ƒå¸¸è§çš„ NVIDIA GPU ä¸¾ä¾‹ï¼Œç³»ç»Ÿä¸º Linuxï¼Œå¯¹äºå…¶ä»–å‚å®¶çš„ GPU è®¾å¤‡ç†è®ºä¸Šæµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ã€‚&lt;/p&gt;

&lt;p&gt;çœæµï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯¹äºECSç¯å¢ƒï¼Œåªéœ€è¦å®‰è£…å¯¹åº”çš„ &lt;a href=&#34;https://help.aliyun.com/zh/egs/user-guide/installation-guideline-for-nvidia-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_0.726f718evZrl7t&#34;&gt;GPU Driver&lt;/a&gt;ï¼ˆGPUè®¡ç®—å‹å®ä¾‹ä¸ºTeslaé©±åŠ¨ï¼ŒGPUè™šæ‹ŸåŒ–å‹å®ä¾‹ä¸ºGRIDé©±åŠ¨ï¼‰ ä»¥åŠ CUDA Toolkit ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹åº” Docker ç¯å¢ƒï¼Œéœ€è¦é¢å¤–å®‰è£… nvidia-container-toolkit å¹¶é…ç½® docker ä½¿ç”¨ nvidia runtimeã€‚&lt;/li&gt;
&lt;li&gt;å¯¹åº” k8s ç¯å¢ƒï¼Œéœ€è¦é¢å¤–å®‰è£…å¯¹åº”çš„ device-plugin ä½¿å¾— kubelet èƒ½å¤Ÿæ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡ï¼Œä»¥ä¾¿ k8s èƒ½å¤Ÿè¿›è¡Œ GPU ç®¡ç†ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ³¨ï¼šä¸€èˆ¬åœ¨ k8s ä¸­ä½¿ç”¨éƒ½ä¼šç›´æ¥ä½¿ç”¨ gpu-operator æ–¹å¼è¿›è¡Œå®‰è£…ï¼Œæœ¬æ–‡ä¸»è¦ä¸ºäº†ææ¸…å„ä¸ªç»„ä»¶çš„ä½œç”¨ï¼Œå› æ­¤è¿›è¡Œæ‰‹åŠ¨å®‰è£…ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;psï¼›ä¸‹ä¸€ç¯‡åˆ†äº«ä¸‹å¦‚ä½•ä½¿ç”¨ gpu-operator å¿«é€Ÿå®Œæˆå®‰è£…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;4-ecsç¯å¢ƒ&#34;&gt;4. ECSç¯å¢ƒ&lt;/h1&gt;

&lt;p&gt;è£¸æœºä¸­è¦ä½¿ç”¨ä¸Š GPU éœ€è¦å®‰è£…ä»¥ä¸‹ç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GPU Driver&lt;/li&gt;
&lt;li&gt;CUDA Toolkit
äºŒè€…çš„å…³ç³»å¦‚ NVIDIA å®˜ç½‘ä¸Šçš„è¿™ä¸ªå›¾æ‰€ç¤ºï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-152256220.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;/p&gt;

&lt;p&gt;GPU Driver åŒ…æ‹¬äº† GPU é©±åŠ¨å’Œ CUDA é©±åŠ¨ï¼ŒCUDA Toolkit åˆ™åŒ…å«äº† CUDA Runtimeã€‚&lt;/p&gt;

&lt;p&gt;GPU ä½œä¸ºä¸€ä¸ª PCIE è®¾å¤‡ï¼Œåªè¦å®‰è£…å¥½ä¹‹åï¼Œåœ¨ç³»ç»Ÿä¸­å°±å¯ä»¥é€šè¿‡ lspci å‘½ä»¤æŸ¥çœ‹åˆ°ï¼Œå…ˆç¡®è®¤æœºå™¨ä¸Šæ˜¯å¦æœ‰ GPUï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-worker1 ~]# lspci | grep -i nvidia
00:07.0 VGA compatible controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
[root@k8s-worker1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯´æ˜è¯¥workerèŠ‚ç‚¹æœ‰1å¼ NVIDIA Tesla T4çš„GPUå¡ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-1-å®‰è£…gridé©±åŠ¨&#34;&gt;4.1. å®‰è£…GRIDé©±åŠ¨&lt;/h2&gt;

&lt;p&gt;ç”±äºä¸»æœºè§„æ ¼æ˜¯ecs.sgn6i-vws-m2.xlargeï¼Œæ˜¯è™šæ‹ŸåŒ–å‹è§„æ ¼ï¼Œä¸èƒ½å®‰è£…Teslaé©±åŠ¨çš„ï¼Œéœ€è¦å®‰è£…gridé©±åŠ¨ã€‚
å®‰è£…Teslaé©±åŠ¨çš„è¯å°†ä¼šå‡ºç°&lt;a href=&#34;#61-error-unable-to-load-the-kernel-module-nvidiako&#34;&gt;ERROR: Unable to load the kernel module &amp;lsquo;nvidia.ko&amp;rsquo;.&lt;/a&gt;é”™è¯¯å®‰è£…å¤±è´¥ã€‚&lt;/p&gt;

&lt;p&gt;å®‰è£…æ­¥éª¤å‚è€ƒï¼š&lt;a href=&#34;https://help.aliyun.com/zh/egs/user-guide/use-cloud-assistant-to-automatically-install-and-upgrade-grid-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_2_1.65bd2ef7tthoW5&#34;&gt;åœ¨GPUè™šæ‹ŸåŒ–å‹å®ä¾‹ä¸­å®‰è£…GRIDé©±åŠ¨ï¼ˆLinuxï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;4-1-1-å‡†å¤‡å®‰è£…è„šæœ¬&#34;&gt;4.1.1. å‡†å¤‡å®‰è£…è„šæœ¬&lt;/h3&gt;

&lt;p&gt;install-grid.shå†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash
if acs-plugin-manager --list --local | grep grid_driver_install &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
then
            acs-plugin-manager --remove --plugin grid_driver_install
fi

acs-plugin-manager --exec --plugin grid_driver_install
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;4-1-2-å®‰è£…grid&#34;&gt;4.1.2. å®‰è£…grid&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-worker1 ~]# sh install-grid.sh 
RemovePlugin success, plugin[grid_driver_install]
INFO[0000] Starting environment pre-check               
INFO[0000] environment pre-check done                   
INFO[0000] Check gpu device present                     
INFO[0000] Check gpu device present done                
INFO[0000] current installed gird driver is, 470.239.06 
INFO[0000] current installed gird driver is already SWL driver 
[root@k8s-worker1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;4-1-3-éªŒè¯&#34;&gt;4.1.3. éªŒè¯&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-worker1 ~]# nvidia-smi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿è¡ŒæˆåŠŸï¼Œå¯çœ‹åˆ°æœ‰ä¸€å¼ T4-2Qçš„GPUå¡ã€‚
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-192347251.png&#34; alt=&#34;picture 6&#34; /&gt;&lt;br /&gt;
è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®‰è£…å¥½ GPU é©±åŠ¨äº†ï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸è¯†åˆ«åˆ° GPUã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæ˜¾ç¤ºçš„ CUDA ç‰ˆæœ¬è¡¨ç¤ºå½“å‰é©±åŠ¨æœ€å¤§æ”¯æŒçš„ CUDA ç‰ˆæœ¬ã€‚&lt;/p&gt;

&lt;h2 id=&#34;4-2-å®‰è£…cuda&#34;&gt;4.2. å®‰è£…CUDA&lt;/h2&gt;

&lt;h3 id=&#34;4-2-1-å®‰è£…è½¯ä»¶&#34;&gt;4.2.1. å®‰è£…è½¯ä»¶&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;wget https://developer.download.nvidia.com/compute/cuda/11.4.0/local_installers/cuda_11.4.0_470.42.01_linux.run
sudo sh cuda_11.4.0_470.42.01_linux.run
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºå·²å®‰è£…äº†GRIDé©±åŠ¨ï¼Œéœ€å–æ¶ˆcudaè‡ªå¸¦çš„é©±åŠ¨å®‰è£…ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-200338239.png&#34; alt=&#34;picture 7&#34; /&gt;&lt;br /&gt;
01) å®‰è£…å…¨éƒ¨ç»„ä»¶ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-200453794.png&#34; alt=&#34;picture 8&#34; /&gt;&lt;br /&gt;
02) è¾“å‡ºï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-201735441.png&#34; alt=&#34;picture 9&#34; /&gt;&lt;/p&gt;

&lt;p&gt;03) æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé‡å¯GPUå®ä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;reboot
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;04) ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé…ç½®CUDAç¯å¢ƒå˜é‡ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;echo &#39;export PATH=/usr/local/cuda/bin:$PATH&#39; | sudo tee /etc/profile.d/cuda.sh
source /etc/profile
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;05) æ£€æŸ¥CUDAæ˜¯å¦æˆåŠŸå®‰è£…ã€‚&lt;/p&gt;

&lt;p&gt;a) æ‰§è¡Œnvcc -Vå‘½ä»¤ï¼Œæ£€æŸ¥CUDAå®‰è£…ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ã€‚
   &lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-202721754.png&#34; alt=&#34;picture 10&#34; /&gt;&lt;/p&gt;

&lt;p&gt;b) ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæµ‹è¯•CUDA Samplesï¼ŒéªŒè¯CUDAæ˜¯å¦å®‰è£…æˆåŠŸã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;    [root@k8s-worker1 ~]# cd /usr/local/cuda-11.4/extras/demo_suite/
    [root@k8s-worker1 demo_suite]# ./deviceQuery  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœè¿”å›ç»“æœæ˜¾ç¤ºResult=PASSï¼Œåˆ™è¡¨ç¤ºCUDAå®‰è£…æˆåŠŸã€‚
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-203410971.png&#34; alt=&#34;picture 11&#34; /&gt;&lt;/p&gt;

&lt;p&gt;06) æµ‹è¯•
æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ Pytorch ç¨‹åºæ¥æ£€æµ‹ GPU å’Œ CUDA æ˜¯å¦æ­£å¸¸ã€‚&lt;/p&gt;

&lt;p&gt;æ•´ä¸ªè°ƒç”¨é“¾å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-204049273.png&#34; alt=&#34;picture 12&#34; /&gt;&lt;br /&gt;
ä½¿ç”¨ä¸‹é¢ä»£ç æ¥æµ‹è¯•èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ï¼Œ check_cuda_pytorch.py å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import torch

def check_cuda_with_pytorch():
    &amp;quot;&amp;quot;&amp;quot;æ£€æŸ¥ PyTorch CUDA ç¯å¢ƒæ˜¯å¦æ­£å¸¸å·¥ä½œ&amp;quot;&amp;quot;&amp;quot;
    try:
        print(&amp;quot;æ£€æŸ¥ PyTorch CUDA ç¯å¢ƒ:&amp;quot;)
        if torch.cuda.is_available():
            print(f&amp;quot;CUDA è®¾å¤‡å¯ç”¨ï¼Œå½“å‰ CUDA ç‰ˆæœ¬æ˜¯: {torch.version.cuda}&amp;quot;)
            print(f&amp;quot;PyTorch ç‰ˆæœ¬æ˜¯: {torch.__version__}&amp;quot;)
            print(f&amp;quot;æ£€æµ‹åˆ° {torch.cuda.device_count()} ä¸ª CUDA è®¾å¤‡ã€‚&amp;quot;)
            for i in range(torch.cuda.device_count()):
                print(f&amp;quot;è®¾å¤‡ {i}: {torch.cuda.get_device_name(i)}&amp;quot;)
                print(f&amp;quot;è®¾å¤‡ {i} çš„æ˜¾å­˜æ€»é‡: {torch.cuda.get_device_properties(i).total_memory / (1024 ** 3):.2f} GB&amp;quot;)
                print(f&amp;quot;è®¾å¤‡ {i} çš„æ˜¾å­˜å½“å‰ä½¿ç”¨é‡: {torch.cuda.memory_allocated(i) / (1024 ** 3):.2f} GB&amp;quot;)
                print(f&amp;quot;è®¾å¤‡ {i} çš„æ˜¾å­˜æœ€å¤§ä½¿ç”¨é‡: {torch.cuda.memory_reserved(i) / (1024 ** 3):.2f} GB&amp;quot;)
        else:
            print(&amp;quot;CUDA è®¾å¤‡ä¸å¯ç”¨ã€‚&amp;quot;)
    except Exception as e:
        print(f&amp;quot;æ£€æŸ¥ PyTorch CUDA ç¯å¢ƒæ—¶å‡ºç°é”™è¯¯: {e}&amp;quot;)

if __name__ == &amp;quot;__main__&amp;quot;:
    check_cuda_with_pytorch()

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…ˆå®‰è£…ä¸‹ torch&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;python -m pip install torch
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿è¡Œä¸€ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;python check_cuda_pytorch.py
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ­£å¸¸è¾“å‡ºåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-210940440.png&#34; alt=&#34;picture 13&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;4-3-æ›´æ–°cuda&#34;&gt;4.3. æ›´æ–°CUDA&lt;/h2&gt;

&lt;p&gt;ç”±äºæœ‰äº›åº”ç”¨éœ€è¦æ›´é«˜çº§çš„ç‰ˆæœ¬çš„CUDAï¼Œéœ€å‡çº§ï¼Œå¦‚ä¸‹å‡çº§ä¸º12.6ç‰ˆæœ¬ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
sudo dnf clean all
sudo dnf -y install cuda-toolkit-12-6
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-203151909.png&#34; alt=&#34;picture 18&#34; /&gt;&lt;br /&gt;
éªŒè¯:
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-203406637.png&#34; alt=&#34;picture 19&#34; /&gt;&lt;br /&gt;
è¯´æ˜12.6ç‰ˆæœ¬å®‰è£…æˆåŠŸã€‚
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-213858800.png&#34; alt=&#34;picture 20&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;5-dockerç¯å¢ƒ&#34;&gt;5. Dockerç¯å¢ƒ&lt;/h1&gt;

&lt;p&gt;ä¸Šä¸€æ­¥ä¸­æˆ‘ä»¬å·²ç»åœ¨è£¸æœºä¸Šå®‰è£…äº† GPU Driverï¼ŒCUDA Toolkit ç­‰å·¥å…·ï¼Œå®ç°äº†åœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨ GPUã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨å¸Œæœ›åœ¨ Docker å®¹å™¨ä¸­ä½¿ç”¨ GPUï¼Œéœ€è¦æ€ä¹ˆå¤„ç†å‘¢?&lt;/p&gt;

&lt;p&gt;ä¸ºäº†è®© Docker å®¹å™¨ä¸­ä¹Ÿèƒ½ä½¿ç”¨ GPUï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å®‰è£…dockerï¼Œå·²æœ‰åˆ™è·³è¿‡è¿™æ­¥éª¤ã€‚&lt;/li&gt;
&lt;li&gt;å®‰è£… nvidia-container-toolkit ç»„ä»¶&lt;/li&gt;
&lt;li&gt;docker é…ç½®ä½¿ç”¨ nvidia-runtime&lt;/li&gt;
&lt;li&gt;å¯åŠ¨å®¹å™¨æ—¶å¢åŠ  &amp;ndash;gpu å‚æ•°&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;5-1-dockerå®‰è£…&#34;&gt;5.1. Dockerå®‰è£…&lt;/h2&gt;

&lt;h3 id=&#34;5-1-1-å®‰è£…å¿…è¦çš„ä¸€äº›ç³»ç»Ÿå·¥å…·&#34;&gt;5.1.1. å®‰è£…å¿…è¦çš„ä¸€äº›ç³»ç»Ÿå·¥å…·&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo yum install -y yum-utils
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-1-2-æ·»åŠ è½¯ä»¶æºä¿¡æ¯&#34;&gt;5.1.2. æ·»åŠ è½¯ä»¶æºä¿¡æ¯&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-1-3-å®‰è£…docker&#34;&gt;5.1.3. å®‰è£…Docker&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-1-4-å¼€å¯dockeræœåŠ¡&#34;&gt;5.1.4. å¼€å¯DockeræœåŠ¡&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo service docker start
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-1-5-éªŒè¯&#34;&gt;5.1.5. éªŒè¯&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-worker1 pytorch]# docker version
Client: Docker Engine - Community
 Version:           26.1.3
 API version:       1.45
 Go version:        go1.21.10
 Git commit:        b72abbb
 Built:             Thu May 16 08:34:39 2024
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          26.1.3
  API version:      1.45 (minimum version 1.24)
  Go version:       go1.21.10
  Git commit:       8e96db1
  Built:            Thu May 16 08:33:34 2024
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.6.32
  GitCommit:        8b3b7ca2e5ce38e8f31a34f35b2b68ceb8470d89
 runc:
  Version:          1.1.12
  GitCommit:        v1.1.12-0-g51d5e94
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0
[root@k8s-worker1 pytorch]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;5-2-å®‰è£…-nvidia-container-toolkit&#34;&gt;5.2. å®‰è£… nvidia-container-toolkit&lt;/h2&gt;

&lt;p&gt;NVIDIA Container Toolkit çš„ä¸»è¦ä½œç”¨æ˜¯å°† NVIDIA GPU è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚
&amp;gt;å…¼å®¹ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä»»æ„å®¹å™¨è¿è¡Œæ—¶ï¼Œdockerã€containerdã€cri-o ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;NVIDIA å®˜æ–¹å®‰è£…æ–‡æ¡£ï¼š&lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html&#34;&gt;nvidia-container-toolkit-install-guide&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ALIOSæˆ–centoså®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Configure the production repository:
curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo

# Optionally, configure the repository to use experimental packages:
sudo yum-config-manager --enable nvidia-container-toolkit-experimental

#Install the NVIDIA Container Toolkit packages:
sudo yum install -y nvidia-container-toolkit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®‰è£…æˆåŠŸå¦‚ä¸‹ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-185247937.png&#34; alt=&#34;picture 14&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;5-3-é…ç½®ä½¿ç”¨è¯¥-runtime&#34;&gt;5.3. é…ç½®ä½¿ç”¨è¯¥ runtime&lt;/h2&gt;

&lt;p&gt;æ”¯æŒ Docker, Containerd, CRI-O, Podman ç­‰ CRIã€‚
&amp;gt;å…·ä½“è§å®˜æ–¹æ–‡æ¡£ &lt;a href=&#34;https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#configuration&#34;&gt;container-toolkit#install-guide&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿™é‡Œä»¥ Docker ä¸ºä¾‹è¿›è¡Œé…ç½®ï¼š
æ—§ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨åœ¨ /etc/docker/daemon.json ä¸­å¢åŠ é…ç½®ï¼ŒæŒ‡å®šä½¿ç”¨ nvidia çš„ runtimeã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;    &amp;quot;runtimes&amp;quot;: {
        &amp;quot;nvidia&amp;quot;: {
            &amp;quot;args&amp;quot;: [],
            &amp;quot;path&amp;quot;: &amp;quot;nvidia-container-runtime&amp;quot;
        }
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ–°ç‰ˆ toolkit å¸¦äº†ä¸€ä¸ªnvidia-ctk å·¥å…·ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ä¸€é”®é…ç½®ç„¶åé‡å¯dockerï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191008933.png&#34; alt=&#34;picture 15&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;5-4-éªŒè¯&#34;&gt;5.4. éªŒè¯&lt;/h2&gt;

&lt;p&gt;å®‰è£…nvidia-container-toolkit åï¼Œæ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191407685.png&#34; alt=&#34;picture 16&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è°ƒç”¨é“¾ä» containerd â€“&amp;gt; runC å˜æˆ containerd â€“&amp;gt; nvidia-container-runtime â€“&amp;gt; runC ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶å nvidia-container-runtime åœ¨ä¸­é—´æ‹¦æˆªäº†å®¹å™¨ specï¼Œå°±å¯ä»¥æŠŠ gpu ç›¸å…³é…ç½®æ·»åŠ è¿›å»ï¼Œå†ä¼ ç»™ runC çš„ spec é‡Œé¢å°±åŒ…å« gpu ä¿¡æ¯äº†ã€‚&lt;/p&gt;

&lt;p&gt;Docker ç¯å¢ƒä¸­çš„ CUDA è°ƒç”¨å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191542185.png&#34; alt=&#34;picture 17&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒCUDA Toolkit è·‘åˆ°å®¹å™¨é‡Œäº†ï¼Œå› æ­¤å®¿ä¸»æœºä¸Šä¸éœ€è¦å†å®‰è£… CUDA Toolkitã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ä¸€ä¸ªå¸¦ CUDA Toolkit çš„é•œåƒå³å¯ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ª Docker å®¹å™¨è¿›è¡Œæµ‹è¯•ï¼Œå…¶ä¸­å‘½ä»¤ä¸­å¢åŠ  &amp;ndash;gpuå‚æ•°æ¥æŒ‡å®šè¦åˆ†é…ç»™å®¹å™¨çš„ GPUã€‚&lt;/p&gt;

&lt;p&gt;gpu å‚æ•°å¯é€‰å€¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gpus allï¼šè¡¨ç¤ºå°†æ‰€æœ‰ GPU éƒ½åˆ†é…ç»™è¯¥å®¹å™¨&lt;/li&gt;
&lt;li&gt;gpus &amp;ldquo;device=&lt;id&gt;[,&lt;id&gt;&amp;hellip;]&amp;ldquo;ï¼šå¯¹äºå¤š GPU åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡ id æŒ‡å®šåˆ†é…ç»™å®¹å™¨çš„ GPUï¼Œä¾‹å¦‚ â€“gpu â€œdevice=0â€ è¡¨ç¤ºåªåˆ†é… 0 å· GPU ç»™è¯¥å®¹å™¨
GPU ç¼–å·åˆ™æ˜¯é€šè¿‡nvidia-smi å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå¸¦ cuda çš„é•œåƒæ¥æµ‹è¯•ï¼Œå¯åŠ¨è¯¥å®¹å™¨å¹¶æ‰§è¡Œnvidia-smi å‘½ä»¤&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-worker1 ~]# docker run --rm --gpus all  nvcr.io/nvidia/cuda:11.0.3-runtime-ubuntu20.04 nvidia-smi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-214303643.png&#34; alt=&#34;picture 22&#34; /&gt;&lt;br /&gt;
æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯å¯ä»¥æ‰“å°å‡ºå®¹å™¨ä¸­çš„ GPU ä¿¡æ¯çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼š é•œåƒéœ€ä¸gridé©±åŠ¨ç‰ˆæœ¬å…¼å®¹ï¼Œå¦åˆ™æŠ¥é”™ã€‚&lt;/p&gt;

&lt;h1 id=&#34;6-k8sç¯å¢ƒ&#34;&gt;6. K8Sç¯å¢ƒ&lt;/h1&gt;

&lt;p&gt;æ›´è¿›ä¸€æ­¥ï¼Œåœ¨ k8s ç¯å¢ƒä¸­ä½¿ç”¨ GPUï¼Œåˆ™éœ€è¦åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä»¥ä¸‹ç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gpu-device-plugin ç”¨äºç®¡ç† GPUï¼Œdevice-plugin ä»¥ DaemonSet æ–¹å¼è¿è¡Œåˆ°é›†ç¾¤å„ä¸ªèŠ‚ç‚¹ï¼Œä»¥æ„ŸçŸ¥èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡ï¼Œä»è€Œè®© k8s èƒ½å¤Ÿå¯¹èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡è¿›è¡Œç®¡ç†ã€‚&lt;/li&gt;
&lt;li&gt;gpu-exporterï¼šç”¨äºç›‘æ§ GPU&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å„ç»„ä»¶å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-215913188.png&#34; alt=&#34;picture 23&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å·¦å›¾ä¸ºæ‰‹åŠ¨å®‰è£…çš„åœºæ™¯ï¼Œåªéœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£… device-plugin å’Œ ç›‘æ§å³å¯ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;å³å›¾ä¸ºä½¿ç”¨ gpu-operotar å®‰è£…åœºæ™¯ï¼Œæœ¬ç¯‡æš‚æ—¶å¿½ç•¥&lt;/p&gt;

&lt;p&gt;å¤§è‡´å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ¯ä¸ªèŠ‚ç‚¹çš„ kubelet ç»„ä»¶ç»´æŠ¤è¯¥èŠ‚ç‚¹çš„ GPU è®¾å¤‡çŠ¶æ€ï¼ˆå“ªäº›å·²ç”¨ï¼Œå“ªäº›æœªç”¨ï¼‰å¹¶å®šæ—¶æŠ¥å‘Šç»™è°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨çŸ¥é“æ¯ä¸€ä¸ªèŠ‚ç‚¹æœ‰å¤šå°‘å¼  GPU å¡å¯ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒåº¦å™¨ä¸º pod é€‰æ‹©èŠ‚ç‚¹æ—¶ï¼Œä»ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;å½“ pod è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šåï¼Œkubelet ç»„ä»¶ä¸º pod åˆ†é… GPU è®¾å¤‡ IDï¼Œå¹¶å°†è¿™äº› ID ä½œä¸ºå‚æ•°ä¼ é€’ç»™ NVIDIA Device Plugin&lt;/li&gt;
&lt;li&gt;NVIDIA Device Plugin å°†åˆ†é…ç»™è¯¥ pod çš„å®¹å™¨çš„ GPU è®¾å¤‡ ID å†™å…¥åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡ NVIDIA_VISIBLE_DEVICESä¸­ï¼Œç„¶åå°†ä¿¡æ¯è¿”å›ç»™ kubeletã€‚&lt;/li&gt;
&lt;li&gt;kubelet å¯åŠ¨å®¹å™¨ã€‚&lt;/li&gt;
&lt;li&gt;NVIDIA Container Toolkit æ£€æµ‹å®¹å™¨çš„ spec ä¸­å­˜åœ¨ç¯å¢ƒå˜é‡ NVIDIA_VISIBLE_DEVICESï¼Œç„¶åæ ¹æ®ç¯å¢ƒå˜é‡çš„å€¼å°† GPU è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚
åœ¨ Docker ç¯å¢ƒæˆ‘ä»¬åœ¨å¯åŠ¨å®¹å™¨æ—¶é€šè¿‡ &amp;ndash;gpu å‚æ•°æ‰‹åŠ¨æŒ‡å®šåˆ†é…ç»™å®¹å™¨çš„ GPUï¼Œk8s ç¯å¢ƒåˆ™ç”± device-plugin è‡ªè¡Œç®¡ç†ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;6-1-é›†ç¾¤ç¯å¢ƒ&#34;&gt;6.1. é›†ç¾¤ç¯å¢ƒ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-220923122.png&#34; alt=&#34;picture 24&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;å®‰è£…-device-plugin&#34;&gt;å®‰è£… device-plugin&lt;/h2&gt;

&lt;p&gt;device-plugin ä¸€èˆ¬ç”±å¯¹åº”çš„ GPU å‚å®¶æä¾›ï¼Œæ¯”å¦‚ NVIDIA çš„ &lt;a href=&#34;https://github.com/NVIDIA/k8s-device-plugin&#34;&gt;k8s-device-plugin&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å®‰è£…å…¶å®å¾ˆç®€å•ï¼Œå°†å¯¹åº”çš„ yaml apply åˆ°é›†ç¾¤å³å¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.15.0/deployments/static/nvidia-device-plugin.yml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°±åƒè¿™æ ·
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-221359266.png&#34; alt=&#34;picture 25&#34; /&gt;&lt;/p&gt;

&lt;p&gt;device-plugin å¯åŠ¨ä¹‹åï¼Œä¼šæ„ŸçŸ¥èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡å¹¶ä¸ŠæŠ¥ç»™ kubeletï¼Œæœ€ç»ˆç”± kubelet æäº¤åˆ° kube-apiserverã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ Node å¯åˆ†é…èµ„æºä¸­çœ‹åˆ° GPUï¼Œå°±åƒè¿™æ ·ï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-221933864.png&#34; alt=&#34;picture 26&#34; /&gt;&lt;br /&gt;
å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†å¸¸è§çš„ cpuã€memory ä¹‹å¤–ï¼Œè¿˜æœ‰nvidia.com/gpu, è¿™ä¸ªå°±æ˜¯ GPU èµ„æºï¼Œæ•°é‡ä¸º 0ï¼Œåº”è¯¥ä¸º1ï¼Œé”™è¯¯åŸå› å¾…æŸ¥ã€‚
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250123-095336709.png&#34; alt=&#34;picture 27&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;å®‰è£…-gpu-ç›‘æ§&#34;&gt;å®‰è£… GPU ç›‘æ§&lt;/h2&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä½ éœ€è¦ç›‘æ§é›†ç¾¤ GPU èµ„æºä½¿ç”¨æƒ…å†µï¼Œä½ å¯èƒ½è¿˜éœ€è¦å®‰è£… DCCM exporter ç»“åˆ Prometheus è¾“å‡º GPU èµ„æºç›‘æ§ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;å®‰è£…ç•¥ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å°ç»“&#34;&gt;å°ç»“&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦åˆ†äº«äº†åœ¨ECSã€Docker ç¯å¢ƒã€k8s ç¯å¢ƒä¸­å¦‚ä½•ä½¿ç”¨ GPUã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å¯¹äºECSç¯å¢ƒï¼Œåªéœ€è¦å®‰è£…å¯¹åº”çš„ GPU Driver å³å¯ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¯¹åº” Docker ç¯å¢ƒï¼Œéœ€è¦é¢å¤–å®‰è£… nvidia-container-toolkit å¹¶é…ç½® docker ä½¿ç”¨ nvidia runtimeã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¯¹åº” k8s ç¯å¢ƒï¼Œéœ€è¦é¢å¤–å®‰è£…å¯¹åº”çš„ device-plugin ä½¿å¾— kubelet èƒ½å¤Ÿæ„ŸçŸ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ GPU è®¾å¤‡ï¼Œä»¥ä¾¿ k8s èƒ½å¤Ÿè¿›è¡Œ GPU ç®¡ç†ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯åœ¨ k8s ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä¸ºäº†ç®€åŒ–å®‰è£…æ­¥éª¤ï¼Œ NVIDIA ä¹Ÿæä¾›äº† gpu-operatoræ¥ç®€åŒ–å®‰è£…éƒ¨ç½²ï¼Œåç»­åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ gpu-operatoræ¥å¿«é€Ÿå®‰è£…ã€‚&lt;/p&gt;

&lt;h1 id=&#34;7-å‚è€ƒèµ„æ–™&#34;&gt;7. å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://blog.csdn.net/Doudou_Mylove/article/details/114388633&#34;&gt;é˜¿é‡Œäº‘GPUæœåŠ¡å™¨å®‰è£…é©±åŠ¨ï¼ˆå®Œæ•´ç‰ˆï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ã€02ã€‘&lt;a href=&#34;https://help.aliyun.com/zh/egs/user-guide/install-a-gpu-driver-on-a-gpu-accelerated-compute-optimized-linux-instance?spm=a2c4g.11186623.help-menu-155040.d_1_5_1_1.6b70fb7cljEZnN&amp;amp;scm=20140722.H_163824._.OR_help-T_cn~zh-V_1&#34;&gt;åœ¨GPUè®¡ç®—å‹å®ä¾‹ä¸­æ‰‹åŠ¨å®‰è£…Teslaé©±åŠ¨ï¼ˆLinuxï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ã€03ã€‘&lt;a href=&#34;https://help.aliyun.com/zh/egs/user-guide/use-cloud-assistant-to-automatically-install-and-upgrade-grid-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_2_1.660551bd3LBP63&#34;&gt;åœ¨GPUè™šæ‹ŸåŒ–å‹å®ä¾‹ä¸­å®‰è£…GRIDé©±åŠ¨ï¼ˆLinuxï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;8-faq&#34;&gt;8. FAQ&lt;/h1&gt;

&lt;h2 id=&#34;8-1-error-unable-to-load-the-kernel-module-nvidia-ko&#34;&gt;8.1. ERROR: Unable to load the kernel module &amp;lsquo;nvidia.ko&amp;rsquo;.&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-155358481.png&#34; alt=&#34;picture 4&#34; /&gt;&lt;br /&gt;
é”™è¯¯è¯¦æƒ…æç¤ºï¼š
&lt;img src=&#34;post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-155501141.png&#34; alt=&#34;picture 5&#34; /&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(07): kubeadmå®‰è£…k8sé›†ç¾¤(containerdç‰ˆ)</title>
            <link>http://mospany.github.io/2024/01/15/kubeadm-install-k8s/</link>
            <pubDate>Mon, 15 Jan 2024 15:42:11 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2024/01/15/kubeadm-install-k8s/</guid>
            <description>

&lt;h1 id=&#34;1-è§„åˆ’&#34;&gt;1. è§„åˆ’&lt;/h1&gt;

&lt;p&gt;ä½¿ç”¨ kubeadm å®‰è£… Kubernetes é›†ç¾¤å¹¶ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainer runtimeï¼‰æ˜¯ä¸€ç§å¸¸è§çš„å®‰è£…æ–¹æ³•ã€‚&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;OS&lt;/th&gt;
&lt;th&gt;é…ç½®&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;th&gt;å¤‡æ³¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;aliOS(172.17.197.69)&lt;/td&gt;
&lt;td&gt;2æ ¸(vCPU) 4GiB 5 Mbps&lt;/td&gt;
&lt;td&gt;k8s-master1&lt;/td&gt;
&lt;td&gt;ä¹Œå…°å¯Ÿå¸ƒ å¯ç”¨åŒº C&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;aliOS(172.17.197.68)&lt;/td&gt;
&lt;td&gt;4æ ¸(vCPU) 10 GiB 5 Mbps GPUï¼šNVIDIA T4/8&lt;/td&gt;
&lt;td&gt;k8s-worker1&lt;/td&gt;
&lt;td&gt;ä¹Œå…°å¯Ÿå¸ƒ å¯ç”¨åŒº C&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼šè¿™æ˜¯æ¼”ç¤º k8s é›†ç¾¤å®‰è£…çš„å®éªŒç¯å¢ƒï¼Œé…ç½®è¾ƒä½ï¼Œç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬çš„æœåŠ¡å™¨é…ç½®è‡³å°‘éƒ½æ˜¯ 8C/16G çš„åŸºç¡€é…ç½®ã€‚&lt;/p&gt;

&lt;h1 id=&#34;2-ç‰ˆæœ¬é€‰æ‹©&#34;&gt;2. ç‰ˆæœ¬é€‰æ‹©&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;Alibaba Cloud Linux 3.2104 LTS 64ä½
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;2-1-é…ç½®ä¸»æœºå&#34;&gt;2.1. é…ç½®ä¸»æœºå&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# hostnamectl set-hostname k8s-master1
[root@k8s-worker1 ~]# hostnamectl set-hostname k8s-worker1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-2-å…³é—­é˜²ç«å¢™&#34;&gt;2.2. å…³é—­é˜²ç«å¢™&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt; # å…³é—­firewalld
2  [root@k8s-master1 ~]# systemctl stop firewalld
3  
4  # å…³é—­selinux
5  [root@k8s-master1 ~]# sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config
6  [root@k8s-master1 ~]# setenforce 0
7   setenforce: SELinux is disabled
8  [root@k8s-master1 ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-3-äº’åšæœ¬åœ°è§£æ&#34;&gt;2.3. äº’åšæœ¬åœ°è§£æ&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
8.130.117.184 k8s-master1
8.130.92.114  k8s-worker1
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-4-ssh-å…å¯†é€šä¿¡-å¯é€‰&#34;&gt;2.4. SSH å…å¯†é€šä¿¡ï¼ˆå¯é€‰ï¼‰&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;masterèŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 ~]# ssh-keygen
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250115-192630256.png&#34; alt=&#34;picture 0&#34; /&gt;&lt;br /&gt;
äº’å‘å…¬é’¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# ssh-copy-id root@k8s-worker1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250115-193004163.png&#34; alt=&#34;picture 1&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;2-5-åŠ è½½-br-netfilter-æ¨¡å—&#34;&gt;2.5. åŠ è½½ br_netfilter æ¨¡å—&lt;/h2&gt;

&lt;p&gt;ç¡®ä¿ br_netfilter æ¨¡å—è¢«åŠ è½½
&amp;gt; æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# åŠ è½½æ¨¡å—
root@k8s-master1 ~]# modprobe br_netfilter
## æŸ¥çœ‹åŠ è½½è¯·çœ‹
[root@k8s-master1 ~]# lsmod | grep br_netfilter
br_netfilter           32768  0
bridge                270336  1 br_netfilter

# æ°¸ä¹…ç”Ÿæ•ˆ
[root@k8s-master1 ~]# cat &amp;lt;&amp;lt;EOF | tee /etc/modules-load.d/k8s.conf
&amp;gt; br_netfilter
&amp;gt; EOF
br_netfilter
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-6-å…è®¸-iptables-æ£€æŸ¥æ¡¥æ¥æµé‡&#34;&gt;2.6. å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# cat &amp;lt;&amp;lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
&amp;gt; net.bridge.bridge-nf-call-ip6tables = 1
&amp;gt; net.bridge.bridge-nf-call-iptables = 1
&amp;gt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
[root@k8s-master1 ~]# sysctl --system
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-7-å…³é—­-swap&#34;&gt;2.7. å…³é—­ swap&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# ä¸´æ—¶å…³é—­
[root@k8s-master1 ~]# swapoff -a

# æ°¸ä¹…å…³é—­
[root@k8s-master1 ~]# sed -ri &#39;s/.*swap.*/#&amp;amp;/&#39; /etc/fstab
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;2-8-å®‰è£…ipsetåŠipvsadm&#34;&gt;2.8. å®‰è£…ipsetåŠipvsadm&lt;/h2&gt;

&lt;p&gt;å®‰è£…ipsetåŠipvsadm&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# dnf install -y ipset ipvsadm
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®ipvsadmæ¨¡å—åŠ è½½æ–¹å¼ï¼Œæ·»åŠ éœ€è¦åŠ è½½çš„æ¨¡å—&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat &amp;gt; /etc/sysconfig/modules/ipvs.modules &amp;lt;&amp;lt;EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
EOF

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆæƒã€è¿è¡Œã€æ£€æŸ¥æ˜¯å¦åŠ è½½&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; bash /etc/sysconfig/modules/ipvs.modules &amp;amp;&amp;amp; lsmod | grep -e ip_vs -e nf_conntrack
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-135626938.png&#34; alt=&#34;picture 2&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;3-å®‰è£…containerd&#34;&gt;3. å®‰è£…containerd&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;3-1-å®‰è£…-containerd&#34;&gt;3.1. å®‰è£… containerd&lt;/h2&gt;

&lt;p&gt;é€šè¿‡ yum å®‰è£… containerdï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 ~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
Adding repo from: http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
[root@k8s-master1 ~]# yum install containerd -y

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;3-2-é…ç½®-containerd&#34;&gt;3.2. é…ç½® containerd&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ /usr/bin/containerd config default &amp;gt; /etc/containerd/config.toml
$ sed -i &#39;s/SystemdCgroup = false/SystemdCgroup = true/g&#39; /etc/containerd/config.toml
$ sed -i &#39;s/sandbox_image = &amp;quot;registry.k8s.io\/pause:3.6&amp;quot;/sandbox_image = &amp;quot;registry.aliyuncs.com\/google_containers\/pause:3.9&amp;quot;/g&#39; /etc/containerd/config.toml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼š è®°å¾—ç¡®ä¿é…ç½®ä¿®æ”¹æˆåŠŸï¼Œå°¤å…¶æ˜¯pauseç‰ˆæœ¬ã€‚&lt;/p&gt;

&lt;h2 id=&#34;3-3-å¯åŠ¨containerd&#34;&gt;3.3. å¯åŠ¨containerd&lt;/h2&gt;

&lt;p&gt;å¯åŠ¨å¹¶ä½¿ containerd éšç³»ç»Ÿå¯åŠ¨ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 ~]# sudo systemctl start containerd
root@k8s-master1 ~]# sudo systemctl enable containerd
root@k8s-master1 ~]# ps -ef | grep containerd
root       37760       1  0 07:35 ?        00:00:00 /usr/bin/containerd
root       37807   36202  0 07:35 pts/0    00:00:00 grep --color=auto containerd
[root@k8s-master1 ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯´æ˜containerdå·²å¯åŠ¨æˆåŠŸã€‚
&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-160630369.png&#34; alt=&#34;picture 3&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;4-å®‰è£…-kubeadm-kubelet&#34;&gt;4. å®‰è£… kubeadmã€kubelet&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;4-1-æ·»åŠ -k8s-é•œåƒæº&#34;&gt;4.1. æ·»åŠ  k8s é•œåƒæº&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ°å€ï¼š &lt;a href=&#34;https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.1cd01b116JYQIn&#34;&gt;https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.1cd01b116JYQIn&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;cat &amp;lt;&amp;lt;EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/repodata/repomd.xml.key
EOF
setenforce 0
yum install -y --nogpgcheck kubelet kubeadm kubectl
systemctl enable kubelet &amp;amp;&amp;amp; systemctl start kubelet
echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;4-2-å»ºç«‹-k8s-yum-ç¼“å­˜&#34;&gt;4.2. å»ºç«‹ k8s YUM ç¼“å­˜&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# yum makecache
alinux3-os                                                                                       1.3 MB/s | 3.8 kB     00:00    
alinux3-updates                                                                                  1.4 MB/s | 4.1 kB     00:00    
alinux3-module                                                                                   354 kB/s | 4.2 kB     00:00    
alinux3-plus                                                                                     645 kB/s | 3.0 kB     00:00    
alinux3-powertools                                                                               598 kB/s | 3.0 kB     00:00    
Extra Packages for Enterprise Linux 8 - x86_64                                                   1.8 MB/s | 4.4 kB     00:00    
Extra Packages for Enterprise Linux Modular 8 - x86_64                                           620 kB/s | 3.0 kB     00:00    
Kubernetes                                                                                        17 kB/s | 1.7 kB     00:00    
Metadata cache created.
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;4-3-å®‰è£…-k8s-ç›¸å…³å·¥å…·&#34;&gt;4.3. å®‰è£… k8s ç›¸å…³å·¥å…·&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# yum list kubelet --showduplicates
Last metadata expiration check: 0:01:46 ago on Wed 15 Jan 2025 10:55:44 PM CST.
Installed Packages
kubelet.x86_64                                           1.28.15-150500.1.1                                           @kubernetes
Available Packages
kubelet.aarch64                                          1.28.0-150500.1.1                                            kubernetes 
kubelet.ppc64le                                          1.28.0-150500.1.1                                            kubernetes 
kubelet.s390x                                            1.28.0-150500.1.1                                            kubernetes 
kubelet.src                                              1.28.0-150500.1.1                                            kubernetes 
kubelet.x86_64                                           1.28.0-150500.1.1                                            kubernetes 
kubelet.aarch64                                          1.28.1-150500.1.1                                            kubernetes 
kubelet.ppc64le                                          1.28.1-150500.1.1                                            kubernetes 
kubelet.s390x                                            1.28.1-150500.1.1                                            kubernetes 
kubelet.src                                              1.28.1-150500.1.1                                            kubernetes 
.....
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è®¾ç½®crictlè¿æ¥ containerd&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ crictl config --set runtime-endpoint=unix:///run/containerd/containerd.sock
$ crictl images ls
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è®¾ç½®kubectlå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;echo &#39;source &amp;lt;(kubectl completion bash)&#39; &amp;gt;&amp;gt; ~/.bashrc
source ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;5-masterèŠ‚ç‚¹&#34;&gt;5. masterèŠ‚ç‚¹&lt;/h1&gt;

&lt;h2 id=&#34;5-1-k8s-åˆå§‹åŒ–&#34;&gt;5.1. k8s åˆå§‹åŒ–&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Master èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼šè®°å¾—ä¿®æ”¹&amp;ndash;apiserver-advertise-addressä¸&amp;ndash;kubernetes-versionä¿®æ”¹æ­£ç¡®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master ~]# kubeadm init \
  --apiserver-advertise-address=172.17.197.69 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.28.15 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16 \
  --ignore-preflight-errors=all \
  --cri-socket /var/run/containerd/containerd.sock
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‚æ•°è¯´æ˜ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;   --apiserver-advertise-address  # é›†ç¾¤masteråœ°å€
   --image-repository             # æŒ‡å®šk8sé•œåƒä»“åº“åœ°å€
   --kubernetes-version           # æŒ‡å®šK8sç‰ˆæœ¬ï¼ˆä¸kubeadmã€kubeletç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼‰
   --service-cidr                 # Podç»Ÿä¸€è®¿é—®å…¥å£
   --pod-network-cidr             # Podç½‘ç»œï¼ˆä¸CNIç½‘ç»œä¿æŒä¸€è‡´ï¼‰
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–åè¾“å‡ºå¦‚ä¸‹å†…å®¹ï¼Œè¯´æ˜æˆåŠŸã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;.....
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run &amp;quot;kubectl apply -f [podnetwork].yaml&amp;quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.17.197.69:6443 --token ipqfom.r9ltq4t3in53cd6w \
        --discovery-token-ca-cert-hash sha256:0f01242802eae4b69408c34070a3ad8d017229faba9f8b30623ed1e9dd69d66c 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;5-2-æ ¹æ®è¾“å‡ºæç¤ºåˆ›å»ºç›¸å…³æ–‡ä»¶&#34;&gt;5.2. æ ¹æ®è¾“å‡ºæç¤ºåˆ›å»ºç›¸å…³æ–‡ä»¶&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master ~]# mkdir -p $HOME/.kube
[root@k8s-master ~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
[root@k8s-master ~]# chown $(id -u):$(id -g) $HOME/.kube/config
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;5-3-æŸ¥çœ‹-k8s-è¿è¡Œçš„å®¹å™¨&#34;&gt;5.3. æŸ¥çœ‹ k8s è¿è¡Œçš„å®¹å™¨&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 ~]# kubectl  get pod -A -o wide
NAMESPACE     NAME                                  READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES
kube-system   coredns-66f779496c-lq5rj              0/1     Pending   0          26m   &amp;lt;none&amp;gt;          &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   coredns-66f779496c-q5pxk              0/1     Pending   0          26m   &amp;lt;none&amp;gt;          &amp;lt;none&amp;gt;        &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   etcd-k8s-master1                      1/1     Running   1          26m   172.17.197.69   k8s-master1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-apiserver-k8s-master1            1/1     Running   1          26m   172.17.197.69   k8s-master1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-controller-manager-k8s-master1   1/1     Running   1          26m   172.17.197.69   k8s-master1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-88trd                      1/1     Running   0          26m   172.17.197.69   k8s-master1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-scheduler-k8s-master1            1/1     Running   1          26m   172.17.197.69   k8s-master1   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;5-4-æŸ¥çœ‹-k8s-èŠ‚ç‚¹&#34;&gt;5.4. æŸ¥çœ‹ k8s èŠ‚ç‚¹&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-master1 ~]# kubectl  get node -o wide
NAME          STATUS     ROLES           AGE   VERSION    INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                                              KERNEL-VERSION           CONTAINER-RUNTIME
k8s-master1   NotReady   control-plane   36m   v1.28.15   172.17.197.69   &amp;lt;none&amp;gt;        Alibaba Cloud Linux 3.2104 U11 (OpenAnolis Edition)   5.10.134-18.al8.x86_64   containerd://1.6.32
[root@k8s-master1 ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯çœ‹åˆ°å½“å‰åªæœ‰ k8s-master èŠ‚ç‚¹ï¼Œè€Œä¸”çŠ¶æ€æ˜¯ NotReadyï¼ˆæœªå°±ç»ªï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰éƒ¨ç½²ç½‘ç»œæ’ä»¶ï¼ˆkubectl apply -f [podnetwork].yamlï¼‰ï¼Œäºæ˜¯æ¥ç€éƒ¨ç½²å®¹å™¨ç½‘ç»œï¼ˆCNIï¼‰ã€‚&lt;/p&gt;

&lt;h2 id=&#34;5-5-å®¹å™¨ç½‘ç»œ-cni-éƒ¨ç½²&#34;&gt;5.5. å®¹å™¨ç½‘ç»œï¼ˆCNIï¼‰éƒ¨ç½²&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;Master èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ’ä»¶åœ°å€ï¼š&lt;a href=&#34;https://kubernetes.io/docs/concepts/cluster-administration/addons/&#34;&gt;https://kubernetes.io/docs/concepts/cluster-administration/addons/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¯¥åœ°å€åœ¨ k8s-master åˆå§‹åŒ–æˆåŠŸæ—¶æ‰“å°å‡ºæ¥ã€‚&lt;/p&gt;

&lt;h3 id=&#34;5-5-1-é€‰æ‹©ä¸€ä¸ªä¸»æµçš„å®¹å™¨ç½‘ç»œæ’ä»¶éƒ¨ç½²-calico&#34;&gt;5.5.1. é€‰æ‹©ä¸€ä¸ªä¸»æµçš„å®¹å™¨ç½‘ç»œæ’ä»¶éƒ¨ç½²ï¼ˆCalicoï¼‰&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-164005909.png&#34; alt=&#34;picture 4&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;5-5-2-ä¸‹è½½ymlæ–‡ä»¶&#34;&gt;5.5.2. ä¸‹è½½ymlæ–‡ä»¶&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;wget https://docs.projectcalico.org/manifests/calico.yaml --no-check-certificate 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-5-3-çœ‹çœ‹è¯¥yamlæ–‡ä»¶æ‰€éœ€è¦å¯åŠ¨çš„å®¹å™¨&#34;&gt;5.5.3. çœ‹çœ‹è¯¥yamlæ–‡ä»¶æ‰€éœ€è¦å¯åŠ¨çš„å®¹å™¨&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 install-k8s-cluster]# cat calico.yaml |grep image
          image: docker.io/calico/cni:v3.25.0
          imagePullPolicy: IfNotPresent
          image: docker.io/calico/cni:v3.25.0
          imagePullPolicy: IfNotPresent
          image: docker.io/calico/node:v3.25.0
          imagePullPolicy: IfNotPresent
          image: docker.io/calico/node:v3.25.0
          imagePullPolicy: IfNotPresent
          image: docker.io/calico/kube-controllers:v3.25.0
          imagePullPolicy: IfNotPresent
[root@k8s-master1 install-k8s-cluster]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;5-5-4-ä¿®æ”¹ä¸ºå›½å†…å¯ä¸‹è½½é•œåƒ&#34;&gt;5.5.4. ä¿®æ”¹ä¸ºå›½å†…å¯ä¸‹è½½é•œåƒ&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨docker.m.daocloud.ioä»£æ›¿docker.io&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sed -i s/docker.io/docker.m.daocloud.io/g calico.yaml 
$ cat calico.yaml | grep image

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-205457826.png&#34; alt=&#34;picture 5&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;5-5-5-å®‰è£…calico&#34;&gt;5.5.5. å®‰è£…calico&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# kubectl  apply -f calico.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-205731350.png&#34; alt=&#34;picture 6&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;5-5-6-æŸ¥çœ‹podå’ŒnodeçŠ¶æ€æ­£å¸¸&#34;&gt;5.5.6. æŸ¥çœ‹podå’ŒnodeçŠ¶æ€æ­£å¸¸&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# kubectl  get pod -A
[root@k8s-master1 calicodir]# kubectl  get node
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-210017047.png&#34; alt=&#34;picture 7&#34; /&gt;&lt;br /&gt;
å¯ä»¥çœ‹å‡ºpodå·²å…¨éƒ¨Runningï¼Œ nodeå·²å˜æˆReadyçŠ¶æ€ï¼Œè¯´æ˜masterèŠ‚ç‚¹å·²å®‰è£…æˆåŠŸå®Œæˆã€‚&lt;/p&gt;

&lt;h1 id=&#34;6-worker-èŠ‚ç‚¹&#34;&gt;6. worker èŠ‚ç‚¹&lt;/h1&gt;

&lt;h2 id=&#34;6-1-worker-èŠ‚ç‚¹åŠ å…¥-k8s-é›†ç¾¤&#34;&gt;6.1. worker èŠ‚ç‚¹åŠ å…¥ k8s é›†ç¾¤&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æ‰€æœ‰ work èŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å¤åˆ¶k8s-masteråˆå§‹åŒ–å±å¹•è¾“å‡ºçš„è¯­å¥å¹¶åœ¨workèŠ‚ç‚¹æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;root@k8s-worker1 ~]# kubeadm join 172.17.197.69:6443 --token ipqfom.r9ltq4t3in53cd6w         --discovery-token-ca-cert-hash sha256:0f01242802eae4b69408c34070a3ad8d017229faba9f8b30623ed1e9dd69d66c
[preflight] Running pre-flight checks
        [WARNING FileExisting-tc]: tc not found in system path
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;
[kubelet-start] Writing kubelet configuration to file &amp;quot;/var/lib/kubelet/config.yaml&amp;quot;
[kubelet-start] Writing kubelet environment file with flags to file &amp;quot;/var/lib/kubelet/kubeadm-flags.env&amp;quot;
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run &#39;kubectl get nodes&#39; on the control-plane to see this node join the cluster.
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;6-2-æŸ¥è¯¢é›†ç¾¤ä¿¡æ¯&#34;&gt;6.2. æŸ¥è¯¢é›†ç¾¤ä¿¡æ¯&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;MasterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# kubectl  get pod -A -o wide
[root@k8s-master1 calicodir]# kubectl  get node -o wide
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-213420388.png&#34; alt=&#34;picture 8&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹crictlå’Œctræ˜¯å¦å®‰è£…æˆåŠŸã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# crictl version
[root@k8s-master1 calicodir]# ctr version
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-213647229.png&#34; alt=&#34;picture 9&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;7-éªŒè¯&#34;&gt;7. éªŒè¯&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;MasterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;k8s é›†ç¾¤éƒ¨ç½² nginx æœåŠ¡ï¼Œå¹¶é€šè¿‡æµè§ˆå™¨è¿›è¡Œè®¿é—®éªŒè¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;7-1-åˆ›å»ºpod&#34;&gt;7.1. åˆ›å»ºPod&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# kubectl create deployment nginx --image=docker.m.daocloud.io/library/nginx:latest
deployment.apps/nginx created
[root@k8s-master1 calicodir]# kubectl expose deployment nginx --port=80 --type=NodePort
service/nginx exposed
[root@k8s-master1 calicodir]# kubectl  get all
NAME                        READY   STATUS    RESTARTS   AGE
pod/nginx-fbf584587-pp6ks   1/1     Running   0          2m45s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/kubernetes   ClusterIP   10.96.0.1       &amp;lt;none&amp;gt;        443/TCP        5h45m
service/nginx        NodePort    10.110.34.104   &amp;lt;none&amp;gt;        80:30884/TCP   28s

NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   1/1     1            1           2m45s

NAME                              DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-fbf584587   1         1         1       2m45s
[root@k8s-master1 calicodir]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;7-2-è®¿é—®nginx&#34;&gt;7.2. è®¿é—®nginx&lt;/h2&gt;

&lt;h3 id=&#34;7-2-1-curlè®¿é—®&#34;&gt;7.2.1. curlè®¿é—®&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[root@k8s-master1 calicodir]# curl 10.110.34.104:80
&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&amp;lt;style&amp;gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&amp;lt;/style&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;
&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&amp;lt;/p&amp;gt;

&amp;lt;p&amp;gt;For online documentation and support please refer to
&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;
Commercial support is available at
&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;

&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
[root@k8s-master1 calicodir]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨nodePortæ–¹å¼è®¿é—®ç°è±¡åŒä¸Š
&lt;img src=&#34;post/2024/images/2024-01-15-kubeadm-install-k8s/IMG_20250116-220403508.png&#34; alt=&#34;picture 10&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è‡³æ­¤ï¼škubeadmæ–¹å¼çš„k8sé›†ç¾¤å·²ç»éƒ¨ç½²å®Œæˆã€‚&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>å¦‚ä½•å®‰è£…ä½¿ç”¨newbingå’Œchatgpt</title>
            <link>http://mospany.github.io/2023/06/23/how-about-install-newbing-and-chatgpt/</link>
            <pubDate>Fri, 23 Jun 2023 17:36:37 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2023/06/23/how-about-install-newbing-and-chatgpt/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;org5c16ff5&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;chatgptåœ¨2022å¹´å¼€å§‹çˆ†å‘ï¼Œéšç€è¶Šæ¥è¶Šå¤šçš„äººåœ¨ä½¿ç”¨ï¼Œäºæ˜¯ä¹Ÿæ‰“ç®—å°è¯•å®‰è£…ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org53977af&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;chatgpt&#34;&gt;chatgpt&lt;/h2&gt;

&lt;p&gt;ChatGPTæ˜¯ä¸€ç§åŸºäºäººå·¥æ™ºèƒ½æŠ€æœ¯çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå¯ä»¥ä¸ç”¨æˆ·è¿›è¡Œè‡ªç„¶è¯­è¨€äº¤äº’ï¼Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œæä¾›æœ‰ç”¨çš„ä¿¡æ¯å’Œå»ºè®®ï¼Œç”šè‡³ç©ä¸€äº›æœ‰è¶£çš„æ¸¸æˆã€‚ChatGPTæ˜¯ç”±OpenAIå¼€å‘ï¼Œä½¿ç”¨äº†GPTï¼ˆGenerative Pre-trained Transformerï¼‰æŠ€æœ¯ï¼Œè¿™æ˜¯ä¸€ç§å…·æœ‰å¼ºå¤§ç”Ÿæˆèƒ½åŠ›çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚ChatGPTé€šè¿‡å­¦ä¹ æµ·é‡çš„è¯­è¨€æ•°æ®é›†æ¥ä¸æ–­æé«˜å…¶å¯¹è‡ªç„¶è¯­è¨€çš„ç†è§£èƒ½åŠ›ï¼Œä»è€Œèƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚ä¸å…¶ä»–èŠå¤©æœºå™¨äººç›¸æ¯”ï¼ŒChatGPTçš„å¯¹è¯æµç•…åº¦å’Œå›ç­”å‡†ç¡®åº¦éƒ½å¾ˆé«˜ï¼Œå› æ­¤å¤‡å—ç”¨æˆ·æ¬¢è¿ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org292f1ea&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;newbing&#34;&gt;newbing&lt;/h2&gt;

&lt;p&gt;å¿…åº”chatæ˜¯å¾®è½¯æ——ä¸‹çš„èŠå¤©æœºå™¨äººæœåŠ¡ï¼Œå®ƒæ˜¯åŸºäºå¿…åº”AIå¼€å‘çš„ä¸€æ¬¾æ™ºèƒ½å¯¹è¯ç³»ç»Ÿã€‚å¿…åº”chatå¯ä»¥ç†è§£è‡ªç„¶è¯­è¨€ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€æä¾›æœåŠ¡ã€å¼€ç©ç¬‘ç­‰ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ä¸æœºå™¨äººè¿›è¡Œè‡ªç„¶çš„å¯¹è¯ã€‚å¿…åº”chatçš„åŠŸèƒ½åŒ…æ‹¬å¤©æ°”æŸ¥è¯¢ã€åœ°å›¾å¯¼èˆªã€éŸ³ä¹æ’­æ”¾ã€é—²èŠèŠå¤©ã€è®¡ç®—æ•°å­¦é—®é¢˜ç­‰ï¼Œå¯å¸®åŠ©ç”¨æˆ·è§£å†³ç”Ÿæ´»ä¸­çš„å„ç§ç–‘é—®å’Œé—®é¢˜ã€‚å¿…åº”chatè¿˜æ”¯æŒå¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬è‹±è¯­ã€ä¸­æ–‡ã€è¥¿ç­ç‰™è¯­ã€æ³•è¯­ã€å¾·è¯­ç­‰ã€‚ä½¿ç”¨å¿…åº”chatï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ä¸æœºå™¨äººè¿›è¡Œäº’åŠ¨ï¼Œè·å¾—ä¾¿æ·çš„æœåŠ¡å’Œå¨±ä¹ä½“éªŒã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org79da4ca&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å®‰è£…&#34;&gt;å®‰è£…&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org8197e6e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ç§‘å­¦ä¸Šç½‘&#34;&gt;ç§‘å­¦ä¸Šç½‘&lt;/h2&gt;

&lt;p&gt;&lt;a id=&#34;org9014292&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;è‡ªç”±é²¸&#34;&gt;è‡ªç”±é²¸&lt;/h3&gt;

&lt;p&gt;è‡ªç”±é²¸ FreeWhale æ˜¯ä¸€å®¶é•¿æœŸèµ°ä¸­é«˜ç«¯è·¯çº¿çš„ ShadowsocksR(SSR) æœºåœºï¼Œä¹Ÿæä¾›éƒ¨åˆ† V2Ray çº¿è·¯ï¼Œå·²ç»ç¨³å®šè¿è¡Œå¤šå¹´ã€‚å®é™…å¯¹æ¯”ä¸‹æ¥ï¼Œå®ƒçš„æ€§ä»·æ¯”è¿˜æ˜¯ç›¸å½“é«˜çš„ï¼Œçº¿è·¯åˆå¤šï¼Œæä¾›çš„æµé‡ä¹Ÿååˆ†å……è¶³ï¼Œä¸»è¦æ¨èçš„å¥—é¤å……åˆ†è€ƒè™‘äº†å½“å‰ä¸»æµç”¨æˆ·èƒ½å¤Ÿæ¥å—çš„ä»·ä½ï¼Œå¯ä»¥è¯´æ˜¯æ— å¯æŒ‘å‰”ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ç‰¹ç‚¹&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;å°é—­é‚€è¯·æœºåˆ¶&lt;/p&gt;

&lt;p&gt;è‡ªç”±é²¸ FreeWhale éœ€è¦é‚€è¯·ç æ‰èƒ½æ³¨å†ŒæˆåŠŸï¼Œè¿™æ ·çš„æ³¨å†Œæœºåˆ¶ä¸€å®šç¨‹åº¦ç¡®ä¿äº†æœåŠ¡çš„ç¨³å®šæ€§ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœéœ€è¦é‚€è¯·ç ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘çš„é‚€è¯·ç :&lt;/p&gt;

&lt;p&gt;ä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»æˆ‘çš„é‚€è¯·é“¾æ¥ï¼Œè¿›å…¥æ³¨å†Œã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¥—é¤ä¾¿å®œ&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/freewhale.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä½¿ç”¨&lt;/p&gt;

&lt;p&gt;ç™»å½•åœ°å€ï¼š&lt;a href=&#34;https://www.freewhale.world/auth/register?code=XXXX&#34;&gt;https://www.freewhale.world/auth/register?code=XXXX&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;é€‰çš„æ˜¯512G/360 å¤©çš„å¥—é¤124å…ƒï¼Œç›¸å½“äºæ¯æœˆ10å…ƒè¿˜ç®—ä¾¿å®œã€‚&lt;/p&gt;

&lt;p&gt;è´­ä¹°æˆåŠŸåå°†å‡ºç°ä¸€å †èŠ‚ç‚¹åˆ—è¡¨ï¼Œåœ¨ç”¨æˆ·ä¸­å¿ƒé‡Œå°†å‡ºç°è®¢é˜…åœ°å€ç”¨åšvpnå®¢æˆ·ç«¯çš„é“¾æ¥ä¿¡æ¯ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a id=&#34;org9d5fbb8&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;clash&#34;&gt;clash&lt;/h3&gt;

&lt;p&gt;Clashæ˜¯ä¸€æ¬¾å¼€æºçš„å¤šå¹³å°ä»£ç†è½¯ä»¶ï¼Œæ”¯æŒ Windowsã€macOSã€Linuxã€Android ç­‰å¹³å°ã€‚Clashå¯ä»¥è¿è¡Œåœ¨æœ¬åœ°å¹¶ä»£ç† HTTPã€HTTPSã€SOCKS5ç­‰åè®®ï¼ŒåŒæ—¶è¿˜æ”¯æŒ SSã€V2Rayã€Trojan ç­‰åè®®ï¼Œå¯ä»¥å®ç°å¯¹äºè®¸å¤šç½‘ç«™å’Œåº”ç”¨çš„ç§‘å­¦ä¸Šç½‘ã€‚Clash çš„ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§åè®®ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä¸”æ›´æ–°é¢‘ç¹ã€‚Clashçš„å¼€æºä»£ç æ‰˜ç®¡åœ¨GitHubä¸Šï¼Œç”¨æˆ·å¯ä»¥å‚ä¸å…¶å¼€å‘å’Œæ”¹è¿›ã€‚&lt;/p&gt;

&lt;p&gt;æŠŠfreeWhaleä¸Šé¢çš„è®¢é˜…åœ°å€ç²˜è´´åˆ°clashçš„é…ç½®-&amp;gt;æ‰˜ç®¡é…ç½®-&amp;gt;ç®¡ç†é‡Œï¼Œ é…ç½®åç§°å†™ä¸ºxinjieCloudã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/clash-face.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ç§‘å­¦ä¸Šç½‘æ—¶ï¼ŒæŸ¥çœ‹ ip åœ°å€å¯èƒ½æ˜¾ç¤ºåœ¨å›½å†…ï¼Œä»¥ä¸‹æ˜¯è§£å†³åŠæ³•:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€å®šæŒ‚å…¨å±€æ¨¡å¼ + æ”¯æŒ OpenAI çš„å›½å®¶ï¼ˆç›®å‰ä¸­ä¿„ç­‰å›½ä¸æ”¯æŒï¼Œæ¨èåŒ—ç¾ã€æ—¥æœ¬ç­‰å›½å®¶ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;ä¸€å®šè®¾ç½®ä¸ºç³»ç»Ÿä»£ç† + æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹(DIRECT), å¦åˆ™ä¸Šä¸äº†å¤–ç½‘ã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šé¢æ­¥éª¤å®Œæˆåä¾ç„¶ä¸è¡Œçš„è¯ï¼Œå°±æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜ç„¶åé‡å¯æµè§ˆå™¨æˆ–è€…ç”µè„‘ï¼›æˆ–è€…ç›´æ¥æ–°å¼€ä¸€ä¸ªæ— ç—•æ¨¡å¼çš„çª—å£ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;org208d97c&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;pchat&#34;&gt;Pchat&lt;/h2&gt;

&lt;p&gt;Pchat æ˜¯ä¸€æ¬¾å¯ä»¥å…è´¹ã€ç®€å•æ˜“ç”¨çš„èŠå¤©æœºå™¨äººï¼Œç¿»å¢™åå¯ä»¥ä½¿ç”¨ï¼Œä¸ç”¨åšä»»ä½•é…ç½®ã€‚å®ƒåŒ…æ‹¬Pchat freeç‰ˆã€Pchat Proé«˜çº§ç‰ˆæœ¬ã€‚&lt;br /&gt;
è®¿é—®åœ°å€ä¸ºï¼š&lt;a href=&#34;https://www.promptboom.com&#34;&gt;https://www.promptboom.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/pchat.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Pchat Freeï¼Œä¸€ä¸ªç”±PromptBoomå’ŒOpenAIåˆä½œå¼€å‘çš„AIåŠ©æ‰‹ã€‚&lt;/li&gt;
&lt;li&gt;Pchat Proï¼Œæ˜¯Pchatå…è´¹ç‰ˆçš„é«˜çº§ç‰ˆæœ¬ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒPchatå…è´¹ç‰ˆæä¾›äº†åŸºæœ¬çš„èŠå¤©åŠŸèƒ½ï¼Œè€ŒPchat Proåˆ™åŒ…æ‹¬æ›´å¤šçš„é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚è¯­éŸ³å’Œè§†é¢‘é€šè¯ï¼Œè‡ªå®šä¹‰è¡¨æƒ…ç¬¦å·ç­‰ç­‰ã€‚æ­¤å¤–ï¼ŒPchat Proè¿˜å…·æœ‰æ›´é«˜çš„æ™ºèƒ½å’Œæ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒé‡‡ç”¨äº†æœ€å…ˆè¿›çš„æŠ€æœ¯å’Œç®—æ³•ã€‚&lt;br /&gt;
è¯•ç”¨æœŸä¸º14å¤©ã€‚åœ¨è¯•ç”¨æœŸç»“æŸä¹‹å‰ï¼Œæ‚¨å¯ä»¥å†³å®šæ˜¯å¦è´­ä¹°Pchat Proçš„è®¸å¯è¯ã€‚å¦‚æœæ‚¨å†³å®šè´­ä¹°ï¼Œæ‚¨å°†è·å¾—æ— é™åˆ¶çš„è®¿é—®æƒé™ï¼Œå¹¶å¯ä»¥äº«å—Pchat Proæä¾›çš„æ‰€æœ‰åŠŸèƒ½ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;org8b69e3f&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;newbing-1&#34;&gt;newBing&lt;/h2&gt;

&lt;p&gt;å¾®è½¯ New Bing æ˜¯å¾®è½¯æ¨å‡ºçš„å…¨æ–°æœç´¢å¼•æ“ï¼Œå®ƒä½¿ç”¨äº†æœ€æ–°çš„äººå·¥æ™ºèƒ½æŠ€æœ¯å’Œè‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯æ¥æä¾›æ›´å¥½çš„æœç´¢ç»“æœå’Œæ›´æ™ºèƒ½çš„æœç´¢ä½“éªŒã€‚å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´å¿«ã€æ›´å‡†ç¡®åœ°æ‰¾åˆ°ä»–ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·çš„æœç´¢å†å²å’Œå…´è¶£çˆ±å¥½æä¾›æ›´åŠ ä¸ªæ€§åŒ–çš„æœç´¢ç»“æœã€‚&lt;/p&gt;

&lt;p&gt;1ã€ä¸‹è½½æœ€æ–°/å·²æ”¯æŒnewbingçš„edgeæµè§ˆå™¨&lt;/p&gt;

&lt;p&gt;2ã€è®¾ç½®bing4ä¸ºé»˜è®¤æœç´¢å¼•æ“&lt;br /&gt;
   URLåœ°å€å†™ä¸ºï¼š&lt;a href=&#34;https://www4.bing.com/search?q=%s&amp;amp;PC=U316&amp;amp;FROM=CHROMN&#34;&gt;https://www4.bing.com/search?q=%s&amp;amp;PC=U316&amp;amp;FROM=CHROMN&lt;/a&gt;&lt;br /&gt;
   &lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/bing4-engine.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;3ã€è®¾ç½®å¤–ç½‘DNS&lt;br /&gt;
   é€‰æ‹©openDNS&lt;br /&gt;
   &lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/select-dns.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;4ã€ç¦æ­¢å’Œæ¸…ç†cookies&lt;br /&gt;
   ç¦æ­¢ä¿å­˜ä¸€äº›cn.bing.comæˆ–c.bing.comçš„cookiesï¼Œå…å¾—è€è·³è½¬åˆ°å›½å†…bingä¸Šã€‚&lt;br /&gt;
   &lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/forbiden-cookies.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;5ã€ç™»å½•&lt;br /&gt;
   æ–°å»ºæ ‡ç­¾é¡µï¼ŒæŠŠè¯­è¨€è®¾ç½®ä¸ºéå›½å†…åœ°åŒº&lt;br /&gt;
  &lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/newbing-index.png&#34; alt=&#34;img&#34; /&gt;&lt;br /&gt;
   ç™»å½•è´¦å·ï¼Œå¦‚æˆ‘ä¸ªäººè´¦å·ä¸º: moshengping210@gmail.com&lt;/p&gt;

&lt;p&gt;ç‚¹å‡»AIï¼Œå°±å¯ä»¥ç”¨bingChatäº†(ä¸å¤ªæ­£å¸¸ï¼Œå¦‚è·³è½¬åˆ°å›½å†…bingåéœ€æ¸…ç†cookiesåé‡å¯æµè§ˆå™¨)&lt;br /&gt;
&lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/newbing.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org554ec02&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;chatgpt-1&#34;&gt;chatgpt&lt;/h2&gt;

&lt;p&gt;1ã€ç”³è¯·è´¦å·&lt;br /&gt;
   æŸå®ä¸Šè´­ä¹°è´¦å·&lt;/p&gt;

&lt;p&gt;2ã€ç™»å½•å®˜ç½‘(éœ€æå‰ç§‘å­¦ä¸Šç½‘)&lt;br /&gt;
   ChatGPTçš„å®˜æ–¹ç½‘å€ï¼š &lt;a href=&#34;https://chat.openai.com/auth/login&#34;&gt;https://chat.openai.com/auth/login&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;3ã€æŸ¥è¯¢&lt;br /&gt;
  &lt;img src=&#34;http://blog.mospan.cn/post/img/chatgpt/chatgpt.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org415b7ac&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘ &lt;a href=&#34;https://zhuanlan.zhihu.com/p/618495330&#34;&gt;å½“å‰æœ€æ–°ç¨³å®šè®¿é—®NewBingæ–¹æ³•ï¼ˆæ“ä½œç®€å•ï¼‰&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(06): åŠ¨æ‰‹å®ç°webhook</title>
            <link>http://mospany.github.io/2023/03/05/k8s-webhook-example/</link>
            <pubDate>Sun, 05 Mar 2023 11:32:18 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2023/03/05/k8s-webhook-example/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;orgabac5c2&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;Webhookå°±æ˜¯ä¸€ç§HTTPå›è°ƒï¼Œç”¨äºåœ¨æŸç§æƒ…å†µä¸‹æ‰§è¡ŒæŸäº›åŠ¨ä½œï¼ŒWebhookä¸æ˜¯K8Sç‹¬æœ‰çš„ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹éƒ½å¯ä»¥è¿›è¡ŒWebhookï¼Œæ¯”å¦‚åœ¨æäº¤å®Œä»£ç åè°ƒç”¨ä¸€ä¸ªWebhookè‡ªåŠ¨æ„å»ºdockeré•œåƒ&lt;/p&gt;

&lt;p&gt;K8Sä¸­æä¾›äº†è‡ªå®šä¹‰èµ„æºç±»å‹å’Œè‡ªå®šä¹‰æ§åˆ¶å™¨æ¥æ‰©å±•åŠŸèƒ½ï¼Œè¿˜æä¾›äº†åŠ¨æ€å‡†å…¥æ§åˆ¶ï¼Œå…¶å®å°±æ˜¯é€šè¿‡Webhookæ¥å®ç°å‡†å…¥æ§åˆ¶ï¼Œåˆ†ä¸ºä¸¤ç§ï¼šéªŒè¯æ€§è´¨çš„å‡†å…¥ Webhook ï¼ˆValidating Admission Webhookï¼‰ å’Œ ä¿®æ”¹æ€§è´¨çš„å‡†å…¥ Webhook ï¼ˆMutating Admission Webhookï¼‰&lt;/p&gt;

&lt;p&gt;Admission Webhookæœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿå¦‚ä¸‹&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åœ¨èµ„æºæŒä¹…åŒ–åˆ°ETCDä¹‹å‰è¿›è¡Œä¿®æ”¹ï¼ˆMutating Webhookï¼‰ï¼Œæ¯”å¦‚å¢åŠ init Containeræˆ–è€…sidecar Container&lt;/li&gt;
&lt;li&gt;åœ¨èµ„æºæŒä¹…åŒ–åˆ°ETCDä¹‹å‰è¿›è¡Œæ ¡éªŒï¼ˆValidating Webhookï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„èµ„æºç›´æ¥æ‹’ç»å¹¶ç»™å‡ºç›¸åº”ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.mospan.cn/post/img/webhook/webhook.webp&#34;&gt;http://blog.mospan.cn/post/img/webhook/webhook.webp&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Webhookå¯ä»¥ç†è§£æˆJava Webå¼€å‘ä¸­çš„Filterï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šç»è¿‡Filterå¤„ç†ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå…ˆæ‰§è¡Œçš„æ˜¯Mutating Webhookï¼Œå®ƒå¯ä»¥å¯¹èµ„æºè¿›è¡Œä¿®æ”¹ï¼Œç„¶åæ‰§è¡Œçš„æ˜¯Validating Webhookï¼Œå®ƒå¯ä»¥æ‹’ç»æˆ–è€…æ¥å—è¯·æ±‚ï¼Œä½†æ˜¯å®ƒä¸èƒ½ä¿®æ”¹è¯·æ±‚ã€‚&lt;/p&gt;

&lt;p&gt;K8Sä¸­æœ‰å·²ç»å®ç°äº†çš„Admission Webhookåˆ—è¡¨ï¼Œè¯¦æƒ…å‚è€ƒæ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org5a64fe0&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç¤ºä¾‹åŸç†&#34;&gt;ç¤ºä¾‹åŸç†&lt;/h1&gt;

&lt;p&gt;æˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„Webhookä½œä¸ºä¾‹å­ï¼Œè¯¥Webhookä¼šåœ¨åˆ›å»ºDeploymentèµ„æºçš„æ—¶å€™æ£€æŸ¥å®ƒæ˜¯å¦æœ‰ç›¸åº”çš„æ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™åŠ ä¸Šï¼ˆMutating Webhookï¼‰ï¼Œç„¶ååœ¨æ£€éªŒå®ƒæ˜¯å¦æœ‰ç›¸åº”çš„æ ‡ç­¾ï¼ˆValidating Webhookï¼‰ï¼Œæœ‰åˆ™åˆ›å»ºè¯¥Deploymentï¼Œå¦åˆ™æ‹’ç»å¹¶ç»™å‡ºç›¸åº”é”™è¯¯æç¤ºã€‚&lt;/p&gt;

&lt;p&gt;æ‰€æœ‰ä»£ç éƒ½åœ¨ï¼š&lt;br /&gt;
git@github.com:mospany/admission-webhook-example.git&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org02043ed&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;éªŒè¯&#34;&gt;éªŒè¯&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org122233e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ç¼–è¯‘æ‰“åŒ…&#34;&gt;ç¼–è¯‘æ‰“åŒ…&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;cd admission-webhook-example/v1
DOCKER_USER=mospany bash ./build
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®ƒå°†ç”Ÿæˆé•œåƒå¹¶ä¸Šä¼ åˆ°docker.io/mospany/admission-webhook-example:v1ã€‚&lt;br /&gt;
&lt;img src=&#34;http://blog.mospan.cn/post/img/webhook/build.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org0aa6c11&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æ£€æŸ¥æ˜¯å¦å¼€å¯äº†åŠ¨æ€å‡†å…¥æ§åˆ¶&#34;&gt;æ£€æŸ¥æ˜¯å¦å¼€å¯äº†åŠ¨æ€å‡†å…¥æ§åˆ¶&lt;/h2&gt;

&lt;p&gt;æŸ¥çœ‹APIServeræ˜¯å¦å¼€å¯äº†MutatingAdmissionWebhookå’ŒValidatingAdmissionWebhook&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# è·å–apiserver podåå­—
apiserver_pod_name=`kubectl get --no-headers=true po -n kube-system | grep kube-apiserver | awk &#39;{ print $1 }&#39;`
# æŸ¥çœ‹api serverçš„å¯åŠ¨å‚æ•°plugin
kubectl get po $apiserver_pod_name -n kube-system -o yaml | grep plugin
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœè¾“å‡ºå¦‚ä¸‹ï¼Œè¯´æ˜å·²ç»å¼€å¯&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;- --enable-admission-plugins=NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦åˆ™ï¼Œéœ€è¦ä¿®æ”¹å¯åŠ¨å‚æ•°ï¼Œè¯·ä¸ç„¶ç›´æ¥ä¿®æ”¹Podçš„å‚æ•°ï¼Œè¿™æ ·ä¿®æ”¹ä¸ä¼šæˆåŠŸï¼Œè¯·ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/kubernetes/manifests/kube-apiserver.yamlï¼ŒåŠ ä¸Šç›¸åº”çš„æ’ä»¶å‚æ•°åä¿å­˜ï¼ŒAPIServerçš„Podä¼šç›‘æ§è¯¥æ–‡ä»¶çš„å˜åŒ–ï¼Œç„¶åé‡æ–°å¯åŠ¨ã€‚&lt;br /&gt;
&lt;img src=&#34;http://blog.mospan.cn/post/img/webhook/check-apiserver.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga56c5e4&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»ºrbac&#34;&gt;åˆ›å»ºRBAC&lt;/h2&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬çš„webhookä¼šå¯¹èµ„æºè¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬ç»™ä¸€ä¸ªServiceAccountï¼Œåœ¨K8Sé›†ç¾¤ä¸­ç›´æ¥åˆ›å»ºå³å¯&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl apply -f deployment/rbac.yaml 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deployment]# kubectl apply -f rbac.yaml
serviceaccount/admission-webhook-example-sa unchanged
clusterrole.rbac.authorization.k8s.io/admission-webhook-example-cr unchanged
clusterrolebinding.rbac.authorization.k8s.io/admission-webhook-example-crb unchanged
[root@k8s-master deployment]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org57c61b3&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;è¯ä¹¦è®¤è¯&#34;&gt;è¯ä¹¦è®¤è¯&lt;/h2&gt;

&lt;p&gt;K8Sé›†ç¾¤é»˜è®¤æ˜¯HTTPSé€šä¿¡çš„ï¼Œæ‰€ä»¥APiserverè°ƒç”¨webhookçš„è¿‡ç¨‹ä¹Ÿæ˜¯HTTPSçš„ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè¯ä¹¦è®¤è¯ï¼Œè¯ä¹¦è®¤è¯ç›¸å½“äºæ˜¯ç»™Serviceçš„åŸŸåè¿›è¡Œè®¤è¯ï¼ˆServiceåé¢ä¼šåˆ›å»ºï¼‰ï¼Œå°†ServiceåŸŸåæ”¾åˆ°è®¤è¯è¯·æ±‚server.csræ–‡ä»¶ä¸­ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªK8Sè¯ä¹¦ç­¾ç½²è¯·æ±‚èµ„æºCertificateSigningRequestï¼ŒAPIServerç­¾ç½²è¯¥è¯ä¹¦åç”Ÿæˆserver-cert.pemï¼Œå†å°†æœ€åˆåˆ›å»ºçš„ç§é’¥server-key.pemå’Œç­¾ç½²å¥½çš„è¯ä¹¦server-cert.pemæ”¾åˆ°Secretä¸­ä¾›Deploymentè°ƒç”¨ï¼Œè¯¦ç»†è¿‡ç¨‹çœ‹è„šæœ¬&lt;br /&gt;
webhook-create-signed-cert.sh&lt;/p&gt;

&lt;p&gt;è®¤è¯å¾ˆç®€å•ï¼Œæ‰§è¡Œè¯¥è„šæœ¬å³å¯ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸ºadmission-webhook-example-certsçš„Secret&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;./deployment/webhook-create-signed-cert.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸€æ­¥é¡ºä¾¿æŠŠServiceåˆ›å»ºäº†ï¼Œå› ä¸ºè¯ä¹¦æ˜¯ç»™è¯¥Serviceçš„åŸŸåé¢å‘çš„&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl apply -f deployment/service.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org9750af4&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²deployment&#34;&gt;éƒ¨ç½²Deployment&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;kubectl  apply -f deployment.yaml 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¨ç­‰ç‰‡åˆ»å¦‚æœæœ‰ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºè¯´æ˜Podå·²ç»è¿è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deployment]# kubectl  apply -f deployment.yaml
deployment.apps/admission-webhook-example-deployment unchanged
[root@k8s-master deployment]# kubectl  get pod -A -o wide | grep web
default       admission-webhook-example-deployment-7dd75cffb6-24bhg   1/1     Running   2 (13d ago)    57d    10.244.235.217   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
[root@k8s-master deployment]# kubectl  get pod -A  | grep web
default       admission-webhook-example-deployment-7dd75cffb6-24bhg   1/1     Running   2 (13d ago)    57d
[root@k8s-master deployment]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org7111e46&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²validatingwebhook&#34;&gt;éƒ¨ç½²ValidatingWebhook&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆåŒ…å«ä¸€ä¸ªnamespaceSelectorï¼Œè¡¨ç¤ºæ­¤webhookåªé’ˆå¯¹æœ‰admission-webhook-exampleæ ‡ç­¾çš„namespaceç”Ÿæ•ˆï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å»æ‰&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;namespaceSelector:
   matchLabels:
     admission-webhook-example: enabled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ç¼–æ’æ–‡ä»¶deployment/validatingwebhook.yamlï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå ä½ç¬¦${CA_BUNDLE}&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;clientConfig:
 service:
 name: admission-webhook-example-svc
 namespace: default
 path: &amp;quot;/validate&amp;quot;  # Pathæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„
 caBundle: ${CA_BUNDLE}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸ªæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿwebhookæ˜¯APIServerè°ƒç”¨çš„ï¼Œæ­¤æ—¶APIServerç›¸å½“äºæ˜¯ä¸€ä¸ªå®¢æœç«¯ï¼Œwebhookæ˜¯ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œå¯ä»¥å¯¹æ¯”ä¸‹å¹³æ—¶ä¸Šç½‘ï¼Œæ‰“å¼€httpsç½‘ç«™æ—¶æ˜¯è°åœ¨éªŒè¯åŸŸåçš„è¯ä¹¦ï¼Ÿæ˜¯å†…ç½®åœ¨æµè§ˆå™¨é‡Œé¢çš„æ ¹è¯ä¹¦åœ¨åšéªŒè¯ï¼Œæ‰€ä»¥è¿™é‡Œçš„CA_BUNDLEå°±ç±»ä¼¼äºAPIServerè°ƒç”¨webhookçš„æ ¹è¯ä¹¦ï¼Œå®ƒå»éªŒè¯webhookè¯ä¹¦ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥å…ˆå¡«å……è¿™ä¸ªCA_BUNDLEåå†æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# å¡«å……å ä½ç¬¦
cat deployment/validatingwebhook.yaml | ./deployment/webhook-patch-ca-bundle.sh &amp;gt; /tmp/validatingwebhook.yaml

# éƒ¨ç½²
kubectl apply -f /tmp/validatingwebhook.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orge4b820e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éªŒè¯-1&#34;&gt;éªŒè¯&lt;/h2&gt;

&lt;p&gt;1ã€ç»™default namespaceæ·»åŠ label&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl label namespace default admission-webhook-example=enabled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ã€éƒ¨ç½²sleep.yaml&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl apply -f deployment/sleep.yaml 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org3ee59df&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;faq&#34;&gt;FAQ&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org896c547&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;error-unable-to-recognize-stdin-no-matches-for-kind-certificatesigningrequest-in-version-certificates-k8s-io-v1beta1&#34;&gt;error: unable to recognize &amp;ldquo;STDIN&amp;rdquo;: no matches for kind &amp;ldquo;CertificateSigningRequest&amp;rdquo; in version &amp;ldquo;certificates.k8s.io/v1beta1&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;å½“æ‰§è¡Œ`bash webhook-create-signed-cert.sh`æ—¶å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;error: unable to recognize &amp;ldquo;STDIN&amp;rdquo;: no matches for kind &amp;ldquo;CertificateSigningRequest&amp;rdquo; in version &amp;ldquo;certificates.k8s.io/v1beta1&amp;rdquo;`&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éœ€ä¿®æ”¹webhook-create-signed-cert.shç›¸å…³å†…å®¹ä¸º:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# create  server cert/key CSR and  send to k8s API
cat &amp;lt;&amp;lt;EOF | kubectl create -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ${csrName}
spec:
  groups:
  - system:authenticated
  request: $(cat ${tmpdir}/server.csr | base64 | tr -d &#39;\n&#39;)
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - digital signature
  - key encipherment
  - client auth
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¦è§ï¼š&lt;a href=&#34;https://bytemeta.vip/repo/morvencao/kube-sidecar-injector/issues/29&#34;&gt;missing required field &amp;ldquo;signerName&amp;rdquo; #29&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga1e1728&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;no-matches-for-kind-validatingwebhookconfiguration-in-version-admissionregistration-k8s-io-v1beta1&#34;&gt;no matches for kind &amp;ldquo;ValidatingWebhookConfiguration&amp;rdquo; in version &amp;ldquo;admissionregistration.k8s.io/v1beta1&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;å½“æ‰§è¡Œ`kubectl apply -f validatingwebhook.yaml`æ—¶å‡ºç°é”™è¯¯ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;no matches for kind &amp;ldquo;ValidatingWebhookConfiguration&amp;rdquo; in version &amp;ldquo;admissionregistration.k8s.io/v1beta1&amp;rdquo;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éœ€æ”¹ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;admissionReviewVersions: [&amp;quot;v1&amp;quot;,&amp;quot;v1beta1&amp;quot;]
sideEffects: None
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¦è§ï¼š &lt;a href=&#34;https://kodekloud.com/community/t/pls-help-me-in-configuring-using-opa-in-minikbe/28428/5&#34;&gt;Pls help me in configuring/using OPA in minikbe&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgc3c8eba&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;x509-certificate-specifies-an-incompatible-key-usage&#34;&gt;x509: certificate specifies an incompatible key usage&lt;/h2&gt;

&lt;p&gt;&lt;a id=&#34;orga94e650&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://zhuanlan.zhihu.com/p/404764407&#34;&gt;ä»0åˆ°1å¼€å‘K8S_Webhookæœ€ä½³å®è·µ&lt;/a&gt;]&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>CentOS7 ä¸‹å®‰è£…å’Œé…ç½® NFS</title>
            <link>http://mospany.github.io/2023/01/15/aliyun-ecs-install-nfs/</link>
            <pubDate>Sun, 15 Jan 2023 10:44:29 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2023/01/15/aliyun-ecs-install-nfs/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;org629d3e2&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;NFSï¼ˆNetwork File Systemï¼Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰æ˜¯å½“å‰ä¸»æµå¼‚æ„å¹³å°å…±äº«æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸€ã€‚ä¸»è¦åº”ç”¨åœ¨UNIXç¯å¢ƒä¸‹ã€‚æœ€æ—©æ˜¯ç”±Sun Microsystemså¼€å‘ï¼Œç°åœ¨èƒ½å¤Ÿæ”¯æŒåœ¨ä¸åŒç±»å‹çš„ç³»ç»Ÿä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œæ–‡ä»¶å…±äº«ï¼Œå¹¿æ³›åº”ç”¨åœ¨FreeBSDã€SCOã€Solarisç­‰å¼‚æ„æ“ä½œç³»ç»Ÿå¹³å°ï¼Œå…è®¸ä¸€ä¸ªç³»ç»Ÿåœ¨ç½‘ç»œä¸Šä¸ä»–äººå…±äº«ç›®å½•å’Œæ–‡ä»¶ã€‚é€šè¿‡ä½¿ç”¨NFSï¼Œç”¨æˆ·å’Œç¨‹åºå¯ä»¥åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·è®¿é—®è¿œç«¯ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ï¼Œä½¿å¾—æ¯ä¸ªè®¡ç®—æœºçš„èŠ‚ç‚¹èƒ½å¤Ÿåƒä½¿ç”¨æœ¬åœ°èµ„æºä¸€æ ·æ–¹ä¾¿åœ°ä½¿ç”¨ç½‘ä¸Šèµ„æºã€‚æ¢è¨€ä¹‹ï¼ŒNFSå¯ç”¨äºä¸åŒç±»å‹è®¡ç®—æœºã€æ“ä½œç³»ç»Ÿã€ç½‘ç»œæ¶æ„å’Œä¼ è¾“åè®®è¿è¡Œç¯å¢ƒä¸­çš„ç½‘ç»œæ–‡ä»¶è¿œç¨‹è®¿é—®å’Œå…±äº«ã€‚&lt;/p&gt;

&lt;p&gt;NFSçš„å·¥ä½œåŸç†æ˜¯ä½¿ç”¨å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¶æ„ï¼Œç”±ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºå’ŒæœåŠ¡å™¨ç¨‹åºç»„æˆã€‚æœåŠ¡å™¨ç¨‹åºå‘å…¶ä»–è®¡ç®—æœºæä¾›å¯¹æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ï¼Œå…¶è¿‡ç¨‹ç§°ä¸ºè¾“å‡ºã€‚NFSå®¢æˆ·ç«¯ç¨‹åºå¯¹å…±äº«æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè®¿é—®æ—¶ï¼ŒæŠŠå®ƒä»¬ä»NFSæœåŠ¡å™¨ä¸­â€œè¾“é€â€å‡ºæ¥ã€‚æ–‡ä»¶é€šå¸¸ä»¥å—ä¸ºå•ä½è¿›è¡Œä¼ è¾“ã€‚å…¶å¤§å°æ˜¯8KBï¼ˆè™½ç„¶å®ƒå¯èƒ½ä¼šå°†æ“ä½œåˆ†æˆæ›´å°å°ºå¯¸çš„åˆ†ç‰‡ï¼‰ã€‚NFSä¼ è¾“åè®®ç”¨äºæœåŠ¡å™¨å’Œå®¢æˆ·æœºä¹‹é—´æ–‡ä»¶è®¿é—®å’Œå…±äº«çš„é€šä¿¡ï¼Œä»è€Œä½¿å®¢æˆ·æœºè¿œç¨‹åœ°è®¿é—®ä¿å­˜åœ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org043eb1b&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æœåŠ¡ç«¯æ­å»º&#34;&gt;æœåŠ¡ç«¯æ­å»º&lt;/h1&gt;

&lt;p&gt;ç”±äºå®ç°CSIéœ€è¦ä¸€ä¸ªåç«¯å­˜å‚¨ï¼ŒLinuxæä¾›NFSåŠŸèƒ½å¯ä»¥å…è´¹æ­å»ºä¸€ä¸ªNSCå­˜å‚¨åŠŸèƒ½ç”¨æ¥éªŒè¯ã€‚&lt;br /&gt;
æ­å»ºåŠæ³•è¯¦è§: &lt;a href=&#34;https://www.codeleading.com/article/35162638950/&#34;&gt;é˜¿é‡Œäº‘æœåŠ¡å™¨ CentOS7 ä¸‹å®‰è£…å’Œé…ç½® NFS&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org31fb10d&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æœåŠ¡ç«¯å®‰è£…&#34;&gt;æœåŠ¡ç«¯å®‰è£…&lt;/h2&gt;

&lt;p&gt;ä½¿ç”¨ yum å®‰è£… NFS å®‰è£…åŒ…ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;yum install nfs-utils -y 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org768e380&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æœåŠ¡ç«¯é…ç½®&#34;&gt;æœåŠ¡ç«¯é…ç½®&lt;/h2&gt;

&lt;p&gt;è®¾ç½® NFS æœåŠ¡å¼€æœºå¯åŠ¨&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# systemctl enable rpcbind
[root@k8s-master ~]# systemctl enable nfs
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org79e8e0b&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®å…±äº«ç›®å½•&#34;&gt;é…ç½®å…±äº«ç›®å½•&lt;/h2&gt;

&lt;p&gt;æœåŠ¡å¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯é…ç½®ä¸€ä¸ªå…±äº«ç›®å½•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# mkdir /data
[root@k8s-master ~]# chmod 755 /data
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¹æ®è¿™ä¸ªç›®å½•ï¼Œç›¸åº”é…ç½®å¯¼å‡ºç›®å½•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vim /etc/exports
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ·»åŠ å¦‚ä¸‹é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/data/     *(rw,sync,no_root_squash,no_all_squash)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;data: å…±äº«ç›®å½•ä½ç½®ã€‚&lt;br /&gt;
192.168.0.0/24: å®¢æˆ·ç«¯ IP èŒƒå›´ï¼Œ* ä»£è¡¨æ‰€æœ‰ï¼Œå³æ²¡æœ‰é™åˆ¶ï¼ˆæˆ‘åœ¨å®éªŒä¸­ä¼šè®¾ç½®ä¸º*ï¼‰ã€‚&lt;br /&gt;
rw: æƒé™è®¾ç½®ï¼Œå¯è¯»å¯å†™ã€‚&lt;br /&gt;
sync: åŒæ­¥å…±äº«ç›®å½•ã€‚&lt;br /&gt;
no_root_squash: å¯ä»¥ä½¿ç”¨ root æˆæƒã€‚&lt;br /&gt;
no_all_squash: å¯ä»¥ä½¿ç”¨æ™®é€šç”¨æˆ·æˆæƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orge7422da&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;å¯åŠ¨-nfs-æœåŠ¡&#34;&gt;å¯åŠ¨ NFS æœåŠ¡&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# systemctl start rpcbind
[root@k8s-master ~]# systemctl start nfs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org2db5bbe&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;é˜²ç«å¢™éœ€è¦æ‰“å¼€-rpc-bind-å’Œ-nfs-çš„æœåŠ¡&#34;&gt;é˜²ç«å¢™éœ€è¦æ‰“å¼€ rpc-bind å’Œ nfs çš„æœåŠ¡&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# firewall-cmd --zone=public --permanent --add-service={rpc-bind,mountd,nfs}
FirewallD is not running
[root@k8s-master ~]# firewall-cmd --reload
FirewallD is not running
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org9febc6e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æ£€æŸ¥&#34;&gt;æ£€æŸ¥&lt;/h2&gt;

&lt;p&gt;å¯ä»¥æ£€æŸ¥ä¸€ä¸‹æœ¬åœ°çš„å…±äº«ç›®å½•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# showmount -e localhost
Export list for localhost:
/data *
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·ï¼ŒæœåŠ¡ç«¯å°±é…ç½®å¥½äº†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgbfea31c&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æŸ¥çœ‹ç«¯å£&#34;&gt;æŸ¥çœ‹ç«¯å£&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# rpcinfo -p localhost
program vers proto   port  service
 100000    4   tcp    111  portmapper
 100000    3   tcp    111  portmapper
 100000    2   tcp    111  portmapper
 100000    4   udp    111  portmapper
 100000    3   udp    111  portmapper
 100000    2   udp    111  portmapper
 100005    1   udp  20048  mountd
 100005    1   tcp  20048  mountd
 100005    2   udp  20048  mountd
 100024    1   udp  54689  status
 100005    2   tcp  20048  mountd
 100024    1   tcp  46564  status
 100005    3   udp  20048  mountd
 100005    3   tcp  20048  mountd
 100003    3   tcp   2049  nfs
 100003    4   tcp   2049  nfs
 100227    3   tcp   2049  nfs_acl
 100003    3   udp   2049  nfs
 100003    4   udp   2049  nfs
 100227    3   udp   2049  nfs_acl
 100021    1   udp  40110  nlockmgr
 100021    3   udp  40110  nlockmgr
 100021    4   udp  40110  nlockmgr
 100021    1   tcp  33742  nlockmgr
 100021    3   tcp  33742  nlockmgr
 100021    4   tcp  33742  nlockmgr
 [root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orga16c2a2&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å®¢æˆ·ç«¯è¿æ¥-nfs&#34;&gt;å®¢æˆ·ç«¯è¿æ¥ NFS&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;orge9dc5a1&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åœ¨å®¢æˆ·ç«¯åˆ›å»ºç›®å½•&#34;&gt;åœ¨å®¢æˆ·ç«¯åˆ›å»ºç›®å½•&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# mkdir -p /mnt/nfs-data/
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgce10511&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æŒ‚è½½&#34;&gt;æŒ‚è½½&lt;/h2&gt;

&lt;p&gt;ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å‡åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# mount -t nfs 127.0.0.1:/data /mnt/nfs-data
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‚è½½ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ mount å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# mount | grep nfs
nfsd on /proc/fs/nfsd type nfsd (rw,relatime)
sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw,relatime)
127.0.0.1:/data on /mnt/nfs-data type nfs4 (rw,relatime,vers=4.1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=127.0.0.1,local_lock=none,addr=127.0.0.1)
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™è¯´æ˜å·²ç»æŒ‚è½½æˆåŠŸäº†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgc315b27&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æµ‹è¯•nfs&#34;&gt;æµ‹è¯•NFS&lt;/h1&gt;

&lt;p&gt;æµ‹è¯•ä¸€ä¸‹ï¼Œåœ¨å®¢æˆ·ç«¯å‘å…±äº«ç›®å½•åˆ›å»ºä¸€ä¸ªæ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# echo test &amp;gt; /mnt/nfs-data/bbb.txt
[root@k8s-master ~]#
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¹‹åå– NFS æœåŠ¡ç«¯æŸ¥çœ‹ä¸€ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# echo test &amp;gt; /mnt/nfs-data/bbb.txt
[root@k8s-master ~]#
[root@k8s-master ~]# cat /data/bbb.txt
test
[root@k8s-master ~]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå…±äº«ç›®å½•å·²ç»å†™å…¥äº†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org6f32303&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å®¢æˆ·ç«¯è‡ªåŠ¨æŒ‚è½½&#34;&gt;å®¢æˆ·ç«¯è‡ªåŠ¨æŒ‚è½½&lt;/h1&gt;

&lt;p&gt;è‡ªåŠ¨æŒ‚è½½å¾ˆå¸¸ç”¨ï¼Œå®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸‹å³å¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ vim /etc/fstab
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ç»“å°¾æ·»åŠ ç±»ä¼¼å¦‚ä¸‹é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# cat /etc/fstab

 #
 # /etc/fstab
 # Created by anaconda on Thu Jul 11 02:52:01 2019
 #
 # Accessible filesystems, by reference, are maintained under &#39;/dev/disk&#39;
 # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
 #
 UUID=1114fe9e-2309-4580-b183-d778e6d97397 /                       ext4    defaults        1 1
 127.0.0.1:/data     /mnt/nfs-data                   nfs     defaults        0 0
 [root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºä¿®æ”¹äº† /etc/fstabï¼Œéœ€è¦é‡æ–°åŠ è½½ systemctlã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# systemctl daemon-reload
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org284ecce&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://www.codeleading.com/article/35162638950/&#34;&gt;é˜¿é‡Œäº‘æœåŠ¡å™¨ CentOS7 ä¸‹å®‰è£…å’Œé…ç½® NFS&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(05): åŠ¨æ‰‹å®ç°CSIé©±åŠ¨</title>
            <link>http://mospany.github.io/2022/12/22/k8s-sci-driver/</link>
            <pubDate>Thu, 22 Dec 2022 22:21:36 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2022/12/22/k8s-sci-driver/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;org3f75c1c&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;å¤–éƒ¨å­˜å‚¨æ¥å…¥ Kubernetes çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼šIn-Tree å’Œ Out-of-Treeã€‚å…¶ä¸­ In-Tree æ˜¯æŒ‡å­˜å‚¨é©±åŠ¨çš„æºç éƒ½åœ¨ Kubernetes ä»£ç åº“ä¸­ï¼Œä¸ Kubernetes ä¸€èµ·å‘å¸ƒã€è¿­ä»£ã€ç®¡ç†ï¼Œè¿™ç§æ–¹å¼çµæ´»æ€§è¾ƒå·®ï¼Œä¸”é—¨æ§›è¾ƒé«˜ã€‚Out-of-Tree æ˜¯æŒ‡å­˜å‚¨æ’ä»¶ç”±ç¬¬ä¸‰æ–¹ç¼–å†™ã€å‘å¸ƒã€ç®¡ç†ï¼Œä½œä¸ºä¸€ç§æ‰©å±•ä¸ Kubernetes é…åˆä½¿ç”¨ã€‚Out-of-Tree ä¸»è¦æœ‰ FlexVolume å’Œ CSI ä¸¤ç§å®ç°æ–¹å¼ï¼Œå…¶ä¸­ï¼ŒFlexVolume å› ä¸ºå…¶å‘½ä»¤å¼çš„ç‰¹ç‚¹ï¼Œä¸æ˜“ç»´æŠ¤å’Œç®¡ç†ï¼Œä» Kubernetes v1.23 ç‰ˆæœ¬å¼€å§‹å·²è¢«å¼ƒç”¨ã€‚å› æ­¤ CSI å·²ç»æˆä¸º Kubernetes å­˜å‚¨æ‰©å±•ï¼ˆ Out-of-Tree ï¼‰çš„å”¯ä¸€æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨ä»‹ç»CSIä¹‹å‰ï¼Œå…ˆæ¢³ç†ä¸€ä¸‹kubernetesä¸­ä½¿ç”¨å­˜å‚¨æœ‰å“ªäº›æ­¥éª¤ï¼š&lt;br /&gt;
1ã€åˆ›å»ºpvå¯¹è±¡&lt;br /&gt;
2ã€å­˜å‚¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªvolume&lt;br /&gt;
3ã€æŠŠåˆ›å»ºçš„volumeæŒ‚è½½åˆ°å®¿ä¸»æœºä¸Š&lt;br /&gt;
4ã€æ ¼å¼åŒ–volume&lt;br /&gt;
5ã€æŠŠæ ¼å¼åŒ–çš„volume mountåˆ°podçš„volumeç›®å½•&lt;br /&gt;
6ã€åˆ›å»ºpvcå¯¹è±¡å¹¶å’Œpvå¯¹è±¡ç»‘å®š&lt;br /&gt;
7ã€podä½¿ç”¨pvc&lt;/p&gt;

&lt;p&gt;ä»£ç å·¥ç¨‹ï¼š&lt;a href=&#34;https://github.com/mospany/nfscsi.git&#34;&gt;https://github.com/mospany/nfscsi.git&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga5011fc&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æœ¯è¯­&#34;&gt;æœ¯è¯­&lt;/h1&gt;

&lt;table border=&#34;2&#34; cellspacing=&#34;0&#34; cellpadding=&#34;6&#34; rules=&#34;groups&#34; frame=&#34;hsides&#34;&gt;


&lt;colgroup&gt;
&lt;col  class=&#34;org-left&#34; /&gt;

&lt;col  class=&#34;org-left&#34; /&gt;

&lt;col  class=&#34;org-left&#34; /&gt;

&lt;col  class=&#34;org-left&#34; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th scope=&#34;col&#34; class=&#34;org-left&#34;&gt;ç¼©å†™&lt;/th&gt;
&lt;th scope=&#34;col&#34; class=&#34;org-left&#34;&gt;è‹±æ–‡å…¨ç§°&lt;/th&gt;
&lt;th scope=&#34;col&#34; class=&#34;org-left&#34;&gt;ä¸­æ–‡å…¨ç§°&lt;/th&gt;
&lt;th scope=&#34;col&#34; class=&#34;org-left&#34;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&#34;org-left&#34;&gt;pvc&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;PersistentVolumeClaim&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;æŒä¹…å·å£°æ˜&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;æè¿°çš„æ˜¯podå¸Œæœ›ä½¿ç”¨çš„æŒä¹…åŒ–å­˜å‚¨çš„å±æ€§&lt;/td&gt;
&lt;/tr&gt;


&lt;tr&gt;
&lt;td class=&#34;org-left&#34;&gt;pv&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;PersistentVolume&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;æŒä¹…å·&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;æè¿°çš„æ˜¯å…·ä½“çš„æŒä¹…åŒ–å­˜å‚¨æ•°æ®å·ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;


&lt;tr&gt;
&lt;td class=&#34;org-left&#34;&gt;storageClass&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;storageClass&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;å­˜å‚¨ç±»&lt;/td&gt;
&lt;td class=&#34;org-left&#34;&gt;åˆ›å»ºpvçš„æ¨¡æ¿&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;&lt;a id=&#34;org20530b7&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;csiç»„æˆ&#34;&gt;CSIç»„æˆ&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/csi/csi-component.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;é€šå¸¸æƒ…å†µä¸‹ï¼šCSI Driver = DaemonSet + Deployment(StatefuleSet) ã€‚&lt;br /&gt;
å…¶ä¸­:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç»¿è‰²éƒ¨åˆ†ï¼šIdentityã€Nodeã€Controller æ˜¯éœ€è¦å¼€å‘è€…è‡ªå·±å®ç°çš„ï¼Œè¢«ç§°ä¸º Custom Componentsã€‚&lt;/li&gt;
&lt;li&gt;ç²‰è‰²éƒ¨åˆ†ï¼šnode-driver-registrarã€external-attacherã€external-provisioner ç»„ä»¶æ˜¯ Kubernetes å›¢é˜Ÿå¼€å‘å’Œç»´æŠ¤çš„ï¼Œè¢«ç§°ä¸º External Componentsï¼Œå®ƒä»¬éƒ½æ˜¯ä»¥ sidecar çš„å½¢å¼ä¸ Custom Components é…åˆä½¿ç”¨çš„ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;orga3ae62a&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;custom-components&#34;&gt;Custom Components&lt;/h2&gt;

&lt;p&gt;Custom Components æœ¬è´¨æ˜¯ 3 ä¸ª gRPC Servicesï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Identity Service é¡¾åæ€ä¹‰ï¼Œä¸»è¦ç”¨äºå¯¹å¤–æš´éœ²è¿™ä¸ªæ’ä»¶æœ¬èº«çš„ä¿¡æ¯ï¼Œæ¯”å¦‚é©±åŠ¨çš„åç§°ã€é©±åŠ¨çš„èƒ½åŠ›ç­‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;//github.com/container-storage-interface/spec/lib/go/csi/csi.pb.go
typeÂ IdentityServerÂ interfaceÂ {
    GetPluginInfo(context.Context,Â *GetPluginInfoRequest)Â (*GetPluginInfoResponse,Â error)
    GetPluginCapabilities(context.Context,Â *GetPluginCapabilitiesRequest)Â (*GetPluginCapabilitiesResponse,Â error)
    Probe(context.Context,Â *ProbeRequest)Â (*ProbeResponse,Â error)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Controller Service ä¸»è¦å®šä¹‰ä¸€äº› æ— éœ€åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œçš„æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯ä¸ä¸‹æ–‡çš„ Node Service æœ€æ ¹æœ¬çš„åŒºåˆ«ã€‚ä»¥ CreateVolume ä¸ºä¾‹ï¼Œk8s é€šè¿‡è°ƒç”¨è¯¥æ–¹æ³•åˆ›å»ºåº•å±‚å­˜å‚¨ã€‚æ¯”å¦‚åº•å±‚ä½¿ç”¨äº†æŸäº‘ä¾›åº”å•†çš„äº‘ç¡¬ç›˜æœåŠ¡ï¼Œå¼€å‘è€…åœ¨ CreateVolume æ–¹æ³•å®ç°ä¸­åº”è¯¥è°ƒç”¨äº‘ç¡¬ç›˜æœåŠ¡çš„åˆ›å»º / è®¢è´­äº‘ç¡¬ç›˜çš„ APIï¼Œè°ƒç”¨ API è¿™ä¸ªæ“ä½œæ˜¯ä¸éœ€è¦åœ¨ç‰¹å®šå®¿ä¸»æœºä¸Šæ‰§è¡Œçš„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// github.com/container-storage-interface/spec/lib/go/csi/csi.pb.go
type ControllerServer interface {
    CreateVolume(context.Context, *CreateVolumeRequest) (*CreateVolumeResponse, error)
    DeleteVolume(context.Context, *DeleteVolumeRequest) (*DeleteVolumeResponse, error)
    ControllerPublishVolume(context.Context, *ControllerPublishVolumeRequest) (*ControllerPublishVolumeResponse, error)
    ControllerUnpublishVolume(context.Context, *ControllerUnpublishVolumeRequest) (*ControllerUnpublishVolumeResponse, error)
    ValidateVolumeCapabilities(context.Context, *ValidateVolumeCapabilitiesRequest) (*ValidateVolumeCapabilitiesResponse, error)
    ListVolumes(context.Context, *ListVolumesRequest) (*ListVolumesResponse, error)
    GetCapacity(context.Context, *GetCapacityRequest) (*GetCapacityResponse, error)
    ControllerGetCapabilities(context.Context, *ControllerGetCapabilitiesRequest) (*ControllerGetCapabilitiesResponse, error)
    CreateSnapshot(context.Context, *CreateSnapshotRequest) (*CreateSnapshotResponse, error)
    DeleteSnapshot(context.Context, *DeleteSnapshotRequest) (*DeleteSnapshotResponse, error)
    ListSnapshots(context.Context, *ListSnapshotsRequest) (*ListSnapshotsResponse, error)
    ControllerExpandVolume(context.Context, *ControllerExpandVolumeRequest) (*ControllerExpandVolumeResponse, error)
    ControllerGetVolume(context.Context, *ControllerGetVolumeRequest) (*ControllerGetVolumeResponse, error)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Node Service å®šä¹‰äº† éœ€è¦åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œçš„æ“ä½œï¼Œæ¯”å¦‚ï¼šmountã€unmountã€‚åœ¨å‰é¢çš„éƒ¨ç½²æ¶æ„å›¾ä¸­ï¼ŒNode Service ä½¿ç”¨ Daemonset çš„æ–¹å¼éƒ¨ç½²ï¼Œä¹Ÿæ˜¯ä¸ºäº†ç¡®ä¿ Node Service ä¼šè¢«è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼Œä»¥ä¾¿æ‰§è¡Œè¯¸å¦‚ mount ä¹‹ç±»çš„æŒ‡ä»¤ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// github.com/container-storage-interface/spec/lib/go/csi/csi.pb.go
type NodeServer interface {
    NodeStageVolume(context.Context, *NodeStageVolumeRequest) (*NodeStageVolumeResponse, error)
    NodeUnstageVolume(context.Context, *NodeUnstageVolumeRequest) (*NodeUnstageVolumeResponse, error)
    NodePublishVolume(context.Context, *NodePublishVolumeRequest) (*NodePublishVolumeResponse, error)
    NodeUnpublishVolume(context.Context, *NodeUnpublishVolumeRequest) (*NodeUnpublishVolumeResponse, error)
    NodeGetVolumeStats(context.Context, *NodeGetVolumeStatsRequest) (*NodeGetVolumeStatsResponse, error)
    NodeExpandVolume(context.Context, *NodeExpandVolumeRequest) (*NodeExpandVolumeResponse, error)
    NodeGetCapabilities(context.Context, *NodeGetCapabilitiesRequest) (*NodeGetCapabilitiesResponse, error)
    NodeGetInfo(context.Context, *NodeGetInfoRequest) (*NodeGetInfoResponse, error)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;org7bc93bd&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;åŸç†&#34;&gt;åŸç†&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/csi/nfs-csi.png&#34; alt=&#34;img&#34; /&gt;&lt;br /&gt;
1ã€é¦–å…ˆè‚¯å®šæ˜¯è¦åœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œç¼–ç¨‹å®ç°å‰é¢æåˆ°çš„ä¸‰ä¸ªgRPCæœåŠ¡å¯¹åº”çš„æ–¹æ³•ï¼Œä¾‹å¦‚IdentityServerä¸‹çš„ä¸‰ä¸ªæ–¹æ³•ã€ControllerServerä¸‹çš„CreateVolume/DeleteVolumeæ–¹æ³•ä»¥åŠNodeServerä¸‹çš„NodePublishVolume/NodeUnpublishVolumeæ–¹æ³•ç­‰ï¼Œå¹¶ä»¥unix sockçš„æ–¹å¼æä¾›gRPCæœåŠ¡ï¼ˆåæ–‡ä¼šç”¨åˆ°ï¼‰ï¼Œå¹¶æ‰“åŒ…æˆé•œåƒï¼›&lt;/p&gt;

&lt;p&gt;2ã€æŠŠnode-driver-registrarå’ŒCSIæœåŠ¡ä½œä¸ºä¸¤ä¸ªå®¹å™¨æ”¾åˆ°ä¸€ä¸ªpodé‡Œï¼Œè¿™æ ·node-driver-registraræœåŠ¡å°±å¯ä»¥ç”¨unix sockçš„æ–¹å¼è®¿é—®CSIè¿›ç¨‹é‡Œçš„gRPCæœåŠ¡å¹¶ä¸”å‘kubeletæ³¨å†Œï¼›&lt;/p&gt;

&lt;p&gt;3ã€node-driver-registrarå®Œæˆæ³¨å†Œåï¼Œåç»­çš„Mount/Unmountç­‰æ“ä½œkubeletä¼šç›´æ¥é€šè¿‡unix sockè®¿é—®CSIã€‚è¿™é‡Œæœ‰ä¸¤å±‚å«ä¹‰ï¼šç¬¬ä¸€å±‚å«ä¹‰æ˜¯kubeletä¼šç›´æ¥é€šè¿‡unix sockè®¿é—®CSIï¼Œå› æ­¤CSIéœ€è¦ç”¨hostPathçš„æ–¹å¼æŠŠè‡ªå·±unix sockæ–‡ä»¶æš´éœ²ï¼›ç¬¬äºŒå±‚å«ä¹‰æ˜¯kubeletç›´æ¥è°ƒç”¨CSIæœåŠ¡ï¼Œè¿™æ„å‘³ç€node-driver-registrarå’ŒCSIçš„è¿™ä¸ªpodåº”è¯¥æ˜¯daemonSetå½¢å¼éƒ¨ç½²çš„ï¼›&lt;/p&gt;

&lt;p&gt;4ã€æŠŠexternal-provisionerå’ŒCSIæœåŠ¡ä½œä¸ºä¸¤ä¸ªå®¹å™¨æ”¾åˆ°ä¸€ä¸ªpodé‡Œï¼Œå»å®ç°Dynamic ProvisioningåŠŸèƒ½ã€‚å› ä¸ºDynamic Provisioningè®¾è®¡åˆ›å»ºå·å’Œåˆ é™¤å·ï¼Œå› æ­¤è¿™ä¸ªpodåº”è¯¥çœ‹åšæ˜¯æœ‰çŠ¶æ€çš„ï¼Œåœ¨éƒ¨ç½²ä¸Šé€šå¸¸æ˜¯å¸¦æœ‰é€‰ä¸¾çš„deploymentéƒ¨ç½²æˆ–è€…å‰¯æœ¬æ•°ä¸º1çš„statefulSetéƒ¨ç½²ï¼ˆå¦‚æœéœ€è¦Attach/DetachåŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥å†åŠ ä¸ªå®¹å™¨æŠŠexternal-attacheræ”¾åˆ°è¿™ä¸ªpodä¸­ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org953691d&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;csiæ³¨å†Œæµç¨‹&#34;&gt;CSIæ³¨å†Œæµç¨‹&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/csi/csi-reg.png&#34; alt=&#34;img&#34; /&gt;&lt;br /&gt;
ç›¸å…³çš„æ­¥éª¤é‡Šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;1ã€kubeletå¯åŠ¨ååŸºäºfsnotifyç›‘å¬/var/lib/kubelet/plugins_registryç›®å½•ï¼›&lt;br /&gt;
2ã€node-driver-registrarå¯åŠ¨é€šè¿‡å¯åŠ¨å‚æ•°ä¸­é…ç½®çš„CSIè¿›ç¨‹çš„sockæ–‡ä»¶ï¼Œè°ƒCSIè¿›ç¨‹çš„GetPluginInfoæ–¹æ³•è·å–CSIæ’ä»¶åç§°ï¼›&lt;br /&gt;
3ã€node-driver-registrarå¯åŠ¨ååœ¨/var/lib/kubelet/plugins_registryç›®å½•ä¸‹åˆ›å»ºè‡ªå·±çš„sockæ–‡ä»¶{csiName}-reg.sockï¼›&lt;br /&gt;
4ã€kubeletçš„watcherç›‘å¬åˆ°/var/lib/kubelet/plugins_registryç›®å½•ä¸‹æœ‰sockæ–‡ä»¶åˆ›å»ºï¼ŒæŠŠè¯¥sockæ–‡ä»¶ä¿¡æ¯å­˜å…¥å†…å­˜ä¸­çš„desiredStateOfWorldå¯¹è±¡ä¸­ï¼›&lt;br /&gt;
5ã€kubeletä¸­æœ‰ä¸ªreconcileråç¨‹å‘¨æœŸæ€§çš„æ£€æŸ¥desiredStateOfWorldå¯¹è±¡å’ŒactualStateOfWorldå¯¹è±¡ä¸­çš„æ•°æ®å·®å¼‚ï¼Œå‘ç°æœ‰æ–°çš„CSIæ’ä»¶éœ€è¦æ‰§è¡Œæ³¨å†Œè¿‡ç¨‹ï¼›&lt;br /&gt;
6ã€reconcileré€šè¿‡/var/lib/kubelet/plugins_registry/{csiName}-reg.sockï¼Œè°ƒç”¨node-driver-registrarä¸‹çš„GetInfoæ–¹æ³•è·å–CSIæ’ä»¶çš„åç§°å’ŒCSIè¿›ç¨‹çš„sockæ–‡ä»¶è·¯å¾„ç­‰ä¿¡æ¯ï¼›&lt;br /&gt;
7ã€reconcileré€šè¿‡ä¸Šä¸€æ­¥æ‹¿åˆ°çš„CSIè¿›ç¨‹sockæ–‡ä»¶ï¼Œè°ƒç”¨CSIè¿›ç¨‹ä¸‹NodeGetInfoæ–¹æ³•è·å–ä¸€äº›æ•°æ®ç”¨äºåç»­çš„Nodeå’ŒCSINodeå¯¹è±¡ï¼›&lt;br /&gt;
8ã€ç»„è£…æ•°æ®è°ƒapiServeræ¥å£æ›´æ–°æœ¬èŠ‚ç‚¹å¯¹åº”çš„Nodeå¯¹è±¡çš„annotationï¼›&lt;br /&gt;
9ã€ç»„è£…æ•°æ®è°ƒapiServeræ¥å£åˆ›å»º/æ›´æ–°å¯¹åº”çš„CSINodeå¯¹è±¡ï¼›&lt;br /&gt;
10ã€reconcileré€šè¿‡/var/lib/kubelet/plugins_registry/{csiName}-reg.sockï¼Œè°ƒç”¨node-driver-registrarçš„NotifyRegistrationStatusæ–¹æ³•ï¼Œå‘ŠçŸ¥å…¶æ³¨å†Œç»“æœã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org34e354f&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;nfsæ­å»º&#34;&gt;NFSæ­å»º&lt;/h1&gt;

&lt;p&gt;ç”±äºå®ç°CSIéœ€è¦ä¸€ä¸ªåç«¯å­˜å‚¨ï¼ŒLinuxæä¾›NFSåŠŸèƒ½å¯ä»¥å…è´¹æ­å»ºä¸€ä¸ªNSCå­˜å‚¨åŠŸèƒ½ç”¨æ¥éªŒè¯ã€‚&lt;br /&gt;
æ­å»ºåŠæ³•è¯¦è§: &lt;a href=&#34;http://blog.mospan.cn/2023/01/15/aliyun-ecs-install-nfs/&#34;&gt;CentOS7 ä¸‹å®‰è£…å’Œé…ç½® NFS&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgaf35c61&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;éƒ¨ç½²&#34;&gt;éƒ¨ç½²&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org82b326f&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²node&#34;&gt;éƒ¨ç½²node&lt;/h2&gt;

&lt;p&gt;è¿›å…¥ä»£ç å·¥ç¨‹ä¸­çš„deployä¸‹è¿è¡Œå‘½ä»¤`kubectl apply -f node.yaml`&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# pwd
/root/nfscsi
[root@k8s-master nfscsi]# cd deploy/
[root@k8s-master deploy]# ls
node.yaml  provisioner.yaml
[root@k8s-master deploy]# ll
æ€»ç”¨é‡ 12
-rw-r--r-- 1 root root 3720 1æœˆ   8 22:18 node.yaml
-rw-r--r-- 1 root root 4413 1æœˆ   8 22:16 provisioner.yaml

[root@k8s-master deploy]# k apply -f node.yaml
serviceaccount/nfs-csi-node created
clusterrole.rbac.authorization.k8s.io/nfs-csi-node created
clusterrolebinding.rbac.authorization.k8s.io/nfs-csi-node created
daemonset.apps/nfs-csi-node created
[root@k8s-master deploy]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹PODçš„è¿è¡ŒçŠ¶æ€ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deploy]# k get pod -A -o wide | grep nfs
kube-system   nfs-csi-node-x28zj                         2/2     Running   0                10m   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
[root@k8s-master deploy]#
[root@k8s-master deploy]# k get ds -A
NAMESPACE     NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                                              AGE
kube-system   calico-node    3         3         3       3            3           kubernetes.io/os=linux                                     19d
kube-system   kube-proxy     3         3         3       3            3           kubernetes.io/os=linux                                     52d
kube-system   nfs-csi-node   1         1         1       1            1           kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux   10m
[root@k8s-master deploy]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;podæ­£å¸¸å¯åŠ¨åï¼Œå…ˆæŸ¥çœ‹node-driver-registrarçš„æ—¥å¿—ï¼Œæ³¨å†Œæ­£å¸¸ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# kubectl logs -n kube-system nfs-csi-node-x28zj node-driver-registrar
I0115 07:45:31.451826       1 main.go:166] Version: v2.5.0
I0115 07:45:31.451864       1 main.go:167] Running node-driver-registrar in mode=registration
I0115 07:45:31.452324       1 main.go:191] Attempting to open a gRPC connection with: &amp;quot;/csi/csi.sock&amp;quot;
I0115 07:45:32.455714       1 main.go:198] Calling CSI driver to discover driver name
I0115 07:45:32.457464       1 main.go:208] CSI driver name: &amp;quot;nfscsi&amp;quot;
I0115 07:45:32.457493       1 node_register.go:53] Starting Registration Server at: /registration/nfscsi-reg.sock
I0115 07:45:32.457582       1 node_register.go:62] Registration Server started at: /registration/nfscsi-reg.sock
I0115 07:45:32.458992       1 node_register.go:92] Skipping HTTP server because endpoint is set to: &amp;quot;&amp;quot;
I0115 07:45:33.018081       1 main.go:102] Received GetInfo call: &amp;amp;InfoRequest{}
I0115 07:45:33.018292       1 main.go:109] &amp;quot;Kubelet registration probe created&amp;quot; path=&amp;quot;/var/lib/kubelet/plugins/csi-nfsplugin/registration&amp;quot;
I0115 07:45:33.623838       1 main.go:120] Received NotifyRegistrationStatus call: &amp;amp;RegistrationStatus{PluginRegistered:true,Error:,}
[root@k8s-master nfscsi]# ll /var/lib/kubelet/plugins/csi-nfsplugin/csi.sock
srwxr-xr-x 1 root root 0 1æœˆ  15 15:45 /var/lib/kubelet/plugins/csi-nfsplugin/csi.sock
[root@k8s-master nfscsi]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†çœ‹çœ‹è‡ªå·±ç¼–ç nfs-csiå®¹å™¨æ—¥å¿—ï¼Œæ³¨å†Œè¿‡ç¨‹åªè°ƒç”¨äº†GetPluginInfoå’ŒNodeGetInfo&lt;br /&gt;
æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# kubectl logs -n kube-system nfs-csi-node-x28zj nfs-csi
2023/01/15 07:45:31 driverName: nfscsi, version: N/A, nodeID: k8s-master
2023/01/15 07:45:31 grpc server start
2023/01/15 07:45:32 GetPluginInfo request
2023/01/15 07:45:33 NodeGetInfo request
[root@k8s-master nfscsi]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;node-driver-registrarå’ŒCSIè¿›ç¨‹çš„sockæ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# ll /var/lib/kubelet/plugins_registry/
æ€»ç”¨é‡ 0
srwx------ 1 root root 0 1æœˆ  15 15:45 nfscsi-reg.sock
[root@k8s-master nfscsi]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;nodeå¯¹è±¡çš„annotationï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# kubectl get node k8s-master  -oyaml| grep annotations -A 9
annotations:
  csi.volume.kubernetes.io/nodeid: &#39;{&amp;quot;nfscsi&amp;quot;:&amp;quot;k8s-master&amp;quot;}&#39;
  kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
  node.alpha.kubernetes.io/ttl: &amp;quot;0&amp;quot;
  projectcalico.org/IPv4Address: 172.25.140.216/20
  projectcalico.org/IPv4IPIPTunnelAddr: 10.244.235.192
  volumes.kubernetes.io/controller-managed-attach-detach: &amp;quot;true&amp;quot;
creationTimestamp: &amp;quot;2022-11-23T15:34:38Z&amp;quot;
labels:
  app: hdls-csi-controller
[root@k8s-master nfscsi]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åéªŒè¯CSINodeå¯¹è±¡ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master nfscsi]# k get csinode -o wide
NAME         DRIVERS   AGE
k8s-master   1         52d
k8s-work1    0         52d
k8s-work2    0         52d
[root@k8s-master nfscsi]# kubectl get csinode k8s-master -o yaml
apiVersion: storage.k8s.io/v1
kind: CSINode
metadata:
  annotations:
    storage.alpha.kubernetes.io/migrated-plugins: kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/cinder,kubernetes.io/gce-pd
  creationTimestamp: &amp;quot;2022-11-23T15:34:38Z&amp;quot;
  name: k8s-master
  ownerReferences:
  - apiVersion: v1
    kind: Node
    name: k8s-master
    uid: cb4c3e59-66e5-40a0-a385-aa2072719381
  resourceVersion: &amp;quot;278990&amp;quot;
  uid: cf0f93f0-495e-49f2-88b4-6f7126ca6176
spec:
  drivers:
  - name: nfscsi
    nodeID: k8s-master
    topologyKeys: null
[root@k8s-master nfscsi]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆ°è¿™é‡Œæˆ‘ä»¬æˆåŠŸå®Œæˆå¹¶éªŒè¯äº†CSIçš„æ³¨å†Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deploy]# k logs -n kube-system nfs-csi-node-vxkc8  nfs-csi
2023/01/15 08:33:22 driverName: nfscsi, version: N/A, nodeID: k8s-master
2023/01/15 08:33:22 grpc server start
2023/01/15 08:33:23 GetPluginInfo request
2023/01/15 08:33:23 NodeGetInfo request
2023/01/15 09:42:25 NodeGetCapabilities request
2023/01/15 09:42:25 NodeGetCapabilities request
2023/01/15 09:42:25 NodeGetCapabilities request
2023/01/15 09:42:25 NodeGetCapabilities request
2023/01/15 09:42:25 NodePublishVolume request
2023/01/15 09:42:25 source: 127.0.0.1:/data/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05, targetPath: /var/lib/kubelet/pods/e86fa053-7d1b-4330-a6f2-555d350b45e9/volumes/kubernetes.io~csi/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05/mount, options: []
2023/01/15 09:43:20 NodeGetCapabilities request
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å½“PODæ‰§è¡ŒCreateVolumeæ˜¯å°†è°ƒç”¨nodeServiceé‡Œçš„NodePublishVolumeæ–¹æ³•è¿›è¡Œmountæ“ä½œï¼Œå³æŠŠnfsé‡Œçš„pvc-å­ç›®å½•mountåˆ°å®¿ä¸»æœºpodç›®å½•å·ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgccab5fd&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²provisioner&#34;&gt;éƒ¨ç½²provisioner&lt;/h2&gt;

&lt;p&gt;Dynamic ProvisioningåŸç†ï¼šæ‰€è°“çš„Dynamic Provisioningï¼Œå…¶å®å°±æ˜¯åˆ›å»ºpvcåä¼šè‡ªåŠ¨åˆ›å»ºå·å’Œpvï¼Œå¹¶æŠŠpvå’Œpvcç»‘å®š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/csi/provisioner-follow.jpg&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;éƒ¨ç½²è¿è¡Œ:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deploy]# kubectl apply -f provisioner.yaml
storageclass.storage.k8s.io/nfscsi created
csidriver.storage.k8s.io/nfscsi created
serviceaccount/nfs-csi-provisioner created
clusterrole.rbac.authorization.k8s.io/nfs-csi-provisioner created
clusterrolebinding.rbac.authorization.k8s.io/nfs-csi-provisioner created
deployment.apps/nfs-csi-provisioner created
[root@k8s-master deploy]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è§‚å¯Ÿå¯¹åº”çš„provisioneræ˜¯å¦èµ·æ¥ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deploy]# k get pod -A -o wide | grep nfs
kube-system   nfs-csi-node-vxkc8                         2/2     Running   0               10m     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   nfs-csi-provisioner-6f7db46646-77lqv       2/2     Running   0               2m20s   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
[root@k8s-master deploy]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgbd2779f&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;åˆ›å»ºpvc&#34;&gt;åˆ›å»ºPVC&lt;/h3&gt;

&lt;p&gt;å‡†å¤‡ä¸€ä¸ªå¦‚ä¸‹çš„pvc yamlï¼Œapplyè¯¥yamlï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# pwd
/root/nfscsi/test
[root@k8s-master test]# cat pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfscsi
  resources:
    requests:
      storage: 1Gi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹æ˜¯å¦ä¼šè‡ªåŠ¨åˆ›å»ºå·ã€pvï¼Œå¹¶å’Œpvcç»‘å®šï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# kubectl apply -f pvc.yaml
persistentvolumeclaim/test-pvc created
[root@k8s-master test]# k get pvc
NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
test-pvc   Bound    pvc-910384b5-b5eb-4196-b6d3-876f9679ed05   1Gi        RWO            nfscsi         20s
[root@k8s-master test]# k get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM              STORAGECLASS   REASON   AGE
pvc-910384b5-b5eb-4196-b6d3-876f9679ed05   1Gi        RWO            Delete           Bound      default/test-pvc   nfscsi                  35s
[root@k8s-master test]# ll /mnt/nfs-data/
æ€»ç”¨é‡ 16
drwxr-xr-x 2 root root 4096 1æœˆ  15 17:06 pvc-910384b5-b5eb-4196-b6d3-876f9679ed05
[root@k8s-master test]# ll /data/
æ€»ç”¨é‡ 16
drwxr-xr-x 2 root root 4096 1æœˆ   8 22:22 pvc-7115a52d-ba4f-4571-adbc-25e71941ca55
[root@k8s-master test]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹provisioner podæ—¥å¿—ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# k logs -n kube-system  nfs-csi-provisioner-6f7db46646-77lqv nfs-csi
2023/01/15 08:41:03 driverName: nfscsi, version: N/A, nodeID: k8s-master
2023/01/15 08:41:03 grpc server start
2023/01/15 08:41:04 Probe request
2023/01/15 08:41:04 GetPluginInfo request
2023/01/15 08:41:04 GetPluginCapabilities request
2023/01/15 08:41:04 ControllerGetCapabilities request
...
2023/01/15 09:06:26 CreateVolume request
2023/01/15 09:06:26 req name:  pvc-910384b5-b5eb-4196-b6d3-876f9679ed05
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºåˆ›å»ºpvcæ—¶è‡ªåŠ¨ç»‘å®špvæˆåŠŸã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org252c6f3&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;åˆ é™¤pvc&#34;&gt;åˆ é™¤PVC&lt;/h3&gt;

&lt;p&gt;åŒç†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org20891ab&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;orgaaf51bd&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éªŒè¯podä½¿ç”¨csi&#34;&gt;éªŒè¯PODä½¿ç”¨CSI&lt;/h2&gt;

&lt;p&gt;å…ˆå‡†å¤‡PODçš„yaml&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# cat pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-nginx-sci-pod
spec:
  nodeName: k8s-master  # è¿è¡Œåœ¨å®‰è£…äº†csiæ’ä»¶çš„nodeä¸Š
  containers:
  - name: nginx
    image: nginx:latest
    imagePullPolicy: IfNotPresent
    volumeMounts:
    - name: nfs-pvc
      mountPath: /var/log/nginx
  volumes:
  - name: nfs-pvc
    persistentVolumeClaim:
      claimName: test-pvc
   [root@k8s-master test]#  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# kubectl apply -f pod.yaml
pod/test-nginx-sci-pod created
[root@k8s-master test]# kubectl get pod -A | grep test-nginx
default       test-nginx-sci-pod                         1/1     Running   0                18s
[root@k8s-master test]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹nginxæ—¥å¿—&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master test]# ll /mnt/nfs-data/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05/
æ€»ç”¨é‡ 4
-rw-r--r-- 1 root root    0 1æœˆ  15 17:48 access.log
-rw-r--r-- 1 root root 1641 1æœˆ  15 17:52 error.log
[root@k8s-master test]#
[root@k8s-master test]# tail /mnt/nfs-data/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05/access.log
[root@k8s-master test]# tail /mnt/nfs-data/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05/error.log
2023/01/15 09:49:20 [notice] 1#1: worker process 33 exited with code 0
2023/01/15 09:49:20 [notice] 1#1: exit
2023/01/15 09:51:39 [notice] 1#1: using the &amp;quot;epoll&amp;quot; event method
2023/01/15 09:51:39 [notice] 1#1: nginx/1.21.5
2023/01/15 09:51:39 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6)
2023/01/15 09:51:39 [notice] 1#1: OS: Linux 3.10.0-957.21.3.el7.x86_64
2023/01/15 09:51:39 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 65536:65536
2023/01/15 09:51:39 [notice] 1#1: start worker processes
2023/01/15 09:51:39 [notice] 1#1: start worker process 32
2023/01/15 09:51:39 [notice] 1#1: start worker process 33
[root@k8s-master test]#
[root@k8s-master test]# ll /data/pvc-910384b5-b5eb-4196-b6d3-876f9679ed05/
æ€»ç”¨é‡ 4
-rw-r--r-- 1 root root    0 1æœˆ  15 17:48 access.log
-rw-r--r-- 1 root root 1641 1æœˆ  15 17:52 error.log
[root@k8s-master test]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºå®¿ä¸»æœºå’ŒnfsæœåŠ¡å™¨ä¸Šè¯¥pvcä¸‹å·²ç»æœ‰nginxæ—¥å¿—ç”Ÿæˆè¾¾åˆ°äº†ç›®çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga9b7cb5&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;cscåŠŸèƒ½æµ‹è¯•å‘½ä»¤&#34;&gt;cscåŠŸèƒ½æµ‹è¯•å‘½ä»¤&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å®‰è£…&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;go install -v  github.com/rexray/gocsi/csc@latest
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨go envæŸ¥çœ‹GOPATH, go install çš„ç¨‹åºä¸€èˆ¬å°±æ”¾åœ¨ç¬¬ä¸€ä¸ªè·¯å¾„ä¸‹çš„bin&lt;/p&gt;

&lt;p&gt;æŠŠå®ƒæ‹·è´åˆ°ç›®æ ‡æœºä¸Šå¹¶åŠ å¯æ‰§è¡Œæƒé™ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å‘½ä»¤&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master csi-hdls]# ./csc
NAME
    csc -- a command line container storage interface (CSI) client

SYNOPSIS
    csc [flags] CMD

AVAILABLE COMMANDS
    controller
    identity
    node

Use &amp;quot;csc -h,--help&amp;quot; for more information
[root@k8s-master csi-hdls]# ./csc controller help
NAME
    controller -- the csi controller service rpcs

SYNOPSIS
    csc controller [flags] CMD

AVAILABLE COMMANDS
    create-snapshot
    create-volume
    delete-snapshot
    delete-volume
    expand-volume
    get-capabilities
    get-capacity
    list-snapshots
    list-volumes
    publish
    unpublish
    validate-volume-capabilities

Use &amp;quot;csc controller -h,--help&amp;quot; for more information
[root@k8s-master csi-hdls]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;emptyDirçš„ä½ç½®åº”è¯¥ä½äºè¿è¡Œpodçš„ç»™å®šèŠ‚ç‚¹ä¸Šçš„/var/lib/kubelet/pods/{podid}/volumes/kubernetes.io~empty-dir/ä¸­&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;orgd2a986a&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://zhuanlan.zhihu.com/p/583032625&#34;&gt;å¦‚ä½•å®ç°ä¸€ä¸ª Kubernetes CSI Driver&lt;/a&gt;&lt;br /&gt;
ã€02ã€‘&lt;a href=&#34;https://zhuanlan.zhihu.com/p/539307741&#34;&gt;Kubernetes CSI é©±åŠ¨å¼€å‘æŒ‡å—&lt;/a&gt;&lt;br /&gt;
ã€03ã€‘&lt;a href=&#34;https://www.cnblogs.com/cxt618/p/15487359.html&#34;&gt;gRPCè¯¦ç»†å…¥é—¨ä»‹ç»&lt;/a&gt;&lt;br /&gt;
ã€04ã€‘&lt;a href=&#34;https://jishuin.proginn.com/p/763bfbd3890f&#34;&gt;å¦‚ä½•ç¼–å†™ä¸€ä¸ª CSI æ’ä»¶&lt;/a&gt;&lt;br /&gt;
ã€05ã€‘&lt;a href=&#34;http://www.noobyard.com/article/p-qgxfxmfi-nv.html&#34;&gt;Kubernetes K8Sä¹‹å›ºå®šèŠ‚ç‚¹nodeNameå’ŒnodeSelectorè°ƒåº¦è¯¦è§£&lt;/a&gt;&lt;br /&gt;
ã€06ã€‘&lt;a href=&#34;https://www.modb.pro/db/523598&#34;&gt;kubernetes CSIï¼ˆä¸‹ï¼‰&lt;/a&gt;&lt;br /&gt;
ã€07ã€‘&lt;a href=&#34;https://www.codeleading.com/article/35162638950/&#34;&gt;é˜¿é‡Œäº‘æœåŠ¡å™¨ CentOS7 ä¸‹å®‰è£…å’Œé…ç½® NFS&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(04): åŸºäºkubebuilderç¼–å†™operator</title>
            <link>http://mospany.github.io/2022/12/14/operator-on-kubebuilder/</link>
            <pubDate>Wed, 14 Dec 2022 18:24:22 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2022/12/14/operator-on-kubebuilder/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;orgcfa7382&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ä»‹ç»&#34;&gt;ä»‹ç»&lt;/h1&gt;

&lt;p&gt;Kubebuilderæ˜¯ä¸€ä¸ªç”±controller-runtimeæ”¯æŒçš„å‡ºè‰²SDKï¼Œå®ƒå¯ä»¥å¸®åŠ©æ‚¨è½»æ¾å¿«é€Ÿåœ°åœ¨ Go ä¸­ç¼–å†™Kubernetes operatorï¼Œæ–¹æ³•æ˜¯å¤„ç†å¤šç§å¿™ç¢Œçš„äº‹æƒ…ï¼Œä¾‹å¦‚ä»¥ç»„ç»‡è‰¯å¥½çš„æ–¹å¼å¼•å¯¼å¤§é‡æ ·æ¿ä»£ç ï¼Œè®¾ç½®æœ‰ç”¨çš„ Makefile makeï¼Œç›®æ ‡æ˜¯æ„å»ºã€è¿è¡Œå’Œéƒ¨ç½²operatorã€æ„å»º CRDã€è®¾ç½®ç›¸å…³çš„ Dockefileã€RBACã€æ¶‰åŠéƒ¨ç½²operatorçš„å¤šä¸ª YAML ç­‰ç­‰ã€‚&lt;br /&gt;
Kubebuilder æ˜¯ä¸€ä¸ªä½¿ç”¨ CRDs æ„å»º K8s API çš„ SDKï¼Œä¸»è¦æ˜¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æä¾›è„šæ‰‹æ¶å·¥å…·åˆå§‹åŒ– CRDs å·¥ç¨‹ï¼Œè‡ªåŠ¨ç”Ÿæˆ boilerplate ä»£ç å’Œé…ç½®ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›ä»£ç åº“å°è£…åº•å±‚çš„ K8s go-clientï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ–¹ä¾¿ç”¨æˆ·ä»é›¶å¼€å§‹å¼€å‘ CRDsï¼ŒControllers å’Œ Admission Webhooks æ¥æ‰©å±• K8sã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†ç¼–å†™è‡ªå®šä¹‰çš„operatroï¼Œéœ€è¦è¿›è¡Œå¦‚ä¸‹:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å®‰è£…kubebuilder&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨kubebuilderè¿›è¡Œé¡¹ç›®åˆ›å»º&lt;/li&gt;
&lt;li&gt;ç¼–å†™operatorä»£ç &lt;/li&gt;
&lt;li&gt;ç¼–è¯‘æ‰“åŒ…é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a id=&#34;org0fa6862&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;åŸç†&#34;&gt;åŸç†&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operatorr/kubebuilder-arch.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org78ac50d&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åŸºç¡€æ¦‚å¿µ&#34;&gt;åŸºç¡€æ¦‚å¿µ&lt;/h2&gt;

&lt;p&gt;&lt;a id=&#34;org52cd124&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;gvks-gvrs&#34;&gt;GVKs&amp;amp;GVRs&lt;/h3&gt;

&lt;p&gt;GVK = GroupVersionKindï¼ŒGVR = GroupVersionResourceã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;API Group &amp;amp; Versionsï¼ˆGVï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;API Group æ˜¯ç›¸å…³ API åŠŸèƒ½çš„é›†åˆï¼Œæ¯ä¸ª Group æ‹¥æœ‰ä¸€æˆ–å¤šä¸ª Versionsï¼Œç”¨äºæ¥å£çš„æ¼”è¿›ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Kinds &amp;amp; Resourcesï¼ˆGVRï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ¯ä¸ª GV éƒ½åŒ…å«å¤šä¸ª API ç±»å‹ï¼Œç§°ä¸º Kindsï¼Œåœ¨ä¸åŒçš„ Versions ä¹‹é—´åŒä¸€ä¸ª Kind å®šä¹‰å¯èƒ½ä¸åŒï¼Œ Resource æ˜¯ Kind çš„å¯¹è±¡æ ‡è¯†ï¼ˆresource typeï¼‰ï¼Œä¸€èˆ¬æ¥è¯´ Kinds å’Œ Resources æ˜¯ 1:1 çš„ï¼Œæ¯”å¦‚ pods Resource å¯¹åº” Pod Kindï¼Œä½†æ˜¯æœ‰æ—¶å€™ç›¸åŒçš„ Kind å¯èƒ½å¯¹åº”å¤šä¸ª Resourcesï¼Œæ¯”å¦‚ Scale Kind å¯èƒ½å¯¹åº”å¾ˆå¤š Resourcesï¼šdeployments/scaleï¼Œreplicasets/scaleï¼Œå¯¹äº CRD æ¥è¯´ï¼Œåªä¼šæ˜¯ 1:1 çš„å…³ç³»ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸€ä¸ª GVK éƒ½å…³è”ç€ä¸€ä¸ª package ä¸­ç»™å®šçš„ root Go typeï¼Œæ¯”å¦‚ apps/v1/Deployment å°±å…³è”ç€ K8s æºç é‡Œé¢ k8s.io/api/apps/v1 package ä¸­çš„ Deployment structï¼Œæˆ‘ä»¬æäº¤çš„å„ç±»èµ„æºå®šä¹‰ YAML æ–‡ä»¶éƒ½éœ€è¦å†™ï¼š&lt;/p&gt;

&lt;p&gt;apiVersionï¼šè¿™ä¸ªå°±æ˜¯ GV ã€‚kindï¼šè¿™ä¸ªå°±æ˜¯ Kã€‚&lt;/p&gt;

&lt;p&gt;æ ¹æ® GVK K8s å°±èƒ½æ‰¾åˆ°ä½ åˆ°åº•è¦åˆ›å»ºä»€ä¹ˆç±»å‹çš„èµ„æºï¼Œæ ¹æ®ä½ å®šä¹‰çš„ Spec åˆ›å»ºå¥½èµ„æºä¹‹åå°±æˆä¸ºäº† Resourceï¼Œä¹Ÿå°±æ˜¯ GVRã€‚GVK/GVR å°±æ˜¯ K8s èµ„æºçš„åæ ‡ï¼Œæ˜¯æˆ‘ä»¬åˆ›å»º/åˆ é™¤/ä¿®æ”¹/è¯»å–èµ„æºçš„åŸºç¡€ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org691e4a3&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;scheme&#34;&gt;Scheme&lt;/h3&gt;

&lt;p&gt;æ¯ä¸€ç»„ Controllers éƒ½éœ€è¦ä¸€ä¸ª Schemeï¼Œæä¾›äº† Kinds ä¸å¯¹åº” Go types çš„æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´ç»™å®š Go type å°±çŸ¥é“ä»–çš„ GVKï¼Œç»™å®š GVK å°±çŸ¥é“ä»–çš„ Go typeï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç»™å®šä¸€ä¸ª Scheme: &amp;ldquo;tutotial.kubebuilder.io/api/v1&amp;rdquo;.CronJob{} è¿™ä¸ª Go type æ˜ å°„åˆ° batch.tutotial.kubebuilder.io/v1 çš„ CronJob GVKï¼Œé‚£ä¹ˆä» Api Server è·å–åˆ°ä¸‹é¢çš„ JSON:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
    &amp;quot;kind&amp;quot;: &amp;quot;CronJob&amp;quot;,
    &amp;quot;apiVersion&amp;quot;: &amp;quot;batch.tutorial.kubebuilder.io/v1&amp;quot;,
    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°±èƒ½æ„é€ å‡ºå¯¹åº”çš„ Go typeäº†ï¼Œé€šè¿‡è¿™ä¸ª Go type ä¹Ÿèƒ½æ­£ç¡®åœ°è·å– GVR çš„ä¸€äº›ä¿¡æ¯ï¼Œæ§åˆ¶å™¨å¯ä»¥é€šè¿‡è¯¥ Go type è·å–åˆ°æœŸæœ›çŠ¶æ€ä»¥åŠå…¶ä»–è¾…åŠ©ä¿¡æ¯è¿›è¡Œè°ƒè°é€»è¾‘ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgc45a76f&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;manager&#34;&gt;Manager&lt;/h3&gt;

&lt;p&gt;Kubebuilder çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…·æœ‰ 3 ä¸ªèŒè´£ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è´Ÿè´£è¿è¡Œæ‰€æœ‰çš„ Controllersï¼›&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–å…±äº« cachesï¼ŒåŒ…å« listAndWatch åŠŸèƒ½ï¼›&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ– clients ç”¨äºä¸ Api Server é€šä¿¡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;org50d3209&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;cache&#34;&gt;Cache&lt;/h3&gt;

&lt;p&gt;Kubebuilder çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£åœ¨ Controller è¿›ç¨‹é‡Œé¢æ ¹æ® Scheme åŒæ­¥ Api Server ä¸­æ‰€æœ‰è¯¥ Controller å…³å¿ƒ GVKs çš„ GVRsï¼Œå…¶æ ¸å¿ƒæ˜¯ GVK -&amp;gt; Informer çš„æ˜ å°„ï¼ŒInformer ä¼šè´Ÿè´£ç›‘å¬å¯¹åº” GVK çš„ GVRs çš„åˆ›å»º/åˆ é™¤/æ›´æ–°æ“ä½œï¼Œä»¥è§¦å‘ Controller çš„ Reconcile é€»è¾‘ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org7fb1547&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;controller&#34;&gt;Controller&lt;/h3&gt;

&lt;p&gt;Kubebuidler ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è„šæ‰‹æ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° Reconcile æ–¹æ³•å³å¯ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org528499e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;client&#34;&gt;Client&lt;/h3&gt;

&lt;p&gt;åœ¨å®ç° Controller çš„æ—¶å€™ä¸å¯é¿å…åœ°éœ€è¦å¯¹æŸäº›èµ„æºç±»å‹è¿›è¡Œåˆ›å»º/åˆ é™¤/æ›´æ–°ï¼Œå°±æ˜¯é€šè¿‡è¯¥ Clients å®ç°çš„ï¼Œå…¶ä¸­æŸ¥è¯¢åŠŸèƒ½å®é™…æŸ¥è¯¢æ˜¯æœ¬åœ°çš„ Cacheï¼Œå†™æ“ä½œç›´æ¥è®¿é—® Api Serverã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org16de8d6&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;index&#34;&gt;Index&lt;/h3&gt;

&lt;p&gt;ç”±äº Controller ç»å¸¸è¦å¯¹ Cache è¿›è¡ŒæŸ¥è¯¢ï¼ŒKubebuilder æä¾› Index utility ç»™ Cache åŠ ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org607691c&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;finalizer&#34;&gt;Finalizer&lt;/h3&gt;

&lt;p&gt;åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœèµ„æºè¢«åˆ é™¤ä¹‹åï¼Œæˆ‘ä»¬è™½ç„¶èƒ½å¤Ÿè¢«è§¦å‘åˆ é™¤äº‹ä»¶ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ä» Cache é‡Œé¢æ— æ³•è¯»å–ä»»ä½•è¢«åˆ é™¤å¯¹è±¡çš„ä¿¡æ¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¯¼è‡´å¾ˆå¤šåƒåœ¾æ¸…ç†å·¥ä½œå› ä¸ºä¿¡æ¯ä¸è¶³æ— æ³•è¿›è¡Œï¼ŒK8s çš„ Finalizer å­—æ®µç”¨äºå¤„ç†è¿™ç§æƒ…å†µã€‚åœ¨ K8s ä¸­ï¼Œåªè¦å¯¹è±¡ ObjectMeta é‡Œé¢çš„ Finalizers ä¸ä¸ºç©ºï¼Œå¯¹è¯¥å¯¹è±¡çš„ delete æ“ä½œå°±ä¼šè½¬å˜ä¸º update æ“ä½œï¼Œå…·ä½“è¯´å°±æ˜¯ update deletionTimestamp å­—æ®µï¼Œå…¶æ„ä¹‰å°±æ˜¯å‘Šè¯‰ K8s çš„ GCâ€œåœ¨deletionTimestamp è¿™ä¸ªæ—¶åˆ»ä¹‹åï¼Œåªè¦ Finalizers ä¸ºç©ºï¼Œå°±ç«‹é©¬åˆ é™¤æ‰è¯¥å¯¹è±¡â€ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ä¸€èˆ¬çš„ä½¿ç”¨å§¿åŠ¿å°±æ˜¯åœ¨åˆ›å»ºå¯¹è±¡æ—¶æŠŠ Finalizers è®¾ç½®å¥½ï¼ˆä»»æ„ stringï¼‰ï¼Œç„¶åå¤„ç† DeletionTimestamp ä¸ä¸ºç©ºçš„ update æ“ä½œï¼ˆå®é™…æ˜¯ deleteï¼‰ï¼Œæ ¹æ® Finalizers çš„å€¼æ‰§è¡Œå®Œæ‰€æœ‰çš„ pre-delete hookï¼ˆæ­¤æ—¶å¯ä»¥åœ¨ Cache é‡Œé¢è¯»å–åˆ°è¢«åˆ é™¤å¯¹è±¡çš„ä»»ä½•ä¿¡æ¯ï¼‰ä¹‹åå°† Finalizers ç½®ä¸ºç©ºå³å¯ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org0c0efe9&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ownerreference&#34;&gt;OwnerReference&lt;/h3&gt;

&lt;p&gt;K8s GC åœ¨åˆ é™¤ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä»»ä½• ownerReference æ˜¯è¯¥å¯¹è±¡çš„å¯¹è±¡éƒ½ä¼šè¢«æ¸…é™¤ï¼Œä¸æ­¤åŒæ—¶ï¼ŒKubebuidler æ”¯æŒæ‰€æœ‰å¯¹è±¡çš„å˜æ›´éƒ½ä¼šè§¦å‘ Owner å¯¹è±¡ controller çš„ Reconcile æ–¹æ³•ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgb1ddf8b&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å®ç°&#34;&gt;å®ç°&lt;/h1&gt;

&lt;p&gt;1ã€æ„é€ æ–°çš„scheme,&lt;br /&gt;
2ã€è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–æˆ–é»˜è®¤metricå’Œå¥åº·æ£€æŸ¥ç«¯å£ã€‚&lt;br /&gt;
3ã€å®ä¾‹åŒ– managerï¼Œå‚æ•° config&lt;br /&gt;
   3.1ï¼‰ å‘ manager æ·»åŠ  scheme&lt;br /&gt;
   3.2ï¼‰ å‘ manager æ·»åŠ  controllerï¼Œè¯¥ controller åŒ…å«ä¸€ä¸ª reconciler ç»“æ„ä½“ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ reconciler ç»“æ„ä½“å®ç°é€»è¾‘å¤„ç†&lt;br /&gt;
4ã€å‘manageræ·»åŠ healthzå’Œreadyzæ¢æµ‹ã€‚&lt;br /&gt;
5ã€å¯åŠ¨ manager.start()&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org40fbcb7&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;é•œåƒä»“åº“&#34;&gt;é•œåƒä»“åº“&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org246c0bb&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;æ³¨å†Œä»“åº“&#34;&gt;æ³¨å†Œä»“åº“&lt;/h2&gt;

&lt;p&gt;ç™»å½•&lt;a href=&#34;https://registry.hub.docker.com/è¿›è¡Œæ³¨å†Œï¼Œå¦‚ç”¨æˆ·åä¸ºmospany&#34;&gt;https://registry.hub.docker.com/è¿›è¡Œæ³¨å†Œï¼Œå¦‚ç”¨æˆ·åä¸ºmospany&lt;/a&gt;, å¯†ç ä¸ºè‡ªå®šä¹‰ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org43ccc0d&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ä½¿ç”¨é•œåƒ&#34;&gt;ä½¿ç”¨é•œåƒ&lt;/h2&gt;

&lt;p&gt;&lt;a id=&#34;org829ca45&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ç™»å½•ä»“åº“&#34;&gt;ç™»å½•ä»“åº“&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ docker login index.docker.io
Username: mospany
Password:
Login Succeeded

æˆ–ç›´æ¥ docker loginé»˜è®¤ç™»å½•docker hubã€‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org2fc914e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¸Šä¼ é•œåƒ&#34;&gt;ä¸Šä¼ é•œåƒ&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ docker tag loggen:latest mospany/loggen:latest
$ docker push mospany/loggen:latest
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operatorr/hub-docker.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å‚è§ï¼š&lt;a href=&#34;https://hub.docker.com/repository/docker/mospany/loggen&#34;&gt;https://hub.docker.com/repository/docker/mospany/loggen&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org3d0e3a5&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¸‹è½½é•œåƒ&#34;&gt;ä¸‹è½½é•œåƒ&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ docker pull mospany/loggen:latest
latest: Pulling from mospany/loggen
Digest: sha256:0cdeece36f8a003dd6b9c463cc73dad93479deabec08c1def033e72ec9818539
Status: Image is up to date for mospany/loggen:latest
docker.io/mospany/loggen:latest
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgc8a2f44&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;é¡¹ç›®&#34;&gt;é¡¹ç›®&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org3a9cf00&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»ºé¡¹ç›®&#34;&gt;åˆ›å»ºé¡¹ç›®&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;mkdir guestbook
cd guestbook
go mod init guestbook
kubebuilder init --domain xiaohongshu.org --owner &amp;quot;luxiu&amp;quot;
kubebuilder create api --group redis  --version v1 --kind RedisCluster
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…³é”®æˆªå›¾å¦‚ä¸‹ï¼š&lt;br /&gt;
   &lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operatorr/kubebuilder-operator.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org1ddad49&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ä¿®æ”¹æ–‡ä»¶&#34;&gt;ä¿®æ”¹æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;1ï¼‰ä¿®æ”¹Dockerfileçš„gcr.ioé•œåƒä¸ºå…¶ä»–å¯è®¿é—®é•œåƒ(å¦‚golang:1.18)&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸ºäº†é˜²æ­¢å‡ºç°â€œfailed to solve with frontend dockerfile.v0: failed to create LLB definition: failed to do request: Head &amp;ldquo;&lt;a href=&#34;https://gcr.io/v2/distroless/static/manifests/nonroot&#34;&gt;https://gcr.io/v2/distroless/static/manifests/nonroot&lt;/a&gt;&amp;ldquo;: Service Unavailableâ€é”™è¯¯ï¼Œéœ€ä¿®æ”¹Dockerfileçš„gcr.ioé•œåƒä¸ºå…¶ä»–å¯è®¿é—®é•œåƒ(å¦‚golang:1.18)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;2ï¼‰ä¿®æ”¹Dockerfileæ·»åŠ ä»£ç†&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸ºäº†é˜²æ­¢go mod downloadæ—¶ä¸è‡³äºè¶…æ—¶è¿ä¸ä¸Šï¼Œéœ€åœ¨Run go mod downloadè¡Œä¸Šé¢æ·»åŠ &lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;ENV GOPROXY=&amp;quot;https://goproxy.cn&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦åˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;3.469 go: cloud.google.com/go@v0.81.0: Get &amp;ldquo;&lt;a href=&#34;https://proxy.golang.org/cloud.google.com/go/@v/v0.81.0.mod&#34;&gt;https://proxy.golang.org/cloud.google.com/go/@v/v0.81.0.mod&lt;/a&gt;&amp;ldquo;: malformed HTTP response &amp;ldquo;\x00\x00\x12\x04&amp;#x2026;\x00\x00\x01&amp;rdquo;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;**åˆ‡è®°åˆ‡è®°**ï¼š å…ˆä¿®æ”¹å¥½å†ç¼–è¯‘ï¼Œå¦åˆ™ä¸€ç›´å‡ºç°ä¸Šé¢é”™è¯¯(å½“æ—¶æ‰¾äº†åŠå¤©)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Build the manager binary
  FROM golang:1.18 as builder
  ENV GOPROXY=&amp;quot;https://goproxy.cn&amp;quot;

  WORKDIR /workspace
  # Copy the Go Modules manifests
  COPY go.mod go.mod
  COPY go.sum go.sum
  # cache deps before building and copying source so that we don&#39;t need to re-download as much
  # and so that source changes don&#39;t invalidate our downloaded layer
  RUN go mod download

  # Copy the go source
  COPY main.go main.go
  COPY api/ api/
  COPY controllers/ controllers/

  # Build
  RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -o manager main.go

  # Use distroless as minimal base image to package the manager binary
  # Refer to https://github.com/GoogleContainerTools/distroless for more details
  #FROM gcr.io/distroless/static:nonroot
  FROM centos:latest
  WORKDIR /
  COPY --from=builder /workspace/manager .
  USER 65532:65532

  ENTRYPOINT [&amp;quot;/manager&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¿…é¡»åœ¨Dockerfileé‡Œé¢è®¾ç½®ä»£ç†â€ENV GOPROXY=&amp;rdquo;&lt;https://goproxy.cn&#34;â€œæ‰è¡Œï¼Œå¦‚ä¸‹è®¾ç½®ä¹Ÿä¸è¡Œ&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/docker-preferences.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;3ï¼‰ä¿®æ”¹Makefileä¸­çš„crdä¸­çš„é…ç½®&lt;br /&gt;
  ç»™kubectlåŠ ä¸Šæ‰€è¦è¿æ¥çš„é›†ç¾¤ï¼Œ å¦‚æœ¬æœºä¸º&amp;#x2013;context docker-desktopã€‚å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å¾—ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl config get-contexts
kubectl cluster-info
kubectl config view
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/kubectl-info.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯¹åº”çš„Makefileä¿®æ”¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;.PHONY: install
install: manifests kustomize ## Install CRDs into the K8s cluster specified in ~/.kube/config.
  $(KUSTOMIZE) build config/crd | kubectl --context docker-desktop  apply -f -

.PHONY: uninstall
uninstall: manifests kustomize ## Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.
  $(KUSTOMIZE) build config/crd | kubectl --context docker-desktop  delete --ignore-not-found=$(ignore-not-found) -f -

.PHONY: deploy
deploy: manifests kustomize ## Deploy controller to the K8s cluster specified in ~/.kube/config.
  cd config/manager &amp;amp;&amp;amp; $(KUSTOMIZE) edit set image controller=${IMG}
  $(KUSTOMIZE) build config/default | kubectl --context docker-desktop  apply -f -

.PHONY: undeploy
undeploy: ## Undeploy controller from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.
  $(KUSTOMIZE) build config/default | kubectl --context docker-desktop  delete --ignore-not-found=$(ignore-not-found) -f -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgf288f34&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ç¼–è¯‘&#34;&gt;ç¼–è¯‘&lt;/h2&gt;

&lt;p&gt;&lt;a id=&#34;org99eec51&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;make-help&#34;&gt;make help&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;make help
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-help.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org54938e4&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;make-build&#34;&gt;make build&lt;/h3&gt;

&lt;p&gt;ç¼–è¯‘å¹¶åœ¨bin/ä¸‹ç”Ÿæˆç›®æ ‡å¯æ‰§è¡Œç¨‹åºã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-build.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orge8e0f0a&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;make-install&#34;&gt;make install&lt;/h3&gt;

&lt;p&gt;å®‰è£…crdåˆ°ç›®æ ‡é›†ç¾¤ï¼Œè¿™ä¸€æ­¥å¯èƒ½å—githubç½‘ç»œå½±å“è‡ªåŠ¨ä¸‹è½½kustomizeæ…¢éœ€è¦å¤šè¯•å‡ æ¬¡æˆ–éš”å¤©å†è¯•ã€‚&lt;br /&gt;
   &lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-install.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orge3f35bb&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;make-docker-build&#34;&gt;make docker-build&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-docker-build.png&#34; alt=&#34;img&#34; /&gt;&lt;br /&gt;
å¯ä»¥åœ¨åˆšç”Ÿæˆçš„é•œåƒåˆ—è¡¨ä¸­ç”Ÿæˆé•œåƒã€‚&lt;br /&gt;
&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-docker-images.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org54b15f4&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;make-docker-push&#34;&gt;make docker-push&lt;/h3&gt;

&lt;p&gt;1ï¼‰å…ˆå¢åŠ è¦ä¸Šä¼ é•œåƒçš„tag&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ docker tag controller:latest docker.io/mospany/controller:latest
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ï¼‰make docker-push&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ make docker-push IMG=docker.io/mospany/controller:latest
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-docker-push.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æŸ¥çœ‹docker hubä¸Šä¼ æ•ˆæœ&lt;br /&gt;
&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-docker-hub.png&#34; alt=&#34;img&#34; /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a id=&#34;org5f3af46&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;è¿è¡Œ&#34;&gt;è¿è¡Œ&lt;/h2&gt;

&lt;p&gt;å…ˆåœ¨macä¸Šå®‰è£…k8sé›†ç¾¤ï¼Œè¯¦è§ï¼š&lt;a href=&#34;https://blog.51cto.com/zlyang/4838042&#34;&gt;Macç³»ç»Ÿå®‰è£…k8sé›†ç¾¤&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org861d0fa&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;æœ¬åœ°è¿è¡Œ&#34;&gt;æœ¬åœ°è¿è¡Œ&lt;/h3&gt;

&lt;p&gt;è¦æƒ³åœ¨æœ¬åœ°è¿è¡Œ controllerï¼Œåªéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°†çœ‹åˆ° controller å¯åŠ¨å’Œè¿è¡Œæ—¶è¾“å‡ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;make run
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-run.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org5dc2c10&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;éƒ¨ç½²åˆ°k8sé›†ç¾¤ä¸­è¿è¡Œ&#34;&gt;éƒ¨ç½²åˆ°k8sé›†ç¾¤ä¸­è¿è¡Œ&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;make deploy IMG=docker.io/mospany/controller:v1.0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-deploy.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹æ—¥å¿—&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl logs -n guestbook-system guestbook-controller-manager-7c67b5bd6c-gm5qs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/make-logs.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgf9f8f6e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»ºcr&#34;&gt;åˆ›å»ºCR&lt;/h2&gt;

&lt;p&gt;è¯¥åˆ›å»ºè‡ªå®šä¹‰èµ„æºå¯¹è±¡CRäº†ï¼Œå¦‚åŸç”Ÿä¸­çš„rc/deploymentç­‰å¯¹è±¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# mosp @ mospdeMacBook-Pro in ~/work/pingan/arch/mysrc/guestbook [21:14:17]
$ kubectl get RedisCluster
NAME                  AGE
rediscluster-sample   48m

# mosp @ mospdeMacBook-Pro in ~/work/pingan/arch/mysrc/guestbook [21:22:49]
$ kubectl get RedisCluster -o yaml
apiVersion: v1
items:
- apiVersion: redis.xiaohongshu.org/v1
  kind: RedisCluster
  metadata:
    annotations:
      kubectl.kubernetes.io/last-applied-configuration: |
        {&amp;quot;apiVersion&amp;quot;:&amp;quot;redis.xiaohongshu.org/v1&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;RedisCluster&amp;quot;,&amp;quot;metadata&amp;quot;:{&amp;quot;annotations&amp;quot;:{},&amp;quot;name&amp;quot;:&amp;quot;rediscluster-sample&amp;quot;,&amp;quot;namespace&amp;quot;:&amp;quot;default&amp;quot;},&amp;quot;spec&amp;quot;:null}
    creationTimestamp: &amp;quot;2022-07-29T12:34:11Z&amp;quot;
    generation: 1
    name: rediscluster-sample
    namespace: default
    resourceVersion: &amp;quot;200052&amp;quot;
    uid: 18eaf75f-9597-46af-bd88-abf7153c1377
  status: {}
kind: List
metadata:
  resourceVersion: &amp;quot;&amp;quot;
  selfLink: &amp;quot;&amp;quot;

# mosp @ mospdeMacBook-Pro in ~/work/pingan/arch/mysrc/guestbook [21:23:07]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org7b598e7&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;å¼€å‘ä¸šåŠ¡é€»è¾‘&#34;&gt;å¼€å‘ä¸šåŠ¡é€»è¾‘&lt;/h2&gt;

&lt;p&gt;ä¸‹é¢æˆ‘ä»¬å°†ä¿®æ”¹ CRD çš„æ•°æ®ç»“æ„å¹¶åœ¨ controller ä¸­å¢åŠ ä¸€äº›æ—¥å¿—è¾“å‡ºã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org869a73b&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¿®æ”¹-crd&#34;&gt;ä¿®æ”¹ CRD&lt;/h3&gt;

&lt;p&gt;æˆ‘ä»¬å°†ä¿®æ”¹api/v1/rediscluster_types.go æ–‡ä»¶çš„å†…å®¹ï¼Œåœ¨ CRD ä¸­å¢åŠ  FirstNameã€LastName å’Œ Status å­—æ®µã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// RedisClusterSpec defines the desired state of RedisCluster
type RedisClusterSpec struct {
    // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster

    // Important: Run &amp;quot;make&amp;quot; to regenerate code after modifying this file

    // Foo is an example field of RedisCluster. Edit rediscluster_types.go to remove/update
    FirstName string `json:&amp;quot;firstname&amp;quot;`
    LastName  string `json:&amp;quot;lastname&amp;quot;`
}

// RedisClusterStatus defines the observed state of RedisCluster
type RedisClusterStatus struct {
    // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster

    // Important: Run &amp;quot;make&amp;quot; to regenerate code after modifying this file
    Status string `json:&amp;quot;Status&amp;quot;`
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orga981c1e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¿®æ”¹-reconcile-å‡½æ•°&#34;&gt;ä¿®æ”¹ Reconcile å‡½æ•°&lt;/h3&gt;

&lt;p&gt;Reconcile å‡½æ•°æ˜¯ Operator çš„æ ¸å¿ƒé€»è¾‘ï¼ŒOperator çš„ä¸šåŠ¡é€»è¾‘éƒ½ä½äº controllers/rediscluster_controller.go æ–‡ä»¶çš„ Reconcile å‡½æ•°ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func (r *RedisClusterReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
    _ = log.FromContext(ctx)

    // TODO(user): your logic here

    // è·å–å½“å‰çš„ CRï¼Œå¹¶æ‰“å°
    logger := log.FromContext(ctx)
    obj := &amp;amp;redisv1.RedisCluster{}
    if err := r.Get(ctx, req.NamespacedName, obj); err != nil {
        logger.Error(err, &amp;quot;Unable to fetch object&amp;quot;)
        return ctrl.Result{}, nil
    } else {
        logger.Info(&amp;quot;Greeting from Kubebuilder to&amp;quot;, obj.Spec.FirstName, obj.Spec.LastName)
    }

    // åˆå§‹åŒ– CR çš„ Status ä¸º Running
    obj.Status.Status = &amp;quot;Running&amp;quot;
    if err := r.Status().Update(ctx, obj); err != nil {
        logger.Error(err, &amp;quot;unable to update status&amp;quot;)
    }

    return ctrl.Result{}, nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org1cfb9cb&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;è¿è¡Œæµ‹è¯•&#34;&gt;è¿è¡Œæµ‹è¯•&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å®‰è£…CRDï¼ˆåŒä¸Šï¼‰&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;éƒ¨ç½²controllerï¼ˆåŒä¸Šï¼‰&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åˆ›å»ºCR&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¿®æ”¹ config/samples/redis_v1_rediscluster.yaml æ–‡ä»¶ä¸­çš„é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apiVersion: redis.xiaohongshu.org/v1
kind: RedisCluster
metadata:
  name: rediscluster-sample
spec:
  # TODO(user): Add fields here
  firstname: Jimmy
  lastname: Song
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œåˆ›å»ºCRï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ k8sdev apply -f  config/samples/redis_v1_rediscluster.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹controlleré‡Œçš„è¿è¡Œæ—¥å¿—ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/operator/controller-logs.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org1683514&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘&lt;a href=&#34;https://blog.csdn.net/weixin_43568070/article/details/89892620&#34;&gt;ä½¿ç”¨shellå‘½ä»¤è¡Œç™»é™†Docker Hubå‡ºç°çš„404Not foundçš„é—®é¢˜&lt;/a&gt;&lt;br /&gt;
ã€02ã€‘&lt;a href=&#34;https://blog.csdn.net/HaHa_Sir/article/details/119412754&#34;&gt;Dockeré•œåƒæ¨é€Dockerhub&lt;/a&gt;&lt;br /&gt;
ã€03ã€‘&lt;a href=&#34;https://www.cnblogs.com/mysql-dba/p/15982341.html&#34;&gt;ä½¿ç”¨ kubebuilder åˆ›å»ºå¹¶éƒ¨ç½² k8s-operator&lt;/a&gt;&lt;br /&gt;
ã€04ã€‘&lt;a href=&#34;http://tnblog.net/hb/article/details/7516&#34;&gt;Kustomizeçš„åŸºæœ¬ä½¿ç”¨&lt;/a&gt;&lt;br /&gt;
ã€05ã€‘&lt;a href=&#34;https://www.cnblogs.com/lizhewei/p/13214785.html&#34;&gt;ã€kubebuilder2.0ã€‘å®‰è£…ã€æºç åˆ†æ &lt;/a&gt;&lt;br /&gt;
ã€06ã€‘&lt;a href=&#34;https://www.cnblogs.com/alisystemsoftware/p/11580202.html&#34;&gt;æ·±å…¥è§£æ Kubebuilderï¼šè®©ç¼–å†™ CRD å˜å¾—æ›´ç®€å•&lt;/a&gt;&lt;br /&gt;
ã€07ã€‘&lt;a href=&#34;https://os.51cto.com/article/661378.html&#34;&gt;ä¸€ç¯‡å¸¦ç»™ä½ KubeBuilder ç®€æ˜æ•™ç¨‹&lt;/a&gt;&lt;br /&gt;
ã€08ã€‘&lt;a href=&#34;https://blog.csdn.net/chenxy02/article/details/125554680&#34;&gt;æ·±å…¥è§£æKubebuilder&lt;/a&gt;&lt;br /&gt;
ã€09ã€‘&lt;a href=&#34;https://blog.csdn.net/qq_45874107/article/details/119839187&#34;&gt;ä»€ä¹ˆæ˜¯RBAC&lt;/a&gt;&lt;br /&gt;
ã€10ã€‘&lt;a href=&#34;https://blog.ihypo.net/15763910382218.html&#34;&gt;Kubernetes Controller Manager å·¥ä½œåŸç†&lt;/a&gt;&lt;br /&gt;
ã€11ã€‘&lt;a href=&#34;https://jishuin.proginn.com/p/763bfbd3012b&#34;&gt;controller-runtime ä¹‹ manager å®ç°&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(03): éšæœºè°ƒåº¦å™¨</title>
            <link>http://mospany.github.io/2022/12/11/k8s-random-scheduler/</link>
            <pubDate>Sun, 11 Dec 2022 11:51:52 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2022/12/11/k8s-random-scheduler/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;org3ccc143&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org6748da5&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;podåˆ›å»ºè¿‡ç¨‹&#34;&gt;PODåˆ›å»ºè¿‡ç¨‹&lt;/h2&gt;

&lt;p&gt;1ã€ ç”±kubectlè§£æåˆ›å»ºpodçš„yamlï¼Œå‘é€åˆ›å»ºpodè¯·æ±‚åˆ°APIServerã€‚&lt;br /&gt;
2ã€ APIServeré¦–å…ˆåšæƒé™è®¤è¯ï¼Œç„¶åæ£€æŸ¥ä¿¡æ¯å¹¶æŠŠæ•°æ®å­˜å‚¨åˆ°ETCDé‡Œï¼Œåˆ›å»ºdeploymentèµ„æºåˆå§‹åŒ–ã€‚&lt;br /&gt;
3ã€ kube-controlleré€šè¿‡list-watchæœºåˆ¶ï¼Œæ£€æŸ¥å‘ç°æ–°çš„deploymentï¼Œå°†èµ„æºåŠ å…¥åˆ°å†…éƒ¨å·¥ä½œé˜Ÿåˆ—ï¼Œæ£€æŸ¥åˆ°èµ„æºæ²¡æœ‰å…³è”podå’Œreplicaset,ç„¶ååˆ›å»ºrsèµ„æºï¼Œrs controllerç›‘å¬åˆ°rsåˆ›å»ºäº‹ä»¶åå†åˆ›å»ºpodèµ„æºã€‚&lt;br /&gt;
4ã€ scheduler ç›‘å¬åˆ°podåˆ›å»ºäº‹ä»¶ï¼Œæ‰§è¡Œè°ƒåº¦ç®—æ³•ï¼Œå°†podç»‘å®šåˆ°åˆé€‚èŠ‚ç‚¹ï¼Œç„¶åå‘ŠçŸ¥APIServeræ›´æ–°podçš„spec.nodeName&lt;br /&gt;
5ã€ kubelet æ¯éš”ä¸€æ®µæ—¶é—´é€šè¿‡å…¶æ‰€åœ¨èŠ‚ç‚¹çš„NodeNameå‘APIServeræ‹‰å–ç»‘å®šåˆ°å®ƒçš„podæ¸…å•ï¼Œå¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚&lt;br /&gt;
6ã€ kubeletå‘ç°æ–°çš„podå±äºè‡ªå·±ï¼Œè°ƒç”¨å®¹å™¨APIæ¥åˆ›å»ºå®¹å™¨ï¼Œå¹¶å‘APIServiceä¸ŠæŠ¥podçŠ¶æ€ã€‚&lt;br /&gt;
7ã€ Kub-proxyä¸ºæ–°åˆ›å»ºçš„podæ³¨å†ŒåŠ¨æ€DNSåˆ°CoreOSã€‚ä¸ºServiceæ·»åŠ iptables/ipvsè§„åˆ™ï¼Œç”¨äºæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;br /&gt;
8ã€ deploy controllerå¯¹æ¯”podçš„å½“å‰çŠ¶æ€å’ŒæœŸæœ›æ¥ä¿®æ­£çŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/scheduler/pod-life-cycle.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org44af008&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;è°ƒåº¦å™¨ä»‹ç»&#34;&gt;è°ƒåº¦å™¨ä»‹ç»&lt;/h2&gt;

&lt;p&gt;ä»ä¸Šè¿°æµç¨‹ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤§æ¦‚æ¸…æ¥škube-schedulerçš„ä¸»è¦å·¥ä½œï¼Œè´Ÿè´£æ•´ä¸ªk8sä¸­podé€‰æ‹©å’Œç»‘å®šnodeçš„å·¥ä½œï¼Œè¿™ä¸ªé€‰æ‹©çš„è¿‡ç¨‹å°±æ˜¯åº”ç”¨è°ƒåº¦ç­–ç•¥ï¼ŒåŒ…æ‹¬NodeAffinityã€PodAffinityã€èŠ‚ç‚¹èµ„æºç­›é€‰ã€è°ƒåº¦ä¼˜å…ˆçº§ã€å…¬å¹³è°ƒåº¦ç­‰ç­‰ï¼Œè€Œç»‘å®šä¾¿å°±æ˜¯å°†podèµ„æºå®šä¹‰é‡Œçš„nodeNameè¿›è¡Œæ›´æ–°ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org39ad97e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;è®¾è®¡&#34;&gt;è®¾è®¡&lt;/h1&gt;

&lt;p&gt;kube-schedulerçš„è®¾è®¡æœ‰ä¸¤ä¸ªå†å²é˜¶æ®µç‰ˆæœ¬ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åŸºäºè°“è¯ï¼ˆpredicateï¼‰å’Œä¼˜å…ˆçº§ï¼ˆpriorityï¼‰çš„ç­›é€‰ã€‚&lt;/li&gt;
&lt;li&gt;åŸºäºè°ƒåº¦æ¡†æ¶çš„è°ƒåº¦å™¨ï¼Œæ–°ç‰ˆæœ¬å·²ç»æŠŠæ‰€æœ‰çš„æ—§çš„è®¾è®¡éƒ½æ”¹é€ æˆæ‰©å±•ç‚¹æ’ä»¶å½¢å¼(1.19+)ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ‰€è°“çš„è°“è¯å’Œä¼˜å…ˆçº§éƒ½æ˜¯å¯¹è°ƒåº¦ç®—æ³•çš„åˆ†ç±»ï¼Œåœ¨scheduleré‡Œï¼Œè°“è¯è°ƒåº¦ç®—æ³•æ˜¯æ¥é€‰æ‹©å‡ºä¸€ç»„èƒ½å¤Ÿç»‘å®špodçš„nodeï¼Œè€Œä¼˜å…ˆçº§ç®—æ³•åˆ™æ˜¯åœ¨è¿™ç¾¤nodeä¸­è¿›è¡Œæ‰“åˆ†ï¼Œå¾—å‡ºä¸€ä¸ªæœ€é«˜åˆ†çš„nodeã€‚&lt;/p&gt;

&lt;p&gt;è€Œè°ƒåº¦æ¡†æ¶çš„è®¾è®¡ç›¸æ¯”ä¹‹å‰åˆ™æ›´å¤æ‚ä¸€ç‚¹ï¼Œä½†ç¡®æ›´åŠ çµæ´»å’Œä¾¿äºæ‰©å±•ï¼Œå…³äºè°ƒåº¦æ¡†æ¶çš„è®¾è®¡ç»†èŠ‚å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£â€”â€”624-scheduling-frameworkï¼Œå½“ç„¶æˆ‘ä¹Ÿæœ‰ä¸€éæ–‡ç« å¯¹å…¶åšäº†ç¿»è¯‘è¿˜åŠ äº†ä¸€äº›ä¾¿äºç†è§£çš„è¡¥å……â€”â€”KEP: 624-scheduling-frameworkã€‚æ€»ç»“æ¥è¯´è°ƒåº¦æ¡†æ¶çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ä»¥å‰webhooksæ‰©å±•å™¨çš„å±€é™æ€§ï¼Œä¸€ä¸ªæ˜¯æ‰©å±•ç‚¹åªæœ‰ï¼šç­›é€‰ã€æ‰“åˆ†ã€æŠ¢å ã€ç»‘å®šï¼Œè€Œè°ƒåº¦æ¡†æ¶åˆ™åœ¨è¿™ä¹‹ä¸Šåˆç»†åˆ†äº†11ä¸ªæ‰©å±•ç‚¹ï¼›å¦ä¸€ä¸ªåˆ™æ˜¯é€šè¿‡httpè°ƒç”¨æ‰©å±•è¿›ç¨‹çš„æ–¹å¼å…¶å®æ•ˆç‡ä¸é«˜ï¼Œè°ƒåº¦æ¡†æ¶çš„è®¾è®¡ç”¨çš„æ˜¯é™æ€ç¼–è¯‘çš„æ–¹å¼å°†æ‰©å±•çš„ç¨‹åºä»£ç å’Œscheduleræºç ä¸€èµ·ç¼–è¯‘æˆæ–°çš„schedulerï¼Œç„¶åé€šè¿‡scheduleré…ç½®æ–‡ä»¶å¯ç”¨éœ€è¦çš„æ’ä»¶ï¼Œåœ¨è¿›ç¨‹å†…å°±èƒ½é€šè¿‡å‡½æ•°è°ƒç”¨çš„æ–¹å¼æ‰§è¡Œæ’ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/scheduler/scheduler-startup.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸Šé¢æ˜¯ä¸€ä¸ªç®€ç•¥ç‰ˆçš„è°ƒåº¦å™¨å¤„ç†podæµç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;é¦–å…ˆschedulerä¼šå¯åŠ¨ä¸€ä¸ªclient-goçš„Informeræ¥ç›‘å¬Podäº‹ä»¶ï¼ˆä¸åªPodå…¶å®è¿˜æœ‰Nodeç­‰èµ„æºå˜æ›´äº‹ä»¶ï¼‰ï¼Œè¿™æ—¶å€™æ³¨å†Œçš„Informerå›è°ƒäº‹ä»¶ä¼šåŒºåˆ†Podæ˜¯å¦å·²ç»è¢«è°ƒåº¦ï¼ˆspec.nodeNameï¼‰ï¼Œå·²ç»è°ƒåº¦è¿‡çš„Podåˆ™åªæ˜¯æ›´æ–°è°ƒåº¦å™¨ç¼“å­˜ï¼Œè€Œæœªè¢«è°ƒåº¦çš„Podä¼šåŠ å…¥åˆ°è°ƒåº¦é˜Ÿåˆ—ï¼Œç„¶åç»è¿‡è°ƒåº¦æ¡†æ¶æ‰§è¡Œæ³¨å†Œçš„æ’ä»¶ï¼Œåœ¨ç»‘å®šå‘¨æœŸå‰ä¼šè¿›è¡ŒPodçš„å‡å®šåŠ¨ä½œï¼Œä»è€Œæ›´æ–°è°ƒåº¦å™¨ç¼“å­˜ä¸­è¯¥PodçŠ¶æ€ï¼Œæœ€ååœ¨ç»‘å®šå‘¨æœŸæ‰§è¡Œå®Œå‘ApiServerå‘èµ·BindAPIï¼Œä»è€Œå®Œæˆäº†ä¸€æ¬¡è°ƒåº¦è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org8ebc078&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å®ç°&#34;&gt;å®ç°&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org98f2089&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»ºè°ƒåº¦å™¨&#34;&gt;åˆ›å»ºè°ƒåº¦å™¨&lt;/h2&gt;

&lt;p&gt;1ã€è·å–é›†ç¾¤kubeconfigé…ç½®ã€‚&lt;br /&gt;
2ã€è°ƒç”¨client-goç”Ÿæˆclientsetã€‚&lt;br /&gt;
3ã€å¡«å……è°ƒåº¦å™¨ç›¸å…³å‚æ•°, åŒ…å«è·å–nodeåˆ—è¡¨å’Œå…³æ³¨çš„PODã€‚&lt;br /&gt;
4ã€è¿”å›è°ƒåº¦å™¨&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; func NewScheduler(podQueue chan *v1.Pod, quit chan struct{}) Scheduler {
  config, err := rest.InClusterConfig()
  if err != nil {
      log.Fatal(err)
  }

  clientset, err := kubernetes.NewForConfig(config)
  if err != nil {
      log.Fatal(err)
  }

  return Scheduler{
      clientset:  clientset,
      podQueue:   podQueue,
      nodeLister: initInformers(clientset, podQueue, quit),
      predicates: []predicateFunc{
          randomPredicate,
      },
      priorities: []priorityFunc{
          randomPriority,
      },
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org7e3d0d6&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;è¿è¡Œè°ƒåº¦å™¨&#34;&gt;è¿è¡Œè°ƒåº¦å™¨&lt;/h2&gt;

&lt;p&gt;ä¸é—´æ–­çš„ä»å…³æ³¨çš„PODåˆ—è¡¨ä¸­é€‰å‡ºè¿›è¡Œè°ƒåº¦ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org9082797&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;æ‰¾åˆé€‚èŠ‚ç‚¹&#34;&gt;æ‰¾åˆé€‚èŠ‚ç‚¹&lt;/h3&gt;

&lt;p&gt;1ã€æ‰¾åˆ°å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨&lt;br /&gt;
2ã€ç»™èŠ‚ç‚¹éšæœºæ‰“100ä»¥å†…çš„åˆ†æ•°&lt;br /&gt;
3ã€é€‰æ‹©åˆ†æ•°æœ€é«˜çš„èŠ‚ç‚¹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func (s *Scheduler) findFit(pod *v1.Pod) (string, error) {
    nodes, err := s.nodeLister.List(labels.Everything())
    if err != nil {
        return &amp;quot;&amp;quot;, err
    }

    filteredNodes := s.runPredicates(nodes, pod)
    if len(filteredNodes) == 0 {
        return &amp;quot;&amp;quot;, errors.New(&amp;quot;failed to find node that fits pod&amp;quot;)
    }
    priorities := s.prioritize(filteredNodes, pod)
    return s.findBestNode(priorities), nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org0354198&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;ç»‘å®špod&#34;&gt;ç»‘å®šPOD&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;func (s *Scheduler) bindPod(ctx context.Context, p *v1.Pod, node string) error {
    opts := metav1.CreateOptions{}
    return s.clientset.CoreV1().Pods(p.Namespace).Bind(ctx, &amp;amp;v1.Binding{
        ObjectMeta: metav1.ObjectMeta{
            Name:      p.Name,
            Namespace: p.Namespace,
        },
        Target: v1.ObjectReference{
            APIVersion: &amp;quot;v1&amp;quot;,
            Kind:       &amp;quot;Node&amp;quot;,
            Name:       node,
        },
    }, opts)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgcdd0603&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;å‘é€eventäº‹ä»¶&#34;&gt;å‘é€eventäº‹ä»¶&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;func (s *Scheduler) emitEvent(ctx context.Context, p *v1.Pod, message string) error {
    timestamp := time.Now().UTC()
    opts := metav1.CreateOptions{}
    _, err := s.clientset.CoreV1().Events(p.Namespace).Create(ctx, &amp;amp;v1.Event{
        Count:          1,
        Message:        message,
        Reason:         &amp;quot;Scheduled&amp;quot;,
        LastTimestamp:  metav1.NewTime(timestamp),
        FirstTimestamp: metav1.NewTime(timestamp),
        Type:           &amp;quot;Normal&amp;quot;,
        Source: v1.EventSource{
            Component: schedulerName,
        },
        InvolvedObject: v1.ObjectReference{
            Kind:      &amp;quot;Pod&amp;quot;,
            Name:      p.Name,
            Namespace: p.Namespace,
            UID:       p.UID,
        },
        ObjectMeta: metav1.ObjectMeta{
            GenerateName: p.Name + &amp;quot;-&amp;quot;,
        },
    }, opts)
    if err != nil {
        return err
    }
    return nil
 }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹eventsä¿¡æ¯å¯ä»¥çœ‹å‡ºrandom-scheduleræ‰“å‡ºçš„â€œlaced pod [default/sleep-5b6fd9944c-5scxv] on k8s-master&amp;rdquo;ç­‰ä¿¡æ¯ã€‚&amp;rdquo;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;27s         Normal    Scheduled           pod/sleep-5b6fd9944c-5scxv    Placed pod [default/sleep-5b6fd9944c-5scxv] on k8s-master
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org22e94bd&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;éªŒè¯&#34;&gt;éªŒè¯&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;org7cc5355&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ç¼–è¯‘&#34;&gt;ç¼–è¯‘&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ make docker-image
$ make docker-push
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;orgede963d&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²&#34;&gt;éƒ¨ç½²&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ kubectl apply -f rbac.yaml
$ kubectl  apply -f deployment.yaml
$ kubectl apply -f sleep.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŠŠsleep.yamlé‡Œæ”¹ä¸ºschedulerName: random-schedulerå°±å¯ä»¥ä½¿ç”¨è¯¥è°ƒåº¦å™¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deployment]# kubectl  get pod -A -o wide
NAMESPACE     NAME                                 READY   STATUS    RESTARTS       AGE     IP               NODE         NOMINATED NODE   READINESS GATES
default       httpbin-master                       1/1     Running   2 (11h ago)    3d22h   10.244.0.36      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       httpbin-worker                       1/1     Running   2 (11h ago)    3d22h   10.244.2.15      k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       netshoot-master                      1/1     Running   2 (11h ago)    3d22h   10.244.0.35      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       netshoot-worker                      1/1     Running   2 (11h ago)    3d22h   10.244.2.14      k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       random-scheduler-6dc78999cc-vnxzg    1/1     Running   0              9m      10.244.0.37      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       sleep-5b6fd9944c-7rn5m               1/1     Running   0              11h     10.244.1.6       k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       sleep-5b6fd9944c-bwb9t               1/1     Running   0              11h     10.244.0.38      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   coredns-6d8c4cb4d-ck2x5              1/1     Running   20 (11h ago)   19d     10.244.0.34      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   coredns-6d8c4cb4d-mbctj              1/1     Running   20 (11h ago)   19d     10.244.0.33      k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   etcd-k8s-master                      1/1     Running   22 (11h ago)   19d     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-apiserver-k8s-master            1/1     Running   24 (11h ago)   19d     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-controller-manager-k8s-master   1/1     Running   22 (11h ago)   19d     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-dnsjg                     1/1     Running   21 (11h ago)   19d     172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-r84lg                     1/1     Running   22 (11h ago)   19d     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-tbkx2                     1/1     Running   20 (11h ago)   19d     172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-scheduler-k8s-master            1/1     Running   22 (11h ago)   19d     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-2xq2d                   1/1     Running   2 (11h ago)    3d23h   172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-dsq8c                   1/1     Running   2 (11h ago)    3d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-h8hm8                   1/1     Running   2 (11h ago)    3d23h   172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡º, random-scheduler-6dc78999cc-vnxzg å’Œ sleep podå·²æ­£å¸¸å˜æˆRunningçŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orgdc135cc&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éªŒè¯-1&#34;&gt;éªŒè¯&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deployment]# kubectl  logs random-scheduler-6dc78999cc-vnxzg
 I&#39;m a scheduler!
 2022/12/13 12:12:02 New Node Added to Store: k8s-master
 2022/12/13 12:12:02 New Node Added to Store: k8s-work1
 2022/12/13 12:12:02 New Node Added to Store: k8s-work2
 found a pod to schedule: default / sleep-5b6fd9944c-bwb9t
 2022/12/13 12:12:02 nodes that fit:
 2022/12/13 12:12:02 k8s-master
 2022/12/13 12:12:02 k8s-work1
 2022/12/13 12:12:02 k8s-work2
 2022/12/13 12:12:02 calculated priorities: map[k8s-master:79 k8s-work1:68 k8s-work2:15]
 Placed pod [default/sleep-5b6fd9944c-bwb9t] on k8s-master

 found a pod to schedule: default / sleep-5b6fd9944c-7rn5m
 2022/12/13 12:12:02 nodes that fit:
 2022/12/13 12:12:02 k8s-master
 2022/12/13 12:12:02 k8s-work1
 2022/12/13 12:12:02 calculated priorities: map[k8s-master:26 k8s-work1:50]
 Placed pod [default/sleep-5b6fd9944c-7rn5m] on k8s-work1

 [root@k8s-master deployment]# kubectl logs sleep-5b6fd9944c-7rn5m
 [root@k8s-master deployment]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»random-scheduleræ—¥å¿—çœ‹ï¼Œ sleepå®¹å™¨ç»è¿‡random-schedulerè¿›è¡Œè°ƒåº¦çš„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master deployment]# k get events
 - LAST SEEN   TYPE      REASON              OBJECT                        MESSAGE
 39m         Normal    Pulled              pod/netshoot-master           Container image &amp;quot;nicolaka/netshoot:latest&amp;quot; already present on machine
 39m         Normal    Created             pod/netshoot-master           Created container centos
 39m         Normal    Started             pod/netshoot-master           Started container centos
 39m         Normal    Pulled              pod/netshoot-worker           Container image &amp;quot;nicolaka/netshoot:latest&amp;quot; already present on machine
 39m         Normal    Created             pod/netshoot-worker           Created container centos
 39m         Normal    Started             pod/netshoot-worker           Started container centos
 27s         Normal    Scheduled           pod/sleep-5b6fd9944c-5scxv    Placed pod [default/sleep-5b6fd9944c-5scxv] on k8s-master
 26s         Normal    Pulled              pod/sleep-5b6fd9944c-5scxv    Container image &amp;quot;tutum/curl&amp;quot; already present on machine
 26s         Normal    Created             pod/sleep-5b6fd9944c-5scxv    Created container sleep
 26s         Normal    Started             pod/sleep-5b6fd9944c-5scxv    Started container sleep
 50s         Normal    Killing             pod/sleep-5b6fd9944c-7rn5m    Stopping container sleep
 50s         Normal    Killing             pod/sleep-5b6fd9944c-bwb9t    Stopping container sleep
 27s         Normal    Scheduled           pod/sleep-5b6fd9944c-rccmj    Placed pod [default/sleep-5b6fd9944c-rccmj] on k8s-work2
 26s         Normal    Pulling             pod/sleep-5b6fd9944c-rccmj    Pulling image &amp;quot;tutum/curl&amp;quot;
 27s         Normal    SuccessfulCreate    replicaset/sleep-5b6fd9944c   Created pod: sleep-5b6fd9944c-rccmj
 27s         Normal    SuccessfulCreate    replicaset/sleep-5b6fd9944c   Created pod: sleep-5b6fd9944c-5scxv
 27s         Normal    ScalingReplicaSet   deployment/sleep              Scaled up replica set sleep-5b6fd9944c to 2
 [root@k8s-master deployment]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹eventsä¿¡æ¯å¯ä»¥çœ‹å‡ºrandom-scheduleræ‰“å‡ºçš„â€œlaced pod [default/sleep-5b6fd9944c-5scxv] on k8s-master&amp;rdquo;ç­‰ä¿¡æ¯ã€‚&amp;rdquo;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org008f2a0&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;[01] &lt;a href=&#34;https://www.cnblogs.com/z-gh/p/15409763.html&#34;&gt;k8sè°ƒåº¦å™¨ä»‹ç»ï¼ˆè°ƒåº¦æ¡†æ¶ç‰ˆæœ¬ï¼‰&lt;/a&gt;&lt;br /&gt;
[02] &lt;a href=&#34;https://zhuanlan.zhihu.com/p/400351590&#34;&gt;client-goåŠŸèƒ½è¯¦è§£&lt;/a&gt;&lt;br /&gt;
[03] &lt;a href=&#34;https://www.jb51.net/article/253965.htm&#34;&gt;ä¸€ç¯‡æ–‡ç« ææ‡‚Goè¯­è¨€ä¸­çš„Context&lt;/a&gt;]&lt;br /&gt;
[04] &lt;a href=&#34;https://www.cnblogs.com/yangyuliufeng/p/13611126.html&#34;&gt;æ·±å…¥ç†è§£k8sä¸­çš„informeræœºåˆ¶&lt;/a&gt;]&lt;/p&gt;
</description>
        </item>
        
        <item>
            <title>K8Sé¡¹ç›®å®è·µ(02): åŠ¨æ‰‹å®ç°minicni</title>
            <link>http://mospany.github.io/2022/11/22/k8s-practice-minicni/</link>
            <pubDate>Tue, 22 Nov 2022 22:42:55 CST</pubDate>
            <author>Mospan</author>
            <guid>http://mospany.github.io/2022/11/22/k8s-practice-minicni/</guid>
            <description>

&lt;p&gt;&lt;a id=&#34;orgfaa973a&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h1&gt;

&lt;p&gt;ä¸ç®¡æ˜¯å®¹å™¨ç½‘ç»œè¿˜æ˜¯ Kubernetes ç½‘ç»œéƒ½éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®¹å™¨/Pod IP åœ°å€çš„ç®¡ç†&lt;/li&gt;
&lt;li&gt;å®¹å™¨/Pod ä¹‹é—´çš„ç›¸äº’é€šä¿¡&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®¹å™¨/Pod IP åœ°å€çš„ç®¡ç†åŒ…æ‹¬å®¹å™¨ IP åœ°å€çš„åˆ†é…ä¸å›æ”¶ï¼Œè€Œå®¹å™¨/Pod ä¹‹é—´çš„ç›¸äº’é€šä¿¡åŒ…æ‹¬åŒä¸€ä¸»æœºçš„å®¹å™¨/Pod ä¹‹é—´å’Œè·¨ä¸»æœºçš„å®¹å™¨/Pod ä¹‹é—´é€šä¿¡ä¸¤ç§åœºæ™¯ã€‚è¿™ä¸¤ä¸ªé—®é¢˜ä¹Ÿä¸èƒ½å®Œå…¨åˆ†å¼€æ¥çœ‹ï¼Œå› ä¸ºä¸åŒçš„è§£å†³æ–¹æ¡ˆå¾€å¾€è¦åŒæ—¶è€ƒè™‘ä»¥ä¸Šä¸¤ç‚¹ã€‚å¯¹äºåŒä¸€ä¸»æœºçš„å®¹å™¨/Pod ä¹‹é—´çš„é€šä¿¡æ¥è¯´å®ç°ç›¸å¯¹å®¹æ˜“ï¼Œå®é™…çš„æŒ‘æˆ˜åœ¨äºï¼Œä¸åŒå®¹å™¨/Pod å®Œå…¨å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„é›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œå¦‚ä½•å®ç°è·¨ä¸»æœºèŠ‚ç‚¹çš„é€šä¿¡ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœä¸é‡‡ç”¨ SDN(Software define networking) æ–¹å¼æ¥ä¿®æ”¹åº•å±‚ç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œä¸»æµæ–¹æ¡ˆæ˜¯åœ¨ä¸»æœºèŠ‚ç‚¹çš„ underlay ç½‘ç»œå¹³é¢æ„å»ºæ–°çš„ overlay ç½‘ç»œè´Ÿè´£ä¼ è¾“å®¹å™¨/Pod ä¹‹é—´é€šä¿¡æ•°æ®ã€‚è¿™ç§ç½‘ç»œæ–¹æ¡ˆåœ¨å¦‚ä½•å¤ç”¨åŸæœ‰çš„ underlay ç½‘ç»œå¹³é¢ä¹Ÿæœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å°†å®¹å™¨çš„æ•°æ®åŒ…å°è£…åˆ°åŸä¸»æœºç½‘ç»œï¼ˆunderlay ç½‘ç»œå¹³é¢ï¼‰çš„ä¸‰å±‚æˆ–å››å±‚æ•°æ®åŒ…ä¸­ï¼Œç„¶åä½¿ç”¨ä¸»æœºç½‘ç»œçš„ä¸‰å±‚æˆ–è€…å››å±‚åè®®ä¼ è¾“åˆ°ç›®æ ‡ä¸»æœºï¼Œç›®æ ‡ä¸»æœºæ‹†åŒ…åå†è½¬å‘ç»™ç›®æ ‡å®¹å™¨ï¼›&lt;/li&gt;
&lt;li&gt;æŠŠå®¹å™¨ç½‘ç»œåŠ åˆ°ä¸»æœºè·¯ç”±è¡¨ä¸­ï¼ŒæŠŠä¸»æœºç½‘ç»œï¼ˆunderlay ç½‘ç»œå¹³é¢ï¼‰è®¾å¤‡å½“ä½œå®¹å™¨ç½‘å…³ï¼Œé€šè¿‡è·¯ç”±è§„åˆ™è½¬å‘åˆ°æŒ‡å®šçš„ä¸»æœºï¼Œå®ç°å®¹å™¨çš„ä¸‰å±‚äº’é€šï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;org3709b23&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;cniåŸç†&#34;&gt;CNIåŸç†&lt;/h1&gt;

&lt;p&gt;CNI è§„èŒƒç›¸å¯¹äº CNM(Container Network Model) å¯¹å¼€å‘è€…çš„çº¦æŸæ›´å°‘ã€æ›´å¼€æ”¾ï¼Œä¸ä¾èµ–äºå®¹å™¨è¿è¡Œæ—¶ï¼Œå› æ­¤ä¹Ÿæ›´ç®€å•ã€‚å…³äº CNI è§„èŒƒçš„è¯¦æƒ…è¯·æŸ¥çœ‹&lt;a href=&#34;https://github.com/containernetworking/cni/blob/master/SPEC.md&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/minicni/cni-standard.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è¯¦è§: &lt;a href=&#34;https://blog.csdn.net/elihe2011/article/details/122926399&#34;&gt;K8S ç½‘ç»œCNI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å®ç°ä¸€ä¸ª CNI ç½‘ç»œæ’ä»¶åªéœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶å’Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é…ç½®æ–‡ä»¶æè¿°æ’ä»¶çš„ç‰ˆæœ¬ã€åç§°ã€æè¿°ç­‰åŸºæœ¬ä¿¡æ¯ï¼›&lt;/li&gt;
&lt;li&gt;å¯æ‰§è¡Œæ–‡ä»¶ä¼šè¢«ä¸Šå±‚çš„å®¹å™¨ç®¡ç†å¹³å°è°ƒç”¨ï¼Œä¸€ä¸ª CNI å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦å®ç°å°†å®¹å™¨åŠ å…¥åˆ°ç½‘ç»œçš„ ADD æ“ä½œä»¥åŠå°†å®¹å™¨ä»ç½‘ç»œä¸­åˆ é™¤çš„ DEL æ“ä½œç­‰ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Kubernetes ä½¿ç”¨ CNI ç½‘ç»œæ’ä»¶çš„åŸºæœ¬å·¥ä½œæµç¨‹æ˜¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;kubelet å…ˆåˆ›å»º pause å®¹å™¨åˆ›å»ºå¯¹åº”çš„ç½‘ç»œå‘½åç©ºé—´ï¼›&lt;/li&gt;
&lt;li&gt;æ ¹æ®é…ç½®è°ƒç”¨å…·ä½“çš„ CNI æ’ä»¶ï¼Œå¯ä»¥é…ç½®æˆ CNI æ’ä»¶é“¾æ¥è¿›è¡Œé“¾å¼è°ƒç”¨ï¼›&lt;/li&gt;
&lt;li&gt;å½“ CNI æ’ä»¶è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæ ¹æ®ç¯å¢ƒå˜é‡ä»¥åŠå‘½ä»¤è¡Œå‚æ•°æ¥è·å¾—ç½‘ç»œå‘½åç©ºé—´ã€å®¹å™¨çš„ç½‘ç»œè®¾å¤‡ç­‰å¿…è¦ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œ ADD æˆ–è€…å…¶ä»–æ“ä½œï¼›&lt;/li&gt;
&lt;li&gt;CNI æ’ä»¶ç»™ pause å®¹å™¨é…ç½®æ­£ç¡®çš„ç½‘ç»œï¼Œpod ä¸­å…¶ä»–çš„å®¹å™¨éƒ½æ˜¯å¤ç”¨ pause å®¹å™¨çš„ç½‘ç»œï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;orgec132b9&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;cnié…ç½®æ–‡ä»¶&#34;&gt;CNIé…ç½®æ–‡ä»¶&lt;/h1&gt;

&lt;p&gt;ç°åœ¨æˆ‘ä»¬æ¥åˆ°å…³é”®çš„éƒ¨åˆ†ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒCNI æ’ä»¶éœ€è¦åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåœ¨ CNI çš„è§„èŒƒé‡Œé¢ï¼Œå®ç°ä¸€ä¸ª CNI æ’ä»¶é¦–å…ˆéœ€è¦ä¸€ä¸ª JSON æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶éœ€è¦æ”¾åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ &lt;em&gt;etc/cni/net.d&lt;/em&gt; ç›®å½•ï¼Œä¸€èˆ¬å‘½åä¸º &amp;lt;æ•°å­—&amp;gt;-&lt;CNI-plugin&gt;.confï¼Œè€Œä¸”é…ç½®æ–‡ä»¶è‡³å°‘éœ€è¦ä»¥ä¸‹å‡ ä¸ªå¿…é¡»çš„å­—æ®µï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;cniVersion: CNI æ’ä»¶çš„å­—ç¬¦ä¸²ç‰ˆæœ¬å·ï¼Œè¦æ±‚ç¬¦åˆ Semantic Version 2.0 è§„èŒƒï¼›&lt;/li&gt;
&lt;li&gt;name: å­—ç¬¦ä¸²å½¢å¼çš„ç½‘ç»œåï¼›&lt;/li&gt;

&lt;li&gt;&lt;p&gt;type: å­—ç¬¦ä¸²è¡¨ç¤ºçš„ CNI æ’ä»¶çš„å¯è¿è¡Œæ–‡ä»¶ï¼›&lt;br /&gt;
é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¢åŠ ä¸€äº›è‡ªå®šä¹‰çš„é…ç½®å­—æ®µï¼Œç”¨äºä¼ é€’å‚æ•°ç»™ CNI æ’ä»¶ï¼Œè¿™äº›é…ç½®ä¼šåœ¨è¿è¡Œæ—¶ä¼ é€’ç»™ CNI æ’ä»¶ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œé¢ï¼Œéœ€è¦é…ç½®æ¯ä¸ªå®¿ä¸»æœºç½‘æ¡¥çš„è®¾å¤‡åã€ç½‘ç»œè®¾å¤‡çš„æœ€å¤§ä¼ è¾“å•å…ƒ(MTU)ä»¥åŠæ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„24ä½å­ç½‘åœ°å€ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬çš„ CNI æ’ä»¶çš„é…ç½®çœ‹èµ·æ¥ä¼šåƒä¸‹é¢è¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  {
    &amp;quot;cniVersion&amp;quot;: &amp;quot;0.1.0&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;minicni&amp;quot;,
    &amp;quot;type&amp;quot;: &amp;quot;minicni&amp;quot;,
    &amp;quot;bridge&amp;quot;: &amp;quot;minicni0&amp;quot;,
    &amp;quot;mtu&amp;quot;: 1500,
    &amp;quot;subnet&amp;quot;: __NODE_SUBNET__
}
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;blockquote&gt;
&lt;p&gt;Note: ç¡®ä¿é…ç½®æ–‡ä»¶æ”¾åˆ° &lt;em&gt;etc/cni/net.d&lt;/em&gt; ç›®å½•ï¼Œkubelet é»˜è®¤æ­¤ç›®å½•å¯»æ‰¾ CNI æ’ä»¶é…ç½®ï¼›å¹¶ä¸”ï¼Œæ’ä»¶çš„é…ç½®å¯ä»¥åˆ†ä¸ºå¤šä¸ªæ’ä»¶é“¾çš„å½¢å¼æ¥è¿è¡Œï¼Œä½†æ˜¯ä¸ºäº†ç®€å•èµ·è§ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåªé…ç½®ä¸€ä¸ªç‹¬ç«‹çš„ CNI æ’ä»¶ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶çš„åç¼€åä¸º .confã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a id=&#34;orgeb0c3b0&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;cniæ ¸å¿ƒå®ç°&#34;&gt;CNIæ ¸å¿ƒå®ç°&lt;/h1&gt;

&lt;p&gt;æ¥ä¸‹æ¥å°±å¼€å§‹çœ‹æ€ä¹ˆå®ç° CNI æ’ä»¶æ¥ç®¡ç† pod IP åœ°å€ä»¥åŠé…ç½®å®¹å™¨ç½‘ç»œè®¾å¤‡ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒCNI ä»‹å…¥çš„æ—¶æœºæ˜¯ kubelet åˆ›å»º pause å®¹å™¨åˆ›å»ºå¯¹åº”çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹åï¼ŒåŒæ—¶å½“ CNI æ’ä»¶è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œkubelet ä¼šå°†ç›¸å…³æ“ä½œå‘½ä»¤ä»¥åŠå‚æ•°é€šè¿‡ç¯å¢ƒå˜é‡çš„å½¢å¼ä¼ é€’ç»™å®ƒã€‚è¿™äº›ç¯å¢ƒå˜é‡åŒ…æ‹¬ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CNI_COMMAND: CNI æ“ä½œå‘½ä»¤ï¼ŒåŒ…æ‹¬ ADD, DEL, CHECK ä»¥åŠ VERSION&lt;/li&gt;
&lt;li&gt;CNI_CONTAINERID: å®¹å™¨ ID&lt;/li&gt;
&lt;li&gt;CNI_NETNS: pod ç½‘ç»œå‘½åç©ºé—´&lt;/li&gt;
&lt;li&gt;CNI_IFNAME: pod ç½‘ç»œè®¾å¤‡åç§°&lt;/li&gt;
&lt;li&gt;CNI_PATH: CNI æ’ä»¶å¯æ‰§è¡Œæ–‡ä»¶çš„æœç´¢è·¯å¾„&lt;/li&gt;
&lt;li&gt;CNI_ARGS: å¯é€‰çš„å…¶ä»–å‚æ•°ï¼Œå½¢å¼ç±»ä¼¼äº key1=value1,key2=value2&amp;#x2026;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨è¿è¡Œæ—¶ï¼Œkubelet é€šè¿‡ CNI é…ç½®æ–‡ä»¶å¯»æ‰¾ CNI å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶ååŸºäºä¸Šè¿°å‡ ä¸ªç¯å¢ƒå˜é‡æ¥æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚CNI æ’ä»¶å¿…é¡»æ”¯æŒçš„æ“ä½œåŒ…æ‹¬ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ADD: å°† pod åŠ å…¥åˆ° pod ç½‘ç»œä¸­&lt;/li&gt;
&lt;li&gt;DEL: å°† pod ä» pod ç½‘ç»œä¸­åˆ é™¤&lt;/li&gt;
&lt;li&gt;CHECK: æ£€æŸ¥ pod ç½‘ç»œé…ç½®æ­£å¸¸&lt;/li&gt;
&lt;li&gt;VERSION: è¿”å›å¯é€‰ CNI æ’ä»¶çš„ç‰ˆæœ¬ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è®©æˆ‘ä»¬ç›´æ¥è·³åˆ° CNI æ’ä»¶çš„å…¥å£å‡½æ•°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func main() {
    setupLogger()

    cmd, cmdArgs, err := args.GetArgsFromEnv()
    if err != nil {
        log.Fatalf(&amp;quot;getting cmd arguments with error: %v&amp;quot;, err)
        os.Exit(1)
    }

    fh := handler.NewFileHandler(IPStore)

    switch cmd {
    case &amp;quot;ADD&amp;quot;:
        err = fh.HandleAdd(cmdArgs)
    case &amp;quot;DEL&amp;quot;:
        err = fh.HandleDel(cmdArgs)
    case &amp;quot;CHECK&amp;quot;:
        err = fh.HandleCheck(cmdArgs)
    case &amp;quot;VERSION&amp;quot;:
        err = fh.HandleVersion(cmdArgs)
    default:
        err = fmt.Errorf(&amp;quot;unknown CNI_COMMAND: %s&amp;quot;, cmd)
    }
    if err != nil {
        fmt.Fprintf(os.Stderr, &amp;quot;Failed to handle CNI_COMMAND %q: %v&amp;quot;, cmd, err)
        os.Exit(1)
    }
 }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é¦–å…ˆè°ƒç”¨ GetArgsFromEnv() å‡½æ•°å°† CNI æ’ä»¶çš„æ“ä½œå‘½ä»¤ä»¥åŠç›¸å…³å‚æ•°é€šè¿‡ç¯å¢ƒå˜é‡è¯»å…¥ï¼ŒåŒæ—¶ä»æ ‡å‡†è¾“å…¥è·å– CNI æ’ä»¶çš„ JSON é…ç½®ï¼Œç„¶ååŸºäºä¸åŒçš„ CNI æ“ä½œå‘½ä»¤æ‰§è¡Œä¸åŒçš„å¤„ç†å‡½æ•°ã€‚&lt;/p&gt;

&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å°†å¤„ç†å‡½æ•°çš„é›†åˆå®ç°ä¸ºä¸€ä¸ªæ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“çš„æ‰©å±•ä¸åŒçš„æ¥å£å®ç°ã€‚åœ¨æœ€åŸºç¡€çš„ç‰ˆæœ¬å®ç°ä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬æ–‡ä»¶å­˜å‚¨åˆ†é…çš„ IP ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œè¿™ç§å®ç°æ–¹å¼å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œä¾‹å¦‚ï¼Œæ–‡ä»¶å­˜å‚¨ä¸å¯é ï¼Œè¯»å†™å¯èƒ½ä¼šå‘ç”Ÿå†²çªç­‰ï¼Œåœ¨åç»­çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¼šå®ç°åŸºäº kubernetes å­˜å‚¨çš„æ¥å£å®ç°ï¼Œå°†å­ç½‘ä¿¡æ¯ä»¥åŠ IP ä¿¡æ¯å­˜å‚¨åˆ° apiserver ä¸­ï¼Œä»è€Œå®ç°å¯é å­˜å‚¨ã€‚&lt;/p&gt;

&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹çœ‹åŸºäºæ–‡ä»¶çš„æ¥å£å®ç°æ˜¯æ€ä¹ˆå¤„ç†è¿™äº› CNI æ“ä½œå‘½ä»¤çš„ã€‚&lt;br /&gt;
å¯¹äº ADD å‘½ä»¤ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä»æ ‡å‡†è¾“å…¥è·å– CNI æ’ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯å½“å‰å®¿ä¸»æœºç½‘æ¡¥çš„è®¾å¤‡åã€ç½‘ç»œè®¾å¤‡çš„æœ€å¤§ä¼ è¾“å•å…ƒ(MTU)ä»¥åŠå½“å‰èŠ‚ç‚¹åˆ†é…çš„24ä½å­ç½‘åœ°å€ï¼›&lt;/li&gt;
&lt;li&gt;ç„¶åä»ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ°å¯¹åº”çš„ CNI æ“ä½œå‚æ•°ï¼ŒåŒ…æ‹¬ pod å®¹å™¨ç½‘ç»œå‘½åç©ºé—´ä»¥åŠ pod ç½‘ç»œè®¾å¤‡åç­‰ï¼›&lt;/li&gt;
&lt;li&gt;æ¥ä¸‹æ¥åˆ›å»ºæˆ–è€…æ›´æ–°èŠ‚ç‚¹å®¿ä¸»æœºç½‘æ¡¥ï¼Œä»å½“å‰èŠ‚ç‚¹åˆ†é…çš„24ä½å­ç½‘åœ°å€ä¸­æŠ½å–å­ç½‘çš„ç½‘å…³åœ°å€ï¼Œå‡†å¤‡åˆ†é…ç»™èŠ‚ç‚¹å®¿ä¸»æœºç½‘æ¡¥ï¼›&lt;/li&gt;
&lt;li&gt;æ¥ç€å°†ä»æ–‡ä»¶è¯»å–å·²ç»åˆ†é…çš„ IP åœ°å€åˆ—è¡¨ï¼Œéå†24ä½å­ç½‘åœ°å€å¹¶ä»ä¸­å–å‡ºç¬¬ä¸€ä¸ªæ²¡æœ‰è¢«åˆ†é…çš„ IP åœ°å€ä¿¡æ¯ï¼Œå‡†å¤‡åˆ†é…ç»™ pod ç½‘ç»œè®¾å¤‡ï¼›pod ç½‘ç»œè®¾å¤‡æ˜¯ veth è®¾å¤‡å¯¹ï¼Œä¸€ç«¯åœ¨ pod ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œå¦å¤–ä¸€ç«¯è¿æ¥ç€å®¿ä¸»æœºä¸Šçš„ç½‘æ¡¥è®¾å¤‡ï¼ŒåŒæ—¶æ‰€æœ‰çš„ pod ç½‘ç»œè®¾å¤‡å°†å®¿ä¸»æœºä¸Šçš„ç½‘æ¡¥è®¾å¤‡å½“ä½œé»˜è®¤ç½‘å…³ï¼›&lt;/li&gt;
&lt;li&gt;æœ€ç»ˆæˆåŠŸåéœ€è¦å°†æ–°çš„ pod IP å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;çœ‹èµ·æ¥å¾ˆç®€å•å¯¹å§ï¼Ÿå…¶å®ä½œä¸ºæœ€ç®€å•çš„æ–¹å¼ï¼Œè¿™ç§æ–¹æ¡ˆå¯ä»¥å®ç°æœ€åŸºç¡€çš„ ADD åŠŸèƒ½, kubeletè°ƒç”¨å‚æ•°å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  2022/12/09 20:17:14 cmd: ADD, ContainerID: 504032948df53a9f7bc7c35d01fb89f32b8db7a1d87514f546b78b91d2d8150a, Netns: /proc/3444/ns/net, ifName: eth0, Path: /opt/cni/bin, Args: IgnoreUnknown=1;K8S_POD_NAMESPACE=kube-system;K8S_POD_NAME=coredns-6d8c4cb4d-mbctj;K8S_POD_INFRA_CONTAINER_ID=504032948df53a9f7bc7c35d01fb89f32b8db7a1d87514f546b78b91d2d8150a, StdinData: {&amp;quot;bridge&amp;quot;:&amp;quot;minicni0&amp;quot;,&amp;quot;cniVersion&amp;quot;:&amp;quot;0.1.0&amp;quot;,&amp;quot;mtu&amp;quot;:1500,&amp;quot;name&amp;quot;:&amp;quot;minicni&amp;quot;,&amp;quot;subnet&amp;quot;:&amp;quot;10.244.0.0/24&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;minicni&amp;quot;}.

2022/12/09 20:17:14 cmd: ADD, ContainerID: 84546b1f14b339f69528d96b60e3b50a983e024daf00a6ef990819d1717aaff7, Netns: /proc/3491/ns/net, ifName: eth0, Path: /opt/cni/bin, Args: IgnoreUnknown=1;K8S_POD_NAMESPACE=kube-system;K8S_POD_NAME=coredns-6d8c4cb4d-ck2x5;K8S_POD_INFRA_CONTAINER_ID=84546b1f14b339f69528d96b60e3b50a983e024daf00a6ef990819d1717aaff7, StdinData: {&amp;quot;bridge&amp;quot;:&amp;quot;minicni0&amp;quot;,&amp;quot;cniVersion&amp;quot;:&amp;quot;0.1.0&amp;quot;,&amp;quot;mtu&amp;quot;:1500,&amp;quot;name&amp;quot;:&amp;quot;minicni&amp;quot;,&amp;quot;subnet&amp;quot;:&amp;quot;10.244.0.0/24&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;minicni&amp;quot;}.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®ç°ä»£ç å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; 1  func (fh *FileHandler) HandleAdd(cmdArgs *args.CmdArgs) error {
 2    cniConfig := args.CNIConfiguration{}
 3    if err := json.Unmarshal(cmdArgs.StdinData, &amp;amp;cniConfig); err != nil {
 4        return err
 5    }
 6    allIPs, err := nettool.GetAllIPs(cniConfig.Subnet)
 7    if err != nil {
 8        return err
 9    }
10    gwIP := allIPs[0]
11  
12    // open or create the file that stores all the reserved IPs
13    f, err := os.OpenFile(fh.IPStore, os.O_RDWR|os.O_CREATE, 0600)
14    if err != nil {
15        return fmt.Errorf(&amp;quot;failed to open file that stores reserved IPs %v&amp;quot;, err)
16    }
17    defer f.Close()
18  
19    // get all the reserved IPs from file
20    content, err := ioutil.ReadAll(f)
21    if err != nil {
22        return err
23    }
24    reservedIPs := strings.Split(strings.TrimSpace(string(content)), &amp;quot;\n&amp;quot;)
25  
26    podIP := &amp;quot;&amp;quot;
27    for _, ip := range allIPs[1:] {
28        reserved := false
29        for _, rip := range reservedIPs {
30            if ip == rip {
31                reserved = true
32                break
33            }
34        }
35        if !reserved {
36            podIP = ip
37            reservedIPs = append(reservedIPs, podIP)
38            break
39        }
40    }
41    if podIP == &amp;quot;&amp;quot; {
42        return fmt.Errorf(&amp;quot;no IP available&amp;quot;)
43    }
44  
45    // Create or update bridge
46    brName := cniConfig.Bridge
47    if brName != &amp;quot;&amp;quot; {
48        // fall back to default bridge name: minicni0
49        brName = &amp;quot;minicni0&amp;quot;
50    }
51    mtu := cniConfig.MTU
52    if mtu == 0 {
53        // fall back to default MTU: 1500
54        mtu = 1500
55    }
56    br, err := nettool.CreateOrUpdateBridge(brName, gwIP, mtu)
57    if err != nil {
58        return err
59    }
60  
61    netns, err := ns.GetNS(cmdArgs.Netns)
62    if err != nil {
63        return err
64    }
65  
66    if err := nettool.SetupVeth(netns, br, cmdArgs.IfName, podIP, gwIP, mtu); err != nil {
67        return err
68    }
69  
70    // write reserved IPs back into file
71    if err := ioutil.WriteFile(fh.IPStore, []byte(strings.Join(reservedIPs, &amp;quot;\n&amp;quot;)), 0600); err != nil {
72        return fmt.Errorf(&amp;quot;failed to write reserved IPs into file: %v&amp;quot;, err)
73    }
74  
75    addCmdResult := &amp;amp;AddCmdResult{
76        CniVersion: cniConfig.CniVersion,
77        IPs: &amp;amp;nettool.AllocatedIP{
78            Version: &amp;quot;IPv4&amp;quot;,
79            Address: podIP,
80            Gateway: gwIP,
81        },
82    }
83    addCmdResultBytes, err := json.Marshal(addCmdResult)
84    if err != nil {
85        return err
86    }
87  
88    // kubelet expects json format from stdout if success
89    fmt.Print(string(addCmdResultBytes))
90  
91    return nil
92  }
93  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸€ä¸ªå…³é”®çš„é—®é¢˜æ˜¯å¦‚ä½•é€‰æ‹©åˆé€‚çš„ Go è¯­è¨€åº“å‡½æ•°æ¥æ“ä½œ Linux ç½‘ç»œè®¾å¤‡ï¼Œå¦‚åˆ›å»ºç½‘æ¡¥è®¾å¤‡ã€ç½‘ç»œå‘½åç©ºé—´ä»¥åŠè¿æ¥ veth è®¾å¤‡å¯¹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé€‰æ‹©äº†æ¯”è¾ƒæˆç†Ÿçš„ netlinkï¼Œå®é™…ä¸Šï¼Œæ‰€æœ‰åŸºäº iproute2 å·¥å…·åŒ…çš„å‘½ä»¤åœ¨ netlink åº“ä¸­éƒ½æœ‰å¯¹åº”çš„ APIï¼Œä¾‹å¦‚ ip link add å¯ä»¥é€šè¿‡è°ƒç”¨ AddLink() å‡½æ•°æ¥å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;è¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æ ¼å¤–å°å¿ƒï¼Œé‚£å°±æ˜¯å¤„ç†ç½‘ç»œå‘½åç©ºé—´åˆ‡æ¢ã€Go åç¨‹ä¸çº¿ç¨‹è°ƒåº¦é—®é¢˜ã€‚åœ¨ Linux ä¸­ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹å¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œè€Œ Go è¯­è¨€çš„åç¨‹ä¼šåŸºäºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„è´Ÿè½½ä»¥åŠå…¶ä»–ä¿¡æ¯åŠ¨æ€åœ°åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ Go åç¨‹åœ¨æ„æƒ³ä¸åˆ°çš„æƒ…å†µä¸‹åˆ‡æ¢åˆ°ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;æ¯”è¾ƒç¨³å¦¥çš„åšæ³•æ˜¯ï¼Œåˆ©ç”¨ Go è¯­è¨€æä¾›çš„ runtime.LockOSThread() å‡½æ•°ä¿è¯ç‰¹å®šçš„ Go åç¨‹ç»‘å®šåˆ°å½“å‰çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äº ADD æ“ä½œçš„è¿”å›ï¼Œç¡®ä¿æ“ä½œæˆåŠŸä¹‹åå‘æ ‡å‡†è¾“å‡ºä¸­å†™å…¥ ADD æ“ä½œçš„è¿”å›ä¿¡æ¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    addCmdResult := &amp;amp;AddCmdResult{
    CniVersion: cniConfig.CniVersion,
    IPs: &amp;amp;nettool.AllocatedIP{
        Version: &amp;quot;IPv4&amp;quot;,
        Address: podIP,
        Gateway: gwIP,
    },
}
addCmdResultBytes, err := json.Marshal(addCmdResult)
if err != nil {
    return err
}

// kubelet expects json format from stdout if success
fmt.Print(string(addCmdResultBytes))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿ç•™IPæ–‡ä»¶å†…å®¹å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; 1  [root@k8s-master ~]# cat /tmp/reserved_ips
 2  10.244.0.2/24
 3  10.244.0.3/24
 4  10.244.0.4/24
 5  10.244.0.5/24
 6  10.244.0.6/24
 7  10.244.0.7/24
 8  10.244.0.8/24
 9  10.244.0.9/24
10  10.244.0.10/24
11  10.244.0.11/24
12  10.244.0.12/24
13  10.244.0.13/24
14  10.244.0.14/24
15  10.244.0.15/24
16  10.244.0.16/24
17  10.244.0.17/24
18  10.244.0.18/24
19  10.244.0.19/24
20  10.244.0.20/24
21  10.244.0.21/24
22  10.244.0.22/24
23  10.244.0.23/24
24  10.244.0.24/24
25  10.244.0.25/24
26  10.244.0.26/24
27  10.244.0.27/24  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä»–ä¸‰ä¸ª CNI æ“ä½œå‘½ä»¤çš„å¤„ç†å°±æ›´ç®€å•äº†ã€‚DEL æ“ä½œåªéœ€è¦å›æ”¶åˆ†é…çš„ IP åœ°å€ï¼Œä»æ–‡ä»¶ä¸­åˆ é™¤å¯¹åº”çš„æ¡ç›®ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¤„ç† pod ç½‘ç»œè®¾å¤‡çš„åˆ é™¤ï¼ŒåŸå› æ˜¯ kubelet åœ¨åˆ é™¤ pod ç½‘ç»œå‘½åç©ºé—´ä¹‹åè¿™äº› pod ç½‘ç»œè®¾å¤‡ä¹Ÿä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼›CHECK å‘½ä»¤æ£€æŸ¥ä¹‹å‰åˆ›å»ºçš„ç½‘ç»œè®¾å¤‡ä¸é…ç½®ï¼Œæš‚æ—¶æ˜¯å¯é€‰çš„ï¼›VERSION å‘½ä»¤ä»¥ JSON å½¢å¼è¾“å‡º CNI ç‰ˆæœ¬ä¿¡æ¯åˆ°æ ‡å‡†è¾“å‡ºã€‚&lt;br /&gt;
CNI_DELå‘½ä»¤å‚æ•°å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2022/12/09 20:16:55 cmd: DEL, ContainerID: 88722baed9e508ab6cc4525a6b0b05da12c65efa1bbf7c1e27f0fee0c4b4f7e7, Netns: , ifName: eth0, Path: /opt/cni/bin, Args: IgnoreUnknown=1;K8S_POD_NAMESPACE=kube-system;K8S_POD_NAME=coredns-6d8c4cb4d-ck2x5;K8S_POD_INFRA_CONTAINER_ID=88722baed9e508ab6cc4525a6b0b05da12c65efa1bbf7c1e27f0fee0c4b4f7e7, StdinData: {&amp;quot;bridge&amp;quot;:&amp;quot;minicni0&amp;quot;,&amp;quot;cniVersion&amp;quot;:&amp;quot;0.1.0&amp;quot;,&amp;quot;mtu&amp;quot;:1500,&amp;quot;name&amp;quot;:&amp;quot;minicni&amp;quot;,&amp;quot;subnet&amp;quot;:&amp;quot;10.244.0.0/24&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;minicni&amp;quot;}. 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆ é™¤æ“ä½œå®ç°ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; 1   func (fh *FileHandler) HandleDel(cmdArgs *args.CmdArgs) error {
 2      netns, err := ns.GetNS(cmdArgs.Netns)
 3      if err != nil {
 4          return err
 5      }
 6      ip, err := nettool.GetVethIPInNS(netns, cmdArgs.IfName)
 7      if err != nil {
 8          return err
 9      }
10  
11      // open or create the file that stores all the reserved IPs
12      f, err := os.OpenFile(fh.IPStore, os.O_RDWR|os.O_CREATE, 0600)
13      if err != nil {
14          return fmt.Errorf(&amp;quot;failed to open file that stores reserved IPs %v&amp;quot;, err)
15      }
16      defer f.Close()
17  
18      // get all the reserved IPs from file
19      content, err := ioutil.ReadAll(f)
20      if err != nil {
21          return err
22      }
23      reservedIPs := strings.Split(strings.TrimSpace(string(content)), &amp;quot;\n&amp;quot;)
24  
25      for i, rip := range reservedIPs {
26          if rip == ip {
27              reservedIPs = append(reservedIPs[:i], reservedIPs[i+1:]...)
28              break
29          }
30      }
31  
32      // write reserved IPs back into file
33      if err := ioutil.WriteFile(fh.IPStore, []byte(strings.Join(reservedIPs, &amp;quot;\n&amp;quot;)), 0600); err != nil {
34          return fmt.Errorf(&amp;quot;failed to write reserved IPs into file: %v&amp;quot;, err)
35      }
36  
37      return nil
38  }
39  
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;CNI_VERSIONå‚æ•°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2022/12/09 20:18:24 cmd: VERSION, ContainerID: , Netns: dummy, ifName: dummy, Path: dummy, Args: , StdinData: {&amp;quot;cniVersion&amp;quot;:&amp;quot;0.4.0&amp;quot;}. 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®ç°ä»£ç å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1  func (fh *FileHandler) HandleVersion(cmdArgs *args.CmdArgs) error {
2     versionInfo, err := json.Marshal(fh.VersionInfo)
3     if err != nil {
4         return err
5     }
6     fmt.Print(string(versionInfo))
7     return nil
8  }
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;orgb4b32d9&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;cni-å®‰è£…å·¥å…·&#34;&gt;CNI å®‰è£…å·¥å…·&lt;/h1&gt;

&lt;p&gt;CNI æ’ä»¶éœ€è¦è¿è¡Œåœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œä¸” CNI æ’ä»¶é…ç½®ä¿¡æ¯ä¸å¯è¿è¡Œæ–‡ä»¶å¿…é¡»åœ¨æ¯ä¸ªèŠ‚ç‚¹ç‰¹æ®Šçš„ç›®å½•ä¸­ï¼Œå› æ­¤ï¼Œå®‰è£… CNI æ’ä»¶éå¸¸é€‚åˆä½¿ç”¨ DaemonSet å¹¶æŒ‚è½½ CNI æ’ä»¶ç›®å½•ï¼Œä¸ºäº†é¿å…å®‰è£… CNI çš„å·¥å…·ä¸èƒ½è¢«æ­£å¸¸è°ƒåº¦ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ hostNetwork æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œã€‚åŒæ—¶ï¼Œå°† CNI æ’ä»¶é…ç½®ä»¥ ConfigMap çš„å½¢å¼æŒ‚è½½ï¼Œè¿™æ ·æ–¹ä¾¿ç»ˆç«¯ç”¨æˆ·é…ç½® CNI æ’ä»¶ã€‚æ›´è¯¦ç»†çš„ä¿¡æ¯è¯·æŸ¥çœ‹å®‰è£…å·¥å…·éƒ¨ç½²æ–‡ä»¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# k describe node k8s-master  | grep CIDR
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
[root@k8s-master ~]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å®‰è£… CNI æ’ä»¶çš„è„šæœ¬ä¸­è·å–æ¯ä¸ªèŠ‚ç‚¹åˆ’åˆ†å¾—åˆ°çš„24å­ç½‘ä¿¡æ¯ã€æ£€æŸ¥æ˜¯å¦åˆæ³•ç„¶åå†™å…¥åˆ° CNI é…ç½®ä¿¡æ¯ä¸­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; 1  # The environment variables used to connect to the kube-apiserver
 2   SERVICE_ACCOUNT_PATH=/var/run/secrets/kubernetes.io/serviceaccount
 3   SERVICEACCOUNT_TOKEN=$(cat $SERVICE_ACCOUNT_PATH/token)
 4   KUBE_CACERT=${KUBE_CACERT:-$SERVICE_ACCOUNT_PATH/ca.crt}
 5   KUBERNETES_SERVICE_PROTOCOL=${KUBERNETES_SERVICE_PROTOCOL-https}
 6  
 7   # Check if we&#39;re running as a k8s pod.
 8   if [ -f &amp;quot;$SERVICE_ACCOUNT_PATH/token&amp;quot; ];
 9   then
10       # some variables should be automatically set inside a pod
11       if [ -z &amp;quot;${KUBERNETES_SERVICE_HOST}&amp;quot; ]; then
12           exit_with_message &amp;quot;KUBERNETES_SERVICE_HOST not set&amp;quot;
13       fi
14       if [ -z &amp;quot;${KUBERNETES_SERVICE_PORT}&amp;quot; ]; then
15           exit_with_message &amp;quot;KUBERNETES_SERVICE_PORT not set&amp;quot;
16       fi
17   fi
18  
19   # exit if the NODE_NAME environment variable is not set.
20   if [[ -z &amp;quot;${NODE_NAME}&amp;quot; ]];
21   then
22       exit_with_message &amp;quot;NODE_NAME not set.&amp;quot;
23   fi
24  
25  
26   NODE_RESOURCE_PATH=&amp;quot;${KUBERNETES_SERVICE_PROTOCOL}://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}/api/v1/nodes/${NODE_NAME}&amp;quot;
27   NODE_SUBNET=$(curl --cacert &amp;quot;${KUBE_CACERT}&amp;quot; --header &amp;quot;Authorization: Bearer ${SERVICEACCOUNT_TOKEN}&amp;quot; -X GET &amp;quot;${NODE_RESOURCE_PATH}&amp;quot; | jq &amp;quot;.spec.podCIDR&amp;quot;)
28  
29   # Check if the node subnet is valid IPv4 CIDR address
30   IPV4_CIDR_REGEX=&amp;quot;(((25[0-5]|2[0-4][0-9]|1?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|1?[0-9][0-9]?))(\/([8-9]|[1-2][0-9]|3[0-2]))([^0-9.]|$)&amp;quot;
31   if [[ ${NODE_SUBNET} =~ ${IPV4_CIDR_REGEX} ]]
32   then
33       echo &amp;quot;${NODE_SUBNET} is a valid IPv4 CIDR address.&amp;quot;
34   else
35       exit_with_message &amp;quot;${NODE_SUBNET} is not a valid IPv4 CIDR address!&amp;quot;
36   fi
37  
38   # exit if the NODE_NAME environment variable is not set.
39   if [[ -z &amp;quot;${CNI_NETWORK_CONFIG}&amp;quot; ]];
40   then
41       exit_with_message &amp;quot;CNI_NETWORK_CONFIG not set.&amp;quot;
42   fi
43  
44   TMP_CONF=&#39;/minicni.conf.tmp&#39;
45   cat &amp;gt;&amp;quot;${TMP_CONF}&amp;quot; &amp;lt;&amp;lt;EOF
46   ${CNI_NETWORK_CONFIG}
47   EOF
48  
49   # Replace the __NODE_SUBNET__
50   grep &amp;quot;__NODE_SUBNET__&amp;quot; &amp;quot;${TMP_CONF}&amp;quot; &amp;amp;&amp;amp; sed -i s~__NODE_SUBNET__~&amp;quot;${NODE_SUBNET}&amp;quot;~g &amp;quot;${TMP_CONF}&amp;quot;
51  
52   # Log the config file
53   echo &amp;quot;CNI config: $(cat &amp;quot;${TMP_CONF}&amp;quot;)&amp;quot;
54  
55   # Move the temporary CNI config into the CNI configuration directory.
56   mv &amp;quot;${TMP_CONF}&amp;quot; &amp;quot;${CNI_NET_DIR}/${CNI_CONF_NAME}&amp;quot; || \
57     exit_with_error &amp;quot;Failed to move ${TMP_CONF} to ${CNI_CONF_NAME}.&amp;quot;
58  
59   echo &amp;quot;Created CNI config ${CNI_CONF_NAME}&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a id=&#34;org9970dc4&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;ç¼–è¯‘éƒ¨ç½²&#34;&gt;ç¼–è¯‘éƒ¨ç½²&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;orgd1c3c68&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;1-ç¼–è¯‘&#34;&gt;1ã€ç¼–è¯‘&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;make build
make image
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/minicni/make-image-minicni.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨docker hubé‡Œå·²çœ‹åˆ°äº†minicnié•œåƒï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.mospan.cn/post/img/k8s/minicni/docker-hub-minicni.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org4e72f27&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²&#34;&gt;éƒ¨ç½²&lt;/h2&gt;

&lt;p&gt;1ã€ç™»å½•å·²å®‰è£…å¥½çš„k8sé›†ç¾¤ï¼ŒæŠŠä¹‹å‰å·²å­˜åœ¨çš„cniå¦‚(calico)å¸è½½æ‰å†å®‰è£…minici:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# kubectl  apply -f minicni.yaml
clusterrole.rbac.authorization.k8s.io/minicni created
serviceaccount/minicni created
clusterrolebinding.rbac.authorization.k8s.io/minicni created
configmap/minicni-config created
Warning: spec.template.spec.nodeSelector[beta.kubernetes.io/os]: deprecated since v1.14; use &amp;quot;kubernetes.io/os&amp;quot; instead
Warning: spec.template.metadata.annotations[scheduler.alpha.kubernetes.io/critical-pod]: non-functional in v1.16+; use the &amp;quot;priorityClassName&amp;quot; field instead
daemonset.apps/minicni-node created
[root@k8s-master minicni]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ã€æŸ¥çœ‹minicniéƒ¨ç½²çŠ¶æ€ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# kubectl get pod -A -o wide
 NAMESPACE     NAME                                       READY   STATUS        RESTARTS        AGE     IP               NODE         NOMINATED NODE   READINESS GATES
 default       nginx-85b98978db-qkd6h                     0/1     Completed     5               4d21h   &amp;lt;none&amp;gt;           k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   calico-kube-controllers-7b8458594b-p2fqj   0/1     Terminating   2               4d12h   &amp;lt;none&amp;gt;           k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   coredns-6d8c4cb4d-ck2x5                    0/1     Completed     7               4d22h   &amp;lt;none&amp;gt;           k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   coredns-6d8c4cb4d-mbctj                    0/1     Completed     7               4d22h   &amp;lt;none&amp;gt;           k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   etcd-k8s-master                            1/1     Running       8 (8m14s ago)   4d22h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-apiserver-k8s-master                  1/1     Running       8 (8m4s ago)    4d22h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-controller-manager-k8s-master         1/1     Running       8 (8m14s ago)   4d22h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-proxy-dnsjg                           1/1     Running       8 (8m14s ago)   4d21h   172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-proxy-r84lg                           1/1     Running       8 (8m14s ago)   4d22h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-proxy-tbkx2                           1/1     Running       7 (8m14s ago)   4d21h   172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   kube-scheduler-k8s-master                  1/1     Running       8 (8m14s ago)   4d22h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   minicni-node-8lmxc                         1/1     Running       0               5m17s   172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   minicni-node-sgjmg                         1/1     Running       0               5m17s   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
 kube-system   minicni-node-xslgx                         1/1     Running       0               5m17s   172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºminicniå¤„äºRunningçŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;org370284e&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h1&gt;

&lt;p&gt;1ã€ç¯å¢ƒå‡†å¤‡, åˆ†åˆ«ç»™nodeæ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# k label nodes k8s-master role=master
node/k8s-master labeled
[root@k8s-master minicni]# k label nodes k8s-work1 role=worker
node/k8s-work1 labeled
[root@k8s-master minicni]# k label nodes k8s-work2 role=worker
node/k8s-work2 labeled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ã€åˆ†åˆ«åœ¨ master ä¸ worker èŠ‚ç‚¹éƒ¨ç½² netshoot ä¸ httpbinï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# k apply -f test-pods.yaml
pod/httpbin-master created
pod/netshoot-master created
pod/httpbin-worker created
pod/netshoot-worker created
[root@k8s-master minicni]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3ã€ç¡®ä¿æ‰€æœ‰ pod éƒ½å¯åŠ¨å¹¶å¼€å§‹è¿è¡Œï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# k get pod
NAME                     READY   STATUS              RESTARTS   AGE
httpbin-master           0/1     ContainerCreating   0          8s
httpbin-worker           0/1     ContainerCreating   0          8s
netshoot-master          0/1     ContainerCreating   0          8s
netshoot-worker          0/1     ContainerCreating   0          8s
[root@k8s-master minicni]# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‘ç°çŠ¶æ€ä¸ºContainerCreating, æŸ¥çœ‹podæè¿°æŠ¥é”™ä¸º:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Warning  FailedCreatePodSandBox  36s                kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = [failed to set up sandbox container &amp;quot;7cb17eace85729539db7d7af1a4955a353a14eb7ffa96f84c117ee6633b3e2b5&amp;quot; network for pod &amp;quot;httpbin-master&amp;quot;: networkPlugin cni failed to set up pod &amp;quot;httpbin-master_default&amp;quot; network: error getting ClusterInformation: connection is unauthorized: Unauthorized, failed to clean up sandbox container &amp;quot;7cb17eace85729539db7d7af1a4955a353a14eb7ffa96f84c117ee6633b3e2b5&amp;quot; network for pod &amp;quot;httpbin-master&amp;quot;: networkPlugin cni failed to teardown pod &amp;quot;httpbin-master_default&amp;quot; network: error getting ClusterInformation: connection is unauthorized: Unauthorized]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœå®‰è£…äº†calicoç½‘ç»œæ’ä»¶ï¼Œéœ€è¦åˆ é™¤calico:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl delete -f  &amp;lt;yaml&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿˜è¦å»æ‰€æœ‰èŠ‚ç‚¹etc/cni/net.d/ç›®å½•ä¸‹ åˆ æ‰ä¸calicoç›¸å…³çš„æ‰€æœ‰é…ç½®æ–‡ä»¶, ç„¶åé‡å¯æœºå™¨ã€‚ ä¸ç„¶podèµ·ä¸æ¥ï¼Œä¼šæŠ¥é”™ network: error getting ClusterInformation: connection is unauthorized: Unauthorized .&lt;/p&gt;

&lt;p&gt;4ã€æœ€åå†æŸ¥çœ‹PODéƒ½å˜æˆRunningçŠ¶æ€äº†&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# k get pod -A -o wide
NAMESPACE     NAME                                 READY   STATUS    RESTARTS       AGE     IP               NODE         NOMINATED NODE   READINESS GATES
default       httpbin-master                       1/1     Running   0              20m     10.244.0.4       k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       httpbin-worker                       1/1     Running   0              20m     10.244.2.2       k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       netshoot-master                      1/1     Running   0              20m     10.244.0.5       k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       netshoot-worker                      1/1     Running   0              20m     10.244.2.3       k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
default       nginx-85b98978db-2hzc9               1/1     Running   0              50m     10.244.1.2       k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   coredns-6d8c4cb4d-ck2x5              1/1     Running   9 (24h ago)    6d23h   10.244.0.2       k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   coredns-6d8c4cb4d-mbctj              1/1     Running   9 (24h ago)    6d23h   10.244.0.3       k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   etcd-k8s-master                      1/1     Running   10 (24h ago)   6d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-apiserver-k8s-master            1/1     Running   12 (24h ago)   6d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-controller-manager-k8s-master   1/1     Running   10 (24h ago)   6d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-dnsjg                     1/1     Running   10 (24h ago)   6d22h   172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-r84lg                     1/1     Running   10 (24h ago)   6d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-proxy-tbkx2                     1/1     Running   9 (24h ago)    6d22h   172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   kube-scheduler-k8s-master            1/1     Running   10 (24h ago)   6d23h   172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-5w9fn                   1/1     Running   0              55m     172.25.140.215   k8s-work1    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-jb5cj                   1/1     Running   0              55m     172.25.140.214   k8s-work2    &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
kube-system   minicni-node-kp25h                   1/1     Running   0              55m     172.25.140.216   k8s-master   &amp;lt;none&amp;gt;           &amp;lt;none&amp;gt;
[root@k8s-master minicni]#
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;5ã€ä¹‹åæµ‹è¯•ä»¥ä¸‹å››ç§ç½‘ç»œé€šä¿¡æ˜¯å¦æ­£å¸¸ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;pod åˆ°å®¿ä¸»æœºçš„é€šä¿¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master minicni]# kubectl exec -ti netshoot-master -- /bin/bash
bash-5.1# ping 172.25.140.216
PING 172.25.140.216 (172.25.140.216) 56(84) bytes of data.
64 bytes from 172.25.140.216: icmp_seq=1 ttl=64 time=0.074 ms
64 bytes from 172.25.140.216: icmp_seq=2 ttl=64 time=0.035 ms
64 bytes from 172.25.140.216: icmp_seq=3 ttl=64 time=0.033 ms
64 bytes from 172.25.140.216: icmp_seq=4 ttl=64 time=0.043 ms
64 bytes from 172.25.140.216: icmp_seq=5 ttl=64 time=0.048 ms
^C
--- 172.25.140.216 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 3999ms
rtt min/avg/max/mdev = 0.033/0.046/0.074/0.014 ms
bash-5.1#
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åŒä¸€ä¸ªèŠ‚ç‚¹ pod-to-pod é€šä¿¡&lt;br /&gt;
é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€å°ä¸»æœºä¸Šçš„ pod-to-pod ç½‘ç»œåŒ…é»˜è®¤ä¼šè¢« Linux å†…æ ¸ä¸¢å¼ƒï¼ŒåŸå› æ˜¯ Linux é»˜è®¤ä¼šæŠŠé default ç½‘ç»œå‘½åç©ºé—´çš„ç½‘ç»œåŒ…çœ‹ä½œæ˜¯å¤–éƒ¨æ•°æ®åŒ…ï¼Œå…³äºè¿™ä¸ªé—®é¢˜çš„å…·ä½“ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹ stackoverflow ä¸Šçš„è®¨è®ºã€‚ç›®å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªé›†ç¾¤ç»“ç‚¹ä¸Šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨æ·»åŠ ä»¥ä¸‹ iptables è§„åˆ™æ¥è®© pod-to-pod ç½‘ç»œæ•°æ®åŒ…é¡ºåˆ©è½¬å‘ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# iptables -t filter -A FORWARD -s 10.244.0.0/24  -j ACCEPT
[root@k8s-master ~]# iptables -t filter -A FORWARD -d 10.244.0.0/24  -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†è¿›è¡Œæµ‹è¯•:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# kubectl  exec -ti netshoot-master -- /bin/bash
bash-5.1# ping 10.244.0.25
PING 10.244.0.25 (10.244.0.25) 56(84) bytes of data.
64 bytes from 10.244.0.25: icmp_seq=1 ttl=64 time=0.079 ms
64 bytes from 10.244.0.25: icmp_seq=2 ttl=64 time=0.061 ms 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµ‹è¯•é€šä¿¡æ­£å¸¸ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;pod åˆ°å…¶ä»–ä¸»æœºçš„é€šä¿¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# kubectl  exec -ti netshoot-master -- /bin/bash
bash-5.1# ping 172.25.140.214
PING 172.25.140.214 (172.25.140.214) 56(84) bytes of data.

^C
--- 172.25.140.214 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 2999ms
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pingä¸é€šï¼ŒåŸå› æ˜¯é˜¿é‡Œäº‘åº•å±‚ç½‘ç»œå¯¹éæ³•IPé™åˆ¶ï¼Œä¸æ˜¯éšä¾¿é…ä¸ªIPå°±å¯ä»¥é€šï¼Œå¦‚éœ€é€šå¯ä»¥è€ƒè™‘overlayå¦‚calicoæˆ–æœ¬åœ°è™šæ‹Ÿæœºæ­å»ºæ–¹å¼ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è·¨ä¸€ä¸ªèŠ‚ç‚¹ pod-to-pod é€šä¿¡&lt;br /&gt;
å¯¹äºè·¨èŠ‚ç‚¹çš„ pod-to-pod ç½‘ç»œåŒ…ï¼Œéœ€è¦åƒ Calico é‚£æ ·æ·»åŠ å®¿ä¸»æœºçš„è·¯ç”±è¡¨ï¼Œä¿è¯å‘å¾€å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ pod æµé‡ç»è¿‡èŠ‚ç‚¹çš„è½¬å‘ã€‚ç›®å‰è¿™äº›è·¯ç”±è¡¨éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ip route add 10.244.2.0/24  via 172.25.140.214 dev eth0 #run on master 
ip route add 10.244.0.0/24  via 172.25.140.216 dev eth0 #run on worker
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†æµ‹è¯•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@k8s-master ~]# kubectl  exec -ti netshoot-master -- /bin/bash
bash-5.1# ping 10.244.2.11
PING 10.244.2.11 (10.244.2.11) 56(84) bytes of data.

^C
--- 10.244.2.11 ping statistics ---
108 packets transmitted, 0 received, 100% packet loss, time 106996ms    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç°è±¡ä¸åŸç†åŒä¸Šã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a id=&#34;orgb51c532&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;faq&#34;&gt;FAQ&lt;/h1&gt;

&lt;p&gt;&lt;a id=&#34;orgdc842c7&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;cannot-find-package-ç¼–è¯‘ä¸è¿‡&#34;&gt;cannot find package ç¼–è¯‘ä¸è¿‡&lt;/h2&gt;

&lt;p&gt;å½“å‡ºç°å¦‚ä¸‹é”™è¯¯æ—¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ make build
Building the minicni on amd64...
cmd/main.go:8:2: cannot find package &amp;quot;github.com/morvencao/minicni/pkg/args&amp;quot; in any of:
 /usr/local/go/src/github.com/morvencao/minicni/pkg/args (from $GOROOT)
 /Users/mosp/goget/src/github.com/morvencao/minicni/pkg/args (from $GOPATH)
cmd/main.go:9:2: cannot find package &amp;quot;github.com/morvencao/minicni/pkg/handler&amp;quot; in any of:
 /usr/local/go/src/github.com/morvencao/minicni/pkg/handler (from $GOROOT)
 /Users/mosp/goget/src/github.com/morvencao/minicni/pkg/handler (from $GOPATH)
make: *** [build] Error 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éœ€è¦æŠŠGO111MODULE=onæˆ–autoï¼Œæ‰èƒ½ä½¿ç”¨Go moduleåŠŸèƒ½ï¼Œå¯åœ¨.bashrcæˆ–.zshrcé‡ŒåŠ ä¸Šï¼šexport GO111MODULE=auto&lt;br /&gt;
è¯¦è§&lt;a href=&#34;http://www.ay1.cc/article/18635.html&#34;&gt;goè‡ªåŠ¨ä¸‹è½½æ‰€æœ‰çš„ä¾èµ–åŒ…go moduleä½¿ç”¨è¯¦è§£_Golang&lt;/a&gt;ï¼š&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga2808f1&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;build-constraints-exclude-all-go-files-in&#34;&gt;build constraints exclude all Go files in&lt;/h2&gt;

&lt;p&gt;å½“å‡ºç°å¦‚ä¸‹é”™è¯¯æ—¶:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ make build
Building the minicni on amd64...
go build github.com/containernetworking/plugins/pkg/ns: build constraints exclude all Go files in /Users/mosp/goget/pkg/mod/github.com/containernetworking/plugins@v1.1.1/pkg/ns
make: *** [build] Error 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éœ€è¦è®¾ç½®å¦‚ä¸‹ä¸¤ä¸ªå˜é‡ï¼š&lt;br /&gt;
export GOOS=â€œlinuxâ€ã€‚å³ï¼šä¸èƒ½ä¸ºdarwin&lt;br /&gt;
export CGO_ENABLED=â€œ1â€ã€‚&lt;br /&gt;
è¯¦è§ï¼š&lt;a href=&#34;https://blog.csdn.net/weixin_42845682/article/details/124568715&#34;&gt;build constraints exclude all Go files in xxx/xxx/xxx&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a id=&#34;orga4ae153&#34;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å‚è€ƒèµ„æ–™&#34;&gt;å‚è€ƒèµ„æ–™&lt;/h1&gt;

&lt;p&gt;ã€01ã€‘ &lt;a href=&#34;https://blog.csdn.net/u012772803/article/details/113703029&#34;&gt;find -print0å’Œxargs -0åŸç†åŠç”¨æ³•&lt;/a&gt;]&lt;br /&gt;
ã€02ã€‘ &lt;a href=&#34;https://zhuanlan.zhihu.com/p/411181637&#34;&gt;Goè¯­è¨€importåˆ†ç»„ç®¡ç†åˆ©å™¨: goimports-reviser&lt;/a&gt;&lt;br /&gt;
ã€03ã€‘ &lt;a href=&#34;https://morven.life/posts/create-your-own-cni-with-golang/&#34;&gt;ä½¿ç”¨ Go ä»é›¶å¼€å§‹å®ç° CNI&lt;/a&gt;&lt;br /&gt;
ã€04ã€‘ &lt;a href=&#34;https://blog.csdn.net/a5534789/article/details/112848404&#34;&gt;centOSå†…ç½‘å®‰è£…kubernetesé›†ç¾¤&lt;/a&gt;&lt;br /&gt;
ã€05ã€‘ &lt;a href=&#34;https://zhuanlan.zhihu.com/p/415032187&#34;&gt;Linux è·¯ç”±è¡¨(RIBè¡¨ã€FIBè¡¨)ã€ARPè¡¨ã€MACè¡¨æ•´ç†&lt;/a&gt;]&lt;br /&gt;
ã€06ã€‘ &lt;a href=&#34;https://www.jianshu.com/p/75704eb30eff&#34;&gt;æŸ¥çœ‹CNIä¸­çš„veth pair&lt;/a&gt;&lt;br /&gt;
ã€07ã€‘ &lt;a href=&#34;https://mp.weixin.qq.com/s/7t_MoZ0quJF50VoIwqvKyQ&#34;&gt;ä¸€æ–‡åƒé€ K8S ç½‘ç»œæ¨¡å‹&lt;/a&gt;&lt;br /&gt;
ã€08ã€‘ &lt;a href=&#34;https://blog.csdn.net/elihe2011/article/details/122926399&#34;&gt;K8S ç½‘ç»œCNI&lt;/a&gt;&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
