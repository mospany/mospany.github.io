<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <base href="http://mospany.github.io/">
  <title>K8S项目实践(12): GPU共享方案Time Slicing - 墨斯潘園</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  <meta name="keywords" content="K8S,GPU,">
  <meta name="description" content="本文主要分享 GPU 共享方案，包括如何安装、配置以及使用，最后通过分析源码了 TimeSlicing 的具体实现。通过配置 TimeSlicing 可以实现 Pod 共享一块物理 GPU(使用GRID GP">
  <meta name="author" content="mospan">
  <meta itemprop="name" content="K8S项目实践(12): GPU共享方案Time Slicing - 墨斯潘園">
  <meta itemprop="description" content="本文主要分享 GPU 共享方案，包括如何安装、配置以及使用，最后通过分析源码了 TimeSlicing 的具体实现。通过配置 TimeSlicing 可以实现 Pod 共享一块物理 GPU(使用GRID GP">
  <meta itemprop="image" content="http://mospany.github.io/img/author.jpg">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mospan" />
  <meta name="twitter:title" content="K8S项目实践(12): GPU共享方案Time Slicing - 墨斯潘園" />
  
  <meta name="twitter:description" content="">
  <link rel="shortcut icon" href="img/favicon.ico"/>
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon.png" />
  <link rel="stylesheet" href="highlight/styles/github.css">
  <script src="highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <link rel="stylesheet" href="font/hack/css/hack.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <header>
    <div>
  
  <div id="imglogo">
    <a href="http://mospany.github.io/"><img src="http://mospany.github.io/img/logo.jpg" alt="墨斯潘園" title="墨斯潘園"/></a>
  </div>
  
  <div id="textlogo">
    <h1 class="site-name"><a href="http://mospany.github.io/" title="墨斯潘園">墨斯潘園</a></h1>
    <h2 class="blog-motto">技术改变生活，学习成就未来</h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
  <nav class="animated">
    <ul>
      
      <li><a href="/">首页</a></li> 
      
      <li><a href="/about">关于</a></li> 
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder="搜索">
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="http://mospany.github.io/2024/01/31/gpu-time-slicing/" title="K8S项目实践(12): GPU共享方案Time Slicing" itemprop="url">K8S项目实践(12): GPU共享方案Time Slicing</a>
  </h1>
  <p class="article-author">By 
    
      <a href="http://blog.mospan.cn" title="mospan">mospan</a>
    
  </p>
  <p class="article-time">
    <time datetime="2024-01-31 19:31:10 &#43;0800 CST" itemprop="datePublished">2024年01月31日</time>
  </p>
</header>

	<div class="article-content">
    
    

<p>本文主要分享 GPU 共享方案，包括如何安装、配置以及使用，最后通过分析源码了 TimeSlicing 的具体实现。通过配置 TimeSlicing 可以实现 Pod 共享一块物理 GPU(使用GRID GPU代替)，以提升资源利用率。</p>

<h1 id="1-为什么需要-gpu-共享-切分等方案">1. 为什么需要 GPU 共享、切分等方案？</h1>

<p>开始之前我们先思考一个问题，<em>为什么需要 GPU 共享、切分等方案?</em></p>

<p>或者说是另外一个问题：<em>明明直接在裸机环境使用，都可以多个进程共享 GPU，怎么到 k8s 环境就不行了。</em></p>

<h2 id="1-1-资源感知">1.1. 资源感知</h2>

<p>首先在 k8s 中资源是和节点绑定的，对于 GPU 资源，我们使用 NVIDIA 提供的 device-plugin 进行感知，并上报到 kube-apiserver,这样我们就能在 Node 对象上看到对应的资源了。</p>

<p>就像这样：</p>

<pre><code class="language-bash">root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     8
  pods:               110
</code></pre>

<p>可以看到，该节点除了基础的 cpu、memory 之外，还有一个nvidia.com/gpu: 8 信息，表示该节点上有 8 个 GPU。</p>

<h2 id="1-2-资源申请">1.2. 资源申请</h2>

<p>然后我们就可以在创建 Pod 时申请对应的资源了，比如申请一个 GPU：</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
spec:
  containers:
  - name: gpu-container
    image: nvidia/cuda:11.0-base   # 一个支持 GPU 的镜像
    resources:
      limits:
        nvidia.com/gpu: 1          # 申请 1 个 GPU
    command: [&quot;nvidia-smi&quot;]         # 示例命令，显示 GPU 的信息
  restartPolicy: OnFailure
</code></pre>

<p>apply 该 yaml 之后，kube-scheduler 在调度该 Pod 时就会将其调度到一个拥有足够 GPU 资源的 Node 上。</p>

<p>同时该 Pod 申请的部分资源也会标记为已使用，不会在分配给其他 Pod。</p>

<p>到这里，问题的答案就已经很明显的。</p>

<ul>
<li>1）device-plugin 感知到节点上的物理 GPU 数量，上报到 kube-apiserver</li>
<li>2）kube-scheduler 调度 Pod 时会根据 pod 中的 Request 消耗对应资源</li>
</ul>

<p>即：<em>Node 上的 GPU 资源被 Pod 申请之后，在 k8s 中就被标记为已消耗了，后续创建的 Pod 会因为资源不够导致无法调度。</em></p>

<p>实际上：可能 GPU 性能比较好，可以支持多个 Pod 共同使用，但是因为 k8s 中的调度限制导致多个 Pod 无法正常共享。</p>

<p>因此，我们才需要 GPU 共享、切分等方案。</p>

<h1 id="2-什么是-time-slicing-方案">2. 什么是 Time Slicing 方案</h1>

<p>NVIDIA 提供的 <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html">Time-Slicing GPUs in Kubernetes</a> 是一种通过 oversubscription(超额订阅) 来实现 GPU 共享的策略，这种策略能让多个任务在同一个 GPU 上进行，而不是每个任务都独占一个 GPU。</p>

<blockquote>
<p>虽然方案名称叫做 Time Slicing，但是device-plugin 的实现上和时间切片没有任何关系，实际上是一个 GPU 超卖方案。</p>
</blockquote>

<h2 id="2-1-为什么要叫time-slicing-时间片">2.1. 为什么要叫Time Slicing(时间片)？</h2>

<p>虽然实现上只是 *oversubscription(超额订阅)*，但是名称中的 Time Slicing(时间片)指的是 GPU 本身的时间片调度。</p>

<p>例如：A、B、C 三个进程共享 GPU，三个进程同时把 CUDA 任务发射到 GPU 上去，GPU 并不会同时执行，而是采用时间片轮转调度的方式。</p>

<p>首先第一个时间片，A 任务被执行，接着第二个时间片，执行 B 任务，第三个时间片， C 任务将被执行。</p>

<blockquote>
<p>时间片是依次进行轮转调度的，分别执行A、B、C中的任务。</p>
</blockquote>

<h2 id="2-2-效果">2.2. 效果</h2>

<p>比如节点上只有一个物理 GPU，正常安装 GPU Operator 之后，device plugin 检测到该节点上有 1 个 GPU，上报给 kubelet，然后 kubelet 更新到 kube-apiserver，我们就可以在 Node 对象上看到了：</p>

<pre><code class="language-bash">root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     1
  pods:               110
</code></pre>

<p>此时，创建一个 Pod 申请 1 个 GPU 之后，第二个 Pod 就无法使用了，因为 GPU 资源不足无法调度。</p>

<p><em>但是 Time Slicing 可以进行 oversubscription 设置，将 device-plugin 上报的 GPU 数量进行扩大。</em></p>

<p>比如将其数量放大 10 倍，device plugin 就会上报该节点有 1*10 = 10 个 GPU，最终 kube-apiserver 则会记录该节点有 10 个 GPU：</p>

<pre><code class="language-bash">root@liqivm:~# k describe node gpu01|grep Capacity -A 7
Capacity:
  cpu:                128
  ephemeral-storage:  879000896Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             1056457696Ki
  nvidia.com/gpu:     10
  pods:               110
</code></pre>

<p>这样，就可以供 10 个 Pod 使用了。</p>

<p>当然了，Time Slicing 方案也有缺点：多个 Pod 之间没有内存或者故障隔离，完全的共享，能使用多少内存和算力全靠多个 Pod 自行竞争。</p>

<blockquote>
<p>ps：就和直接在宿主机上多个进程共享一个 GPU 基本一致</p>
</blockquote>

<h1 id="3-time-slicing-demo">3. Time Slicing Demo</h1>

<p>Time Slicing 由于是 NVIDIA 的方案，因此使用起来比较简单，只需要在部署完成 GPU Operator 之后进行配置即可。</p>

<p>首先参考这篇文章完成 GPU Operator 的部署 –&gt; GPU 环境搭建指南：<a href="http://blog.mospan.cn/2024/01/17/gpu-operator/">使用 GPU Operator搭建AI算力环境</a></p>

<p>然后即可开始配置 TimeSlicing。</p>

<p>整体配置分为以下 3 个步骤：</p>

<ul>
<li>1）创建 TimeSlicing 配置

<ul>
<li>根据官方文档描述，修改了 TimeSlicing 配置之后，device plugin Pod 不会自动重启，因此新的配置不会生效,需要手动重启对应 Pod。</li>
</ul></li>
<li>2）修改集群策略开启 Time Slicing，并指定让 device-plugin 使用第一步中创建的配置

<ul>
<li>这里则是通过 Configmap 名称来指定</li>
</ul></li>
<li>3）（可选）给要使用 GPU TimeSlicing 的节点打上对应 label，实现不同 Node 使用不同策略

<ul>
<li>比如不同节点上的 GPU 不同，那么可以根据 GPU 的算力或者内存情况设置不同的副本数以合理利用资源</li>
<li>如果都是统一 GPU，则使用集群级别的统一配置即可</li>
</ul></li>
</ul>

<h2 id="3-1-配置开启-timeslicing">3.1. 配置开启 TimeSlicing</h2>

<h3 id="3-1-1-创建-timeslicing-配置">3.1.1. 创建 TimeSlicing 配置</h3>

<p>使用一个单独的 Configmap 来存放 TimeSlicing 的配置。</p>

<p>这里使用集群级别的统一配置，配置文件 time-slicing-config-all.yaml 完整内容如下：</p>

<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-all
data:
  any: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        renameByDefault: false
        failRequestsGreaterThanOne: false
        resources:
          - name: nvidia.com/gpu
            replicas: 4    
</code></pre>

<p>具体配置含义参考官方文档：<a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html#about-configuring-gpu-time-slicing">about-configuring-gpu-time-slicing</a></p>

<ul>
<li>data.<key>： 配置的名字，可以为不同 Node 设置单独配置，后续通过名称引用对应配置。

<ul>
<li>后续开启 TimeSlicing 时则根据 key 指定使用不同配置</li>
<li>这里我们使用集群统一配置，因此创建一个 key 即可</li>
</ul></li>
<li>flags.migStrategy：配置开启时间片之后如何处理 MIG 设备，默认为 none</li>
<li>renameByDefault：是否对 GPU 资源改名。

<ul>
<li>设置为 true 之后，会使用<resource-name>.shared 替代原本的 <resource-name>。例如 nvidia.com/gpu 会变成 nvidia.com/gpu.shared ，显式告知使用者这是共享 GPU。</li>
<li>默认为 false，即不改资源类型名，不过 Node 上的 label 也会改，比如使用时间片之前是nvidia.com/gpu.product=Tesla-T4, 使用后就会变成nvidia.com/gpu.product=Tesla-T4-SHARED 这样依旧可以通过 nodeSelector 来限制 Pod 调度节点，来控制是否使用共享的 GPU</li>
<li>推荐使用 fasle 即可</li>
</ul></li>
<li>failRequestsGreaterThanOne：开启后，当 Pod 请求 1 个以上的 shared GPU 时直接报错 UnexpectedAdmissionError。这个字段是通过报错的方式告诉使用者，请求多个 shared GPU 并不会增加 Pod 对该共享 GPU 的占用时间。</li>
<li>resources.name：要通过时间分片提供访问的资源类似，比如nvidia.com/gpu</li>
<li>resources.replicas：可共享访问的资源数量，比如这里指定的 4 也就是 1 个该类型的 GPU 可以供 4 个 Pod 共享访问，也就是最终 Pod 上看到的 GPU 数量是物理 GPU 数量的 4 倍。</li>
</ul>

<p>将配置 Apply 到 gpu-operator 所在的 namespace</p>

<pre><code class="language-bash">kubectl create -n gpu-operator -f time-slicing-config-all.yaml
</code></pre>

<h3 id="3-1-2-修改集群策略">3.1.2. 修改集群策略</h3>

<p>修改clusterpolicies.nvidia.com/cluster-policy 对象，让 device plugin 使用上一步创建的配置。</p>

<pre><code class="language-bash">kubectl patch clusterpolicies.nvidia.com/cluster-policy \
    -n gpu-operator --type merge \
    -p '{&quot;spec&quot;: {&quot;devicePlugin&quot;: {&quot;config&quot;: {&quot;name&quot;: &quot;time-slicing-config-all&quot;, &quot;default&quot;: &quot;any&quot;}}}}'
</code></pre>

<ul>
<li>name：time-slicing-config-all 指定了配置文件对应的 Configmap 名称</li>
<li>default：any：表示默认配置为这个 Configmap 中的 key 为 any 的配置
修改后 gpu-feature-discovery 和 nvidia-device-plugin-daemonset pod 会重启，使用以下命令查看重启过程</li>
</ul>

<pre><code class="language-bash">kubectl get events -n gpu-operator --sort-by='.lastTimestamp'
</code></pre>

<p><img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-215925170.png" alt="picture 0" /></p>

<h2 id="3-2-验证-timeslicing-是否生效">3.2. 验证 TimeSlicing 是否生效</h2>

<h3 id="3-2-1-查看-node-上的-gpu-信息">3.2.1. 查看 Node 上的 GPU 信息</h3>

<p>首先查看一下 Node 信息，确认 TimeSlicing 生效了</p>

<pre><code class="language-bash">kubectl  describe node k8s-worker1 | grep Capacity -A20
</code></pre>

<p><img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-221241899.png" alt="picture 1" /><br />
gpu为1*4=4显示成功。</p>

<pre><code class="language-bash">...
Labels:
                  nvidia.com/gpu.count=1
                  nvidia.com/gpu.product=GRID-T4-2Q-SHARED
                  nvidia.com/gpu.replicas=4
Capacity:
  nvidia.com/gpu: 4
  ...
Allocatable:
  nvidia.com/gpu: 4
  ...
</code></pre>

<p>增加了几个 label，</p>

<ul>
<li>nvidia.com/gpu.product=GRID-T4-2Q-SHARED</li>
<li>nvidia.com/gpu.replicas=4</li>
</ul>

<p>根据nvidia.com/gpu.count=1 可知，节点上有 1 张 GPU，然后由于使用了时间片，且配置的nvidia.com/gpu.replicas=4 副本数为 4，因此最终节点上 device plugin 上报的 GPU 数量就是 1*4 = 4 个。</p>

<h2 id="3-3-验证-gpu-能否正常使用">3.3. 验证 GPU 能否正常使用</h2>

<p>创建一个 Deployment 来验证，GPU 能否正常使用。</p>

<p>这里副本数指定为 2，因为集群里只有 1 张 GPU，如果 TimeSlicing 未生效，那么有一个 Pod 肯定会应为拿不到 GPU 资源而 pending。</p>

<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: time-slicing-verification
  labels:
    app: time-slicing-verification
spec:
  replicas: 2
  selector:
    matchLabels:
      app: time-slicing-verification
  template:
    metadata:
      labels:
        app: time-slicing-verification
    spec:
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
      hostPID: true
      containers:
        - name: cuda-sample-vector-add
          image: &quot;nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2&quot;
          command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot;]
          args:
            - while true; do /tmp/vectorAdd; done
          resources:
           limits:
             nvidia.com/gpu: 1
</code></pre>

<p>会启动 2个 Pod，</p>

<p>查看情况
<img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250201-224915379.png" alt="picture 2" /></p>

<p>2 个 Pod 都启动了，说明时间片时成功的。</p>

<p>随便查看一个 Pod 的日志</p>

<pre><code class="language-bash">root@k8s-master1 timeSlicing]# kubectl logs time-slicing-verification-56487b549d-nqn6s 
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
...
</code></pre>

<p>有 Test PASSED 则说明成功了。</p>

<p>说明 TimeSlicing 配置生效了。</p>

<h1 id="4-使用-node-级别的单独配置">4. 使用 Node 级别的单独配置</h1>

<p>前面只创建了一个名称为 any 的配置，并在 clusterpolicy 中指明了使用该配置为默认配置，因此集群中的全部节点都会使用该配置来做时间片。</p>

<p>但是可能*集群中不同节点上的 GPU 型号不同*，因此需要共享分副本数可以调整，性能好的副本数就调大一点，性能差的就小一点。</p>

<p>本章主要记录怎么为不同的节点使用不同的配置。</p>

<blockquote>
<p>实际上是为不同的 GPU 准备不同的配置。</p>
</blockquote>

<h2 id="4-1-创建时间片配置">4.1. 创建时间片配置</h2>

<p>同样的创建 TimeSlicing 配置，不过这次 Configmap 中写了两个配置，而且是以 GPU 型号命名的</p>

<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-fine
data:
  a100-40gb: |-
    version: v1
    flags:
      migStrategy: mixed
    sharing:
      timeSlicing:
        resources:
        - name: nvidia.com/gpu
          replicas: 8
        - name: nvidia.com/mig-1g.5gb
          replicas: 2
        - name: nvidia.com/mig-2g.10gb
          replicas: 2
        - name: nvidia.com/mig-3g.20gb
          replicas: 3
        - name: nvidia.com/mig-7g.40gb
          replicas: 7    
  tesla-t4: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        resources:
        - name: nvidia.com/gpu
          replicas: 5
</code></pre>

<p>可以看到，分别对 A100 和 Tesla T4 这两种 GPU 做了配置。</p>

<ul>
<li>a100-40gb：A100 支持 MIG，因此增加了 MIG 部分的配置，若没有则指定为 none 即可

<ul>
<li>然后根据 MIG 实例分别指定不同的 replicas 数</li>
</ul></li>

<li><p>tesla-t4：Tesla T4 GPU 性能比较差，因此 replicas 指定为 4 即可
将配置 Apply 到 gpu-operator 所在的 namespace</p>

<pre><code class="language-bash">kubectl  create -n gpu-operator -f time-slicing-config-fine.yaml 
</code></pre>

<p><img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-201203558.png" alt="picture 3" /></p>

<h2 id="4-2-修改集群策略">4.2. 修改集群策略</h2>

<p>同样的，修改一下 cluster-policy 指定 device plugin 使用的 Configmap，这次与之前的区别在于，*这里没有指定 default 配置*。</p>

<pre><code class="language-bash">kubectl patch clusterpolicies.nvidia.com/cluster-policy \
-n gpu-operator --type merge \
-p '{&quot;spec&quot;: {&quot;devicePlugin&quot;: {&quot;config&quot;: {&quot;name&quot;: &quot;time-slicing-config-fine&quot;}}}}'
</code></pre></li>
</ul>

<p>没有指定 default 时，device-plugin 则会根据 node 上的 label (nvidia.com/device-plugin.config)来获取要使用的配置。</p>

<h2 id="4-3-为节点打-label">4.3. 为节点打 label</h2>

<p>在节点上打上下面的 label，这样该节点上的 device plugin 就会根据该 label 的 value 来使用对应名字的配置了。</p>

<p>比如这里，就是有这个 label 的节点就使用名叫 tesla-t4 的配置。</p>

<pre><code class="language-bash">kubectl label node k8s-worker1 nvidia.com/device-plugin.config=tesla-t4
</code></pre>

<p>一般都是以 GPU 型号命名，然后给使用该 GPU 的节点都打上对应 label,这样便于查看。</p>

<h2 id="4-4-验证">4.4. 验证</h2>

<p>查看node节点gpu卡数是否已为5.</p>

<pre><code class="language-bash">kubectl  describe node k8s-worker1 | grep Capacity -A20
</code></pre>

<p><img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-203630774.png" alt="picture 4" /></p>

<h1 id="5-关闭-timeslicing">5. 关闭 TimeSlicing</h1>

<p>想关闭 TimeSlicing 配置也很简单，直接更新 集群策略 把 device plugin 下的 config 这一段去掉即可。</p>

<pre><code class="language-yaml">  devicePlugin:
    config:
      default: any
      name: time-slicing-config-fine
    enabled: true
    env:
    - name: PASS_DEVICE_SPECS
      value: &quot;true&quot;
    - name: FAIL_ON_INIT_ERROR
      value: &quot;true&quot;
</code></pre>

<p>命令如下：</p>

<pre><code class="language-bash">kubectl patch clusterpolicies.nvidia.com/cluster-policy -n gpu-operator --type json -p '[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/devicePlugin/config&quot;}]'
</code></pre>

<p>然后重启一下 device-plugin pod</p>

<pre><code class="language-bash">kubectl rollout restart -n gpu-operator daemonset/nvidia-device-plugin-daemonset
</code></pre>

<p>不出意外的话就关掉了，再次查看 Pod 信息，GPU 就变成了物理 GPU 数量，说明关闭成功。
<img src="post/2024/images/2024-01-31-gpu-time-slicing/IMG_20250204-204613867.png" alt="picture 5" /></p>

<h1 id="6-源码分析">6. 源码分析</h1>

<p>简单看下源码，分析 TimeSlicing 是怎么实现的。</p>

<p>首先是 device-plugin 可以接收的配置</p>

<pre><code class="language-go">// api/config/v1/config.go#L32
// Config is a versioned struct used to hold configuration information.
type Config struct {
	Version   string    `json:&quot;version&quot;             yaml:&quot;version&quot;`
	Flags     Flags     `json:&quot;flags,omitempty&quot;     yaml:&quot;flags,omitempty&quot;`
	Resources Resources `json:&quot;resources,omitempty&quot; yaml:&quot;resources,omitempty&quot;`
	Sharing   Sharing   `json:&quot;sharing,omitempty&quot;   yaml:&quot;sharing,omitempty&quot;`
}
</code></pre>

<p>这也就是我们在 clusterPolicy 中配置的：</p>

<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config-all
data:
  any: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        renameByDefault: false
        failRequestsGreaterThanOne: false
        resources:
          - name: nvidia.com/gpu
            replicas: 4    
</code></pre>

<p>这里我们关注 resources 中的 replicas 参数，正是这个参数定义了 oversubscription(超额订阅) 的额度。</p>

<pre><code class="language-yaml">        resources:
          - name: nvidia.com/gpu
            replicas: 4
</code></pre>

<p>看下代码中是什么生效的</p>

<pre><code class="language-go">// internal/rm/device_map.go#L282

// updateDeviceMapWithReplicas returns an updated map of resource names to devices with replica
// information from the active replicated resources config.
func updateDeviceMapWithReplicas(replicatedResources *spec.ReplicatedResources, oDevices DeviceMap) (DeviceMap, error) {
	devices := make(DeviceMap)

	// Begin by walking replicatedResources.Resources and building a map of just the resource names.
	names := make(map[spec.ResourceName]bool)
	for _, r := range replicatedResources.Resources {
		names[r.Name] = true
	}

	// Copy over all devices from oDevices without a resource reference in TimeSlicing.Resources.
	for r, ds := range oDevices {
		if !names[r] {
			devices[r] = ds
		}
	}

	// Walk shared Resources and update devices in the device map as appropriate.
	for _, resource := range replicatedResources.Resources {
		r := resource
		// Get the IDs of the devices we want to replicate from oDevices
		ids, err := oDevices.getIDsOfDevicesToReplicate(&amp;r)
		if err != nil {
			return nil, fmt.Errorf(&quot;unable to get IDs of devices to replicate for '%v' resource: %v&quot;, r.Name, err)
		}
		// Skip any resources not matched in oDevices
		if len(ids) == 0 {
			continue
		}

		// Add any devices we don't want replicated directly into the device map.
		for _, d := range oDevices[r.Name].Difference(oDevices[r.Name].Subset(ids)) {
			devices.insert(r.Name, d)
		}

		// Create replicated devices add them to the device map.
		// Rename the resource for replicated devices as requested.
		name := r.Name
		if r.Rename != &quot;&quot; {
			name = r.Rename
		}
		for _, id := range ids {
			for i := 0; i &lt; r.Replicas; i++ {
				annotatedID := string(NewAnnotatedID(id, i))
				replicatedDevice := *(oDevices[r.Name][id])
				replicatedDevice.ID = annotatedID
				replicatedDevice.Replicas = r.Replicas
				devices.insert(name, &amp;replicatedDevice)
			}
		}
	}

	return devices, nil
}
</code></pre>

<p>核心部分如下：</p>

<pre><code class="language-go">for _, id := range ids {
  for i := 0; i &lt; r.Replicas; i++ {
    annotatedID := string(NewAnnotatedID(id, i))
    replicatedDevice := *(oDevices[r.Name][id])
    replicatedDevice.ID = annotatedID
    replicatedDevice.Replicas = r.Replicas
    devices.insert(name, &amp;replicatedDevice)
  }
}
</code></pre>

<p>可以看到，这里是双层 for 循环，对 device 数量进行了一个复制的操作，这样每张 GPU 都可以被使用 Replicas 次了。</p>

<p>其他属性都没变，只是把 deviceID 进行了处理，便于区分</p>

<pre><code class="language-go">// NewAnnotatedID creates a new AnnotatedID from an ID and a replica number.
func NewAnnotatedID(id string, replica int) AnnotatedID {
	return AnnotatedID(fmt.Sprintf(&quot;%s::%d&quot;, id, replica))
}
</code></pre>

<p>然后在真正挂载时则进行 split 拿到 id 和 replicas 信息</p>

<pre><code class="language-go">// Split splits a AnnotatedID into its ID and replica number parts.
func (r AnnotatedID) Split() (string, int) {
	split := strings.SplitN(string(r), &quot;::&quot;, 2)
	if len(split) != 2 {
		return string(r), 0
	}
	replica, _ := strconv.ParseInt(split[1], 10, 0)
	return split[0], int(replica)
}
</code></pre>

<p>至此，我们就分析完了 TimeSlicing 的具体实现，其实很简单，就是根据配置的 replicas 参数对 device plugin 感知到的设备进行复制，并在 DeviceID 使用特定格式进行标记便于区分。</p>

<h1 id="7-小结">7. 小结</h1>

<p>本文主要分享了 NVIDIA Time Slicing 这个 GPU 共享方案,包括即实现原理，以及配置和使用方式。</p>

<p>最后通过分析源码的方式探索了 TimeSlicing 的代码实现。</p>

<h2 id="7-1-为什么需要-gpu-共享-切分">7.1. 为什么需要 GPU 共享、切分？</h2>

<p>在 k8s 中使用默认 device plugin 时，GPU 资源和物理 GPU 是一一对应的，导致一个物理 GPU 被一个 Pod 申请后，其他 Pod 就无法使用了。</p>

<p>为了提高资源利用率，因此我们需要 GPU 共享、切分等方案。</p>

<h2 id="7-2-什么是-timeslicing">7.2. 什么是 TimeSlicing？</h2>

<p>TimeSlicing 是一种通过 oversubscription(超额订阅) 来实现 GPU 共享的策略，这种策略能让多个任务在同一个 GPU 上进行，而不是每个任务都独占一个 GPU。</p>

<h2 id="7-3-如何开启-timeslicing">7.3. 如何开启 TimeSlicing</h2>

<ul>
<li><p>1）创建 TimeSlicing 配置</p>

<ul>
<li>可以是集群统一配置，也可以是 Node 级别的配置，主要根据不同节点上的 GPU 进行配置</li>
<li>如果集群中所有节点 GPU 型号都一致，则使用集群统一配置即可，若不一致则根据 节点上的 GPU 性能修改配置</li>
</ul></li>

<li><p>2）修改 cluster-policy，增加 TimeSlicing 相关配置</p>

<ul>
<li>作为这两个步骤之后，TimeSlicing 就开启了，再次查看 Node 信息时会发现 GPU 数量变多了。</li>
</ul></li>
</ul>

<h2 id="7-4-timeslicing-实现原理">7.4. TimeSlicing 实现原理</h2>

<p>根据配置的 replicas 参数对 device plugin 感知到的设备进行复制，并在 DeviceID 使用特定格式进行标记便于区分。</p>

    <div style="border: 1px dashed #e0e0e0; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
  <div style="float:right;margin-top:0px;">
    <img src="/img/qrcode.jpg" width="129px" height="129px"/>
    <div style="text-align:center;">微信扫一扫</div>
  </div>
  <div style="float:left;margin-top:0px;">
    <img src="/img/rewardcode.jpg" width="129px" height="129px"/>
  </div>
  <div>
    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.mospan.cn/">mospan</a>
      <br />微信关注：墨斯潘園
      <br />本文出处：<a target="_blank" href="http://mospany.github.io/2024/01/31/gpu-time-slicing/">http://mospany.github.io/2024/01/31/gpu-time-slicing/</a>
      <br />
      文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
  </div>
</div>


	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="/tags/k8s">K8S</a>
  
  <a href="/tags/gpu">GPU</a>
  
</div>



<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="/categories/k8s">K8S</a>
  
  <a class="article-category-link" href="/categories/gpu">GPU</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="http://mospany.github.io/2024/01/31/gpu-time-slicing/" data-title="K8S项目实践(12): GPU共享方案Time Slicing" data-tsina="3833537679" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  





<div id="git-comments"></div>
<link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
<script src="https://billts.site/js/gitment.js"></script>
<script>
var gitment = new Gitment({
  id: '<%= page.date %>',
  owner: 'mospany',
  repo: 'mospan-hugo-blog-gitment',
  oauth: {
    client_id: '0cafe299c964f0af2d1e',
    client_secret: 'ec47ee9481210935a662298791c31da203694a8f',
  },
})
gitment.render('git-comments')
</script>    


</div>

    <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>
<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
  

<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
    <li><a href="http://mospany.github.io/categories/%e4%ba%91%e8%ae%a1%e7%ae%97" title="云计算">云计算<sup>7</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e4%ba%ba%e5%b7%a5%e6%99%ba%e8%83%bd" title="人工智能">人工智能<sup>12</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e5%b7%a5%e5%85%b7%e4%bd%bf%e7%94%a8" title="工具使用">工具使用<sup>3</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" title="技术文章">技术文章<sup>47</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" title="生活记录">生活记录<sup>1</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" title="职场人生">职场人生<sup>1</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" title="读书笔记">读书笔记<sup>2</sup></a></li>
    
  </ul>
</div>



  

<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
      
			<li><a href="http://mospany.github.io/tags/" title=""><sup>6</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/dns" title="dns">dns<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/dpdk" title="dpdk">dpdk<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/emacs" title="emacs">emacs<sup>5</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/gpu" title="gpu">gpu<sup>6</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/hugo" title="hugo">hugo<sup>3</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/ipv6" title="ipv6">ipv6<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/k8s" title="k8s">k8s<sup>20</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/linux" title="linux">linux<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/openresty" title="openresty">openresty<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/org-mode" title="org-mode">org-mode<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/pango" title="pango">pango<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/redis" title="redis">redis<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/spacemacs" title="spacemacs">spacemacs<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/vim" title="vim">vim<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/vue" title="vue">vue<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/xns" title="xns">xns<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/yaml" title="yaml">yaml<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e4%ba%91%e8%ae%a1%e7%ae%97" title="云计算">云计算<sup>6</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e4%ba%92%e8%81%94%e7%bd%91" title="互联网">互联网<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e4%ba%ba%e5%b7%a5%e6%99%ba%e8%83%bd" title="人工智能">人工智能<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%89%8d%e7%ab%af" title="前端">前端<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%8d%9a%e5%ae%a2" title="博客">博客<sup>7</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%ad%98%e5%82%a8" title="存储">存储<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%b7%a5%e5%85%b7" title="工具">工具<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%be%ae%e4%bf%a1" title="微信">微信<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" title="技术文章">技术文章<sup>4</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e6%9e%b6%e6%9e%84" title="架构">架构<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e7%8b%ac%e7%ab%8b" title="独立">独立<sup>3</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" title="生活记录">生活记录<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" title="职场人生">职场人生<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" title="读书笔记">读书笔记<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%82%ae%e7%ae%b1" title="邮箱">邮箱<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%9d%a2%e8%af%95" title="面试">面试<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%a1%b9%e7%9b%ae%e5%ae%9e%e8%b7%b5" title="项目实践">项目实践<sup>4</sup></a></li>
      
		</ul>
</div>



    <div class="linkslist">
  <p class="asidetitle">我的关注</p>
    <ul>
          <li>
            	<a href="http://www.csdn.net/" target="_blank" title="中国软件开发网(CSDN)">中国软件开发网(CSDN)</a>
          </li>
          <li>
            	<a href="http://www.golangtc.com/" target="_blank" title="Golang中国">Golang中国</a>
          </li>
          <li>
            	<a href="http://blog.qiniu.com/" target="_blank" title="七牛团队博客">七牛团队博客</a>
          </li>
          <li>
            	<a href="http://csrd.aliapp.com/" target="_blank" title="阿里核心系统团队博客">阿里核心系统团队博客</a>
          </li>
          <li>
            	<a href="http://coolshell.cn/" target="_blank" title="酷壳－陈浩">酷壳－陈浩</a>
          </li>
          <li>
            	<a href="http://www.ruanyifeng.com/blog/" target="_blank" title="阮一峰的网络日志">阮一峰的网络日志</a>
          </li>
          <li>
            	<a href="https://blog.dandyweng.com/" target="_blank" title="homeschooler－翁天信的博客">homeschooler－翁天信的博客</a>
          </li>
          <li>
            	<a href="http://www.jeffjade.com/" target="_blank" title="晚晴幽草轩">晚晴幽草轩</a>
          </li>
          <li>
            	<a href="https://nicejade.github.io/index.html" target="_blank" title="天意人间舫">天意人间舫</a>
          </li>
    </ul>
</div>

    <div class="linkslist">
  <p class="asidetitle">在线书籍</p>
    <ul>
          <li>
            	<a href="https://docs.ruanjiadeng.com/gopl-zh/index.html" target="_blank" title="Go语言圣经（中文版）">Go语言圣经（中文版）</a>
          </li>
          <li>
            	<a href="http://studygolang.com/pkgdoc" target="_blank" title="Go语言标准库">Go语言标准库</a>
          </li>
          <li>
            	<a href="http://www.w3school.com.cn/" target="_blank" title="w3school 在线教程">w3school 在线教程</a>
          </li>
    </ul>
</div>

    <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
          <li>
            	<a href="http://www.cloudxns.net/" target="_blank" title="CloudXNS官网">CloudXNS官网</a>
          </li>
          <li>
            	<a href="http://www.chinatesters.com/" target="_blank" title="华夏评测师家园">华夏评测师家园</a>
          </li>
    </ul>
</div>

  
  <div class="archiveslist">
    <p class="asidetitle">归档</p>
    <ul class="archive-list">
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2025-08">2025年08月</a><span class="archive-list-count">10</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2025-07">2025年07月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2024-02">2024年02月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2024-01">2024年01月</a><span class="archive-list-count">7</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-06">2023年06月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-03">2023年03月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-01">2023年01月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-12">2022年12月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-11">2022年11月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-10">2022年10月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-09">2022年09月</a><span class="archive-list-count">7</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-11">2019年11月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-10">2019年10月</a><span class="archive-list-count">8</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-08">2019年08月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-02">2019年02月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2018-02">2018年02月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-08">2017年08月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-07">2017年07月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-03">2017年03月</a><span class="archive-list-count">8</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-09">2016年09月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-05">2016年05月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-03">2016年03月</a><span class="archive-list-count">5</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-02">2016年02月</a><span class="archive-list-count">11</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-01">2016年01月</a><span class="archive-list-count">6</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#0001-01">0001年01月</a><span class="archive-list-count">1</span>
      </li>
      
    </ul>

  </div>


  

<div class="tagcloudlist">
  <p class="asidetitle">标签云</p>
  <div class="tagcloudlist clearfix">
    
    <a href="http://mospany.github.io/tags/" style="font-size: 12px;"></a>
    
    <a href="http://mospany.github.io/tags/dns" style="font-size: 12px;">dns</a>
    
    <a href="http://mospany.github.io/tags/dpdk" style="font-size: 12px;">dpdk</a>
    
    <a href="http://mospany.github.io/tags/emacs" style="font-size: 12px;">emacs</a>
    
    <a href="http://mospany.github.io/tags/gpu" style="font-size: 12px;">gpu</a>
    
    <a href="http://mospany.github.io/tags/hugo" style="font-size: 12px;">hugo</a>
    
    <a href="http://mospany.github.io/tags/ipv6" style="font-size: 12px;">ipv6</a>
    
    <a href="http://mospany.github.io/tags/k8s" style="font-size: 12px;">k8s</a>
    
    <a href="http://mospany.github.io/tags/linux" style="font-size: 12px;">linux</a>
    
    <a href="http://mospany.github.io/tags/openresty" style="font-size: 12px;">openresty</a>
    
    <a href="http://mospany.github.io/tags/org-mode" style="font-size: 12px;">org-mode</a>
    
    <a href="http://mospany.github.io/tags/pango" style="font-size: 12px;">pango</a>
    
    <a href="http://mospany.github.io/tags/redis" style="font-size: 12px;">redis</a>
    
    <a href="http://mospany.github.io/tags/spacemacs" style="font-size: 12px;">spacemacs</a>
    
    <a href="http://mospany.github.io/tags/vim" style="font-size: 12px;">vim</a>
    
    <a href="http://mospany.github.io/tags/vue" style="font-size: 12px;">vue</a>
    
    <a href="http://mospany.github.io/tags/xns" style="font-size: 12px;">xns</a>
    
    <a href="http://mospany.github.io/tags/yaml" style="font-size: 12px;">yaml</a>
    
    <a href="http://mospany.github.io/tags/%e4%ba%91%e8%ae%a1%e7%ae%97" style="font-size: 12px;">云计算</a>
    
    <a href="http://mospany.github.io/tags/%e4%ba%92%e8%81%94%e7%bd%91" style="font-size: 12px;">互联网</a>
    
    <a href="http://mospany.github.io/tags/%e4%ba%ba%e5%b7%a5%e6%99%ba%e8%83%bd" style="font-size: 12px;">人工智能</a>
    
    <a href="http://mospany.github.io/tags/%e5%89%8d%e7%ab%af" style="font-size: 12px;">前端</a>
    
    <a href="http://mospany.github.io/tags/%e5%8d%9a%e5%ae%a2" style="font-size: 12px;">博客</a>
    
    <a href="http://mospany.github.io/tags/%e5%ad%98%e5%82%a8" style="font-size: 12px;">存储</a>
    
    <a href="http://mospany.github.io/tags/%e5%b7%a5%e5%85%b7" style="font-size: 12px;">工具</a>
    
    <a href="http://mospany.github.io/tags/%e5%be%ae%e4%bf%a1" style="font-size: 12px;">微信</a>
    
    <a href="http://mospany.github.io/tags/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" style="font-size: 12px;">技术文章</a>
    
    <a href="http://mospany.github.io/tags/%e6%9e%b6%e6%9e%84" style="font-size: 12px;">架构</a>
    
    <a href="http://mospany.github.io/tags/%e7%8b%ac%e7%ab%8b" style="font-size: 12px;">独立</a>
    
    <a href="http://mospany.github.io/tags/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" style="font-size: 12px;">生活记录</a>
    
    <a href="http://mospany.github.io/tags/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" style="font-size: 12px;">职场人生</a>
    
    <a href="http://mospany.github.io/tags/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" style="font-size: 12px;">读书笔记</a>
    
    <a href="http://mospany.github.io/tags/%e9%82%ae%e7%ae%b1" style="font-size: 12px;">邮箱</a>
    
    <a href="http://mospany.github.io/tags/%e9%9d%a2%e8%af%95" style="font-size: 12px;">面试</a>
    
    <a href="http://mospany.github.io/tags/%e9%a1%b9%e7%9b%ae%e5%ae%9e%e8%b7%b5" style="font-size: 12px;">项目实践</a>
    
  </div>
</div>



  
</aside>
</div>

  </div>
  <footer><div id="footer" >
  
  <div class="line">
    <span></span>
    <div style='background:no-repeat url("http://mospany.github.io/img/author.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/qiniu_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/fastweb_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/leadsec_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/raisecom_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/jbt_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  
  
  <div class="social-font clearfix">
    
    <a href="http://weibo.com/mospan" target="_blank" title="weibo"></a>
    
    
    <a href="https://twitter.com/mospan" target="_blank" title="twitter"></a>
    
    
    <a href="https://github.com/mospany" target="_blank" title="github"></a>
    
    
    <a href="https://www.facebook.com/mospan" target="_blank" title="facebook"></a>
    
    
    <a href="https://www.linkedin.com/mospan" target="_blank" title="linkedin"></a>
    
  </div>
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/mospany/mospan-hugo-blog/tree/master/themes/hugo-panman-theme" target="_blank" title="hugo-panman-theme">hugo-panman-theme</a> © 2025
    
    <a href="http://mospany.github.io/" target="_blank" title="mospan">mospan</a>
    
  </p>
</div>
</footer>
  <script src="http://mospany.github.io/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:http:\/\/mospany.github.io\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<link rel="stylesheet" href="http://mospany.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="http://mospany.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>




</body>
</html>
