<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <base href="http://mospany.github.io/">
  <title>K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU - 墨斯潘園</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  <meta name="keywords" content="K8S,GPU,">
  <meta name="description" content="1. 引言 本文主要分享在不同环境，例如ECS、Docker 和 Kubernetes 等环境中如何使用 GPU。 注：由于没有物理机裸机，在阿里云上申请ECS也可满足学习使">
  <meta name="author" content="mospan">
  <meta itemprop="name" content="K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU - 墨斯潘園">
  <meta itemprop="description" content="1. 引言 本文主要分享在不同环境，例如ECS、Docker 和 Kubernetes 等环境中如何使用 GPU。 注：由于没有物理机裸机，在阿里云上申请ECS也可满足学习使">
  <meta itemprop="image" content="http://mospany.github.io/img/author.jpg">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@mospan" />
  <meta name="twitter:title" content="K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU - 墨斯潘園" />
  
  <meta name="twitter:description" content="">
  <link rel="shortcut icon" href="img/favicon.ico"/>
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon.png" />
  <link rel="stylesheet" href="highlight/styles/github.css">
  <script src="highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <link rel="stylesheet" href="font/hack/css/hack.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <header>
    <div>
  
  <div id="imglogo">
    <a href="http://mospany.github.io/"><img src="http://mospany.github.io/img/logo.jpg" alt="墨斯潘園" title="墨斯潘園"/></a>
  </div>
  
  <div id="textlogo">
    <h1 class="site-name"><a href="http://mospany.github.io/" title="墨斯潘園">墨斯潘園</a></h1>
    <h2 class="blog-motto">技术改变生活，学习成就未来</h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
  <nav class="animated">
    <ul>
      
      <li><a href="/">首页</a></li> 
      
      <li><a href="/about">关于</a></li> 
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder="搜索">
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="http://mospany.github.io/2024/01/16/gpu-on-k8s/" title="K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU" itemprop="url">K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU</a>
  </h1>
  <p class="article-author">By 
    
      <a href="http://blog.mospan.cn" title="mospan">mospan</a>
    
  </p>
  <p class="article-time">
    <time datetime="2024-01-16 19:31:10 &#43;0800 CST" itemprop="datePublished">2024年01月16日</time>
  </p>
</header>

	<div class="article-content">
    
    

<h1 id="1-引言">1. 引言</h1>

<p>本文主要分享在不同环境，例如ECS、Docker 和 Kubernetes 等环境中如何使用 GPU。
<strong>注</strong>：由于没有物理机裸机，在阿里云上申请ECS也可满足学习使用。</p>

<h1 id="2-规划">2. 规划</h1>

<p>基于如下环境搭建：
<img src="post/2024/images/2024-01-17-gpu-operator/IMG_20250117-194645644.png" alt="picture 0" /><br />
查看worker节点GPU信息：</p>

<pre><code class="language-bash">[root@k8s-worker1 ~]# lspci | grep -i nvidia
00:07.0 VGA compatible controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
[root@k8s-worker1 ~]# 
</code></pre>

<p>说明该worker节点有1张NVIDIA Tesla T4的GPU卡。</p>

<h1 id="3-概述">3. 概述</h1>

<p>仅以比较常见的 NVIDIA GPU 举例，系统为 Linux，对于其他厂家的 GPU 设备理论上流程都是一样的。</p>

<p>省流：</p>

<ul>
<li>对于ECS环境，只需要安装对应的 <a href="https://help.aliyun.com/zh/egs/user-guide/installation-guideline-for-nvidia-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_0.726f718evZrl7t">GPU Driver</a>（GPU计算型实例为Tesla驱动，GPU虚拟化型实例为GRID驱动） 以及 CUDA Toolkit 。</li>
<li>对应 Docker 环境，需要额外安装 nvidia-container-toolkit 并配置 docker 使用 nvidia runtime。</li>
<li>对应 k8s 环境，需要额外安装对应的 device-plugin 使得 kubelet 能够感知到节点上的 GPU 设备，以便 k8s 能够进行 GPU 管理。</li>
</ul>

<p>注：一般在 k8s 中使用都会直接使用 gpu-operator 方式进行安装，本文主要为了搞清各个组件的作用，因此进行手动安装。</p>

<blockquote>
<p>ps；下一篇分享下如何使用 gpu-operator 快速完成安装</p>
</blockquote>

<h1 id="4-ecs环境">4. ECS环境</h1>

<p>裸机中要使用上 GPU 需要安装以下组件：</p>

<ul>
<li>GPU Driver</li>
<li>CUDA Toolkit
二者的关系如 NVIDIA 官网上的这个图所示：</li>
</ul>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-152256220.png" alt="picture 0" /></p>

<p>GPU Driver 包括了 GPU 驱动和 CUDA 驱动，CUDA Toolkit 则包含了 CUDA Runtime。</p>

<p>GPU 作为一个 PCIE 设备，只要安装好之后，在系统中就可以通过 lspci 命令查看到，先确认机器上是否有 GPU：</p>

<pre><code class="language-bash">[root@k8s-worker1 ~]# lspci | grep -i nvidia
00:07.0 VGA compatible controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
[root@k8s-worker1 ~]# 
</code></pre>

<p>说明该worker节点有1张NVIDIA Tesla T4的GPU卡。</p>

<h2 id="4-1-安装grid驱动">4.1. 安装GRID驱动</h2>

<p>由于主机规格是ecs.sgn6i-vws-m2.xlarge，是虚拟化型规格，不能安装Tesla驱动的，需要安装grid驱动。
安装Tesla驱动的话将会出现<a href="#61-error-unable-to-load-the-kernel-module-nvidiako">ERROR: Unable to load the kernel module &lsquo;nvidia.ko&rsquo;.</a>错误安装失败。</p>

<p>安装步骤参考：<a href="https://help.aliyun.com/zh/egs/user-guide/use-cloud-assistant-to-automatically-install-and-upgrade-grid-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_2_1.65bd2ef7tthoW5">在GPU虚拟化型实例中安装GRID驱动（Linux）</a></p>

<h3 id="4-1-1-准备安装脚本">4.1.1. 准备安装脚本</h3>

<p>install-grid.sh内容如下：</p>

<pre><code class="language-bash">#!/bin/bash
if acs-plugin-manager --list --local | grep grid_driver_install &gt; /dev/null 2&gt;&amp;1
then
            acs-plugin-manager --remove --plugin grid_driver_install
fi

acs-plugin-manager --exec --plugin grid_driver_install
</code></pre>

<h3 id="4-1-2-安装grid">4.1.2. 安装grid</h3>

<pre><code class="language-bash">[root@k8s-worker1 ~]# sh install-grid.sh 
RemovePlugin success, plugin[grid_driver_install]
INFO[0000] Starting environment pre-check               
INFO[0000] environment pre-check done                   
INFO[0000] Check gpu device present                     
INFO[0000] Check gpu device present done                
INFO[0000] current installed gird driver is, 470.239.06 
INFO[0000] current installed gird driver is already SWL driver 
[root@k8s-worker1 ~]# 
</code></pre>

<h3 id="4-1-3-验证">4.1.3. 验证</h3>

<pre><code class="language-bash">root@k8s-worker1 ~]# nvidia-smi
</code></pre>

<p>运行成功，可看到有一张T4-2Q的GPU卡。
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-192347251.png" alt="picture 6" /><br />
至此，我们就安装好 GPU 驱动了，系统也能正常识别到 GPU。</p>

<p>这里显示的 CUDA 版本表示当前驱动最大支持的 CUDA 版本。</p>

<h2 id="4-2-安装cuda">4.2. 安装CUDA</h2>

<h3 id="4-2-1-安装软件">4.2.1. 安装软件</h3>

<pre><code class="language-bash">wget https://developer.download.nvidia.com/compute/cuda/11.4.0/local_installers/cuda_11.4.0_470.42.01_linux.run
sudo sh cuda_11.4.0_470.42.01_linux.run
</code></pre>

<p>由于已安装了GRID驱动，需取消cuda自带的驱动安装：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-200338239.png" alt="picture 7" /><br />
01) 安装全部组件：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-200453794.png" alt="picture 8" /><br />
02) 输出：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-201735441.png" alt="picture 9" /></p>

<p>03) 执行以下命令，重启GPU实例</p>

<pre><code class="language-bash">reboot
</code></pre>

<p>04) 依次执行以下命令，配置CUDA环境变量。</p>

<pre><code class="language-bash">echo 'export PATH=/usr/local/cuda/bin:$PATH' | sudo tee /etc/profile.d/cuda.sh
source /etc/profile
</code></pre>

<p>05) 检查CUDA是否成功安装。</p>

<p>a) 执行nvcc -V命令，检查CUDA安装版本是否正确。
   <img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-202721754.png" alt="picture 10" /></p>

<p>b) 依次执行以下命令，测试CUDA Samples，验证CUDA是否安装成功。</p>

<pre><code class="language-bash">    [root@k8s-worker1 ~]# cd /usr/local/cuda-11.4/extras/demo_suite/
    [root@k8s-worker1 demo_suite]# ./deviceQuery  
</code></pre>

<p>如果返回结果显示Result=PASS，则表示CUDA安装成功。
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-203410971.png" alt="picture 11" /></p>

<p>06) 测试
我们使用一个简单的 Pytorch 程序来检测 GPU 和 CUDA 是否正常。</p>

<p>整个调用链大概是这样的：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-204049273.png" alt="picture 12" /><br />
使用下面代码来测试能够正常使用， check_cuda_pytorch.py 内容如下：</p>

<pre><code class="language-python">import torch

def check_cuda_with_pytorch():
    &quot;&quot;&quot;检查 PyTorch CUDA 环境是否正常工作&quot;&quot;&quot;
    try:
        print(&quot;检查 PyTorch CUDA 环境:&quot;)
        if torch.cuda.is_available():
            print(f&quot;CUDA 设备可用，当前 CUDA 版本是: {torch.version.cuda}&quot;)
            print(f&quot;PyTorch 版本是: {torch.__version__}&quot;)
            print(f&quot;检测到 {torch.cuda.device_count()} 个 CUDA 设备。&quot;)
            for i in range(torch.cuda.device_count()):
                print(f&quot;设备 {i}: {torch.cuda.get_device_name(i)}&quot;)
                print(f&quot;设备 {i} 的显存总量: {torch.cuda.get_device_properties(i).total_memory / (1024 ** 3):.2f} GB&quot;)
                print(f&quot;设备 {i} 的显存当前使用量: {torch.cuda.memory_allocated(i) / (1024 ** 3):.2f} GB&quot;)
                print(f&quot;设备 {i} 的显存最大使用量: {torch.cuda.memory_reserved(i) / (1024 ** 3):.2f} GB&quot;)
        else:
            print(&quot;CUDA 设备不可用。&quot;)
    except Exception as e:
        print(f&quot;检查 PyTorch CUDA 环境时出现错误: {e}&quot;)

if __name__ == &quot;__main__&quot;:
    check_cuda_with_pytorch()

</code></pre>

<p>先安装下 torch</p>

<pre><code class="language-bash">python -m pip install torch
</code></pre>

<p>运行一下</p>

<pre><code class="language-bash">python check_cuda_pytorch.py
</code></pre>

<p>正常输出应该是这样的：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250121-210940440.png" alt="picture 13" /></p>

<h2 id="4-3-更新cuda">4.3. 更新CUDA</h2>

<p>由于有些应用需要更高级的版本的CUDA，需升级，如下升级为12.6版本。</p>

<pre><code class="language-bash">sudo dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
sudo dnf clean all
sudo dnf -y install cuda-toolkit-12-6
</code></pre>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-203151909.png" alt="picture 18" /><br />
验证:
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-203406637.png" alt="picture 19" /><br />
说明12.6版本安装成功。
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-213858800.png" alt="picture 20" /></p>

<h1 id="5-docker环境">5. Docker环境</h1>

<p>上一步中我们已经在裸机上安装了 GPU Driver，CUDA Toolkit 等工具，实现了在宿主机上使用 GPU。</p>

<p>现在希望在 Docker 容器中使用 GPU，需要怎么处理呢?</p>

<p>为了让 Docker 容器中也能使用 GPU，大致步骤如下：</p>

<ol>
<li>安装docker，已有则跳过这步骤。</li>
<li>安装 nvidia-container-toolkit 组件</li>
<li>docker 配置使用 nvidia-runtime</li>
<li>启动容器时增加 &ndash;gpu 参数</li>
</ol>

<h2 id="5-1-docker安装">5.1. Docker安装</h2>

<h3 id="5-1-1-安装必要的一些系统工具">5.1.1. 安装必要的一些系统工具</h3>

<pre><code class="language-bash">sudo yum install -y yum-utils
</code></pre>

<h3 id="5-1-2-添加软件源信息">5.1.2. 添加软件源信息</h3>

<pre><code class="language-bash">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre>

<h3 id="5-1-3-安装docker">5.1.3. 安装Docker</h3>

<pre><code class="language-bash">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre>

<h3 id="5-1-4-开启docker服务">5.1.4. 开启Docker服务</h3>

<pre><code class="language-bash">sudo service docker start
</code></pre>

<h3 id="5-1-5-验证">5.1.5. 验证</h3>

<pre><code class="language-bash">root@k8s-worker1 pytorch]# docker version
Client: Docker Engine - Community
 Version:           26.1.3
 API version:       1.45
 Go version:        go1.21.10
 Git commit:        b72abbb
 Built:             Thu May 16 08:34:39 2024
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          26.1.3
  API version:      1.45 (minimum version 1.24)
  Go version:       go1.21.10
  Git commit:       8e96db1
  Built:            Thu May 16 08:33:34 2024
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.6.32
  GitCommit:        8b3b7ca2e5ce38e8f31a34f35b2b68ceb8470d89
 runc:
  Version:          1.1.12
  GitCommit:        v1.1.12-0-g51d5e94
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0
[root@k8s-worker1 pytorch]# 
</code></pre>

<h2 id="5-2-安装-nvidia-container-toolkit">5.2. 安装 nvidia-container-toolkit</h2>

<p>NVIDIA Container Toolkit 的主要作用是将 NVIDIA GPU 设备挂载到容器中。
&gt;兼容生态系统中的任意容器运行时，docker、containerd、cri-o 等。</p>

<p>NVIDIA 官方安装文档：<a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html">nvidia-container-toolkit-install-guide</a></p>

<p>ALIOS或centos安装命令如下：</p>

<pre><code class="language-bash"># Configure the production repository:
curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo

# Optionally, configure the repository to use experimental packages:
sudo yum-config-manager --enable nvidia-container-toolkit-experimental

#Install the NVIDIA Container Toolkit packages:
sudo yum install -y nvidia-container-toolkit
</code></pre>

<p>安装成功如下：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-185247937.png" alt="picture 14" /></p>

<h2 id="5-3-配置使用该-runtime">5.3. 配置使用该 runtime</h2>

<p>支持 Docker, Containerd, CRI-O, Podman 等 CRI。
&gt;具体见官方文档 <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#configuration">container-toolkit#install-guide</a></p>

<p>这里以 Docker 为例进行配置：
旧版本需要手动在 /etc/docker/daemon.json 中增加配置，指定使用 nvidia 的 runtime。</p>

<pre><code class="language-json">    &quot;runtimes&quot;: {
        &quot;nvidia&quot;: {
            &quot;args&quot;: [],
            &quot;path&quot;: &quot;nvidia-container-runtime&quot;
        }
    }
</code></pre>

<p>新版 toolkit 带了一个nvidia-ctk 工具，执行以下命令即可一键配置然后重启docker：</p>

<pre><code class="language-bash">sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
</code></pre>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191008933.png" alt="picture 15" /></p>

<h2 id="5-4-验证">5.4. 验证</h2>

<p>安装nvidia-container-toolkit 后，整个调用链如下：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191407685.png" alt="picture 16" /></p>

<p>调用链从 containerd –&gt; runC 变成 containerd –&gt; nvidia-container-runtime –&gt; runC 。</p>

<p>然后 nvidia-container-runtime 在中间拦截了容器 spec，就可以把 gpu 相关配置添加进去，再传给 runC 的 spec 里面就包含 gpu 信息了。</p>

<p>Docker 环境中的 CUDA 调用大概是这样的：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-191542185.png" alt="picture 17" /></p>

<p>从图中可以看到，CUDA Toolkit 跑到容器里了，因此宿主机上不需要再安装 CUDA Toolkit。</p>

<p>使用一个带 CUDA Toolkit 的镜像即可。</p>

<p>最后我们启动一个 Docker 容器进行测试，其中命令中增加 &ndash;gpu参数来指定要分配给容器的 GPU。</p>

<p>gpu 参数可选值：</p>

<ul>
<li>gpus all：表示将所有 GPU 都分配给该容器</li>
<li>gpus &ldquo;device=<id>[,<id>&hellip;]&ldquo;：对于多 GPU 场景，可以通过 id 指定分配给容器的 GPU，例如 –gpu “device=0” 表示只分配 0 号 GPU 给该容器
GPU 编号则是通过nvidia-smi 命令进行查看</li>
</ul>

<p>这里我们直接使用一个带 cuda 的镜像来测试，启动该容器并执行nvidia-smi 命令</p>

<pre><code class="language-bash">[root@k8s-worker1 ~]# docker run --rm --gpus all  nvcr.io/nvidia/cuda:11.0.3-runtime-ubuntu20.04 nvidia-smi
</code></pre>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-214303643.png" alt="picture 22" /><br />
正常情况下应该是可以打印出容器中的 GPU 信息的。</p>

<p><strong>注</strong>： 镜像需与grid驱动版本兼容，否则报错。</p>

<h1 id="6-k8s环境">6. K8S环境</h1>

<p>更进一步，在 k8s 环境中使用 GPU，则需要在集群中部署以下组件：</p>

<ul>
<li>gpu-device-plugin 用于管理 GPU，device-plugin 以 DaemonSet 方式运行到集群各个节点，以感知节点上的 GPU 设备，从而让 k8s 能够对节点上的 GPU 设备进行管理。</li>
<li>gpu-exporter：用于监控 GPU</li>
</ul>

<p>各组件关系如下图所示：</p>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-215913188.png" alt="picture 23" /></p>

<p>左图为手动安装的场景，只需要在集群中安装 device-plugin 和 监控即可使用。</p>

<p>右图为使用 gpu-operotar 安装场景，本篇暂时忽略</p>

<p>大致工作流程如下：</p>

<ul>
<li>每个节点的 kubelet 组件维护该节点的 GPU 设备状态（哪些已用，哪些未用）并定时报告给调度器，调度器知道每一个节点有多少张 GPU 卡可用。</li>
<li>调度器为 pod 选择节点时，从符合条件的节点中选择一个节点。</li>
<li>当 pod 调度到节点上后，kubelet 组件为 pod 分配 GPU 设备 ID，并将这些 ID 作为参数传递给 NVIDIA Device Plugin</li>
<li>NVIDIA Device Plugin 将分配给该 pod 的容器的 GPU 设备 ID 写入到容器的环境变量 NVIDIA_VISIBLE_DEVICES中，然后将信息返回给 kubelet。</li>
<li>kubelet 启动容器。</li>
<li>NVIDIA Container Toolkit 检测容器的 spec 中存在环境变量 NVIDIA_VISIBLE_DEVICES，然后根据环境变量的值将 GPU 设备挂载到容器中。
在 Docker 环境我们在启动容器时通过 &ndash;gpu 参数手动指定分配给容器的 GPU，k8s 环境则由 device-plugin 自行管理。</li>
</ul>

<h2 id="6-1-集群环境">6.1. 集群环境</h2>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-220923122.png" alt="picture 24" /></p>

<h2 id="安装-device-plugin">安装 device-plugin</h2>

<p>device-plugin 一般由对应的 GPU 厂家提供，比如 NVIDIA 的 <a href="https://github.com/NVIDIA/k8s-device-plugin">k8s-device-plugin</a></p>

<p>安装其实很简单，将对应的 yaml apply 到集群即可。</p>

<pre><code class="language-bash">kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.15.0/deployments/static/nvidia-device-plugin.yml
</code></pre>

<p>就像这样
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-221359266.png" alt="picture 25" /></p>

<p>device-plugin 启动之后，会感知节点上的 GPU 设备并上报给 kubelet，最终由 kubelet 提交到 kube-apiserver。</p>

<p>因此我们可以在 Node 可分配资源中看到 GPU，就像这样：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250122-221933864.png" alt="picture 26" /><br />
可以看到，除了常见的 cpu、memory 之外，还有nvidia.com/gpu, 这个就是 GPU 资源，数量为 0，应该为1，错误原因待查。
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250123-095336709.png" alt="picture 27" /></p>

<h2 id="安装-gpu-监控">安装 GPU 监控</h2>

<p>除此之外，如果你需要监控集群 GPU 资源使用情况，你可能还需要安装 DCCM exporter 结合 Prometheus 输出 GPU 资源监控信息。</p>

<p>安装略。</p>

<h1 id="小结">小结</h1>

<p>本文主要分享了在ECS、Docker 环境、k8s 环境中如何使用 GPU。</p>

<ul>
<li><p>对于ECS环境，只需要安装对应的 GPU Driver 即可。</p></li>

<li><p>对应 Docker 环境，需要额外安装 nvidia-container-toolkit 并配置 docker 使用 nvidia runtime。</p></li>

<li><p>对应 k8s 环境，需要额外安装对应的 device-plugin 使得 kubelet 能够感知到节点上的 GPU 设备，以便 k8s 能够进行 GPU 管理。</p></li>
</ul>

<p>现在一般都是在 k8s 环境中使用，为了简化安装步骤， NVIDIA 也提供了 gpu-operator来简化安装部署，后续分享一下如何使用 gpu-operator来快速安装。</p>

<h1 id="7-参考资料">7. 参考资料</h1>

<p>【01】<a href="https://blog.csdn.net/Doudou_Mylove/article/details/114388633">阿里云GPU服务器安装驱动（完整版）</a></p>

<p>【02】<a href="https://help.aliyun.com/zh/egs/user-guide/install-a-gpu-driver-on-a-gpu-accelerated-compute-optimized-linux-instance?spm=a2c4g.11186623.help-menu-155040.d_1_5_1_1.6b70fb7cljEZnN&amp;scm=20140722.H_163824._.OR_help-T_cn~zh-V_1">在GPU计算型实例中手动安装Tesla驱动（Linux）</a></p>

<p>【03】<a href="https://help.aliyun.com/zh/egs/user-guide/use-cloud-assistant-to-automatically-install-and-upgrade-grid-drivers?spm=a2c4g.11186623.help-menu-155040.d_1_5_2_1.660551bd3LBP63">在GPU虚拟化型实例中安装GRID驱动（Linux）</a></p>

<h1 id="8-faq">8. FAQ</h1>

<h2 id="8-1-error-unable-to-load-the-kernel-module-nvidia-ko">8.1. ERROR: Unable to load the kernel module &lsquo;nvidia.ko&rsquo;.</h2>

<p><img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-155358481.png" alt="picture 4" /><br />
错误详情提示：
<img src="post/2024/images/2024-01-16-gpu-on-k8s/IMG_20250120-155501141.png" alt="picture 5" /></p>

    <div style="border: 1px dashed #e0e0e0; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
  <div style="float:right;margin-top:0px;">
    <img src="/img/qrcode.jpg" width="129px" height="129px"/>
    <div style="text-align:center;">微信扫一扫</div>
  </div>
  <div style="float:left;margin-top:0px;">
    <img src="/img/rewardcode.jpg" width="129px" height="129px"/>
  </div>
  <div>
    <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.mospan.cn/">mospan</a>
      <br />微信关注：墨斯潘園
      <br />本文出处：<a target="_blank" href="http://mospany.github.io/2024/01/16/gpu-on-k8s/">http://mospany.github.io/2024/01/16/gpu-on-k8s/</a>
      <br />
      文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</p>
  </div>
</div>


	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="/tags/k8s">K8S</a>
  
  <a href="/tags/gpu">GPU</a>
  
</div>



<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="/categories/k8s">K8S</a>
  
  <a class="article-category-link" href="/categories/gpu">GPU</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="http://mospany.github.io/2024/01/16/gpu-on-k8s/" data-title="K8S项目实践(08): 在ECS、Docker、K8s 等环境中使用 GPU" data-tsina="3833537679" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  





<div id="git-comments"></div>
<link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
<script src="https://billts.site/js/gitment.js"></script>
<script>
var gitment = new Gitment({
  id: '<%= page.date %>',
  owner: 'mospany',
  repo: 'mospan-hugo-blog-gitment',
  oauth: {
    client_id: '0cafe299c964f0af2d1e',
    client_secret: 'ec47ee9481210935a662298791c31da203694a8f',
  },
})
gitment.render('git-comments')
</script>    


</div>

    <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>
<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
  

<div class="categorieslist">
  <p class="asidetitle">分类</p>
  <ul>
    
    <li><a href="http://mospany.github.io/categories/k8s" title="k8s">k8s<sup>1</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e4%ba%91%e8%ae%a1%e7%ae%97" title="云计算">云计算<sup>3</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e4%ba%ba%e5%b7%a5%e6%99%ba%e8%83%bd" title="人工智能">人工智能<sup>2</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e5%b7%a5%e5%85%b7%e4%bd%bf%e7%94%a8" title="工具使用">工具使用<sup>3</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" title="技术文章">技术文章<sup>42</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" title="生活记录">生活记录<sup>1</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" title="职场人生">职场人生<sup>1</sup></a></li>
    
    <li><a href="http://mospany.github.io/categories/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" title="读书笔记">读书笔记<sup>2</sup></a></li>
    
  </ul>
</div>



  

<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
      
			<li><a href="http://mospany.github.io/tags/" title=""><sup>6</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/dns" title="dns">dns<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/dpdk" title="dpdk">dpdk<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/emacs" title="emacs">emacs<sup>5</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/gpu" title="gpu">gpu<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/hugo" title="hugo">hugo<sup>3</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/ipv6" title="ipv6">ipv6<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/k8s" title="k8s">k8s<sup>16</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/linux" title="linux">linux<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/openresty" title="openresty">openresty<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/org-mode" title="org-mode">org-mode<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/pango" title="pango">pango<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/redis" title="redis">redis<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/spacemacs" title="spacemacs">spacemacs<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/vim" title="vim">vim<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/vue" title="vue">vue<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/xns" title="xns">xns<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/yaml" title="yaml">yaml<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e4%ba%91%e8%ae%a1%e7%ae%97" title="云计算">云计算<sup>6</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e4%ba%92%e8%81%94%e7%bd%91" title="互联网">互联网<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%89%8d%e7%ab%af" title="前端">前端<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%8d%9a%e5%ae%a2" title="博客">博客<sup>7</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%ad%98%e5%82%a8" title="存储">存储<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%b7%a5%e5%85%b7" title="工具">工具<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e5%be%ae%e4%bf%a1" title="微信">微信<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" title="技术文章">技术文章<sup>2</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e6%9e%b6%e6%9e%84" title="架构">架构<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e7%8b%ac%e7%ab%8b" title="独立">独立<sup>3</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" title="生活记录">生活记录<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" title="职场人生">职场人生<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" title="读书笔记">读书笔记<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%82%ae%e7%ae%b1" title="邮箱">邮箱<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%9d%a2%e8%af%95" title="面试">面试<sup>1</sup></a></li>
      
			<li><a href="http://mospany.github.io/tags/%e9%a1%b9%e7%9b%ae%e5%ae%9e%e8%b7%b5" title="项目实践">项目实践<sup>4</sup></a></li>
      
		</ul>
</div>



    <div class="linkslist">
  <p class="asidetitle">我的关注</p>
    <ul>
          <li>
            	<a href="http://www.csdn.net/" target="_blank" title="中国软件开发网(CSDN)">中国软件开发网(CSDN)</a>
          </li>
          <li>
            	<a href="http://www.golangtc.com/" target="_blank" title="Golang中国">Golang中国</a>
          </li>
          <li>
            	<a href="http://blog.qiniu.com/" target="_blank" title="七牛团队博客">七牛团队博客</a>
          </li>
          <li>
            	<a href="http://csrd.aliapp.com/" target="_blank" title="阿里核心系统团队博客">阿里核心系统团队博客</a>
          </li>
          <li>
            	<a href="http://coolshell.cn/" target="_blank" title="酷壳－陈浩">酷壳－陈浩</a>
          </li>
          <li>
            	<a href="http://www.ruanyifeng.com/blog/" target="_blank" title="阮一峰的网络日志">阮一峰的网络日志</a>
          </li>
          <li>
            	<a href="https://blog.dandyweng.com/" target="_blank" title="homeschooler－翁天信的博客">homeschooler－翁天信的博客</a>
          </li>
          <li>
            	<a href="http://www.jeffjade.com/" target="_blank" title="晚晴幽草轩">晚晴幽草轩</a>
          </li>
          <li>
            	<a href="https://nicejade.github.io/index.html" target="_blank" title="天意人间舫">天意人间舫</a>
          </li>
    </ul>
</div>

    <div class="linkslist">
  <p class="asidetitle">在线书籍</p>
    <ul>
          <li>
            	<a href="https://docs.ruanjiadeng.com/gopl-zh/index.html" target="_blank" title="Go语言圣经（中文版）">Go语言圣经（中文版）</a>
          </li>
          <li>
            	<a href="http://studygolang.com/pkgdoc" target="_blank" title="Go语言标准库">Go语言标准库</a>
          </li>
          <li>
            	<a href="http://www.w3school.com.cn/" target="_blank" title="w3school 在线教程">w3school 在线教程</a>
          </li>
    </ul>
</div>

    <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
          <li>
            	<a href="http://www.cloudxns.net/" target="_blank" title="CloudXNS官网">CloudXNS官网</a>
          </li>
          <li>
            	<a href="http://www.chinatesters.com/" target="_blank" title="华夏评测师家园">华夏评测师家园</a>
          </li>
    </ul>
</div>

  
  <div class="archiveslist">
    <p class="asidetitle">归档</p>
    <ul class="archive-list">
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2024-01">2024年01月</a><span class="archive-list-count">14</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-06">2023年06月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-03">2023年03月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2023-01">2023年01月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-12">2022年12月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-11">2022年11月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-10">2022年10月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2022-09">2022年09月</a><span class="archive-list-count">7</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-11">2019年11月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-10">2019年10月</a><span class="archive-list-count">8</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-08">2019年08月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2019-02">2019年02月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2018-02">2018年02月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-08">2017年08月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-07">2017年07月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2017-03">2017年03月</a><span class="archive-list-count">8</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-09">2016年09月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-05">2016年05月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-03">2016年03月</a><span class="archive-list-count">5</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-02">2016年02月</a><span class="archive-list-count">11</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#2016-01">2016年01月</a><span class="archive-list-count">6</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="http://mospany.github.io/post/#0001-01">0001年01月</a><span class="archive-list-count">1</span>
      </li>
      
    </ul>

  </div>


  

<div class="tagcloudlist">
  <p class="asidetitle">标签云</p>
  <div class="tagcloudlist clearfix">
    
    <a href="http://mospany.github.io/tags/" style="font-size: 12px;"></a>
    
    <a href="http://mospany.github.io/tags/dns" style="font-size: 12px;">dns</a>
    
    <a href="http://mospany.github.io/tags/dpdk" style="font-size: 12px;">dpdk</a>
    
    <a href="http://mospany.github.io/tags/emacs" style="font-size: 12px;">emacs</a>
    
    <a href="http://mospany.github.io/tags/gpu" style="font-size: 12px;">gpu</a>
    
    <a href="http://mospany.github.io/tags/hugo" style="font-size: 12px;">hugo</a>
    
    <a href="http://mospany.github.io/tags/ipv6" style="font-size: 12px;">ipv6</a>
    
    <a href="http://mospany.github.io/tags/k8s" style="font-size: 12px;">k8s</a>
    
    <a href="http://mospany.github.io/tags/linux" style="font-size: 12px;">linux</a>
    
    <a href="http://mospany.github.io/tags/openresty" style="font-size: 12px;">openresty</a>
    
    <a href="http://mospany.github.io/tags/org-mode" style="font-size: 12px;">org-mode</a>
    
    <a href="http://mospany.github.io/tags/pango" style="font-size: 12px;">pango</a>
    
    <a href="http://mospany.github.io/tags/redis" style="font-size: 12px;">redis</a>
    
    <a href="http://mospany.github.io/tags/spacemacs" style="font-size: 12px;">spacemacs</a>
    
    <a href="http://mospany.github.io/tags/vim" style="font-size: 12px;">vim</a>
    
    <a href="http://mospany.github.io/tags/vue" style="font-size: 12px;">vue</a>
    
    <a href="http://mospany.github.io/tags/xns" style="font-size: 12px;">xns</a>
    
    <a href="http://mospany.github.io/tags/yaml" style="font-size: 12px;">yaml</a>
    
    <a href="http://mospany.github.io/tags/%e4%ba%91%e8%ae%a1%e7%ae%97" style="font-size: 12px;">云计算</a>
    
    <a href="http://mospany.github.io/tags/%e4%ba%92%e8%81%94%e7%bd%91" style="font-size: 12px;">互联网</a>
    
    <a href="http://mospany.github.io/tags/%e5%89%8d%e7%ab%af" style="font-size: 12px;">前端</a>
    
    <a href="http://mospany.github.io/tags/%e5%8d%9a%e5%ae%a2" style="font-size: 12px;">博客</a>
    
    <a href="http://mospany.github.io/tags/%e5%ad%98%e5%82%a8" style="font-size: 12px;">存储</a>
    
    <a href="http://mospany.github.io/tags/%e5%b7%a5%e5%85%b7" style="font-size: 12px;">工具</a>
    
    <a href="http://mospany.github.io/tags/%e5%be%ae%e4%bf%a1" style="font-size: 12px;">微信</a>
    
    <a href="http://mospany.github.io/tags/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" style="font-size: 12px;">技术文章</a>
    
    <a href="http://mospany.github.io/tags/%e6%9e%b6%e6%9e%84" style="font-size: 12px;">架构</a>
    
    <a href="http://mospany.github.io/tags/%e7%8b%ac%e7%ab%8b" style="font-size: 12px;">独立</a>
    
    <a href="http://mospany.github.io/tags/%e7%94%9f%e6%b4%bb%e8%ae%b0%e5%bd%95" style="font-size: 12px;">生活记录</a>
    
    <a href="http://mospany.github.io/tags/%e8%81%8c%e5%9c%ba%e4%ba%ba%e7%94%9f" style="font-size: 12px;">职场人生</a>
    
    <a href="http://mospany.github.io/tags/%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0" style="font-size: 12px;">读书笔记</a>
    
    <a href="http://mospany.github.io/tags/%e9%82%ae%e7%ae%b1" style="font-size: 12px;">邮箱</a>
    
    <a href="http://mospany.github.io/tags/%e9%9d%a2%e8%af%95" style="font-size: 12px;">面试</a>
    
    <a href="http://mospany.github.io/tags/%e9%a1%b9%e7%9b%ae%e5%ae%9e%e8%b7%b5" style="font-size: 12px;">项目实践</a>
    
  </div>
</div>



  
</aside>
</div>

  </div>
  <footer><div id="footer" >
  
  <div class="line">
    <span></span>
    <div style='background:no-repeat url("http://mospany.github.io/img/author.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/qiniu_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/fastweb_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/leadsec_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/raisecom_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <div class="line">
    <div style='background:no-repeat url("http://mospany.github.io/img/jbt_logo.jpg") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  
  
  <div class="social-font clearfix">
    
    <a href="http://weibo.com/mospan" target="_blank" title="weibo"></a>
    
    
    <a href="https://twitter.com/mospan" target="_blank" title="twitter"></a>
    
    
    <a href="https://github.com/mospany" target="_blank" title="github"></a>
    
    
    <a href="https://www.facebook.com/mospan" target="_blank" title="facebook"></a>
    
    
    <a href="https://www.linkedin.com/mospan" target="_blank" title="linkedin"></a>
    
  </div>
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/mospany/mospan-hugo-blog/tree/master/themes/hugo-panman-theme" target="_blank" title="hugo-panman-theme">hugo-panman-theme</a> © 2025
    
    <a href="http://mospany.github.io/" target="_blank" title="mospan">mospan</a>
    
  </p>
</div>
</footer>
  <script src="http://mospany.github.io/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:http:\/\/mospany.github.io\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>


<link rel="stylesheet" href="http://mospany.github.io/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="http://mospany.github.io/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
});
</script>




</body>
</html>
